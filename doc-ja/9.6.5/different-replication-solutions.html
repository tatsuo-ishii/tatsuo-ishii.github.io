<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>様々な解法の比較</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REV="MADE"
HREF="mailto:pgsql-docs@postgresql.org"><LINK
REL="HOME"
TITLE="PostgreSQL 9.6.5文書"
HREF="index.html"><LINK
REL="UP"
TITLE="高可用性、負荷分散およびレプリケーション"
HREF="high-availability.html"><LINK
REL="PREVIOUS"
TITLE="高可用性、負荷分散およびレプリケーション"
HREF="high-availability.html"><LINK
REL="NEXT"
TITLE="ログシッピングスタンバイサーバ"
HREF="warm-standby.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="stylesheet.css"><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=utf-8"><META
NAME="creation"
CONTENT="2017-10-17T11:51:21"></HEAD
><BODY
CLASS="SECT1"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="4"
ALIGN="center"
VALIGN="bottom"
><A
HREF="index.html"
>PostgreSQL 9.6.5文書</A
></TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="高可用性、負荷分散およびレプリケーション"
HREF="high-availability.html"
ACCESSKEY="P"
>前のページ</A
></TD
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
HREF="high-availability.html"
ACCESSKEY="U"
>上に戻る</A
></TD
><TD
WIDTH="60%"
ALIGN="center"
VALIGN="bottom"
>第 26章高可用性、負荷分散およびレプリケーション</TD
><TD
WIDTH="20%"
ALIGN="right"
VALIGN="top"
><A
TITLE="ログシッピングスタンバイサーバ"
HREF="warm-standby.html"
ACCESSKEY="N"
>次のページ</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="DIFFERENT-REPLICATION-SOLUTIONS"
>26.1. 様々な解法の比較</A
></H1
><P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>共有ディスクを用いたフェールオーバ</DT
><DD
><P
>データベースのコピーを 1つだけ保有すればよいため、共有ディスクを用いたフェールオーバは同期によるオーバーヘッドを回避できます。
本解法では、複数のサーバが単一のディスクアレイを共有します。
主データベースサーバが故障したとき、まるでデータベースの破損から復旧したように、スタンバイサーバが元のデータベースを実装して稼動できます。
これはデータの消失がない高速なフェールオーバを行うことができます。
    </P
><P
>ハードウェアを共有するという機能は、ネットワーク上の記憶装置では一般的です。
ネットワークファイルシステムの利用も可能ですが、そのファイルシステムがPOSIX仕様を満たしているか注意してください。
（ <A
HREF="creating-cluster.html#CREATING-CLUSTER-NFS"
>項18.2.2</A
>を見てください）。
本解法には重大な制約があり、共有ディスクアレイが故障または破損したとき、プライマリサーバもスタンバイサーバも機能しなくなります。
また、プライマリサーバが稼動している間は、スタンバイサーバが共有記憶装置にアクセスしてはなりません。
    </P
></DD
><DT
>ファイルシステム（ブロックデバイス）レプリケーション</DT
><DD
><P
>ハードウェア共有機能の改善の一つとしてファイルシステムのレプリケーションをあげることができます。
それは、あるファイルシステムに対して行われたすべての変更を他のコンピュータに存在するファイルシステムにミラーリングします。
制約はただ一つであり、スタンバイサーバがファイルシステムの一貫したコピーを自身の領域に持つようにミラーリングしなければなりません。具体的には、スタンバイサーバへの書き込みがマスタサーバへの書き込みと同じ順序でおこなわれなければなりません。
Linuxにおける<SPAN
CLASS="PRODUCTNAME"
>DRBD</SPAN
>は、ファイルシステムレプリケーションで広く受けいれられている手法です。
    </P
></DD
><DT
>トランザクションログシッピング</DT
><DD
><P
>ウォームスタンバイおよびホットスタンバイサーバは、ログ先行書き込み（<ACRONYM
CLASS="ACRONYM"
>WAL</ACRONYM
>）のレコードを解読して最新の状態を保持できます。
プライマリサーバが故障したとき、スタンバイサーバがプライマリサーバのほぼすべてのデータを保存して、速やかに新しい主データベースを稼動できます。
本解法は同期、非同期で行うことができ、データベース全体だけを範囲として処理できます。
    </P
><P
>スタンバイサーバは、ファイル単位のログシッピング（<A
HREF="warm-standby.html"
>項26.2</A
>参照）またはストリーミングレプリケーション（<A
HREF="warm-standby.html#STREAMING-REPLICATION"
>項26.2.5</A
>参照）または両者の併用を使用して実装できます。
ホットスタンバイの情報は <A
HREF="hot-standby.html"
>項26.5</A
> を参照してください。
    </P
></DD
><DT
>トリガベースのマスタ・スタンバイレプリケーション</DT
><DD
><P
>マスタとスタンバイによるレプリケーションでは、データ更新のすべての問い合わせをマスタサーバに送付します。
マスタサーバは更新したデータを非同期でスタンバイサーバに送付します。
マスタサーバが稼動している間、スタンバイサーバは読み取り問い合わせだけに応答します。
スタンバイサーバはデータウェアハウスへの問い合わせに理想的です。
    </P
><P
>この種類のレプリケーションの一例は<SPAN
CLASS="PRODUCTNAME"
>Slony-I</SPAN
>であり、テーブル単位の粒度を持ち、複数のスタンバイサーバが稼動できます。
（バッチ処理によって）スタンバイサーバのデータを非同期で更新するため、フェールオーバにおけるデータ消失の可能性があります。
    </P
></DD
><DT
>文に基づいたレプリケーションのミドルウェア</DT
><DD
><P
>文に基づいたレプリケーションのミドルウェアでは、プログラムがすべてのSQL問い合わせを採取して、1つまたはすべてのサーバに送付します。
なお、各々のサーバは独立して稼動します。
読み書き問い合わせは、すべてのサーバがすべての変更を受け取るように全サーバに送付されなければなりません。
しかし、読み取り専用の問い合わせはサーバ全体の読み取り負荷を分散させるために、1つのサーバだけに送付することができます。
    </P
><P
>問い合わせを修正しないで送付した場合、<CODE
CLASS="FUNCTION"
>random()</CODE
>関数による乱数値と<CODE
CLASS="FUNCTION"
>CURRENT_TIMESTAMP</CODE
>関数による現在時刻およびシーケンス値が、サーバごとに異なることがあります。
その理由は、各サーバが独立して稼動しているため、および、SQL問い合わせの送付では実際に更新した行の識別値を取得できないためです。
これが許容できない場合は、ミドルウェアかアプリケーションにおいて1つのサーバにこのような問い合わせを送付し、その結果を書き込み問い合わせで使用しなければなりません。
その他の選択肢は従来のマスタとスタンバイによるレプリケーションのオプションを使用するものです。
すなわち、データ更新の問い合わせをマスタサーバだけに送付し、ミドルウェアによるレプリケーションを使わずにマスタとスタンバイによるレプリケーションを介してスタンバイサーバに伝達します。
トランザクションをコミットするか中断するかについても、全サーバが同一となるよう注意しなければなりません。
これには2相コミット（<A
HREF="sql-prepare-transaction.html"
>PREPARE TRANSACTION</A
> および <A
HREF="sql-commit-prepared.html"
>COMMIT PREPARED</A
>）を使用することになるでしょう。
<SPAN
CLASS="PRODUCTNAME"
>Pgpool-II</SPAN
>と<SPAN
CLASS="PRODUCTNAME"
>Continuent Tungsten</SPAN
>がこのレプリケーションの一例です。
    </P
></DD
><DT
>非同期マルチマスタレプリケーション</DT
><DD
><P
>ラップトップやリモートマシンのように、通常は接続されていないサーバ間において、データの一貫性を保持することは挑戦的な課題です。
非同期マルチマスタレプリケーションの使用により、全サーバの独立した稼動、およびトランザクションの衝突を識別するための定期的な通信を実現します。
トランザクションの衝突は、利用者および衝突回避法によって解決できるでしょう。
Bucardoはこの種のレプリケーションの一例です。
    </P
></DD
><DT
>同期マルチマスタレプリケーション</DT
><DD
><P
>同期マルチマスタレプリケーションでは全てのサーバが書き込み要求を受理できます。
受理したサーバは更新したデータを、トランザクションをコミットする前に、他の全サーバへ配布します。
書き込み負荷が重いとき、ロックの掛かり過ぎによる作業効率の低下の原因となりえます。
実際、書き込み効率は単一サーバより悪いことが大半です。
読み取り要求はどのサーバにも送付できます。
通信による負荷を減らすには、共有ディスクが実装されます。
同期マルチマスタレプリケーションは、主に読み取り作業負荷の低減に最適ですが、全てのサーバが書き込み要求を受理できることも大きな利点です。
その利点とは、マスタとスタンバイ間で作業負荷を分けなくてよいこと、および更新データが1つのサーバから他のサーバに送付されるため、出力が確定しない<CODE
CLASS="FUNCTION"
>random()</CODE
>関数などによる問題が起こらないことです。
    </P
><P
><SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
> では、この種類のレプリケーションを提供しません。
しかし、<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
> の 2相コミット（<A
HREF="sql-prepare-transaction.html"
>PREPARE TRANSACTION</A
>および<A
HREF="sql-commit-prepared.html"
>COMMIT PREPARED</A
>）を使用すれば、アプリケーションのコードまたはミドルウェアにおいて本解法を実装できます。
    </P
></DD
><DT
>商業的な解法</DT
><DD
><P
><SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
> はオープンソースであり、容易に拡張できます。
そのため多数の企業が、<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>を取り入れて商業的な解法を作成し、フェールオーバとレプリケーションと負荷分散の機能を独自に実現していますが、ソースコードは非公開です。
    </P
></DD
></DL
></DIV
><P
><A
HREF="different-replication-solutions.html#HIGH-AVAILABILITY-MATRIX"
>表26-1</A
>は上述した種々の解法の機能を要約したものです。
 </P
><DIV
CLASS="TABLE"
><A
NAME="HIGH-AVAILABILITY-MATRIX"
></A
><P
><B
>表 26-1. 高可用性、負荷分散およびレプリケーションの特徴</B
></P
><TABLE
BORDER="1"
CLASS="CALSTABLE"
><COL><COL><COL><COL><COL><COL><COL><COL><THEAD
><TR
><TH
>特徴</TH
><TH
>共有ディスクを用いたフェールオーバ</TH
><TH
>ファイルシステムのレプリケーション</TH
><TH
>トランザクションログシッピング</TH
><TH
>マスタとスタンバイによるトリガに基づいたレプリケーション</TH
><TH
>文に基づいたレプリケーションのミドルウェア</TH
><TH
>非同期マルチマスタレプリケーション</TH
><TH
>同期マルチマスタレプリケーション</TH
></TR
></THEAD
><TBODY
><TR
><TD
>最も一般的な実装</TD
><TD
ALIGN="CENTER"
>NAS</TD
><TD
ALIGN="CENTER"
>DRBD</TD
><TD
ALIGN="CENTER"
>ストリーミングレプリケーション</TD
><TD
ALIGN="CENTER"
>Slony</TD
><TD
ALIGN="CENTER"
>pgpool-II</TD
><TD
ALIGN="CENTER"
>Bucardo</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
></TR
><TR
><TD
>通信方法</TD
><TD
ALIGN="CENTER"
>共有ディスク</TD
><TD
ALIGN="CENTER"
>ディスクブロック</TD
><TD
ALIGN="CENTER"
>WAL</TD
><TD
ALIGN="CENTER"
>テーブル行</TD
><TD
ALIGN="CENTER"
>SQL</TD
><TD
ALIGN="CENTER"
>テーブル行</TD
><TD
ALIGN="CENTER"
>テーブル行および行ロック</TD
></TR
><TR
><TD
>特別なハードウェアが不要</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>○</TD
></TR
><TR
><TD
>複数のマスタサーバが可能</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>○</TD
></TR
><TR
><TD
>マスタサーバにオーバヘッドがない</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
></TR
><TR
><TD
>複数のスレーブサーバを待たない</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
><TD
ALIGN="CENTER"
>同期が無効の場合</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
></TR
><TR
><TD
>マスタの故障によるデータ損失がない</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>同期が有効の場合</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
><TD
ALIGN="CENTER"
>○</TD
></TR
><TR
><TD
>スタンバイは読み取り問い合わせだけを受理</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
><TD
ALIGN="CENTER"
>ホットスタンバイ使用時</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>○</TD
></TR
><TR
><TD
>テーブルごとの粒度となる</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>○</TD
></TR
><TR
><TD
>コンフリクトの回避が不要</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>○</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
><TD
ALIGN="CENTER"
>&nbsp;</TD
><TD
ALIGN="CENTER"
>○</TD
></TR
></TBODY
></TABLE
></DIV
><P
>上の分類に該当しない解法もあります。
 </P
><P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
>データの分割</DT
><DD
><P
>データの分割とは、同じテーブルのデータを複数部分に分けることです。
各部分に書き込むことができるのは、1つのサーバだけです。
例えば、データをロンドンとパリの営業所用に分割でき、サーバをロンドンとパリのどちらにも設置できた状態を考えます。
問い合わせにロンドンとパリのデータが混在した場合、アプリケーションは両方のサーバに問い合わせることができます。
または、マスタスタンバイレプリケーションを使用して、他の営業所のデータを読み取り専用コピーとして保持できます。
    </P
></DD
><DT
>複数サーバによる問い合わせの並列実行</DT
><DD
><P
>上述した多くの解法は、複数のサーバが複数の問い合わせを処理するものです。
処理速度の向上のために、単一の問い合わせに複数のサーバを使用するものはありません。
本解法は複数のサーバが単一の問い合わせを共同して実行するものです。
その方法は、データをサーバ間で分割し、各サーバが部分的に問い合わせを実行し、各々の結果をプライマリサーバに送付し、プライマリサーバが合体して利用者に返送するものです。
<SPAN
CLASS="PRODUCTNAME"
>Pgpool-II</SPAN
>はこの性能を持っています。
また、<SPAN
CLASS="PRODUCTNAME"
>PL/Proxy</SPAN
>ツールセットを使用して実装できます。
    </P
></DD
></DL
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="high-availability.html"
ACCESSKEY="P"
>前のページ</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>ホーム</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="warm-standby.html"
ACCESSKEY="N"
>次のページ</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>高可用性、負荷分散およびレプリケーション</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="high-availability.html"
ACCESSKEY="U"
>上に戻る</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>ログシッピングスタンバイサーバ</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>