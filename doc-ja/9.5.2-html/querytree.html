<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>問い合わせツリーとは</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REV="MADE"
HREF="mailto:pgsql-docs@postgresql.org"><LINK
REL="HOME"
TITLE="PostgreSQL 9.5.2文書"
HREF="index.html"><LINK
REL="UP"
TITLE="ルールシステム"
HREF="rules.html"><LINK
REL="PREVIOUS"
TITLE="ルールシステム"
HREF="rules.html"><LINK
REL="NEXT"
TITLE="ビューとルールシステム"
HREF="rules-views.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="stylesheet.css"><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=utf-8"><META
NAME="creation"
CONTENT="2016-05-13T05:09:04"></HEAD
><BODY
CLASS="SECT1"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="4"
ALIGN="center"
VALIGN="bottom"
><A
HREF="index.html"
>PostgreSQL 9.5.2文書</A
></TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="ルールシステム"
HREF="rules.html"
ACCESSKEY="P"
>前のページ</A
></TD
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
HREF="rules.html"
ACCESSKEY="U"
>上に戻る</A
></TD
><TD
WIDTH="60%"
ALIGN="center"
VALIGN="bottom"
>第 38章ルールシステム</TD
><TD
WIDTH="20%"
ALIGN="right"
VALIGN="top"
><A
TITLE="ビューとルールシステム"
HREF="rules-views.html"
ACCESSKEY="N"
>次のページ</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="QUERYTREE"
>38.1. 問い合わせツリーとは</A
></H1
><P
>どのようにルールシステムが機能するかを理解するためには、ルールがどのように起動され、その入力と結果は何かを理解しなければなりません。</P
><P
>ルールシステムは問い合わせパーサとプランナの中間に位置します。
ルールシステムは、入力としてパーサの出力、単一の問い合わせツリー、および何らかの特別な情報を持つ問い合わせツリーでもあるユーザ定義の書き換えルールを取り、結果として0個以上の問い合わせツリーを生成します。
ルールシステムの入力と出力は常にパーサ自体でも生成することができるもので、参照する対象は基本的に<ACRONYM
CLASS="ACRONYM"
>SQL</ACRONYM
>文として表現できるものです。</P
><P
>では問い合わせツリーとは何でしょうか。
それは、<ACRONYM
CLASS="ACRONYM"
>SQL</ACRONYM
>文を構成する個々の部品を別々に記憶した、<ACRONYM
CLASS="ACRONYM"
>SQL</ACRONYM
>文の内部表現です。
<TT
CLASS="VARNAME"
>debug_print_parse</TT
>、<TT
CLASS="VARNAME"
>debug_print_rewritten</TT
>、もしくは<TT
CLASS="VARNAME"
>debug_print_plan</TT
>設定パラメータを設定していれば、サーバログ内で問い合わせツリーを見ることができます。
ルールアクションも<TT
CLASS="STRUCTNAME"
>pg_rewrite</TT
>システムカタログ内に問い合わせツリーとして格納されています。
これはログ出力のように整形されていませんが、まったく同じ情報を持っています。</P
><P
>問い合わせツリーそのものを読むためにはある程度の経験が必要です。
ルールシステムを理解するためには問い合わせツリーの<ACRONYM
CLASS="ACRONYM"
>SQL</ACRONYM
>表現で十分ですので、ここではその読み方までは教えません。</P
><P
>本章の問い合わせツリーの<ACRONYM
CLASS="ACRONYM"
>SQL</ACRONYM
>表現形式を読む時に必要なのは、問い合わせツリー構造の中に分解された、ある文の部品を識別できることです。
問い合わせツリーには以下の部品があります。

<P
></P
></P><DIV
CLASS="VARIABLELIST"
><DL
><DT
>コマンド種類</DT
><DD
><P
>これはどのコマンド（<TT
CLASS="COMMAND"
>SELECT</TT
>、<TT
CLASS="COMMAND"
>INSERT</TT
>、<TT
CLASS="COMMAND"
>UPDATE</TT
>、<TT
CLASS="COMMAND"
>DELETE</TT
>）が構文解析ツリーを作ったかを示す単純な値です。
    </P
></DD
><DT
>範囲テーブル
      </DT
><DD
><P
>範囲テーブルは問い合わせで使われるリレーションのリストです。
<TT
CLASS="COMMAND"
>SELECT</TT
>文ではこれは<TT
CLASS="LITERAL"
>FROM</TT
>キーワードの後で与えられるリレーションになります。
    </P
><P
>範囲テーブルのそれぞれの項目はテーブルもしくはビューを識別し、問い合わせの別の部品ではどんな名前で呼び出されるかを示します。
問い合わせツリーでは範囲テーブルの項目は名前よりも番号で参照されることが多いため、ここでは<ACRONYM
CLASS="ACRONYM"
>SQL</ACRONYM
>文とは違い、重複する名前があるかということは問題になりません。
これはルールの範囲テーブルがマージされた後に起こる可能性があります。
本章の例ではその状況を含んでいません。
    </P
></DD
><DT
>結果リレーション</DT
><DD
><P
>問い合わせの結果が格納されるリレーションを識別する範囲テーブルへのインデックスです。
    </P
><P
><TT
CLASS="COMMAND"
>SELECT</TT
>問い合わせは結果リレーションを持ちません。
（<TT
CLASS="COMMAND"
>SELECT INTO</TT
>の場合は特別ですが、<TT
CLASS="LITERAL"
>INSERT ... SELECT</TT
>が付いた<TT
CLASS="COMMAND"
>CREATE TABLE</TT
>とほぼ同じですので、ここでは個別には説明しません。）
    </P
><P
><TT
CLASS="COMMAND"
>INSERT</TT
>、<TT
CLASS="COMMAND"
>UPDATE</TT
>、<TT
CLASS="COMMAND"
>DELETE</TT
>コマンドでは、結果リレーションは変更が有効になるテーブル（もしくはビュー）です。
    </P
></DD
><DT
>目的リスト
    </DT
><DD
><P
>目的リストは問い合わせの結果を定義する式のリストです。
<TT
CLASS="COMMAND"
>SELECT</TT
>の場合、この式は問い合わせの最終結果を構築するものです。
これらは<TT
CLASS="COMMAND"
>SELECT</TT
>と<TT
CLASS="COMMAND"
>FROM</TT
>キーワードの間にある式に対応します
（<TT
CLASS="LITERAL"
>*</TT
>は単にリレーションの全ての列名の省略です。
これはパーサによって個別の列に展開されますので、ルールシステムが見ることはありません）。
    </P
><P
><TT
CLASS="COMMAND"
>DELETE</TT
>コマンドは結果を返しませんので、通常の目的リストは必要ありません。
その代わり、ルールシステムは空の目的リストに特別な<ACRONYM
CLASS="ACRONYM"
>CTID</ACRONYM
>項目を追加し、エクゼキュータが削除すべき行を見つけられるようにします。
（<ACRONYM
CLASS="ACRONYM"
>CTID</ACRONYM
>は結果リレーションが通常のテーブルの場合に追加されます。
もしビューであれば<A
HREF="rules-views.html#RULES-VIEWS-UPDATE"
>項38.2.4</A
>で述べるように、代わりに行全体の変数が追加されます。）
    </P
><P
><TT
CLASS="COMMAND"
>INSERT</TT
>問い合わせでは、目的リストは結果リレーションへ入る新規の行を示します。
これは<TT
CLASS="LITERAL"
>VALUES</TT
>句か<TT
CLASS="LITERAL"
>INSERT ... SELECT</TT
>の中の<TT
CLASS="COMMAND"
>SELECT</TT
>句の式です。
書き換え処理の最初のステップでは、元の問い合わせでは割り当てられず、デフォルト値となっている列の目的リストの項目を追加します。
残った列（値が与えられていない列、かつデフォルト値を持たない列）は全て、プランナによって定数NULL式で埋められます。
    </P
><P
><TT
CLASS="COMMAND"
>UPDATE</TT
>コマンドでは、目的リストは古いものを置き換えるべき新しい行を示します。
ルールシステムではコマンド内の<TT
CLASS="LITERAL"
>SET column = expression</TT
>部分にある式だけを持っています。
プランナは、古い行から新しい行へ値をコピーする式を挿入することにより、抜けている列を処理します。
<TT
CLASS="COMMAND"
>DELETE</TT
>の場合と同様、エクゼキュータが更新すべき行を見つけられるように、ルールシステムは<ACRONYM
CLASS="ACRONYM"
>CTID</ACRONYM
>もしくは行全体の変数を追加します。
    </P
><P
>目的リストの各項目は、定数値、範囲テーブル内のリレーション中の1つの列を指し示す変数、パラメータ等の式を保持するか、または、関数呼び出し、定数、変数、演算子などにより作られた式のツリーを保持します。
    </P
></DD
><DT
>条件</DT
><DD
><P
>問い合わせの条件は目的リストの項目に含まれている式によく似た式です。
この式の結果は、最終的な結果の行を得るための（<TT
CLASS="COMMAND"
>INSERT</TT
>、<TT
CLASS="COMMAND"
>UPDATE</TT
>、<TT
CLASS="COMMAND"
>DELETE</TT
>または<TT
CLASS="COMMAND"
>SELECT</TT
>）演算を実行すべきかどうかを示すブール値です。
それは<ACRONYM
CLASS="ACRONYM"
>SQL</ACRONYM
>文の中の<TT
CLASS="LITERAL"
>WHERE</TT
>句に対応します。
    </P
></DD
><DT
>結合ツリー</DT
><DD
><P
>問い合わせの結合ツリーは<TT
CLASS="LITERAL"
>FROM</TT
>句の構造を表します。
<TT
CLASS="LITERAL"
>SELECT ... FROM a, b, c</TT
>のような単純な問い合わせでは、結合ツリーは単なる<TT
CLASS="LITERAL"
>FROM</TT
>項目のリストです。
なぜならこれらはどんな順番で結合しても構わないためです。
しかし<TT
CLASS="LITERAL"
>JOIN</TT
>式、特に外部結合が使われた場合は、その結合が示す順番通りに結合しなければいけません。
この場合結合ツリーは<TT
CLASS="LITERAL"
>JOIN</TT
>式の構造を表します。
特定の<TT
CLASS="LITERAL"
>JOIN</TT
>句と関連付けられた制約（<TT
CLASS="LITERAL"
>ON</TT
>もしくは<TT
CLASS="LITERAL"
>USING</TT
>式からのもの）はこれらの結合ツリーノードに付加された条件として格納されます。
頂点レベルの<TT
CLASS="LITERAL"
>WHERE</TT
>式を頂点レベルの結合ツリー項目に付加された条件として格納することも便利です。
ですから、結合ツリーは<TT
CLASS="COMMAND"
>SELECT</TT
>の<TT
CLASS="LITERAL"
>FROM</TT
>句と<TT
CLASS="LITERAL"
>WHERE</TT
>句の両方を表しているわけです。
    </P
></DD
><DT
>その他</DT
><DD
><P
><TT
CLASS="LITERAL"
>ORDER BY</TT
>句のような、問い合わせツリーのその他の部品は、ここでは取り上げません。
ルールシステムはルールを適用している時にそこで項目を入れ替えることもありますが、これはルールシステムの基本とはあまり関係しません。
    </P
></DD
></DL
></DIV
><P></P
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="rules.html"
ACCESSKEY="P"
>前のページ</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>ホーム</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="rules-views.html"
ACCESSKEY="N"
>次のページ</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>ルールシステム</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="rules.html"
ACCESSKEY="U"
>上に戻る</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>ビューとルールシステム</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>