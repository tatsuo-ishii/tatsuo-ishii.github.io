<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>SSLによる安全なTCP/IP接続</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REV="MADE"
HREF="mailto:pgsql-docs@postgresql.org"><LINK
REL="HOME"
TITLE="PostgreSQL 9.6.5文書"
HREF="index.html"><LINK
REL="UP"
TITLE="サーバの準備と運用"
HREF="runtime.html"><LINK
REL="PREVIOUS"
TITLE="暗号化オプション"
HREF="encryption-options.html"><LINK
REL="NEXT"
TITLE="SSHトンネルを使った安全なTCP/IP接続"
HREF="ssh-tunnels.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="stylesheet.css"><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=utf-8"><META
NAME="creation"
CONTENT="2018-02-10T07:29:51"></HEAD
><BODY
CLASS="SECT1"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="4"
ALIGN="center"
VALIGN="bottom"
><A
HREF="index.html"
>PostgreSQL 9.6.5文書</A
></TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="暗号化オプション"
HREF="encryption-options.html"
ACCESSKEY="P"
>前のページ</A
></TD
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
HREF="runtime.html"
ACCESSKEY="U"
>上に戻る</A
></TD
><TD
WIDTH="60%"
ALIGN="center"
VALIGN="bottom"
>第 18章サーバの準備と運用</TD
><TD
WIDTH="20%"
ALIGN="right"
VALIGN="top"
><A
TITLE="SSHトンネルを使った安全なTCP/IP接続"
HREF="ssh-tunnels.html"
ACCESSKEY="N"
>次のページ</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="SSL-TCP"
>18.9. SSLによる安全なTCP/IP接続</A
></H1
><P
><SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>は標準で<ACRONYM
CLASS="ACRONYM"
>SSL</ACRONYM
>接続をサポートし、クライアント/サーバの通信がさらに安全になるよう暗号化します。
そのためには<SPAN
CLASS="PRODUCTNAME"
>OpenSSL</SPAN
>がクライアントとサーバシステムの両方にインストールされ、構築時に<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>におけるそのサポートが有効になっている必要があります（<A
HREF="installation.html"
>第16章</A
>を参照してください）。
  </P
><P
><ACRONYM
CLASS="ACRONYM"
>SSL</ACRONYM
>サポートを有効にしてコンパイルされた場合、<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>サーバは、<TT
CLASS="FILENAME"
>postgresql.conf</TT
>において<A
HREF="runtime-config-connection.html#GUC-SSL"
>ssl</A
>パラメータを<TT
CLASS="LITERAL"
>on</TT
>にすることで、<ACRONYM
CLASS="ACRONYM"
>SSL</ACRONYM
>サポートを有効にして起動することができます。
サーバは同じTCPポートで通常の接続と<ACRONYM
CLASS="ACRONYM"
>SSL</ACRONYM
>接続の両方を待ち受け、クライアントとの接続に<ACRONYM
CLASS="ACRONYM"
>SSL</ACRONYM
>を使用するかどうかを調停します。
デフォルトでは、これはクライアント側の選択肢です。
一部またはすべての接続で<ACRONYM
CLASS="ACRONYM"
>SSL</ACRONYM
>の使用を必要とさせるためのサーバ側の設定方法に関しては<A
HREF="auth-pg-hba-conf.html"
>項20.1</A
>を参照してください。
  </P
><P
><SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>は、システム全体用の<SPAN
CLASS="PRODUCTNAME"
>OpenSSL</SPAN
>設定ファイルを読み取ります。
デフォルトでは、このファイルの名前は<TT
CLASS="FILENAME"
>openssl.cnf</TT
>であり、<TT
CLASS="LITERAL"
>openssl version -d</TT
>で報告されるディレクトリに存在します。
このデフォルトは、環境変数<TT
CLASS="ENVAR"
>OPENSSL_CONF</TT
>を希望する設定ファイルの名前に設定することにより変更可能です。
  </P
><P
><SPAN
CLASS="PRODUCTNAME"
>OpenSSL</SPAN
>は、強度が異なる、多くの暗号化および認証用のアルゴリズムをサポートします。
暗号の一覧は<SPAN
CLASS="PRODUCTNAME"
>OpenSSL</SPAN
>設定ファイル内で指定することができますが、<TT
CLASS="FILENAME"
>postgresql.conf</TT
>内の<A
HREF="runtime-config-connection.html#GUC-SSL-CIPHERS"
>ssl_ciphers</A
>を変更することで、データベースサーバで使用される暗号を指定することができます。
  </P
><DIV
CLASS="NOTE"
><BLOCKQUOTE
CLASS="NOTE"
><P
><B
>注意: </B
><TT
CLASS="LITERAL"
>NULL-SHA</TT
>または<TT
CLASS="LITERAL"
>NULL-MD5</TT
>暗号を使用して暗号化のオーバーヘッドなしで認証を行うことが可能です。
しかし、中間者はクライアントサーバ間の通信を読み取り中継することができます。
また、暗号化のオーバーヘッドは認証のオーバーヘッドと比べると最小です。
こうした理由によりNULL暗号は推奨しません。
   </P
></BLOCKQUOTE
></DIV
><P
><ACRONYM
CLASS="ACRONYM"
>SSL</ACRONYM
>モードで起動するには、サーバ証明書と秘密鍵を含むファイルが存在していなければなりません。
デフォルトでは、これらのファイルは<TT
CLASS="FILENAME"
>server.crt</TT
>および<TT
CLASS="FILENAME"
>server.key</TT
>という名前で、それぞれがサーバのデータディレクトリに存在していることが想定されていますが、設定パラメータの<A
HREF="runtime-config-connection.html#GUC-SSL-CERT-FILE"
>ssl_cert_file</A
>と<A
HREF="runtime-config-connection.html#GUC-SSL-KEY-FILE"
>ssl_key_file</A
>によって他の名前、他の場所を指定することもできます。
  </P
><P
>Unixシステムでは、<TT
CLASS="FILENAME"
>server.key</TT
>の権限は所有者以外からのアクセスを許可してはなりません。
これは<TT
CLASS="COMMAND"
>chmod 0600 server.key</TT
>というコマンドで実現できます。
あるいは、このファイルの所有者をrootにして、グループに読み取りアクセス権を与える（つまり、パーミッションを<TT
CLASS="LITERAL"
>0640</TT
>にする）ということもできます。
この設定は、証明書と鍵ファイルがオペレーティングシステムによって管理されるインストレーションのためのものです。
<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>サーバを実行するユーザは、証明書と鍵ファイルにアクセス権のあるグループのメンバーにする必要があります。
  </P
><P
>秘密キーがパスフレーズで保護されている場合、サーバはパスフレーズの入力を促し、入力されるまでは起動しません。
  </P
><P
>サーバ証明書がクライアントで直接信頼している認証局ではなく、<SPAN
CLASS="QUOTE"
>"中間"</SPAN
>認証局により署名されている場合があります。
こうした証明書を使用するために、<TT
CLASS="FILENAME"
>server.crt</TT
>ファイルに署名した認証局の証明書を追加し、その後、クライアントが信頼しているルートまたは中間までの認証局証明書を追加します。クライアントが信頼しているとは、クライアントにある<TT
CLASS="FILENAME"
>root.crt</TT
>ファイルの認証局による署名がある証明書です。
  </P
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="SSL-CLIENT-CERTIFICATES"
>18.9.1. クライアント証明書の使用</A
></H2
><P
>クライアントに信頼できる証明書を要求するためには、信頼する認証局（<ACRONYM
CLASS="ACRONYM"
>CA</ACRONYM
>）の証明書をデータディレクトリ内の<TT
CLASS="FILENAME"
>root.crt</TT
>ファイルに置き、<TT
CLASS="FILENAME"
>postgresql.conf</TT
>の<A
HREF="runtime-config-connection.html#GUC-SSL-CA-FILE"
>ssl_ca_file</A
>パラメータを<TT
CLASS="LITERAL"
>root.crt</TT
>に設定し、認証オプション<TT
CLASS="LITERAL"
>clientcert=1</TT
>を<TT
CLASS="FILENAME"
>pg_hba.conf</TT
>の適切な<TT
CLASS="LITERAL"
>hostssl</TT
>行に追加します。
そうすると、SSL接続の開始時にクライアントへ証明書が要求されます。
（クライアント上での証明書の設定方法については<A
HREF="libpq-ssl.html"
>項32.18</A
>を参照してください。）
サーバは、クライアントの証明書が信頼する認証局のいずれかにより署名されていることを検証します。
  </P
><P
>   
中間<ACRONYM
CLASS="ACRONYM"
>CA</ACRONYM
>が<TT
CLASS="FILENAME"
>root.crt</TT
>に記載されている場合、ファイルにはルート<ACRONYM
CLASS="ACRONYM"
>CA</ACRONYM
>までの証明書チェーンが含まれている必要があります。
<A
HREF="runtime-config-connection.html#GUC-SSL-CRL-FILE"
>ssl_crl_file</A
>パラメータが設定されている場合、証明書失効リスト（CRL）項目も検査されます。
（SSL証明書の使用方法を示す図については<A
HREF="http://h71000.www7.hp.com/doc/83final/ba554_90007/ch04s02.html"
TARGET="_top"
>http://h71000.www7.hp.com/doc/83final/ba554_90007/ch04s02.html</A
>を参照してください。）
  </P
><P
>認証オプション<TT
CLASS="LITERAL"
>clientcert</TT
>はすべての認証方式について利用可能ですが、<TT
CLASS="FILENAME"
>pg_hba.conf</TT
>の<TT
CLASS="LITERAL"
>hostssl</TT
>として指定された行でのみ有効です。
<TT
CLASS="LITERAL"
>clientcert</TT
>が指定されていない、または0と設定されている場合でも、認証局のリストが設定されていれば、サーバはその認証局に対してクライアント証明書の検証を行いますが、クライアント証明書を提示することを要求しません。
  </P
><P
>サーバの<TT
CLASS="FILENAME"
>root.crt</TT
>は、クライアント証明書の署名に対して信頼できるとみなしている最上位のCAを列挙していることに注意してください。
原理的には、サーバの証明書を署名したCAを列挙する必要はありませんが、ほとんどの場合、そのCAはクライアント証明書でも信頼されています。
  </P
><P
>クライアント証明書を設定している場合、接続の安全性を提供するとともに証明書でユーザ認証を制御できるように<TT
CLASS="LITERAL"
>cert</TT
>認証方式を使用したいと考えるかもしれません。
詳細については<A
HREF="auth-methods.html#AUTH-CERT"
>項20.3.9</A
>を参照してください。
（<TT
CLASS="LITERAL"
>cert</TT
>認証方式を使用している場合は、明示的に<TT
CLASS="LITERAL"
>clientcert=1</TT
>を指定する必要はありません。）
  </P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="SSL-SERVER-FILES"
>18.9.2. サーバにおけるSSL関連ファイルの利用</A
></H2
><P
><A
HREF="ssl-tcp.html#SSL-FILE-USAGE"
>表18-2</A
>にて、サーバにおけるSSLの設定に関連するファイルをまとめます。
（表示されているファイル名はデフォルトまたは一般的な名前です。異なる名前を個別に設定することもできます。）
   </P
><DIV
CLASS="TABLE"
><A
NAME="SSL-FILE-USAGE"
></A
><P
><B
>表 18-2. SSLサーバファイルの使用方法</B
></P
><TABLE
BORDER="1"
CLASS="CALSTABLE"
><COL><COL><COL><THEAD
><TR
><TH
>ファイル</TH
><TH
>内容</TH
><TH
>影響</TH
></TR
></THEAD
><TBODY
><TR
><TD
><A
HREF="runtime-config-connection.html#GUC-SSL-CERT-FILE"
>ssl_cert_file</A
> (<TT
CLASS="FILENAME"
>$PGDATA/server.crt</TT
>)</TD
><TD
>サーバ証明書</TD
><TD
>サーバの身元を示すためにクライアントに送信します</TD
></TR
><TR
><TD
><A
HREF="runtime-config-connection.html#GUC-SSL-KEY-FILE"
>ssl_key_file</A
> (<TT
CLASS="FILENAME"
>$PGDATA/server.key</TT
>)</TD
><TD
>サーバの秘密キー</TD
><TD
>サーバ証明書が所有者によって送られたことを証明します。証明書所有者が信頼できることを意味しません。</TD
></TR
><TR
><TD
><A
HREF="runtime-config-connection.html#GUC-SSL-CA-FILE"
>ssl_ca_file</A
> (<TT
CLASS="FILENAME"
>$PGDATA/root.crt</TT
>)</TD
><TD
>信頼できる認証局</TD
><TD
>信頼する認証局により署名されたクライアント証明書か検査します。</TD
></TR
><TR
><TD
><A
HREF="runtime-config-connection.html#GUC-SSL-CRL-FILE"
>ssl_crl_file</A
> (<TT
CLASS="FILENAME"
>$PGDATA/root.crl</TT
>)</TD
><TD
>認証局により失効された証明書</TD
><TD
>クライアント証明書はこの一覧にあってはいけません。</TD
></TR
></TBODY
></TABLE
></DIV
><P
><TT
CLASS="FILENAME"
>server.key</TT
>、<TT
CLASS="FILENAME"
>server.crt</TT
>、<TT
CLASS="FILENAME"
>root.crt</TT
>、<TT
CLASS="FILENAME"
>root.crl</TT
>ファイル（またはその他の設定されたファイル名）は、サーバ起動時にのみ検査されます。
ですので、これらのファイルの変更を有効にするためにはサーバを再起動する必要があります。
   </P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="SSL-CERTIFICATE-CREATION"
>18.9.3. 自己署名証明書の作成</A
></H2
><P
>サーバ用の自己署名証明書を簡単に作るためには下記の<SPAN
CLASS="PRODUCTNAME"
>OpenSSL</SPAN
>コマンドを使ってください。
</P><PRE
CLASS="PROGRAMLISTING"
>openssl req -new -text -out server.req</PRE
><P>
<SPAN
CLASS="APPLICATION"
>openssl</SPAN
>から出される質問に答えてください。
この時、<SPAN
CLASS="QUOTE"
>"Common Name"</SPAN
>には確実にローカルホスト名を入力してください。
チャレンジパスワードは空白でも構いません。
このプログラムはパスフレーズで保護されたキーを生成しますが、4文字以下のパスフレーズは認められません。
パスフレーズを削除するためには（サーバの自動起動を行いたいのであれば）、下記のコマンドを実行してください。
</P><PRE
CLASS="PROGRAMLISTING"
>openssl rsa -in privkey.pem -out server.key
rm privkey.pem</PRE
><P>
既存のキーのロックを外すために、古いパスフレーズを入力します。
そして、下記を実行してください。
</P><PRE
CLASS="PROGRAMLISTING"
>openssl req -x509 -in server.req -text -key server.key -out server.crt</PRE
><P>
このように、証明書を自己署名の証明書にして、キーと証明書とをサーバが検索する場所にコピーします。
サーバは、もしこのファイルがこれよりもゆるい権限の場合拒否するので、最後に以下を行います。
</P><PRE
CLASS="PROGRAMLISTING"
>chmod og-rwx server.key</PRE
><P>
サーバの秘密キーおよび証明書を作成するための詳しい方法については<SPAN
CLASS="PRODUCTNAME"
>OpenSSL</SPAN
>の文書を参照してください。
   </P
><P
>自己署名証明書を試験のために使用することはできますが、クライアントがサーバの身元を検証できるように、運用時は（グローバルな<ACRONYM
CLASS="ACRONYM"
>CA</ACRONYM
>の1つまたはローカルな認証局のいずれかの）認証局（<ACRONYM
CLASS="ACRONYM"
>CA</ACRONYM
>）により署名された証明書を使用すべきです。
もしすべてのクライアントが組織においてローカルであれば、ローカル<ACRONYM
CLASS="ACRONYM"
>CA</ACRONYM
>の使用が推奨されます。
   </P
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="encryption-options.html"
ACCESSKEY="P"
>前のページ</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>ホーム</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="ssh-tunnels.html"
ACCESSKEY="N"
>次のページ</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>暗号化オプション</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="runtime.html"
ACCESSKEY="U"
>上に戻る</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><SPAN
CLASS="APPLICATION"
>SSH</SPAN
>トンネルを使った安全なTCP/IP接続</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>