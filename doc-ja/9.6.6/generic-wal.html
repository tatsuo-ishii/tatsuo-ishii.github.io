<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>汎用WALレコード</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REV="MADE"
HREF="mailto:pgsql-docs@postgresql.org"><LINK
REL="HOME"
TITLE="PostgreSQL 9.6.5文書"
HREF="index.html"><LINK
REL="UP"
TITLE="内部情報"
HREF="internals.html"><LINK
REL="PREVIOUS"
TITLE="インデックスコスト推定関数"
HREF="index-cost-estimation.html"><LINK
REL="NEXT"
TITLE="GiSTインデックス"
HREF="gist.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="stylesheet.css"><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=utf-8"><META
NAME="creation"
CONTENT="2018-02-10T07:29:51"></HEAD
><BODY
CLASS="CHAPTER"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="4"
ALIGN="center"
VALIGN="bottom"
><A
HREF="index.html"
>PostgreSQL 9.6.5文書</A
></TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="インデックスコスト推定関数"
HREF="index-cost-estimation.html"
ACCESSKEY="P"
>前のページ</A
></TD
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
HREF="internals.html"
ACCESSKEY="U"
>上に戻る</A
></TD
><TD
WIDTH="60%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="20%"
ALIGN="right"
VALIGN="top"
><A
TITLE="GiSTインデックス"
HREF="gist.html"
ACCESSKEY="N"
>次のページ</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="CHAPTER"
><H1
><A
NAME="GENERIC-WAL"
></A
>第 60章汎用WALレコード</H1
><P
>組み込みのWALにログを書き込むすべてのモジュールは、それぞれに独自の型のWALレコードがありますが、ページへの変更を汎用的な方法で記述する汎用WALレコード型もあります。
カスタムアクセスメソッドを提供する拡張では、独自のWALの再実行(redo)ルーチンを登録できないため、汎用WALレコードが役立ちます。
  </P
><P
>汎用WALレコードを構築するためのAPIは<TT
CLASS="FILENAME"
>access/generic_xlog.h</TT
>に定義されており、<TT
CLASS="FILENAME"
>access/transam/generic_xlog.c</TT
>で実装されています。
  </P
><P
>汎用WALレコードの機能を使ってWAL書き込みを伴うデータ更新を行うには、以下の手順に従ってください。

   <P
></P
></P><OL
TYPE="1"
><LI
><P
><CODE
CLASS="FUNCTION"
>state = GenericXLogStart(relation)</CODE
> により、指定のリレーションについての汎用WALレコードの構築を開始します。
     </P
></LI
><LI
><P
><CODE
CLASS="FUNCTION"
>page = GenericXLogRegisterBuffer(state, buffer, flags)</CODE
> により、現在の汎用WALレコード内で更新されるバッファを登録します。
この関数はバッファページの一時コピーへのポインタを返すので、更新はそれに対して行ってください。
（バッファの内容は直接更新しないでください。）
3番目の引数は、操作についてのフラグのビットマスクです。
現在のところ、使用できるフラグは<TT
CLASS="LITERAL"
>GENERIC_XLOG_FULL_IMAGE</TT
>のみで、これはWALレコードには変更の差分ではなく、ページ全体のイメージが含まれることを示します。
典型的には、このフラグはページが新しいか、あるいは完全に書き換えられるときにセットされます。
WAL書き込み対象の動作が複数のページを更新する必要がある場合は、<CODE
CLASS="FUNCTION"
>GenericXLogRegisterBuffer</CODE
>を繰り返すことができます。
     </P
></LI
><LI
><P
>前の手順で取得したページのイメージに更新を適用する。
     </P
></LI
><LI
><P
><CODE
CLASS="FUNCTION"
>GenericXLogFinish(state)</CODE
>により、バッファの変更を適用し、汎用WALレコードを送出する。
     </P
></LI
></OL
><P>
  </P
><P
>WALレコードの構築は、上記の手順内の間のどこででも、<CODE
CLASS="FUNCTION"
>GenericXLogAbort(state)</CODE
>を呼び出すことで中止できます。
これによりページイメージのコピーに対する変更はすべて廃棄されます。
  </P
><P
>汎用WALレコードの機能を使うときは、以下の点に注意してください。

   <P
></P
></P><UL
><LI
><P
>バッファの直接更新は許されません！
すべての更新は<CODE
CLASS="FUNCTION"
>GenericXLogRegisterBuffer()</CODE
>で取得したコピーに対して行わなければなりません。
言い換えれば、汎用WALレコードを使うコードでは<CODE
CLASS="FUNCTION"
>BufferGetPage()</CODE
>を呼び出してはいけません。
しかし、適切なときにバッファにピンを立てる、外す、そしてロックする、解除するのが呼び出し側の責任であることに変わりはありません。
各ターゲットバッファの排他的ロックを<CODE
CLASS="FUNCTION"
>GenericXLogRegisterBuffer()</CODE
>の前から<CODE
CLASS="FUNCTION"
>GenericXLogFinish()</CODE
>の後まで保持していなければなりません。
     </P
></LI
><LI
><P
>手順2のバッファの登録と、手順3のページイメージの更新は自由に混在させることができます。
つまり、両方の手順を任意の順序で繰り返すことができます。
バッファの登録は、再生時にロックを取得する順序と同じにすべきであることを覚えていてください。
     </P
></LI
><LI
><P
>汎用WALレコードに登録できるバッファの最大数は<TT
CLASS="LITERAL"
>MAX_GENERIC_XLOG_PAGES</TT
>です。
この制限を超えるとエラーが発生します。
     </P
></LI
><LI
><P
>汎用WALでは、更新対象のページが標準的なレイアウトになっている、特に<TT
CLASS="STRUCTFIELD"
>pd_lower</TT
>と<TT
CLASS="STRUCTFIELD"
>pd_upper</TT
>の間には意味のあるデータがないということを想定しています。
     </P
></LI
><LI
><P
>ここではバッファページのコピーを更新するため、<CODE
CLASS="FUNCTION"
>GenericXLogStart()</CODE
>はクリティカルセクションを開始しません。
従って、<CODE
CLASS="FUNCTION"
>GenericXLogStart()</CODE
>と<CODE
CLASS="FUNCTION"
>GenericXLogFinish()</CODE
>の間では、メモリの割り当て、エラーの発生などを安全に実行できます。
唯一の本当のクリティカルセクションは<CODE
CLASS="FUNCTION"
>GenericXLogFinish()</CODE
>の内部にあります。
エラー終了の中で<CODE
CLASS="FUNCTION"
>GenericXLogAbort()</CODE
>を呼び出すことについても心配する必要はありません。
     </P
></LI
><LI
><P
><CODE
CLASS="FUNCTION"
>GenericXLogFinish()</CODE
>はバッファをダーティにして、LSNの設定をすることの処理をします。
これについて明示的な処理をする必要はありません。
     </P
></LI
><LI
><P
>ログを取らないリレーションは、実際のWALレコードが送出されないことを除けば、すべてが同じように動作します。
従って、通常は、ログを取らないリレーションについて明示的な検査をする必要はありません。
     </P
></LI
><LI
><P
>汎用WALを再生する機能は、バッファの排他的ロックを、バッファが登録されたのと同じ順序で取得します。
すべての変更を再生した後で、ロックは同じ順序で解放されます。
     </P
></LI
><LI
><P
>登録バッファに<TT
CLASS="LITERAL"
>GENERIC_XLOG_FULL_IMAGE</TT
>が指定されない場合、汎用WALレコードは古いページイメージと新しいページイメージの間の差分を含むものとされます。
この差分はバイト毎の比較に基づくものです。
これはデータをページ内で移動する場合、あまり小さくなりませんが、将来は改善されるかもしれません。
     </P
></LI
></UL
><P>
  </P
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="index-cost-estimation.html"
ACCESSKEY="P"
>前のページ</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>ホーム</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="gist.html"
ACCESSKEY="N"
>次のページ</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>インデックスコスト推定関数</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="internals.html"
ACCESSKEY="U"
>上に戻る</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>GiSTインデックス</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>