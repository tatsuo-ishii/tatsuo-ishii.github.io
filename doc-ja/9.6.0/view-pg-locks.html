<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>pg_locks</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REV="MADE"
HREF="mailto:pgsql-docs@postgresql.org"><LINK
REL="HOME"
TITLE="PostgreSQL 9.6.0文書"
HREF="index.html"><LINK
REL="UP"
TITLE="システムカタログ"
HREF="catalogs.html"><LINK
REL="PREVIOUS"
TITLE="pg_indexes"
HREF="view-pg-indexes.html"><LINK
REL="NEXT"
TITLE="pg_matviews"
HREF="view-pg-matviews.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="stylesheet.css"><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=utf-8"><META
NAME="creation"
CONTENT="2016-10-20T00:12:21"></HEAD
><BODY
CLASS="SECT1"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="4"
ALIGN="center"
VALIGN="bottom"
><A
HREF="index.html"
>PostgreSQL 9.6.0文書</A
></TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="pg_indexes"
HREF="view-pg-indexes.html"
ACCESSKEY="P"
>前のページ</A
></TD
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
HREF="catalogs.html"
ACCESSKEY="U"
>上に戻る</A
></TD
><TD
WIDTH="60%"
ALIGN="center"
VALIGN="bottom"
>第 50章システムカタログ</TD
><TD
WIDTH="20%"
ALIGN="right"
VALIGN="top"
><A
TITLE="pg_matviews"
HREF="view-pg-matviews.html"
ACCESSKEY="N"
>次のページ</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="VIEW-PG-LOCKS"
>50.65. <TT
CLASS="STRUCTNAME"
>pg_locks</TT
></A
></H1
><P
><TT
CLASS="STRUCTNAME"
>pg_locks</TT
>ビューはデータベースサーバ内で開いているトランザクションにより獲得されたロックに関する情報へのアクセスを提供します。
ロックに関するより詳細な説明は<A
HREF="mvcc.html"
>第13章</A
>を参照してください。
  </P
><P
><TT
CLASS="STRUCTNAME"
>pg_locks</TT
>にはロック対象となる進行中のオブジェクト、要求されたロックモード、および関連するトランザクション毎に1つの行を持ちます。
ですから、もし複数のトランザクションがそのトランザクション上でロックを保持していたりロックを待機している場合には、同じロック対象オブジェクトが数多く出現することがあります。
しかし現在ロックされていないオブジェクトはまったく現れません。
  </P
><P
>ロック対象オブジェクトには異なる型がいくつか存在します。
リレーション全体（例：テーブル）、リレーションの個別のページ、リレーションの個別のタプル、トランザクションID（仮想と永続の両方のID）、一般的なデータベースオブジェクト（これは<TT
CLASS="STRUCTNAME"
>pg_description</TT
>や<TT
CLASS="STRUCTNAME"
>pg_depend</TT
>と同様にクラスOIDとオブジェクトOIDで識別されます）。
さらに、リレーションを拡張する権利は、別のロック対象オブジェクトとして表現されます。
また<SPAN
CLASS="QUOTE"
>"勧告的"</SPAN
>ロックはユーザ定義の意味を持つ複数から形成されるかもしれません。
  </P
><DIV
CLASS="TABLE"
><A
NAME="AEN110743"
></A
><P
><B
>表 50-66. <TT
CLASS="STRUCTNAME"
>pg_locks</TT
>の列</B
></P
><TABLE
BORDER="1"
CLASS="CALSTABLE"
><COL><COL><COL><COL><THEAD
><TR
><TH
>名前</TH
><TH
>型</TH
><TH
>参照先</TH
><TH
>説明</TH
></TR
></THEAD
><TBODY
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>locktype</TT
></TD
><TD
><TT
CLASS="TYPE"
>text</TT
></TD
><TD
>&nbsp;</TD
><TD
>       ロック対象オブジェクトの種類。
       <TT
CLASS="LITERAL"
>relation</TT
>、
       <TT
CLASS="LITERAL"
>extend</TT
>、
       <TT
CLASS="LITERAL"
>page</TT
>、
       <TT
CLASS="LITERAL"
>tuple</TT
>、
       <TT
CLASS="LITERAL"
>transactionid</TT
>、
       <TT
CLASS="LITERAL"
>virtualxid</TT
>、
       <TT
CLASS="LITERAL"
>object</TT
>、
       <TT
CLASS="LITERAL"
>userlock</TT
>、
       <TT
CLASS="LITERAL"
>advisory</TT
>
      </TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>database</TT
></TD
><TD
><TT
CLASS="TYPE"
>oid</TT
></TD
><TD
><TT
CLASS="LITERAL"
><A
HREF="catalog-pg-database.html"
><TT
CLASS="STRUCTNAME"
>pg_database</TT
></A
>.oid</TT
></TD
><TD
>ロック対象が存在しているデータベースのOID。対象が共有オブジェクトの場合はゼロ。対象がトランザクションIDである場合はNULL。
      </TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>relation</TT
></TD
><TD
><TT
CLASS="TYPE"
>oid</TT
></TD
><TD
><TT
CLASS="LITERAL"
><A
HREF="catalog-pg-class.html"
><TT
CLASS="STRUCTNAME"
>pg_class</TT
></A
>.oid</TT
></TD
><TD
>ロックの対象となるリレーションのOID。対象がリレーションではない場合かリレーションの一部である場合はNULL。
      </TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>page</TT
></TD
><TD
><TT
CLASS="TYPE"
>integer</TT
></TD
><TD
>&nbsp;</TD
><TD
>ロックの対象となるリレーション内のページ番号。対象がタプルもしくはリレーションページではない場合はNULL。
      </TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>tuple</TT
></TD
><TD
><TT
CLASS="TYPE"
>smallint</TT
></TD
><TD
>&nbsp;</TD
><TD
>ページ内のロックの対象となっているタプル番号。対象がタプルではない場合はNULL。
      </TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>virtualxid</TT
></TD
><TD
><TT
CLASS="TYPE"
>text</TT
></TD
><TD
>&nbsp;</TD
><TD
>ロックの対象となるトランザクションの仮想ID。対象が仮想トランザクションIDではない場合はNULL。
      </TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>transactionid</TT
></TD
><TD
><TT
CLASS="TYPE"
>xid</TT
></TD
><TD
>&nbsp;</TD
><TD
>ロックの対象となるトランザクションのID。対象がトランザクションIDではない場合はNULL。
      </TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>classid</TT
></TD
><TD
><TT
CLASS="TYPE"
>oid</TT
></TD
><TD
><TT
CLASS="LITERAL"
><A
HREF="catalog-pg-class.html"
><TT
CLASS="STRUCTNAME"
>pg_class</TT
></A
>.oid</TT
></TD
><TD
>ロックの対象を含むシステムカタログのOID。対象が一般的なデータベースオブジェクトではない場合はNULL。
      </TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>objid</TT
></TD
><TD
><TT
CLASS="TYPE"
>oid</TT
></TD
><TD
>any OID column</TD
><TD
>システムカタログ内のロックの対象のOID。
対象が一般的なデータベースオブジェクトでない場合はNULL。
      </TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>objsubid</TT
></TD
><TD
><TT
CLASS="TYPE"
>smallint</TT
></TD
><TD
>&nbsp;</TD
><TD
>ロック対象の列番号（<TT
CLASS="STRUCTFIELD"
>classid</TT
>と<TT
CLASS="STRUCTFIELD"
>objid</TT
>はテーブル自身を参照します）、その他の一般的なデータベースオブジェクトではゼロ、一般的ではないデータベースオブジェクトではNULLです。
      </TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>virtualtransaction</TT
></TD
><TD
><TT
CLASS="TYPE"
>text</TT
></TD
><TD
>&nbsp;</TD
><TD
>      ロックを保持、もしくは待っている仮想トランザクションID。
      </TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>pid</TT
></TD
><TD
><TT
CLASS="TYPE"
>integer</TT
></TD
><TD
>&nbsp;</TD
><TD
>ロックを保持、もしくは待っているサーバプロセスのプロセスID。
ただしプリペアードトランザクションによりロックが保持されている場合はNULL。
      </TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>mode</TT
></TD
><TD
><TT
CLASS="TYPE"
>text</TT
></TD
><TD
>&nbsp;</TD
><TD
>このプロセスで保持または要求するロックモードの名称。
（<A
HREF="explicit-locking.html#LOCKING-TABLES"
>項13.3.1</A
> and <A
HREF="transaction-iso.html#XACT-SERIALIZABLE"
>項13.2.3</A
>参照）
      </TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>granted</TT
></TD
><TD
><TT
CLASS="TYPE"
>boolean</TT
></TD
><TD
>&nbsp;</TD
><TD
>ロックが保持されている場合は真、ロックが待ち状態の場合は偽</TD
></TR
><TR
><TD
><TT
CLASS="STRUCTFIELD"
>fastpath</TT
></TD
><TD
><TT
CLASS="TYPE"
>boolean</TT
></TD
><TD
>&nbsp;</TD
><TD
>      ファストパス経由でロックが獲得されている場合は真、メインロックテーブル経由で獲得されている場合は偽。
      </TD
></TR
></TBODY
></TABLE
></DIV
><P
>指定されたトランザクションにより所有されているロックを表す行内では<TT
CLASS="STRUCTFIELD"
>granted</TT
>は真です。
偽の場合はこのロックを獲得するため現在トランザクションが待機中であることを示しています。
つまり、同じロック対象のオブジェクトに対して何らかの他のトランザクションが競合するロックを獲得していることを意味します。
待機中のトランザクションはその別のトランザクションがロックを解放するまで活動を控えます。
（もしくはデッドロック状態が検出されることになります）。
単一トランザクションでは一度に多くても1つのロックを獲得するために待機します。 ★変更あり
  </P
><P
>すべてのトランザクションはそのすべての過程完了までその仮想トランザクションID上に排他的ロックをかけます。
もしある永続IDがトランザクションに割り当てられる（普通はトランザクションがデータベースの状態を変化させるときのみに発生します）と、トランザクションは終了するまで永続トランザクションIDに対して排他ロックを保持します。
あるトランザクションが他のトランザクションを特定して待機しなければならないと判断した場合、他とみなしたトランザクションのIDに対し共有ロックを獲得するように試み、目的を達します。
（仮想IDであるか永続IDであるかは、その状況によります）。
これは、他とみなしたトランザクションが完了し、そしてロックを解放した場合のみ成功します。 ★変更あり
  </P
><P
>タプルはロック対象のオブジェクト種類ですが、行レベルロックについての情報はメモリではなく、ディスクに保存されます。
よって行レベルロックは通常、このビューには現れません。
もしトランザクションが行レベルロックの待ち状態である場合は、その行ロックを保持している永続トランザクションIDを待つ状態で、そのトランザクションはビューに現れます。
  </P
><P
>勧告的ロックは、単一の<TT
CLASS="TYPE"
>bigint</TT
>値、または、2つの整数値をキーとして獲得することができます。
<TT
CLASS="TYPE"
>bigint</TT
>の場合は、その上位半分が<TT
CLASS="STRUCTFIELD"
>classid</TT
>列内に表示され、残りの下位半分は<TT
CLASS="STRUCTFIELD"
>objid</TT
>列内に表示されます。
また、<TT
CLASS="STRUCTFIELD"
>objsubid</TT
>は1となります。
元の<TT
CLASS="TYPE"
>bigint</TT
>値を<TT
CLASS="LITERAL"
>(classid::bigint &lt;&lt; 32) | objid::bigint</TT
>という式で再構成することができます。
整数値キーでは、最初のキーが<TT
CLASS="STRUCTFIELD"
>classid</TT
>列に、2番目のキーが<TT
CLASS="STRUCTFIELD"
>objid</TT
>列に表示され、<TT
CLASS="STRUCTFIELD"
>objsubid</TT
>は2となります。
キーの実際の意味はユーザに任されています。
勧告的ロックはデータベースに対して局所的ですので、勧告的ロックでは<TT
CLASS="STRUCTFIELD"
>database</TT
>列が意味を持ちます。
  </P
><P
><TT
CLASS="STRUCTNAME"
>pg_locks</TT
>は現行のデータベースに関連するロックのみならず、データベースクラスタ内のすべてのロックに関する全体的なビューを提供します。
<TT
CLASS="STRUCTFIELD"
>relation</TT
>列はロックされたリレーションを識別するために<TT
CLASS="STRUCTNAME"
>pg_class</TT
>.<TT
CLASS="STRUCTFIELD"
>oid</TT
>と結合することができますが、これは現行のデータベース内のリレーション（<TT
CLASS="STRUCTFIELD"
>database</TT
>列が現行のデータベースのOIDまたはゼロとなっているもの）に対してのみ正常に動作します。
  </P
><P
>ロック保持もしくは保持を待機しているセッションのさらなる情報を入手するため<A
HREF="monitoring-stats.html#PG-STAT-ACTIVITY-VIEW"
><TT
CLASS="STRUCTNAME"
>pg_stat_activity</TT
></A
>ビューの<TT
CLASS="STRUCTFIELD"
>pid</TT
>列と<TT
CLASS="STRUCTFIELD"
>pid</TT
>列を結合することができます。
例えば、このような感じです。
</P><PRE
CLASS="PROGRAMLISTING"
>SELECT * FROM pg_locks pl LEFT JOIN pg_stat_activity psa
    ON pl.pid = psa.pid;</PRE
><P>
また、プリペアードトランザクションを使用している場合には、ロックを保持しているプリペアードトランザクションに関してより多くの情報を得るため、<TT
CLASS="STRUCTFIELD"
>virtualtransaction</TT
>列は、<A
HREF="view-pg-prepared-xacts.html"
><TT
CLASS="STRUCTNAME"
>pg_prepared_xacts</TT
></A
>ビューの<TT
CLASS="STRUCTFIELD"
>transaction</TT
>列と結合することができます。
（プリペアードトランザクションはロックを待つことはありませんが、実行時に獲得したロックを保持し続けます。）
例えば、このような感じです。
</P><PRE
CLASS="PROGRAMLISTING"
>SELECT * FROM pg_locks pl LEFT JOIN pg_prepared_xacts ppx
    ON pl.virtualtransaction = '-1/' || ppx.transaction;</PRE
><P>
  </P
><P
>   While it is possible to obtain information about which processes block
   which other processes by joining <TT
CLASS="STRUCTNAME"
>pg_locks</TT
> against
   itself, this is very difficult to get right in detail.  Such a query would
   have to encode knowledge about which lock modes conflict with which
   others.  Worse, the <TT
CLASS="STRUCTNAME"
>pg_locks</TT
> view does not expose
   information about which processes are ahead of which others in lock wait
   queues, nor information about which processes are parallel workers running
   on behalf of which other client sessions.  It is better to use
   the <CODE
CLASS="FUNCTION"
>pg_blocking_pids()</CODE
> function
   (see <A
HREF="functions-info.html#FUNCTIONS-INFO-SESSION-TABLE"
>表9-59</A
>) to identify which
   process(es) a waiting process is blocked behind.
  </P
><P
><TT
CLASS="STRUCTNAME"
>pg_locks</TT
>ビューは、異なるシステムにおける、通常のロックマネージャと述部ロックマネージャの両方からのデータを表示します。
さらに通常のロックマネージャではロックを通常ロックと<I
CLASS="FIRSTTERM"
>近道</I
>ロックに細分化します。
このデータが完全に一貫性があることは保証されません。
ビューが問い合わせられると、近道ロック（<TT
CLASS="STRUCTFIELD"
>fastpath</TT
> = <TT
CLASS="LITERAL"
>true</TT
>が真）は、ロックマネージャ全体の状態を凍結することなく、各バックエンドからひとつひとつ収集されます。
このため情報収集期間中にロックが獲得されたり解放されたりされる可能性があります。
しかし、これらのロックはその時点で存在する他のロックと競合することがないことが分かっていることに注意してください。
近道ロックについてすべてのバックエンドを問い合わせた後、通常のロックマネージャの残りは１つの単位としてロックされ、残りすべてのロックの一貫性があるスナップショットを原子的な処理で収集します。
ロックマネージャのロックを解除した後、述部ロックマネージャは同様にロックされ、すべての述部ロックを原子的な処理で収集します。
このように、近道ロックという例外がありますが、各ロックマネージャは一貫性をもった結果セットを生成します。
しかし、両方のロックマネージャを同時にロックしませんので、通常のロックマネージャを問い合わせた後と述部ロックマネージャを問い合わせる前の間にロックが獲得されたり解放されたりされる可能性があります。
  </P
><P
>このビューが頻繁にアクセスされている場合は、通常もしくは述部ロックマネージャをロックするとデータベースのパフォーマンスに影響があります。
ロックマネージャからデータを取得するために、ロックは必要最低限の時間だけ保持されますが、パフォーマンスに影響がある可能性が全くないわけではありません。
  </P
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="view-pg-indexes.html"
ACCESSKEY="P"
>前のページ</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>ホーム</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="view-pg-matviews.html"
ACCESSKEY="N"
>次のページ</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><TT
CLASS="STRUCTNAME"
>pg_indexes</TT
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="catalogs.html"
ACCESSKEY="U"
>上に戻る</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><TT
CLASS="STRUCTNAME"
>pg_matviews</TT
></TD
></TR
></TABLE
></DIV
></BODY
></HTML
>