<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>SQLによるダンプ</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REV="MADE"
HREF="mailto:pgsql-docs@postgresql.org"><LINK
REL="HOME"
TITLE="PostgreSQL 9.6.0文書"
HREF="index.html"><LINK
REL="UP"
TITLE="バックアップとリストア"
HREF="backup.html"><LINK
REL="PREVIOUS"
TITLE="バックアップとリストア"
HREF="backup.html"><LINK
REL="NEXT"
TITLE="ファイルシステムレベルのバックアップ"
HREF="backup-file.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="stylesheet.css"><META
HTTP-EQUIV="Content-Type"
CONTENT="text/html; charset=utf-8"><META
NAME="creation"
CONTENT="2016-10-20T00:12:21"></HEAD
><BODY
CLASS="SECT1"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="4"
ALIGN="center"
VALIGN="bottom"
><A
HREF="index.html"
>PostgreSQL 9.6.0文書</A
></TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
TITLE="バックアップとリストア"
HREF="backup.html"
ACCESSKEY="P"
>前のページ</A
></TD
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="top"
><A
HREF="backup.html"
ACCESSKEY="U"
>上に戻る</A
></TD
><TD
WIDTH="60%"
ALIGN="center"
VALIGN="bottom"
>第 25章バックアップとリストア</TD
><TD
WIDTH="20%"
ALIGN="right"
VALIGN="top"
><A
TITLE="ファイルシステムレベルのバックアップ"
HREF="backup-file.html"
ACCESSKEY="N"
>次のページ</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="BACKUP-DUMP"
>25.1. <ACRONYM
CLASS="ACRONYM"
>SQL</ACRONYM
>によるダンプ</A
></H1
><P
>このダンプ方法の背景にはSQLコマンドでファイルを生成し、そのファイルをサーバが再度読み込みを行った時に、ダンプした時点と同じ状態が再構築されるという意図があります。
この目的のため、<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>は<A
HREF="app-pgdump.html"
>pg_dump</A
>ユーティリティプログラムを提供しています。
このコマンドの基本となる使い方は以下の通りです。
</P><PRE
CLASS="SYNOPSIS"
>pg_dump <TT
CLASS="REPLACEABLE"
><I
>dbname</I
></TT
> &gt; <TT
CLASS="REPLACEABLE"
><I
>outfile</I
></TT
></PRE
><P>
見てわかる通り、<SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>は結果を標準出力に書き出します。
これがどのように活用できるかをこれから説明します。
上記のコマンドはテキストファイルを作成しますが、<SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>は並列処理を可能にしたり、オブジェクトのリストアをより細かく制御できる他のフォーマットでファイルを作れます。
  </P
><P
><SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>は、<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>の通常のクライアントアプリケーションです（その中でも特に優れた機能を発揮するものですが）。
ということは、データベースに接続可能なあらゆるリモートホストからこのバックアップ手順を実行できます。
しかし、<SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>は特別な権限で実行される訳ではないことを忘れないでください。
特に、バックアップを行う全てのテーブルに対して読み取り権限が必要ですので、データベース全体のバックアップを実行する場合、ほとんど常にデータベースのスーパーユーザとして実行しなければなりません。
(もしデータベース全体のバックアップを取るのに十分な権限を持っていない場合には、<TT
CLASS="OPTION"
>-n <TT
CLASS="REPLACEABLE"
><I
>schema</I
></TT
></TT
>もしくは、<TT
CLASS="OPTION"
>-t <TT
CLASS="REPLACEABLE"
><I
>table</I
></TT
></TT
>のようなオプションを使って、データベースのアクセス権のある部分をバックアップできます。)
  </P
><P
><SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>を行うデータベースサーバを特定するにはコマンドラインの<TT
CLASS="OPTION"
>-h <TT
CLASS="REPLACEABLE"
><I
>host</I
></TT
></TT
>オプションと<TT
CLASS="OPTION"
>-p <TT
CLASS="REPLACEABLE"
><I
>port</I
></TT
></TT
>オプションを使用します。
デフォルトのホストはローカルホスト、または<TT
CLASS="ENVAR"
>PGHOST</TT
>環境変数で指定したものです。
同様に、デフォルトのポートは<TT
CLASS="ENVAR"
>PGPORT</TT
>環境変数で指定されているか、うまく行かない場合にはコンパイル時の設定がデフォルトとなります（そこはうまくできていて、サーバは通常コンパイル時の設定をデフォルトとします）。
  </P
><P
>他の<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>のクライアントアプリケーションのように、<SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>はデフォルトでオペレーティングシステムの現在のユーザ名と同じデータベースユーザ名で接続します。
これを書き換えるには<TT
CLASS="OPTION"
>-U</TT
>オプションを付けるか<TT
CLASS="ENVAR"
>PGUSER</TT
>環境変数を設定します。
<SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>の接続は（<A
HREF="client-authentication.html"
>第20章</A
>で説明されている）通常のクライアント認証方法によることを思い出してください。
  </P
><P
>後で述べる他のバックアップ手法に対する<SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>の重要な利点は、<SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>の出力は一般に新しいバージョンの<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>に再ロードできるということです。
一方、ファイルレベルのバックアップと継続的アーカイブは両方とも非常にサーバ、バージョン依存です。
<SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>は、32ビットから64ビットのサーバに移行するなどの異なるマシンアーキテクチャにデータベースを移す場合に上手くいく唯一の方法でもあります。
  </P
><P
><SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>で作成されたダンプは、内部的に整合性があります。
つまり、ダンプは<SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>が開始された際のデータベースのスナップショットを示しています。
<SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>の操作はデータベースに対する他の作業を妨げません（<TT
CLASS="COMMAND"
>ALTER TABLE</TT
>のほとんどの形態であるような排他的ロックが必要な作業は例外です）。
  </P
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="BACKUP-DUMP-RESTORE"
>25.1.1. ダンプのリストア</A
></H2
><P
><SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>で作成されたテキストファイルは<SPAN
CLASS="APPLICATION"
>psql</SPAN
>プログラムで読み込まれることを意図しています。
以下に、ダンプをリストアする一般的なコマンドを示します。
</P><PRE
CLASS="SYNOPSIS"
>psql <TT
CLASS="REPLACEABLE"
><I
>dbname</I
></TT
> &lt; <TT
CLASS="REPLACEABLE"
><I
>infile</I
></TT
></PRE
><P>
ここで<TT
CLASS="REPLACEABLE"
><I
>infile</I
></TT
>は<SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>コマンドにより出力されたファイルです。
<TT
CLASS="REPLACEABLE"
><I
>dbname</I
></TT
>データベースはこのコマンドでは作成されません。
（例えば<TT
CLASS="LITERAL"
>createdb -T template0 <TT
CLASS="REPLACEABLE"
><I
>dbname</I
></TT
></TT
> のようにして）<SPAN
CLASS="APPLICATION"
>psql</SPAN
>を実行する前に自分で<TT
CLASS="LITERAL"
>template0</TT
>から作成してください。
<SPAN
CLASS="APPLICATION"
>psql</SPAN
>は<SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>と似たような、接続データベースサーバと使用するユーザ名を指定するオプションに対応しています。
詳細については、<A
HREF="app-psql.html"
><SPAN
CLASS="APPLICATION"
>psql</SPAN
></A
>のリファレンスページを参照してください。
テキスト形式ではないダンプファイルは<A
HREF="app-pgrestore.html"
>pg_restore</A
> ユーティリティを使いリストアします。
   </P
><P
>SQLダンプのリストアを実行する前に、ダンプされたデータベース内のオブジェクトを所有するユーザやそのオブジェクト上に権限を与えられたユーザも存在しなければなりません。
存在していない場合、リストアはそのオブジェクトの元々の所有権や付与された権限を再作成することができません
（このようにしたい場合もあるでしょうが、通常そうではありません）。
   </P
><P
>デフォルトで<SPAN
CLASS="APPLICATION"
>psql</SPAN
>スクリプトは、SQLエラーが起きた後も実行を継続します。
<TT
CLASS="LITERAL"
>ON_ERROR_STOP</TT
>変数を設定して<SPAN
CLASS="APPLICATION"
>psql</SPAN
>を実行することで、その動作を変更し、SQLエラーが起きた場合に<SPAN
CLASS="APPLICATION"
>psql</SPAN
>が、終了ステータス3で終了するようにしたいと思うかもしれません。
</P><PRE
CLASS="PROGRAMLISTING"
>psql --set ON_ERROR_STOP=on dbname &lt; infile</PRE
><P>
どちらにしても、部分的にリストアされたデータベースにしかなりません。
他に、ダンプ全体を1つのトランザクションとしてリストアするように指定することができます。
こうすれば、リストアが完全に終わるか、完全にロールバックされるかのどちらかになります。
このモードは、<SPAN
CLASS="APPLICATION"
>psql</SPAN
>のコマンドラインオプションに<TT
CLASS="OPTION"
>-1</TT
>または<TT
CLASS="OPTION"
>--single-transaction</TT
>を渡すことで指定できます。
このモードを使用する場合、数時間かけて実行していたリストアが軽微なエラーでロールバックしてしまうことに注意してください。
しかし、部分的にリストアされたダンプから手作業で複雑なデータベースを整理するよりまだましかもしれません。
   </P
><P
><SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>と<SPAN
CLASS="APPLICATION"
>psql</SPAN
>ではパイプから読み書きができるので、あるサーバから別のサーバへデータベースを直接ダンプできます。
以下に例を示します。
</P><PRE
CLASS="PROGRAMLISTING"
>pg_dump -h <TT
CLASS="REPLACEABLE"
><I
>host1</I
></TT
> <TT
CLASS="REPLACEABLE"
><I
>dbname</I
></TT
> | psql -h <TT
CLASS="REPLACEABLE"
><I
>host2</I
></TT
> <TT
CLASS="REPLACEABLE"
><I
>dbname</I
></TT
></PRE
><P>
   </P
><DIV
CLASS="IMPORTANT"
><BLOCKQUOTE
CLASS="IMPORTANT"
><P
><B
>重要項目: </B
><SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>で作成されるダンプは<TT
CLASS="LITERAL"
>template0</TT
>と相対関係にあります。
つまり<TT
CLASS="LITERAL"
>template1</TT
>を経由して追加されたあらゆる言語、プロシージャなども<SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>によりダンプされます。
その結果としてリストアする際に、カスタマイズされた<TT
CLASS="LITERAL"
>template1</TT
>を使用している場合は、上記の例のように、<TT
CLASS="LITERAL"
>template0</TT
>から空のデータベースを作成する必要があります。
    </P
></BLOCKQUOTE
></DIV
><P
>バックアップをリストアした後、問い合わせオプティマイザが有用な統計情報を使用できるように、各データベースに対して<A
HREF="sql-analyze.html"
>ANALYZE</A
>を実行することを勧めます。
より詳しくは、<A
HREF="routine-vacuuming.html#VACUUM-FOR-STATISTICS"
>項24.1.3</A
> と <A
HREF="routine-vacuuming.html#AUTOVACUUM"
>項24.1.6</A
>を参照してください。
効率的に大規模なデータを<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>にロードする方法に関するより多くの勧告については、<A
HREF="populate.html"
>項14.4</A
>を参照してください。
   </P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="BACKUP-DUMP-ALL"
>25.1.2. <SPAN
CLASS="APPLICATION"
>pg_dumpall</SPAN
>の使用</A
></H2
><P
><SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>は一度に単一のデータベースのみをダンプします。
また、ロールやテーブル空間についての情報はダンプしません。
（これらはテーブル毎ではなくクラスタ全体のものだからです。）
データベースクラスタの全内容の簡便なダンプをサポートするために、<A
HREF="app-pg-dumpall.html"
><SPAN
CLASS="APPLICATION"
>pg_dumpall</SPAN
></A
>プログラムが提供されています。
<SPAN
CLASS="APPLICATION"
>pg_dumpall</SPAN
>は指定されたクラスタの各データベースのバックアップを行い、そして、ロールやテーブル空間定義などのクラスタ全体にわたるデータを保存します。
このコマンドの基本的な使用方法は
</P><PRE
CLASS="SYNOPSIS"
>pg_dumpall &gt; <TT
CLASS="REPLACEABLE"
><I
>outfile</I
></TT
></PRE
><P>
です。
ダンプの結果は<SPAN
CLASS="APPLICATION"
>psql</SPAN
>でリストアできます。
</P><PRE
CLASS="SYNOPSIS"
>psql -f <TT
CLASS="REPLACEABLE"
><I
>infile</I
></TT
> postgres</PRE
><P>
（実際、開始時に任意の既存のデータベース名を指定することができますが、空のクラスタ内にロードする場合は、通常 <TT
CLASS="LITERAL"
>postgres</TT
> を使用すべきです。）
ロールやテーブル空間の情報をリストアしなければならないので、<SPAN
CLASS="APPLICATION"
>pg_dumpall</SPAN
>のダンプをリストアする時には、データベーススーパーユーザのアクセス権限を確実に必要とします。
テーブル空間を使用している場合、ダンプ内のテーブル空間のパスが新しいインストレーションで適切であることを確認してください。
   </P
><P
><SPAN
CLASS="APPLICATION"
>pg_dumpall</SPAN
>はコマンドを発令することによりロール、テーブル空間、およびデータベースを再作成し、それぞれのデータベースに対して<SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>を起動します。
このことは、それぞれのデータベースには内部的に矛盾がない一方、異なるデータベースのスナップショットは完全に同期しないことを示しています。
   </P
><P
>クラスタレベルでのデータは<SPAN
CLASS="APPLICATION"
>pg_dumpall</SPAN
> の<TT
CLASS="OPTION"
>--globals-only</TT
> オプションを使用して出力することができます。
このコマンドは個々のデータベースに<SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
> コマンドを実行しつつ、フルバックアップを取得する際に必要です。
   </P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="BACKUP-DUMP-LARGE"
>25.1.3. 大規模データベースの扱い</A
></H2
><P
>オペレーティングシステムの中には最大ファイルサイズに制限があるものがあり、大きな<SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>出力ファイルを作成しているときに問題を引き起こします。
幸運なことに、<SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>は標準出力に書き出すことができますので、Unix標準のツールを使ってこの潜在的な問題を解決できます。
取りうる方法がいくつか存在します。
   </P
><DIV
CLASS="FORMALPARA"
><P
><B
>圧縮ダンプの使用. </B
>たとえば、自分が愛用している<SPAN
CLASS="APPLICATION"
>gzip</SPAN
>のような圧縮プログラムが使えます。

</P><PRE
CLASS="PROGRAMLISTING"
>pg_dump <TT
CLASS="REPLACEABLE"
><I
>dbname</I
></TT
> | gzip &gt; <TT
CLASS="REPLACEABLE"
><I
>filename</I
></TT
>.gz</PRE
><P>

元に戻すには次のようにします。

</P><PRE
CLASS="PROGRAMLISTING"
>gunzip -c <TT
CLASS="REPLACEABLE"
><I
>filename</I
></TT
>.gz | psql <TT
CLASS="REPLACEABLE"
><I
>dbname</I
></TT
></PRE
><P>

あるいは次のようにもできます。

</P><PRE
CLASS="PROGRAMLISTING"
>cat <TT
CLASS="REPLACEABLE"
><I
>filename</I
></TT
>.gz | gunzip | psql <TT
CLASS="REPLACEABLE"
><I
>dbname</I
></TT
></PRE
><P>
    </P
></DIV
><DIV
CLASS="FORMALPARA"
><P
><B
><TT
CLASS="COMMAND"
>split</TT
>の使用. </B
><TT
CLASS="COMMAND"
>split</TT
>コマンドで結果を使用しているファイルシステムが受け付けられる大きさに分割することができます。
例えば1メガバイトずつに分割するには次のようにします。

</P><PRE
CLASS="PROGRAMLISTING"
>pg_dump <TT
CLASS="REPLACEABLE"
><I
>dbname</I
></TT
> | split -b 1m - <TT
CLASS="REPLACEABLE"
><I
>filename</I
></TT
></PRE
><P>

元に戻すには次のようにします。

</P><PRE
CLASS="PROGRAMLISTING"
>cat <TT
CLASS="REPLACEABLE"
><I
>filename</I
></TT
>* | psql <TT
CLASS="REPLACEABLE"
><I
>dbname</I
></TT
></PRE
><P>
    </P
></DIV
><DIV
CLASS="FORMALPARA"
><P
><B
><SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>のカスタムダンプ書式の使用. </B
>もし<SPAN
CLASS="PRODUCTNAME"
>PostgreSQL</SPAN
>が<SPAN
CLASS="APPLICATION"
>zlib</SPAN
>圧縮ライブラリインストール済みのシステム上で構築されたのなら、カスタムダンプ書式では出力ファイルに書き出す時にデータを圧縮します。
<TT
CLASS="COMMAND"
>gzip</TT
>を使用した時と似通ったダンプサイズとなりますが、テーブルの復元を部分的に行えるという点で優れていると言えます。
以下のコマンドは、カスタムダンプ書式でのデータベースのダンプを行います。

</P><PRE
CLASS="PROGRAMLISTING"
>pg_dump -Fc <TT
CLASS="REPLACEABLE"
><I
>dbname</I
></TT
> &gt; <TT
CLASS="REPLACEABLE"
><I
>filename</I
></TT
></PRE
><P>

カスタム書式のダンプは<SPAN
CLASS="APPLICATION"
>psql</SPAN
>用のスクリプトではありませんので、代わりに<SPAN
CLASS="APPLICATION"
>pg_restore</SPAN
>でリストアしなければなりません。
例えば以下のようにします。

</P><PRE
CLASS="PROGRAMLISTING"
>pg_restore -d <TT
CLASS="REPLACEABLE"
><I
>dbname</I
></TT
> <TT
CLASS="REPLACEABLE"
><I
>filename</I
></TT
></PRE
><P>

詳細は<A
HREF="app-pgdump.html"
>pg_dump</A
>と<A
HREF="app-pgrestore.html"
>pg_restore</A
>のリファレンスページを参照してください。
    </P
></DIV
><P
>巨大なデータベースに対しては、そのほかの２つの手法のうちの１つと一緒に<TT
CLASS="COMMAND"
>split</TT
>を組み合わせる必要があるかもしれません。
   </P
><DIV
CLASS="FORMALPARA"
><P
><B
><SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>の並列実行. </B
><SPAN
CLASS="APPLICATION"
>pg_dump</SPAN
>を並列実行することで、大きなデータベースのダンプを高速に実行することができます。
これは同時に複数テーブルのダンプを実行します。
並列度は<TT
CLASS="COMMAND"
>-j</TT
>パラメータを指定することで制御できます。
並列ダンプはディレクトリダンプ書式のみサポートします。

</P><PRE
CLASS="PROGRAMLISTING"
>pg_dump -j <TT
CLASS="REPLACEABLE"
><I
>num</I
></TT
> -F d -f <TT
CLASS="REPLACEABLE"
><I
>out.dir</I
></TT
> <TT
CLASS="REPLACEABLE"
><I
>dbname</I
></TT
></PRE
><P>

<TT
CLASS="COMMAND"
>pg_restore -j</TT
>コマンドでダンプファイルを並列でリストアすることができます。
これは<TT
CLASS="COMMAND"
>pg_dump -j</TT
>でダンプファイルが作成されたか、否かにかかわらず、カスタムもしくはディレクトリダンプ書式で作成されたダンプファイルに使用できます。
    </P
></DIV
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="backup.html"
ACCESSKEY="P"
>前のページ</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>ホーム</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="backup-file.html"
ACCESSKEY="N"
>次のページ</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>バックアップとリストア</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="backup.html"
ACCESSKEY="U"
>上に戻る</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>ファイルシステムレベルのバックアップ</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>