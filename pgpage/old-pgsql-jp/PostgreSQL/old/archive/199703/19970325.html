<A NAME="6">
<PRE><B>
From: &quot;H.Hatakeyama&quot; &lt;hatake@jncs.ac.jp&gt;
Date: Tue, 25 Mar 1997 20:17:20 +0900 (JST)
Subject: [postgres95 1619] hello
Message-Id: &lt;199703251117.UAA00392@csbmaster.jncs.ac.jp&gt;
</A>
</B></PRE>
<PRE>


はじめまして、畠山＠千葉スクールオブビジネスと申します。

（校名から良くビジネス系と間違われるのですが）コンピュータの専門学校の
講師を務めています。
 授業で、dBASE系のデータベースしか教えていない状況をかねがね遺憾に思っ
 ておりまして、ある日 Javaのメーリングリストで出た postgreSQLの名に魅き
 寄せられる様にして来ました。
 
 これからは、教務のデータ管理を postgres に移行すると共に、授業にも使っ
て行きたいと考えています。

畠山＠千葉スクールオブビジネス


<HR>
</PRE>
<A NAME="5">
<PRE><B>
From: Daiki Ueno &lt;daiki@labnet.or.jp&gt;
Date: Tue, 25 Mar 1997 14:45:03 +0900
Subject: [postgres95 1618] Re: Welcome to postgres95
Message-Id: &lt;199703250545.FAA00815@hellhammer.mayhem.jp&gt;
</A>
</B></PRE>
<PRE>

上野＠早稲田と申します．初めまして．

| 新規にこのMLに加入された方は、まずは自己紹介を投稿して下さるようにお願
| いします。フォーマットは自由です。購読者相互の理解を深めるためですので、
| 御協力のほどをお願いします。

との事なので自己紹介させて頂きます．
postgres95は家のlinuxと学校のSolaris 2.5.1で動かしています．
Software Design誌の記事を見たのがきっかけで、DBMSに興味を持ちました．
# 最初に触ったのが、つい最近です． ^^;;
# Apache + PHP/FI の連携も少し試してみました．

関係無いですが、興味ある事は：
Tcl/Tk(8.0)の国際化です．あと、それとは別に趣味上での事なのですが、
Tcl/TkのIRCのクライアントの日本語化をやっています．SRAから配布されてい
る日本語パッチ(7.6jp/4.2jp)では日本語の正規表現が扱えないため、EUCにし
て切り分け切り分けやっていますが、近いうちにpostgres95の日本語パッチの
部分を眺めて勉強したいと思っています．

どうぞよろしくお願いします．
--
上野乃毅 ／ 早稲田大学理工学部情報学科知識情報工学専攻３年
mailto:daiki@labnet.or.jp
(PGP fingerprint = CB 93 0F A0 4D 6B 6A E3  10 4B F7 7B 77 2D 98 47)
<HR>
</PRE>
<A NAME="4">
<PRE><B>
From: Tatsuo Ishii &lt;t-ishii@sra.co.jp&gt;
Date: Tue, 25 Mar 1997 13:07:44 +0900
Subject: [postgres95 1617] Re: date 
Message-Id: &lt;199703250407.NAA17426@srashd.sra.co.jp&gt;
</A>
</B></PRE>
<PRE>

石井＠SRAです。

&gt; 浅田％逃避行動＠トラストです。
&gt;
&gt;&gt;   ソースが多くて hack はあきらめてましたが、これだけ書いて頂ければ少しくら
&gt;&gt; いは。というわけで、少し試してみました。
&gt;
&gt; まー、この程度のことを hack と呼ぶのかどうかはおいといて ;-)
&gt; 手元の Solaris 2.5 SPARC edition + gcc-2.7.2.1 では生成されるコードが

解析、お疲れさまです。

&gt;&gt;   となるとコンパイラか？ 一応 gcc 2.7.0 ですけど。
&gt;
&gt; これは今回の件とは別ですけれど不穏な動きをするバージョンなので 2.6.3
&gt;の方がマシなくらいです。gcc-2.7.2.1 にしてください。
&gt;
&gt; でも 2.7.2.1 も今回の内容ではバグっているんですけどね。
&gt;
&gt; # しかしあんなに変なコードを書く方が悪いと思う。

この件は本家メーリングリストでは gcc のバグ扱いになってますね。でも、
ソースを直した方がいいんじゃないかと言う気が私もします。

&gt; この関数をみていて ISO スタイルの Y-M-D 形式はサポートされていないの
&gt;かなと思ったのですが、やっぱりそうなのかしらん？
&gt;
&gt; (Postgres95 の 0.9X〜1.0 までしか触っていないヤツなのでした)

6.1 beta で  ISO 8601 format をサポートするパッチが取り込まれたようで
す。
---
t-ishii@sra.co.jp	石井達夫
（株）ＳＲＡ
<HR>
</PRE>
<A NAME="3">
<PRE><B>
From: ASADA Kazuhisa &lt;asada@trust.co.jp&gt;
Date: Tue, 25 Mar 1997 11:28:36 +0900
Subject: [postgres95 1616] Re: date
Message-Id: &lt;199703250228.LAA04606@pigeon.trust.co.jp&gt;
</A>
</B></PRE>
<PRE>

 浅田＠トラストです。最後に書き忘れがありました。

 神田さんも書いていた

&gt;   その三
&gt;     return((int4)(d &lt;&lt; 24 | m &lt;&lt; 16 | y));

 こういうのが一番適切ですね。きちんと 32bits で収まります。

 いちお〜、return ((int4)d &lt;&lt; 24) | ((int4)m &lt;&lt; 16) | (int4)y; とでも
しておきましょうか。

 # でも整数化して比較するなら順序が逆・・・

 メンド〜くさいっていう向きにはマクロや関数でも使って頂くのがよろしい
かと思います。
--
  ******************************************************
    株式会社トラストシステム  オープンシステムグループ
        浅田和久         E-mail: asada@trust.co.jp
  ******************************************************
<HR>
</PRE>
<A NAME="2">
<PRE><B>
From: ASADA Kazuhisa &lt;asada@trust.co.jp&gt;
Date: Tue, 25 Mar 1997 11:08:21 +0900
Subject: [postgres95 1615] Re: date
Message-Id: &lt;199703250208.LAA04533@pigeon.trust.co.jp&gt;
</A>
</B></PRE>
<PRE>

 浅田％逃避行動＠トラストです。

&gt;   ソースが多くて hack はあきらめてましたが、これだけ書いて頂ければ少しくら
&gt; いは。というわけで、少し試してみました。

 まー、この程度のことを hack と呼ぶのかどうかはおいといて ;-)
 手元の Solaris 2.5 SPARC edition + gcc-2.7.2.1 では生成されるコードが


&gt;     date-&gt;day = d;
&gt;     date-&gt;month = m;
&gt;     date-&gt;year = y;
&gt;     return result;

 に対して

・-O なし

	int4 result;	[%fp-32]
	DateADT *date;	[%fp-36]
	int d;		[%fp-17]
	int m;		[%fp-21]
	int y;		[%fp-26]

	ld [%fp-36],%o0
	ldub [%fp-17],%o1
	stb %o1,[%o0]
	ld [%fp-36],%o0
	ldub [%fp-21],%o1
	stb %o1,[%o0+1]
	ld [%fp-36],%o0
	lduh [%fp-26],%o1
	sth %o1,[%o0+2]
	ld [%fp-32],%i0
	b .LL5
	nop
.LL5:
	ret
	restore


・-O の場合

	int4 result;	[%fp-20]
	DateADT *date;	%l0		(自動レジスタ割り付け)
	int d;		[%fp-21]
	int m;		[%fp-25]
	int y;		[%fp-30]

        ldub [%fp-21],%o0
.LL15:
	stb %o0,[%l0]
	ldub [%fp-25],%o0
	stb %o0,[%l0+1]
	lduh [%fp-30],%o0
	sth %o0,[%l0+2]
	ld [%fp-20],%i0
	ret
	restore

・-O2 の場合

	int4 result;	[%fp-20]
	DateADT *date;	%l0		(自動レジスタ割り付け)
	int d;		[%fp-24]
	int m;		[%fp-28]
	int y;		[%fp-32]

	ld [%fp-24],%o0
	stb %o0,[%l1]
	ld [%fp-28],%o0
	stb %o0,[%l1+1]
	ld [%fp-32],%o0
	ld [%fp-20],%i0
	sth %o0,[%l1+2]
	ret
	restore

 というわけで、-O2 だと最後の ld と sth(STore Halfword) の順序が入れ
替わっています。これが原因なのでごじゃりますね。


&gt;   elog 呼んだだけでうまくいくというのが少々謎ですが、DateADT -&gt; int4 のキャ
&gt; ストが変みたいですね。

 以上のトレースよりキャストじゃないです。
 単に最適化における命令の再配置ミスでバグが埋め込まれているですね。

 安直には

   volatile int4 result;
   volatile DateADT *date = (DateADR*)&amp;result;

 とコードを変更すると一応まともになるみたいです。

 まともなやり方としては

   union {
       int4    value;
       DateADT date;
   } result;
   DateAdt *date = &amp;result.date;

   〜中略〜

   return result.value;

 とすることですね。


&gt;   となるとコンパイラか？ 一応 gcc 2.7.0 ですけど。

 これは今回の件とは別ですけれど不穏な動きをするバージョンなので 2.6.3
の方がマシなくらいです。gcc-2.7.2.1 にしてください。

 でも 2.7.2.1 も今回の内容ではバグっているんですけどね。

 # しかしあんなに変なコードを書く方が悪いと思う。

 この関数をみていて ISO スタイルの Y-M-D 形式はサポートされていないの
かなと思ったのですが、やっぱりそうなのかしらん？

 (Postgres95 の 0.9X〜1.0 までしか触っていないヤツなのでした)
--
  ******************************************************
    株式会社トラストシステム  オープンシステムグループ
        浅田和久         E-mail: asada@trust.co.jp
  ******************************************************
<HR>
</PRE>
<A NAME="1">
<PRE><B>
From: &quot;神田大輔 [Daisuke Kanda]&quot; &lt;small@first.tsukuba.ac.jp&gt;
Date: Tue, 25 Mar 1997 01:45:34 +0900
Subject: [postgres95 1614] Re: date
Message-Id: &lt;19970325014534U.small@first.tsukuba.ac.jp&gt;
</A>
</B></PRE>
<PRE>


  まいどお騒がせしてます(^^; 神田です。

おみつさんの書かれた、
	「[postgres95 1613] Re: date」
からの引用です。

おみつ&gt; おみつ@Tramp です
おみつ&gt; 
おみつ&gt; On Mon, 24 Mar 1997 19:35:16 +0900
おみつ&gt; &quot;神田大輔 [Daisuke Kanda]&quot; &lt;small@first.tsukuba.ac.jp&gt; wrote:
おみつ&gt; &gt; ...snip...
おみつ&gt; &gt; 
おみつ&gt; &gt;   Apache1.2b7 &amp; PHP/FI 1.0b10 +jp3 から、postgreSQL6.0 +date引き算パッチ
おみつ&gt; &gt; 
おみつ&gt; 
おみつ&gt; date引き算の部分は単純な(でもないかな;p)コードのバグでしたが、
おみつ&gt; 
おみつ&gt; &gt;   を使っていますが、以下のような症状がでます。
おみつ&gt; &gt;     ・PHP から、insert into table (date) values('03-26-1997') などとやると
おみつ&gt; &gt;       ・年が 0000 になってしまいます。
おみつ&gt; 
おみつ&gt; これがよく分からないんですよね... :-&lt;
おみつ&gt; 
おみつ&gt; 石井さん(MkLinux)、いしかわ＠ぎふだいさん(SPARC/Linux)からの投稿で
おみつ&gt; 変な症状が出ているとのことでしたし、
おみつ&gt; 本家 ML でも同様な報告が流れてました。

おみつ&gt; ちなみに、プラットホームは何でしょうか?
おみつ&gt; # Linux/x86 では問題なく代入・保存・表示できていますので...

  書き忘れました、SPARC/Solaris2.4 です。



おみつ&gt; もしかして内部処理が変なのかななどと勝手に疑ったりして、
おみつ&gt; 少々ハックしてみますと、
おみつ&gt; 
おみつ&gt; PostgreSQL での date型のデータの受渡しはint4型(32bit)の値渡しで、
おみつ&gt; それを DateADT構造体にキャストしてます。(なんでかな?)
おみつ&gt; 
おみつ&gt; DateADT は 
おみつ&gt;         typedef struct DateADT {
おみつ&gt;             char        day;
おみつ&gt;             char        month;
おみつ&gt;             short       year;
おみつ&gt;         } DateADT;
おみつ&gt; の形です。
おみつ&gt; 合計4バイトですので、int4型と同じ大きさということなのでしょう。
おみつ&gt; 
おみつ&gt; このメンバの day,month,year にそれぞれ PostgreSQL がパースした文字列を
おみつ&gt; sscanf で int型にとってきて突っ込んでるのですが、
おみつ&gt; この代入(明示的な int から char または short へのキャストはしてません)
おみつ&gt; がおかしいのか、値渡しの機構そのものがおかしいのか...
おみつ&gt; くらいしか datetimes.c からは読み取れません

おみつ&gt; で、提案なのですが、
おみつ&gt; datetimes.c で気になった代入時のキャストと値渡しの構造について、
おみつ&gt; 
おみつ&gt; 	1. 代入時にキャストするようにソースをいじってみる
おみつ&gt; 
おみつ&gt; 	2. ポインタを渡す date型を登録してみる
おみつ&gt; 	   あるいは同じ構造体で定義できる新しい型を作ってみる
おみつ&gt; 	   # Cソースと登録用のSQLくらいは用意できると思います
おみつ&gt; 
おみつ&gt; という実験をしてみる元気はありませんか?

  ソースが多くて hack はあきらめてましたが、これだけ書いて頂ければ少しくら
いは。というわけで、少し試してみました。

  src/backend/utils/datetime.c の int4 datein(char *datestr) の後半。

    date-&gt;day = d;
    date-&gt;month = m;
    date-&gt;year = y;
    return result;

  の辺り。

  その一
    date-&gt;day = (char)d;
    date-&gt;month = (char)m;
    date-&gt;year = (short)y;

    結果：×

  その二
&gt;   elog(DEBUG, &quot;&quot;);
    return result; 

    結果：○ (なぜ？)

  その三
    return((int4)(d &lt;&lt; 24 | m &lt;&lt; 16 | y));

    結果：○

  結論
  elog 呼んだだけでうまくいくというのが少々謎ですが、DateADT -&gt; int4 のキャ
ストが変みたいですね。
  となるとコンパイラか？ 一応 gcc 2.7.0 ですけど。

    筑波大学自然学類三年次神田大輔 
	e-mail:	small@first.tsukuba.ac.jp
	WWW:	http://www.first.tsukuba.ac.jp/~small
	PGP fingerprint:09 35 5B 57 5B B7 C8 8B  9C 87 7C 57 8F 2F BE 8B
<HR>
</PRE>
<A NAME="0">
<PRE><B>
From: Mitsuhiro Maeda &lt;mitsu@tramp.co.jp&gt;
Date: Tue, 25 Mar 1997 00:33:46 +0900
Subject: [postgres95 1613] Re: date
Message-Id: &lt;199703241533.AAA07690@log.tramp.co.jp&gt;
</A>
</B></PRE>
<PRE>

おみつ@Tramp です

On Mon, 24 Mar 1997 19:35:16 +0900
&quot;神田大輔 [Daisuke Kanda]&quot; &lt;small@first.tsukuba.ac.jp&gt; wrote:
&gt; ...snip...
&gt; 
&gt;   Apache1.2b7 &amp; PHP/FI 1.0b10 +jp3 から、postgreSQL6.0 +date引き算パッチ
&gt; 

date引き算の部分は単純な(でもないかな;p)コードのバグでしたが、

&gt;   を使っていますが、以下のような症状がでます。
&gt;     ・PHP から、insert into table (date) values('03-26-1997') などとやると
&gt;       ・年が 0000 になってしまいます。

これがよく分からないんですよね... :-&lt;

石井さん(MkLinux)、いしかわ＠ぎふだいさん(SPARC/Linux)からの投稿で
変な症状が出ているとのことでしたし、
本家 ML でも同様な報告が流れてました。

もしかして内部処理が変なのかななどと勝手に疑ったりして、
少々ハックしてみますと、

PostgreSQL での date型のデータの受渡しはint4型(32bit)の値渡しで、
それを DateADT構造体にキャストしてます。(なんでかな?)

DateADT は 
        typedef struct DateADT {
            char        day;
            char        month;
            short       year;
        } DateADT;
の形です。
合計4バイトですので、int4型と同じ大きさということなのでしょう。

このメンバの day,month,year にそれぞれ PostgreSQL がパースした文字列を
sscanf で int型にとってきて突っ込んでるのですが、
この代入(明示的な int から char または short へのキャストはしてません)
がおかしいのか、値渡しの機構そのものがおかしいのか...
くらいしか datetimes.c からは読み取れません

ではパーサーかと、gram.y,scan.l などをみてみても
さほど大したことをしてる気配もありません。
# lex,yacc の構文はほとんど知りませんので、あやしいものですが ;-)

&gt;     ・さらにその後で psql から insert すると、 
&gt;       ・何回か変な年 (03-23-27648 や 03-23--11172 など) が入力され、
&gt;       ・やがて一回前に insert した年を入力されるようになります

ますます ??? ですね。

ちなみに、プラットホームは何でしょうか?
# Linux/x86 では問題なく代入・保存・表示できていますので...


で、提案なのですが、
datetimes.c で気になった代入時のキャストと値渡しの構造について、

	1. 代入時にキャストするようにソースをいじってみる

	2. ポインタを渡す date型を登録してみる
	   あるいは同じ構造体で定義できる新しい型を作ってみる
	   # Cソースと登録用のSQLくらいは用意できると思います

という実験をしてみる元気はありませんか?

== おみつ

<HR>
</PRE>
