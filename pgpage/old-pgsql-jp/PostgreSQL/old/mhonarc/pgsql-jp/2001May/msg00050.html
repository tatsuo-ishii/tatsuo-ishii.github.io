<!-- MHonArc v2.1.0 -->
<!--X-Subject: [pgsql&#45;jp 20993] SELECT problem in PL/pgSQL on PostgreSQL 7.1.1 -->
<!--X-From: Tsuyoshi SASAMOTO <sasamoto@e&#45;vision.co.jp> -->
<!--X-Date: Mon, 7 May 2001 20:53:00 +0900 (JST) -->
<!--X-Message-Id: 200105071153.UAA04977@mailhost.e&#45;vision.co.jp -->
<!--X-ContentType: text/plain -->
<!--X-Head-End-->
<HTML>
<HEAD>
<TITLE>[pgsql-jp 20993] SELECT problem in PL/pgSQL on PostgreSQL 7.1.1 </TITLE>
<LINK REV="made" HREF="mailto:sasamoto@e-vision.co.jp">
</HEAD>
<BODY BGCOLOR="#ffffff">
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<HR>
[<A HREF="msg00049.html">Date Prev</A>][<A HREF="msg00051.html">Date Next</A>][<A HREF="msg00076.html">Thread Prev</A>][<A HREF="msg00055.html">Thread Next</A>][<A HREF="index.html#00050">Date Index</A>][<A HREF="threads.html#00050">Thread Index</A>]
<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<H1>[pgsql-jp 20993] SELECT problem in PL/pgSQL on PostgreSQL 7.1.1</H1>
<HR>
<!--X-Subject-Header-End-->
<UL>
<LI><em>From</em>: Tsuyoshi SASAMOTO &lt;<A HREF="mailto:sasamoto@e-vision.co.jp">sasamoto@e-vision.co.jp</A>&gt;</LI>
<LI><em>Date</em>: Mon, 7 May 2001 20:53:00 +0900 (JST)</LI>
</UL>
<!--X-Head-Body-Sep-Begin-->
<HR>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<PRE>
7.1.1早速入れてみました．

私が[pgsql-jp 20713]で書いたSolaris8(x86)上での"--with-openssl"の
問題のうち，プロトタイプ宣言の衝突の問題は解消されていました．

ただ，OpenSSLがシェアードオブジェクトになっている場合については，
まだ自分でMakefile.*を書き換えないとダメなんですが......まぁ，
こういうことをやる人はあまりいないので，“自己責任で”ということ
なんでしょうか??????


それはともかくとして，実際に動かしてみたところ，今まで使えていた
PL/pgSQLの関数が使えなくなってしまったのですが......どうも

「PL/pgSQL中のSELECT文の実行結果で，レコード数が０の場合は
　バックエンドが異常終了してしまう」

という問題があるようです（さまざまなパターンで検証したという
わけではないので，断言はできませんが）．例えば
----------------------------------------------------------------------
CREATE TABLE hogehoge (
  hogeid integer PRIMARY KEY,
  hogehoge text
);

CREATE FUNCTION get_hoge(integer) RETURNS text AS '
DECLARE
  result text;
BEGIN
  SELECT hogehoge INTO result FROM hogehoge WHERE hogeid=$1;
  RETURN result;
END;
' LANGUAGE 'plpgsql';

INSERT INTO hogehoge VALUES (1,'hoge1');
----------------------------------------------------------------------
で準備をしてから
----------------------------------------------------------------------
hoge=# select version();
                            version
----------------------------------------------------------------
 PostgreSQL 7.1.1 on i386-pc-solaris2.8, compiled by GCC 2.95.3
(1 row)

hoge=# select get_hoge(1);
 get_hoge
----------
 hoge1
(1 row)

hoge=# select get_hoge(2);
pqReadData() -- backend closed the channel unexpectedly.
	This probably means the backend terminated abnormally
	before or while processing the request.
The connection to the server was lost. Attempting reset: Failed.
!# 
----------------------------------------------------------------------
という具合です．この間のsyslogは
----------------------------------------------------------------------
May  7 19:57:23 hogehost postgres[4797]: [ID 553393 local0.debug] [1] DEBUG:
  database system was interrupted at 2001-05-07 19:54:20 JST
May  7 19:57:23 hogehost postgres[4797]: [ID 553393 local0.debug] [2] DEBUG:
  CheckPoint record at (8, 2264375516)
May  7 19:57:23 hogehost postgres[4797]: [ID 553393 local0.debug] [3] DEBUG:
  Redo record at (8, 2264375516); Undo record at (0, 0); Shutdown TRUE
May  7 19:57:23 hogehost postgres[4797]: [ID 553393 local0.debug] [4] DEBUG:
  NextTransactionId: 25505147; NextOid: 67990538
May  7 19:57:23 hogehost postgres[4797]: [ID 553393 local0.debug] [5] DEBUG:
  database system was not properly shut down; automatic recovery in progress...
May  7 19:57:23 hogehost postgres[4797]: [ID 553393 local0.debug] [6] DEBUG:
  ReadRecord: record with zero len at (8, 2264375580)
May  7 19:57:23 hogehost postgres[4797]: [ID 553393 local0.debug] [7] DEBUG:
  redo is not required
May  7 19:57:25 hogehost postgres[4797]: [ID 553393 local0.debug] [8] DEBUG:
  database system is in production state
----------------------------------------------------------------------
という具合です．$PGDATA/base/270512というところにcoreもできてまして
----------------------------------------------------------------------
GNU gdb 5.0
Copyright 2000 Free Software Foundation, Inc.
GDB is free software, covered by the GNU General Public License, and you are
welcome to change it and/or distribute copies of it under certain conditions.
Type "show copying" to see the conditions.
There is absolutely no warranty for GDB.  Type "show warranty" for details.
This GDB was configured as "i386-pc-solaris2.8"...
Core was generated by `/usr/local/pgsql/bin/postmaster -il -B 4096 --syslog=2
 -D /usr/local/pgsql/data'.
Program terminated with signal 11, Segmentation Fault.
Reading symbols from /usr/local/ssl/lib/libssl.so.0.9.6...done.
Loaded symbols for /usr/local/ssl/lib/libssl.so.0.9.6
Reading symbols from /usr/local/ssl/lib/libcrypto.so.0.9.6...done.
Loaded symbols for /usr/local/ssl/lib/libcrypto.so.0.9.6
Reading symbols from /usr/lib/libz.so.1...done.
Loaded symbols for /usr/lib/libz.so.1
Reading symbols from /usr/lib/libresolv.so.2...done.
Loaded symbols for /usr/lib/libresolv.so.2
Reading symbols from /usr/lib/libgen.so.1...done.
Loaded symbols for /usr/lib/libgen.so.1
Reading symbols from /usr/lib/libnsl.so.1...done.
Loaded symbols for /usr/lib/libnsl.so.1
Reading symbols from /usr/lib/libsocket.so.1...done.
Loaded symbols for /usr/lib/libsocket.so.1
Reading symbols from /usr/lib/libdl.so.1...done.
Loaded symbols for /usr/lib/libdl.so.1
Reading symbols from /usr/lib/libm.so.1...done.
Loaded symbols for /usr/lib/libm.so.1
Reading symbols from /usr/local/lib/libreadline.so.4...done.
Loaded symbols for /usr/local/lib/libreadline.so.4
Reading symbols from /usr/lib/libc.so.1...done.
Loaded symbols for /usr/lib/libc.so.1
Reading symbols from /usr/lib/libmp.so.2...done.
Loaded symbols for /usr/lib/libmp.so.2
Reading symbols from /usr/lib/libcurses.so.1...done.
Loaded symbols for /usr/lib/libcurses.so.1
Reading symbols from /usr/local/pgsql/lib/plpgsql.so...done.
Loaded symbols for /usr/local/pgsql/lib/plpgsql.so
---Type &lt;return&gt; to continue, or q &lt;return&gt; to quit---
#0  0x80f4230 in SPI_gettypeid ()
(gdb) bt
#0  0x80f4230 in SPI_gettypeid ()
#1  0xdf78ff3c in exec_move_row () from /usr/local/pgsql/lib/plpgsql.so
#2  0xdf78de7f in exec_stmt_select () from /usr/local/pgsql/lib/plpgsql.so
#3  0xdf78d410 in exec_stmt () from /usr/local/pgsql/lib/plpgsql.so
#4  0xdf78d24c in exec_stmts () from /usr/local/pgsql/lib/plpgsql.so
#5  0xdf78d14b in exec_stmt_block () from /usr/local/pgsql/lib/plpgsql.so
#6  0xdf78c0e4 in plpgsql_exec_function () from /usr/local/pgsql/lib/plpgsql.so
#7  0xdf789428 in plpgsql_call_handler () from /usr/local/pgsql/lib/plpgsql.so
#8  0x80e5e61 in ExecMakeFunctionResult ()
#9  0x80e5f8c in ExecEvalFunc ()
#10 0x80e66bd in ExecEvalExpr ()
#11 0x80e6b15 in ExecTargetList ()
#12 0x80e6eee in ExecProject ()
#13 0x80eedd2 in ExecResult ()
#14 0x80e43ec in ExecProcNode ()
#15 0x80e2cb0 in ExecutePlan ()
#16 0x80e1eea in ExecutorRun ()
#17 0x814ac55 in ProcessQuery ()
#18 0x814936f in pg_exec_query_string ()
#19 0x814a5d8 in PostgresMain ()
#20 0x812a460 in DoBackend ()
#21 0x8129e5a in BackendStartup ()
#22 0x812894f in ServerLoop ()
#23 0x8128096 in PostmasterMain ()
---Type &lt;return&gt; to continue, or q &lt;return&gt; to quit---
#24 0x80fa756 in main ()
#25 0x8066a1b in _start ()
(gdb) 
----------------------------------------------------------------------
てな感じです．configure時のオプションは
    "--enable-multibyte=EUC_JP --with-openssl --enable-syslog"
でした．


Tsuyoshi SASAMOTO
sasamoto@e-vision.co.jp
</PRE>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<HR>
<UL><LI><STRONG>Follow-Ups</STRONG>:
<UL>
<LI><STRONG><A NAME="00055" HREF="msg00055.html">[pgsql-jp 20998] Re: SELECT problem in PL/pgSQL on PostgreSQL 7.1.1</A></STRONG>
<UL><LI><EM>From:</EM> Hiroshi Inoue &lt;Inoue@tpf.co.jp&gt;</LI></UL></LI>
</UL></LI></UL>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<UL>
<LI>Prev by Date:
<STRONG><A HREF="msg00049.html">[pgsql-jp 20992] ユーザ権限の変更について</A></STRONG>
</LI>
<LI>Next by Date:
<STRONG><A HREF="msg00051.html">[pgsql-jp 20994] データインポートについて</A></STRONG>
</LI>
<LI>Prev by thread:
<STRONG><A HREF="msg00076.html">[pgsql-jp 21019] Re: SJIS で作成したDBでpsql \dtが失敗</A></STRONG>
</LI>
<LI>Next by thread:
<STRONG><A HREF="msg00055.html">[pgsql-jp 20998] Re: SELECT problem in PL/pgSQL on PostgreSQL 7.1.1</A></STRONG>
</LI>
<LI>Index(es):
<UL>
<LI><A HREF="index.html#00050"><STRONG>Date</STRONG></A></LI>
<LI><A HREF="threads.html#00050"><STRONG>Thread</STRONG></A></LI>
</UL>
</LI>
</UL>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</BODY>
</HTML>
