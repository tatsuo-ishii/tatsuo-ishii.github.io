<!-- MHonArc v2.1.0 -->
<!--X-Subject: [pgsql&#45;jp 19880] postmaster のプロセスはあるのに	psqlで入れない -->
<!--X-From: Junzo Kudou <tech@dk.catv.ne.jp> -->
<!--X-Date: Tue, 13 Feb 2001 17:16:49 +0900 -->
<!--X-Message-Id: 200102130819.RAA11653@cs2.catv.ne.jp -->
<!--X-ContentType: text/plain -->
<!--X-Head-End-->
<HTML>
<HEAD>
<TITLE>[pgsql-jp 19880] postmaster のプロセスはあるのに	psqlで入れない </TITLE>
<LINK REV="made" HREF="mailto:tech@dk.catv.ne.jp">
</HEAD>
<BODY BGCOLOR="#ffffff">
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<HR>
[<A HREF="msg00122.html">Date Prev</A>][<A HREF="msg00123.html">Date Next</A>][<A HREF="msg00123.html">Thread Prev</A>][<A HREF="msg00117.html">Thread Next</A>][<A HREF="index.html#00124">Date Index</A>][<A HREF="threads.html#00124">Thread Index</A>]
<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<H1>[pgsql-jp 19880] postmaster のプロセスはあるのに	psqlで入れない</H1>
<HR>
<!--X-Subject-Header-End-->
<UL>
<LI><em>From</em>: Junzo Kudou &lt;<A HREF="mailto:tech@dk.catv.ne.jp">tech@dk.catv.ne.jp</A>&gt;</LI>
<LI><em>Date</em>: Tue, 13 Feb 2001 17:16:49 +0900</LI>
</UL>
<!--X-Head-Body-Sep-Begin-->
<HR>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<PRE>
はじめまして。工藤と申します。

MLの過去ログ等自分にできる範囲で調べてみたのですが復旧できません。
どなたかご存知の方、お知恵を拝借させてください。

負荷がかかっているのか、23時前後にバックエンドが落ちてしまうよう
になりました。telnetで入りpostmasterを起動してやって運用対処して
いたのですが、今回のはそれではダメそうです。
現象としては

〜現状〜
1 postgresのスーパユーザでpostmaster -Sとするとプロセス自体は
  立ち上がる
2 登録されているpostgresのユーザでpsqlで使おうとすると
  psql:pqReadeData() -- backend〜のメッセージが出て利用できない

〜環境〜
OS VineLinux2.1
DB Postgres7.0.3
etc Apacheとphpを使いwebサービスに利用


過去の拙い経験値から、以下の手段を試みました。

〜1.vacuumdbによる復旧〜
過去、いきなりDBが落ちた後、postmasterも起動できず接続できなく
なった場合にこれで回復したので試みました。結果は現状の2と同じで、
psql:pqReadData()〜と出たあと、最後にvacuumdb:vacuum failedと出力されます。

〜2.ロックファイルの削除〜
vacuumdbがうまくいかなかった場合、PGDATA/base/[dbname]/pg_vlock
ファイルを削除せよ、というのをFAQかどこかのドキュメントで見かけた
ので探しました。ありませんでした。

〜3./tmp/.s.PGSQL.5432ファイルの削除〜
postmasterは起動はできているようなので関係ないと思いましたが、
削除してpostmasterを再起動しましたが現象変わらず。

〜4.ipcclearによるリソースの開放〜
共有メモリの開放に失敗した場合もこのメッセージがでる、という記述を
MLの過去ログから発見しましたので、ipcclearによって掃除を試みました。
postmasterを切った直後に動かすと「まだpostmasterが動いている」と
いった内容のメッセージが出て来ましたが、数回動かしたら(これも変な
挙動?)幾つかの共有メモリの削除には成功しました。しかしそれでも数個
残っていました(pidが)ので、ipcrmによって残りも削除、サーバを再起動
させましたけど現象は変わらず。

〜5.gdbによるコアの解析〜
PDDATA/base/[dbname]/coreをgdbで読んだところ、以下のような
メッセージが出ました。

GNU gdb 4.18
Copyright 1998 Free Software Foundation, Inc.
GDB is free software, covered by the GNU General Public License, and you are
welcome to change it and/or distribute copies of it under certain conditions.
Type "show copying" to see the conditions.
There is absolutely no warranty for GDB.  Type "show warranty" for details.
This GDB was configured as "i386-redhat-linux"...
Core was generated by `/usr/local/pgsql/bin/postgres localhost chibikki chibikki sta'.
Program terminated with signal 11, Segmentation fault.
Reading symbols from /lib/libcrypt.so.1...done.
Reading symbols from /lib/libnsl.so.1...done.
Reading symbols from /lib/libdl.so.2...done.
Reading symbols from /lib/libm.so.6...done.
Reading symbols from /lib/libutil.so.1...done.
Reading symbols from /usr/lib/libreadline.so.3...done.
Reading symbols from /lib/libtermcap.so.2...done.
Reading symbols from /usr/lib/libncurses.so.4...done.
Reading symbols from /lib/libc.so.6...done.
Reading symbols from /lib/ld-linux.so.2...done.
#0  0x81205ba in IndexedAccessMethodInitialize ()
(gdb) where
#0  0x81205ba in IndexedAccessMethodInitialize ()
#1  0x81204f1 in RelationBuildDesc ()
#2  0x81209bf in RelationNameGetRelation ()
#3  0x8070362 in index_openr ()
#4  0x8095ee6 in RelationBuildTriggers ()
#5  0x81204d7 in RelationBuildDesc ()
#6  0x81209bf in RelationNameGetRelation ()
#7  0x806e849 in heap_openr ()
#8  0x811de82 in CatalogCacheInitializeCache ()
#9  0x811eb85 in SearchSysCache ()
#10 0x81222d6 in SearchSysCacheTuple ()
#11 0x81258e5 in SetUserId ()
#12 0x8125f7f in InitPostgres ()
#13 0x80eca95 in PostgresMain ()
#14 0x80d6e82 in DoBackend ()
#15 0x80d6a61 in BackendStartup ()
#16 0x80d5e1a in ServerLoop ()
#17 0x80d58a4 in PostmasterMain ()
#18 0x80ac016 in main ()
#19 0x401001fb in __libc_start_main (main=0x80abfb0 &lt;main&gt;, argc=5, argv=0xbffff964, init=0x80645c0 &lt;_init&gt;, 
    fini=0x812cbbc &lt;_fini&gt;, rtld_fini=0x4000a600 &lt;_dl_fini&gt;, stack_end=0xbffff95c) at ../sysdeps/generic/libc-start.c:90
(gdb) (gdb) q

-----gdb出力--------------------------------

読み方が良く解らなかったんですが、#0にindex〜と書かれている
(のと、似たような現象についてのMLでの過去ログ)のから、index
の再構築を試みました。結果は同じです。現象がまったく改善されません。

どなたか何か解らないでしょうか?何か肝心の作業を忘れている
のか・・・
私にはそろそろ八方塞がりに近いです。データを吸い上げて別な
環境で暫定的に公開というのも、pg_dumpが動かないのでかない
ません。うーん。

+-----------------------------------------------------------+
|  株式会社デジタオ 技術担当                      工藤順三  |
|  mail tech@dk.catv.ne.jp                                  |
+--URL  <A HREF="http://digitao.net/">http://digitao.net/</A> --------------------------------+
</PRE>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<HR>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<UL>
<LI>Prev by Date:
<STRONG><A HREF="msg00122.html">[pgsql-jp 19878] Re: パスワードファイルの扱いについての質問</A></STRONG>
</LI>
<LI>Next by Date:
<STRONG><A HREF="msg00123.html">[pgsql-jp 19879] 画像ファイル管理pgimage</A></STRONG>
</LI>
<LI>Prev by thread:
<STRONG><A HREF="msg00123.html">[pgsql-jp 19879] 画像ファイル管理pgimage</A></STRONG>
</LI>
<LI>Next by thread:
<STRONG><A HREF="msg00117.html">[pgsql-jp 19873] パスワードファイルの扱いについての質問</A></STRONG>
</LI>
<LI>Index(es):
<UL>
<LI><A HREF="index.html#00124"><STRONG>Date</STRONG></A></LI>
<LI><A HREF="threads.html#00124"><STRONG>Thread</STRONG></A></LI>
</UL>
</LI>
</UL>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</BODY>
</HTML>
