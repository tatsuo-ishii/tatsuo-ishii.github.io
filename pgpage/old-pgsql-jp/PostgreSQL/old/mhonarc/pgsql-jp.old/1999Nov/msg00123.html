<!-- MHonArc v2.1.0 -->
<!--X-Subject: [pgsql&#45;jp 11549] Re: [pgsql&#45;jp 11538] ¥È¥ê¥¬¡¼(TRIGGER)¤Ë¤è¤ë»²¾ÈÀ°¹çÀ­¤Ë¤Ä¤¤¤Æ¼ÁÌä -->
<!--X-From: "Hitoshi Komatsu (MLs)" <mls@hitoshi.ne.jp> -->
<!--X-Date: Thu, 4 Nov 1999 21:22:54 +0900 -->
<!--X-Message-Id: 002a01bf26bf$51f9d600$0701a8c0@hitoshi.ne.jp -->
<!--X-ContentType: text/plain -->
<!--X-Reference-Id: 19991104090845.19265.qmail@hotmail.com -->
<!--X-Head-End-->
<HTML>
<HEAD>
<TITLE>[pgsql-jp 11549] Re: [pgsql-jp 11538] ¥È¥ê¥¬¡¼(TRIGGER)¤Ë¤è¤ë»²¾ÈÀ°¹çÀ­¤ </TITLE>
<LINK REV="made" HREF="mailto:mls@hitoshi.ne.jp">
</HEAD>
<BODY BGCOLOR="#ffffff">
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<HR>
[<A HREF="msg00124.html">Date Prev</A>][<A HREF="msg00125.html">Date Next</A>][<A HREF="msg00122.html">Thread Prev</A>][<A HREF="msg00156.html">Thread Next</A>][<A HREF="index.html#00123">Date Index</A>][<A HREF="threads.html#00123">Thread Index</A>]
<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<H1>[pgsql-jp 11549] Re: [pgsql-jp 11538] ¥È¥ê¥¬¡¼(TRIGGER)¤Ë¤è¤ë»²¾ÈÀ°¹çÀ­¤Ë¤Ä¤¤¤Æ¼ÁÌä</H1>
<HR>
<!--X-Subject-Header-End-->
<UL>
<LI><em>From</em>: "Hitoshi Komatsu (MLs)" &lt;<A HREF="mailto:mls@hitoshi.ne.jp">mls@hitoshi.ne.jp</A>&gt;</LI>
<LI><em>Date</em>: Thu, 4 Nov 1999 21:22:54 +0900</LI>
<LI><em>References</em>: &lt;<A HREF="msg00112.html">19991104090845.19265.qmail@hotmail.com</A>&gt;</LI>
</UL>
<!--X-Head-Body-Sep-Begin-->
<HR>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<PRE>
¹â¿®¤µ¤ó¡¢¤Ï¤¸¤á¤Þ¤·¤Æ¡£
£è£é£ô£ï£ó£è£é¤È¸À¤¤¤Þ¤¹¡£


¡Ê°ìÉô¾ÊÎ¬¤·¤Þ¤¹¤Î¤Ç¡£¡Ë

&gt; ¤µ¤Æ¡¢ËÜÂê¤Ç¤¹¡£
&gt; Access97¤Ç¥Ç¥¶¥¤¥ó¤·¤¿¥Ç¡¼¥¿¥Ù¡¼¥¹¤òPostgreSQL¤Ë°Ü¤·¤Þ¤·¤¿¡£¼ç¥­¡¼¤ÎÌäÂê
(¤È
&gt; ¤ê¤¢¤¨¤ºserial¤Ï»È¤ï¤Ê¤¤¤³¤È¤Ë¤·¤Þ¤·¤¿)¤Ï²ò·è¤Ç¤­¤¿¤Î¤Ç¤¹¤¬¡¢Access¤Ç¤¤¤¦
¤È
&gt; ¤³¤í¤Î¥ê¥ì¡¼¥·¥ç¥ó¥·¥Ã¥×¤ò¤É¤¦¼Â¸½¤·¤¿¤é¤¤¤¤¤Î¤«Çº¤ó¤Ç¤¤¤Þ¤¹¡£
&gt; (PHP¤Ç¤É¤¦¥³¡¼¥Ç¥£¥ó¥°¤¹¤ë¤«¤ÎÌäÂê¤À¡¢¤È¤¤¤ï¤ì¤ì¤Ð¤½¤ì¤Þ¤Ç¤«¤âÃÎ¤ì¤Þ¤»¤ó
¤¬)
&gt; ²áµî¥í¥°¤ò¸¡º÷¤·¤¿¤ê¡¢¤¤¤í¤¤¤í¤Ê¥É¥­¥å¥á¥ó¥È¤ò¤¶¤Ã¤ÈÄ´¤Ù¤¿¤ê¤·¤¿¤Î¤Ç¤¹¤¬¡¢
¥ª
&gt; ¥ó¥é¥¤¥ó¥ê¥Õ¥¡¥ì¥ó¥¹¤ÎCREATE
&gt; TABLEÊ¸¤Î¹àÌÜ¤Ë¡Ö³°Éô¥­¡¼¤Ï¤Þ¤À¼ÂÁõ¤µ¤ì¤Æ¤¤¤Þ¤»¤ó¡£¤Ä¤®¤Î¥Ð¡¼¥¸¥ç¥ó¤Þ¤Ç¤ª
ÂÔ
&gt; ¤Á¤¯¤À¤µ¤¤¡£¤ª¤Ê¤¸¤³¤È¤¬CREATE
&gt; TRIGGERÊ¸¤Ç¼Â¸½¤Ç¤­¤Þ¤¹¡£¡×¤Î¤è¤¦¤Ê¤³¤È¤¬½ñ¤¤¤Æ¤¢¤ê¤Þ¤·¤¿¡£(°ã¤Ã¤Æ¤¤¤¿¤é¤´
¤á
&gt; ¤ó¤Ê¤µ¤¤)
&gt; ¤½¤³¤ÇCREATE
&gt; TRIGGERÊ¸¤Î¹àÌÜ¤òÄ´¤Ù¤ë¤È¡¢¥µ¥ó¥×¥ë¤¬¤Î¤Ã¤Æ¤¤¤¿¤Î¤Ç¡¢»ä¤ÏÄ¾´¶Åª¤Ë¤³¤ì¤À!¤È
»×
&gt; ¤¤¡¢¼¡¤Î¤è¤¦¤Ëµ­½Ò¤·¤Þ¤·¤¿¡£
&gt;
&gt; CREATE TRIGGER ÉÊÌÜid_exists
&gt;    BEFORE INSERT OR UPDATE ON ¾¦ÉÊ¥Þ¥¹¥¿.ÉÊÌÜid FOR EACH ROW
&gt;    EXECUTE PROCEDURE check_primary_key ('did', 'ÉÊÌÜ¥Þ¥¹¥¿', 'did');
&gt;
&gt; ¤·¤«¤·¡¢·ë²Ì¤Ï¡Öcheck_primary_key¤È¤¤¤¦´Ø¿ô¤ÏÂ¸ºß¤·¤Þ¤»¤ó¡£¡×¤È¤¤¤¦ÆâÍÆ¤Ç
¤·
&gt; ¤¿¡£
&gt;
&gt; ¤½¤Î¸å¤â¤¤¤í¤¤¤í¤È¥É¥­¥å¥á¥ó¥ÈÎà¤ò¿©¤Ã¤¿²þ¤á·«¤Ã¤¿¤Î¤Ç¤¹¤¬¡¢Ä´¤ÙÊý¤¬°­¤¤¤é
¤·
&gt; ¤¯¡¢¤È¤¦¤È¤¦¶ØÃÇ¤ÎMLÅê¹Æ¤ËÆ§¤ßÀÚ¤ê¤Þ¤·¤¿¡£
&gt;
&gt; ¤É¤Î¥É¥­¥å¥á¥ó¥È¤òÄ´¤Ù¤ì¤Ð¡¢¤³¤ÎÌäÂê¤¬²ò·è¤¹¤ë¤Î¤«¡¢¶µ¤¨¤Æ¤¯¤À¤µ¤¤¡£

EXECUTE PROCEDURE function ¤Ï "function" ´Ø¿ô¤ò¸Æ¤Ó½Ð¤¹¤È¤¤¤¦
°ÕÌ£¤Ç¤¢¤ê¡¢¤³¤Î¾ì¹ç¤Ï "check_primary_key" ´Ø¿ô¤ò¸Æ¤Ó½Ð¤¹
¤È¤¤¤¦¤³¤È¤Ë¤Ê¤ê¤Þ¤¹¤¬¤½¤Î´Ø¿ô¤¬ÅÐÏ¿¤µ¤ì¤Æ¤¤¤Ê¤¤¤¿¤á¤½¤¦¤¤¤¦
¥¨¥é¡¼¤¬½Ð¤ë¤Î¤Ç¤Ï¤Ê¤¤¤Ç¤·¤ç¤¦¤«¡£
¡Êcheck_primary_key ¤¬ÁÈ¤ß¹þ¤ß´Ø¿ô¡©¡©¤Ê¤éÉ¬Í×¤Ê¤¤¤Ç¤·¤ç¤¦¤¬¡¥¡¥¡¥¡Ë
´Ø¿ô¤òÅÐÏ¿¤¹¤ë¤Ë¤Ï create function ¤ÇÅÐÏ¿¤·¤Þ¤¹¡£


°Ê²¼¤Ë»ä¤¬¤ä¤Ã¤Æ¤¤¤ëÊýË¡¤Ç´ÊÃ±¤ËÀâÌÀ¤·¤Þ¤¹¡£

==============================================
¤Þ¤º¡¢¼¡¤Î£²¤Ä¤Î¥Æ¡¼¥Ö¥ë¤¬¤¢¤ë¤È¤·¤Þ¤¹¡£

/*** ¥Þ¥¹¥¿¥Æ¡¼¥Ö¥ë ***/
create table TB_MST (
  ID      integer not null unique,
  NAME    varchar(10),
  primary key(ID)
);

/*** ¥Þ¥¹¥¿»²¾È¥Æ¡¼¥Ö¥ë ***/
create table TB_REF (
  PKEY    varchar(10) not null,
  MST_ID  integer not null,
  primary key (PKEY)
);

¤³¤³¤Ç¡¢TB_MST.ID ¤È TB_REF.MST_ID ¤È¤Î»²¾ÈÀ°¹çÀ­¤ò
³ÎÎ©¤·¤¿¤¤¾ì¹ç¤Ï¼¡¤Î¥È¥ê¥¬¤È´Ø¿ô¤òºî¤ê¤Þ¤¹¡£
-----------------------------------------------------

/*
    ¡Ê¼¡¤Î´Ø¿ô¤Ï TG_REF_BIU¥È¥ê¥¬¤«¤é¸Æ¤Ð¤ì¤ë´Ø¿ô¡Ë
    ¤³¤ÎÃæ¤Ç¤Ï¡¢TB_MST¥Æ¡¼¥Ö¥ëÃæ¤Î new.MST_ID ¤Ç»ØÄê¤·¤¿
    ID ¤ò»ý¤Ä¥ì¥³¡¼¥É¿ô¤òÄ´¤Ù¡¢£±¤Ä¤â¤Ê¤¤¾ì¹ç¡¢Í×¤¹¤ë¤Ë
    ¥Þ¥¹¥¿¥Æ¡¼¥Ö¥ëÃæ¤ËÂ¸ºß¤·¤Ê¤¤ÃÍ¤òÆþ¤ì¤è¤¦¤È¤·¤¿¤È¤­¤Ë
    ÅÐÏ¿¡Ê¹¹¿·¡Ë¤Ç¤­¤Ê¤¤¤è¤¦¤·¤Þ¤¹¡£

    new ¤È¤ÏÄÉ²Ã¡Ê¹¹¿·¡Ë¤·¤è¤¦¤È¤·¤Æ¤¤¤ë¥ì¥³¡¼¥É
    ¤Î¤³¤È¤Ç new.MST_ID ¤Ï ¤½¤Î¥ì¥³¡¼¥ÉÃæ¤Î MST_ID
    ¥Õ¥£¡¼¥ë¥É¤Î¤³¤È¤Ç¤¹¡£

    raise exception ... ¤Ï¥ì¥³¡¼¥É¤òÅÐÏ¿¡Ê¹¹¿·¡Ë¤Ç¤­¤Ê¤¤
    ¤è¤¦¤Ë¤·¤Þ¤¹¡£
*/
create function TG_REF_BIU() returns opaque as '
begin
  if count(*) = 0 from TB_MST where ID = new.MST_ID then
    raise exception ''MST_ID "%" does not exist!'', new.MST_ID;
  end if;

  return new;
end;
' language 'plpgsql';

/*
    TB_REF¥Æ¡¼¥Ö¥ë¤Ø¤Î¥ì¥³¡¼¥É¤ÎÄÉ²ÃÁ°¡¢
    ¤Þ¤¿¤Ï¥ì¥³¡¼¥É¹¹¿·Á°ÍÑ¤Î¥È¥ê¥¬¤Ç¤¹¡£

    TG_REF_BIU()´Ø¿ô¤ò¸Æ¤Ó½Ð¤·¤Þ¤¹¡£
*/
create trigger TG_REF_BIU before insert or update
  on TB_REF for each row execute procedure TG_REF_BIU();

-----------------------------------------------------

¤³¤ì¤Ç¡¢TB_REF¥Æ¡¼¥Ö¥ë¤Ø¤Î¥ì¥³¡¼¥ÉÄÉ²Ã¡Ê¹¹¿·¡Ë»þ¤Ë
TB_MST.ID ¤ò»²¾È¥Á¥§¥Ã¥¯¤·¤Þ¤¹¤¬¡¢¤³¤ì¤À¤±¤À¤ÈÉÔ´°Á´¤Ç¡¢
º£ÅÙ¤Ï TB_REF ¥ì¥³¡¼¥É¤Î»²¾ÈÀè¤Î TB_MST ¥Æ¡¼¥Ö¥ë¤Î
ID ¤ÎÃÍ¤¬ÊÑ¹¹¤µ¤ì¤ë¤È¤­¤È¥ì¥³¡¼¥É¤¬ºï½ü¤µ¤ì¤ë¤È¤­¤Î½èÍý
¤¬É¬Í×¤Ë¤Ê¤ê¤Þ¤¹¡£Í×¤¹¤ë¤ËÁê¸ßÅª¤Ê¥Á¥§¥Ã¥¯¤¬É¬Í×¤È¤¤¤¦
¤³¤È¤Ç¤¹¡£
¤Þ¤¿¡¢£±ÂÐÂ¿¡¢Â¿ÂÐ£±¤Î»²¾È¤Î¾ì¹ç¤Ï¹¹¤ËÂ¿¤¯¤Îµ­½Ò¤¬
É¬Í×¤Ë¤Ê¤ë¤Î¤ÇÌÌÅÝ¤Ç¤¹¡£
ÀâÌÀÊ¸¤¬Ä¹¤¯¤Ê¤Ã¤Æ¤·¤Þ¤Ã¤¿¤Î¤Ç TB_MST ¥ì¥³¡¼¥É¤Î¹¹¿·¡¿ºï½ü
¥È¥ê¥¬¤ÎÀâÌÀ¤ò¾ÊÎ¬¤·¤Æ¤·¤Þ¤¤¤Þ¤·¤¿¡£¤¹¤ß¤Þ¤»¤ó¡£

¤Ê¤ª¡¢¤³¤ì¤é¤Î´Ø¿ô¤Ï PL/pgSQL ¤È¤¤¤¦¥æ¡¼¥¶´Ø¿ôÄêµÁ¸À¸ì
¤¬É¬Í×¤Ë¤Ê¤ê¡¢¥Ç¡¼¥¿¥Ù¡¼¥¹¡Ê¥¹¥­¡¼¥Þ¡ËÃ±°Ì¤ÇÁÈ¤ß¹þ¤à
É¬Í×¤¬¤¢¤ë¤Î¤Ç psql ¤Ê¤É¤Ç¼¡¤Î£Ó£Ñ£ÌÊ¸¤ò¤¢¤é¤«¤¸¤á
¼Â¹Ô¤·¤Æ¤ª¤¯É¬Í×¤¬¤¢¤ê¤Þ¤¹¡£

create function plpgsql_call_handler() returns opaque
  as '/usr/local/pgsql/lib/plpgsql.so'
  language 'C';

create trusted procedural language 'plpgsql'
  handler plpgsql_call_handler
  lancompiler 'PL/pgSQL';

'/usr/local/pgsql/lib/plpgsql.so' ¤Ï´Ä¶­¤Ë¹ç¤ï¤»¤Þ¤¹¡£

»ä¤â»È¤¤¤Ï¤¸¤á¤Æ¤Þ¤â¤Ê¤¤¤Î¤ÇÊ¸Ãæ¤Ë¸í¤ê¤¬¤¢¤ë¤«¤â¤·¤ì¤Þ¤»¤ó¤Î¤Ç¡¥¡¥¡¥


P.S.

¡¡»ä¤Î¾ì¹ç¤ÏÀÐ°æÃ£É×¤µ¤ó¤Î¡ÖPostgreSQL ´°Á´¹¶Î¬¥¬¥¤¥É¡×
¡¡¤È¤¦¤¤¤¦ËÜ¤ò»²¹Í¤Ë¤µ¤»¤Æ¤â¤é¤Ã¤Æ¤Þ¤¹¡£



£è£é£ô£ï£ó£è£é¡Ê¾®¾¾¡¡¿Î¡Ë
mls@hitoshi.ne.jp
hitoshi@hitoshi.ne.jp
</PRE>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<HR>
<!--X-Follow-Ups-End-->
<!--X-References-->
<UL><LI><STRONG>References</STRONG>:
<UL>
<LI><STRONG><A NAME="00112" HREF="msg00112.html">[pgsql-jp 11538] ¥È¥ê¥¬¡¼(TRIGGER)¤Ë¤è¤ë»²¾ÈÀ°¹çÀ­¤Ë¤Ä¤¤¤Æ¼ÁÌä</A></STRONG>
<UL><LI><EM>From:</EM> "¹â¿® Î¼" &lt;m_takanobu@hotmail.com&gt;</LI></UL></LI>
</UL></LI></UL>
<!--X-References-End-->
<!--X-BotPNI-->
<UL>
<LI>Prev by Date:
<STRONG><A HREF="msg00124.html">[pgsql-jp 11550] Re: ¥³¥ó¥Ñ¥¤¥ë¤Ç¤Ä¤Þ¤º¤¤¤Æ¤¤¤Þ¤¹¡£</A></STRONG>
</LI>
<LI>Next by Date:
<STRONG><A HREF="msg00125.html">[pgsql-jp 11551] Re: Re[2]: ¥¤¥ó¥¿¡¼¥Í¥Ã¥È·ÐÍ³¤Ç¥¯¥é¥¤¥¢¥ó¥È¡ÊMS-Access¡Ë¤«¤é¤Î¥Ç¡¼¥¿ÆþÎÏ</A></STRONG>
</LI>
<LI>Prev by thread:
<STRONG><A HREF="msg00122.html">[pgsql-jp 11548] Re: ¥È¥ê¥¬¡¼(TRIGGER)¤Ë¤è¤ë»²¾ÈÀ°¹çÀ­¤Ë¤Ä¤¤¤Æ¼ÁÌä</A></STRONG>
</LI>
<LI>Next by thread:
<STRONG><A HREF="msg00156.html">[pgsql-jp 11582] EUC¤Ç¤Î¥Ç¡¼¥¿Å¾Á÷¤Ë¤Ä¤¤¤Æ¡£¡£</A></STRONG>
</LI>
<LI>Index(es):
<UL>
<LI><A HREF="index.html#00123"><STRONG>Date</STRONG></A></LI>
<LI><A HREF="threads.html#00123"><STRONG>Thread</STRONG></A></LI>
</UL>
</LI>
</UL>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</BODY>
</HTML>
