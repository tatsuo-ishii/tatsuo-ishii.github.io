<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>7.3. AWS Configuration Example</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="pgpool-II 3.6.0 Documentation" /><link rel="up" href="example-configs.html" title="Chapter 7. Configuration Examples" /><link rel="prev" href="example-watchdog.html" title="7.2. Watchdog Configuration Example" /><link rel="next" href="reference.html" title="Part IV. Reference" /><link rel="copyright" href="legalnotice.html" title="Legal Notice" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">7.3. AWS Configuration Example</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="example-watchdog.html">Prev</a> </td><th width="60%" align="center">Chapter 7. Configuration Examples</th><td width="20%" align="right"> <a accesskey="n" href="reference.html">Next</a></td></tr></table><hr /></div><div class="sect1" id="example-aws"><div class="titlepage"><div><div><h2 class="title" style="clear: both">7.3. AWS Configuration Example</h2></div></div></div><p>      This tutrial explains the simple way to try "Watchdog"
      on <a class="ulink" href="https://aws.amazon.com/" target="_top">AWS</a> and using
      the <a class="ulink" href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html" target="_top">      Elastic IP Address</a> as the Virtual IP for the high availability solution.
      </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>        You can use watchdog with <span class="productname">        Pgpool-II</span> in any mode: replication mode,
        master/slave mode and raw mode.
        </p></div><p>
    </p><div class="sect2" id="example-aws-setup"><div class="titlepage"><div><div><h3 class="title">7.3.1. AWS Setup</h3></div></div></div><p>        For this example, we will use two node <span class="productname">        Pgpool-II</span> watchdog cluster. So we will set up two
        Linux Amazon EC2 instances and one Elastic IP address.
        So for this example, do the following steps:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>            Launch two Linux Amazon EC2 instances. For this example, we name these
            instances as "instance-1" and "instance-2"
          </p></li><li class="listitem"><p>           Configure the security group for the instances and allow inbound traffic
           on ports used by pgpool-II and watchdog.
          </p></li><li class="listitem"><p>           Install the <span class="productname">Pgpool-II</span> on both instances.
          </p></li><li class="listitem"><p>            Allocate an Elastic IP address.
            For this example, we will use "35.163.178.3" as an Elastic IP address"
          </p></li></ul></div></div><div class="sect2" id="example-aws-pgpool-config"><div class="titlepage"><div><div><h3 class="title">7.3.2. <span class="productname">Pgpool-II</span> configurations</h3></div></div></div><p>        Mostly the <span class="productname">Pgpool-II</span> configurations for this
        example will be same as in the <a class="xref" href="example-watchdog.html" title="7.2. Watchdog Configuration Example">Section 7.2, “Watchdog Configuration Example”</a>, except the
        <a class="xref" href="runtime-watchdog-config.html#guc-delegate-ip">delegate_IP</a> which we will not set in this example instead
        we will use <a class="xref" href="runtime-watchdog-config.html#guc-wd-escalation-command">wd_escalation_command</a> and
        <a class="xref" href="runtime-watchdog-config.html#guc-wd-de-escalation-command">wd_de_escalation_command</a> to switch the
        Elastic IP address to the maste/Active <span class="productname">Pgpool-II</span> node.
      </p><div class="sect3" id="example-aws-pgpool-config-instance-1"><div class="titlepage"><div><div><h4 class="title">7.3.2.1. <span class="productname">Pgpool-II</span> configurations on Instance-1</h4></div></div></div><p>
          </p><pre class="programlisting">use_watchdog = on
delegate_IP = ''
wd_hostname = 'instance-1-private-ip'
other_pgpool_hostname0 = 'instance-2-private-ip'
other_pgpool_port0 = 9999
other_wd_port0 = 9000
wd_escalation_command = '$path_to_script/aws-escalation.sh'
wd_de_escalation_command = '$path_to_script/aws-de-escalation.sh'
          </pre><p>

        </p></div><div class="sect3" id="example-aws-pgpool-config-instance-2"><div class="titlepage"><div><div><h4 class="title">7.3.2.2. <span class="productname">Pgpool-II</span> configurations on Instance-2</h4></div></div></div><p>
          </p><pre class="programlisting">use_watchdog = on
delegate_IP = ''
wd_hostname = 'instance-2-private-ip'
other_pgpool_hostname0 = 'instance-1-private-ip'
other_pgpool_port0 = 9999
other_wd_port0 = 9000
wd_escalation_command = '$path_to_script/aws-escalation.sh'
wd_de_escalation_command = '$path_to_script/aws-de-escalation.sh'
          </pre><p>

        </p></div></div><div class="sect2" id="example-aws-pgpool-aws-escalation-instance"><div class="titlepage"><div><div><h3 class="title">7.3.3. escalation and de-escalation Scripts</h3></div></div></div><p>        Create the aws-escalation.sh and aws-de-escalation.sh scripts on both
        instances and point the <a class="xref" href="runtime-watchdog-config.html#guc-wd-escalation-command">wd_escalation_command</a> and
        <a class="xref" href="runtime-watchdog-config.html#guc-wd-de-escalation-command">wd_de_escalation_command</a> to the respective scripts.
      </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>          You may need to configure the AWS CLI first on all AWS instances
          to enable the execution of commands used by wd-escalation.sh and wd-de-escalation.sh.
          See <a class="ulink" href="http://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html" target="_top">configure AWS CLI</a>
        </p></div><div class="sect3" id="example-aws-pgpool-aws-escalation-script"><div class="titlepage"><div><div><h4 class="title">7.3.3.1. escalation script</h4></div></div></div><p>        This script will be executed by the watchdog
        to assign the Elastic IP on the instance when the watchdog becomes the active/master node.
        Change the INSTANCE_ID and ELASTIC_IP values as per your AWS setup values.
      </p><p>        <span class="emphasis"><em>aws-escalation.sh:</em></span>
        </p><pre class="programlisting">#! /bin/sh

ELASTIC_IP=35.163.178.3
                        # replace it with the Elastic IP address you
                        # allocated from the aws console
INSTANCE_ID=i-0a9b64e449b17ed4b
                        # replace it with the instance id of the Instance
                        # this script is installed on

echo "Assigning Elastic IP $ELASTIC_IP to the instance $INSTANCE_ID"
# bring up the Elastic IP
aws ec2 associate-address --instance-id $INSTANCE_ID --public-ip $ELASTIC_IP

exit 0
        </pre><p>

      </p></div><div class="sect3" id="example-aws-pgpool-aws-de-escalation-script"><div class="titlepage"><div><div><h4 class="title">7.3.3.2. de-escalation script</h4></div></div></div><p>        This script will be executed by watchdog
        to remove the Elastic IP from the instance when the watchdog resign from the active/master node.
      </p><p>      <span class="emphasis"><em>aws-de-escalation.sh:</em></span>
        </p><pre class="programlisting">#! /bin/sh

ELASTIC_IP=35.163.178.3
                        # replace it with the Elastic IP address you
                        # allocated from the aws console

echo "disassociating the Elastic IP $ELASTIC_IP from the instance"
# bring down the Elastic IP
aws ec2 disassociate-address --public-ip $ELASTIC_IP
exit 0
          </pre><p>
        </p></div><div class="bibliography" id="idp58328784"><div class="titlepage"><div><div><h4 class="title">AWS Command References</h4></div></div></div><div class="biblioentry" id="idp58329200"><p><span class="biblioset">“<a class="ulink" href="http://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html" target="_top">Configure AWS CLI</a>”. </span><span class="biblioset"><em>AWS Documentation: Configuring the AWS Command Line Interface</em>. </span></p></div><div class="biblioentry" id="idp58331216"><p><span class="biblioset">“<a class="ulink" href="http://docs.aws.amazon.com/cli/latest/reference/ec2/associate-address.html" target="_top">associate-address</a>”. </span><span class="biblioset"><em>AWS Documentation: associate-address reference</em>. </span></p></div><div class="biblioentry" id="idp58333152"><p><span class="biblioset">“<a class="ulink" href="http://docs.aws.amazon.com/cli/latest/reference/ec2/disassociate-address.html" target="_top">disassociate-address</a>”. </span><span class="biblioset"><em>AWS Documentation: disassociate-address reference</em>. </span></p></div></div></div><div class="sect2" id="example-aws-try"><div class="titlepage"><div><div><h3 class="title">7.3.4. Try it out</h3></div></div></div><p>        Start <span class="productname">Pgpool-II</span> on each server with "-n" switch
        and redirect log messages to the pgpool.log file.
        The log message of master/active <span class="productname">Pgpool-II</span> node
        will show the message of Elastic IP assignment.
        </p><pre class="programlisting">LOG:  I am the cluster leader node. Starting escalation process
LOG:  escalation process started with PID:23543
LOG:  watchdog: escalation started
<span class="emphasis"><strong>Assigning Elastic IP 35.163.178.3 to the instance i-0a9b64e449b17ed4b
{
    "AssociationId": "eipassoc-39853c42"
}</strong></span>
LOG:  watchdog escalation successful
LOG:  watchdog escalation process with pid: 23543 exit with SUCCESS.
        </pre><p>
      </p><p>        Confirm to ping to the Elastic IP address.
        </p><pre class="programlisting">[user@someserver]$ ping 35.163.178.3
PING 35.163.178.3 (35.163.178.3) 56(84) bytes of data.
64 bytes from 35.163.178.3: icmp_seq=1 ttl=64 time=0.328 ms
64 bytes from 35.163.178.3: icmp_seq=2 ttl=64 time=0.264 ms
64 bytes from 35.163.178.3: icmp_seq=3 ttl=64 time=0.412 ms
        </pre><p>
     </p><p>        Try to connect <span class="productname">PostgreSQL</span> by "psql -h ELASTIC_IP -p port".
        </p><pre class="programlisting">[user@someserver]$ psql -h 35.163.178.3 -p 9999 -l
        </pre><p>
      </p></div><div class="sect2" id="example-aws-vip-switch"><div class="titlepage"><div><div><h3 class="title">7.3.5. Switching Elastic IP</h3></div></div></div><p>        To confirm if the Standby server acquires the Elastic IP when the
        Active server becomes unavailable, Stop the <span class="productname">Pgpool-II</span>
        on the Active server. Then, the Standby server should start using the Elastic IP address,
        And the <span class="productname">Pgpool-II</span> log will show the below messages.

        </p><pre class="programlisting"><span class="emphasis"><strong>LOG:  remote node "172.31.2.94:9999 [Linux ip-172-31-2-94]" is shutting down
LOG:  watchdog cluster has lost the coordinator node</strong></span>
LOG:  watchdog node state changed from [STANDBY] to [JOINING]
LOG:  watchdog node state changed from [JOINING] to [INITIALIZING]
LOG:  I am the only alive node in the watchdog cluster
HINT:  skiping stand for coordinator state
LOG:  watchdog node state changed from [INITIALIZING] to [MASTER]
LOG:  I am announcing my self as master/coordinator watchdog node
LOG:  I am the cluster leader node
DETAIL:  our declare coordinator message is accepted by all nodes
LOG:  I am the cluster leader node. Starting escalation process
LOG:  escalation process started with PID:23543
LOG:  watchdog: escalation started
<span class="emphasis"><strong>Assigning Elastic IP 35.163.178.3 to the instance i-0dd3e60734a6ebe14
{
    "AssociationId": "eipassoc-39853c42"
}</strong></span>
LOG:  watchdog escalation successful
LOG:  watchdog escalation process with pid: 61581 exit with SUCCESS.
        </pre><p>
         Confirm to ping to the Elastic IP address again.
        </p><pre class="programlisting">[user@someserver]$ ping 35.163.178.3
PING 35.163.178.3 (35.163.178.3) 56(84) bytes of data.
64 bytes from 35.163.178.3: icmp_seq=1 ttl=64 time=0.328 ms
64 bytes from 35.163.178.3: icmp_seq=2 ttl=64 time=0.264 ms
64 bytes from 35.163.178.3: icmp_seq=3 ttl=64 time=0.412 ms
        </pre><p>
      </p><p>        Try to connect <span class="productname">PostgreSQL</span> by "psql -h ELASTIC_IP -p port".
        </p><pre class="programlisting">[user@someserver]$ psql -h 35.163.178.3 -p 9999 -l
        </pre><p>
      </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="example-watchdog.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="example-configs.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="reference.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">7.2. Watchdog Configuration Example </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Part IV. Reference</td></tr></table></div></body></html>