<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>5.10. Online Recovery</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="pgpool-II 3.6.0 Documentation" /><link rel="up" href="runtime-config.html" title="Chapter 5. Server Configuration" /><link rel="prev" href="runtime-config-failover.html" title="5.9. Failover and Failback" /><link rel="next" href="runtime-streaming-replication-check.html" title="5.11. Streaming Replication Check" /><link rel="copyright" href="legalnotice.html" title="Legal Notice" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">5.10. Online Recovery</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="runtime-config-failover.html">Prev</a> </td><th width="60%" align="center">Chapter 5. Server Configuration</th><td width="20%" align="right"> <a accesskey="n" href="runtime-streaming-replication-check.html">Next</a></td></tr></table><hr /></div><div class="sect1" id="runtime-online-recovery"><div class="titlepage"><div><div><h2 class="title" style="clear: both">5.10. Online Recovery</h2></div></div></div><p>    <span class="productname">Pgpool-II</span> can synchronize database nodes and attach
	a node without stopping the service.
    This feature is called <acronym class="acronym">"online recovery"</acronym>.
  </p><p>    For online recovery, the recovery target node must be detached from <span class="productname">Pgpool-II</span>.
    If you wish to add a <span class="productname">PostgreSQL</span> server node dynamically, reload the
    <code class="filename">pgpool.conf</code> after adding the
    <a class="xref" href="runtime-config-backend-settings.html#guc-backend-hostname">backend_hostname</a> and its associated parameters.
    This will register the new server to <span class="productname">Pgpool-II</span> as a detached backend node.
  </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>      The recovery target <span class="productname">PostgreSQL</span> server must not be running for performing the online recovery.
      If the target <span class="productname">PostgreSQL</span> server has already started, you must shut it down before
      starting the online recovery.
    </p></div><p>    Online recovery is performed in two phases. Connections from cliens are
    not allowd only in second phase of online recovery while the data can be
    updated or retrieved during the first phase.
    <span class="productname">Pgpool-II</span> performs the follows steps in online recovery:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>        CHECKPOINT.
      </p></li><li class="listitem"><p>        First stage of online recovery.
      </p></li><li class="listitem"><p>        Wait until all client connections have disconnected.
      </p></li><li class="listitem"><p>        CHECKPOINT.
      </p></li><li class="listitem"><p>        Second stage of online recovery.
      </p></li><li class="listitem"><p>        Start up postmaster (perform <code class="literal">pgpool_remote_start</code>)
      </p></li><li class="listitem"><p>        Node attach
      </p></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>      There is a restriction in the online recovery. If
      <span class="productname">Pgpool-II</span> itself is installed
      on multiple hosts, online recovery does not work correctly,
      because <span class="productname">Pgpool-II</span> has to stop all
      the clients during the 2nd stage of online recovery.
      If there are several <span class="productname">Pgpool-II</span> hosts,
      only one of them will have received the online recovery command and will
      block the connections from clients.
    </p></div><div class="variablelist"><dl class="variablelist"><dt id="guc-recovery-user"><span class="term"><code class="varname">recovery_user</code> (<code class="type">string</code>)
        <a id="idp57467024" class="indexterm"></a>
      </span></dt><dd><p>        Specifies the <span class="productname">PostgreSQL</span> user name to perform online recovery.
      </p><p>          This parameter can be changed by reloading the <span class="productname">Pgpool-II</span> configurations.
        </p></dd><dt id="guc-recovery-password"><span class="term"><code class="varname">recovery_password</code> (<code class="type">string</code>)
        <a id="idp57472192" class="indexterm"></a>
      </span></dt><dd><p>          Specifies the password for the <span class="productname">PostgreSQL</span> user name configured in
          <a class="xref" href="runtime-online-recovery.html#guc-recovery-user">recovery_user</a> to perform online recovery.
        </p><p>          This parameter can be changed by reloading the <span class="productname">Pgpool-II</span> configurations.
        </p></dd><dt id="guc-recovery-1st-stage-command"><span class="term"><code class="varname">recovery_1st_stage_command</code> (<code class="type">string</code>)
        <a id="idp57478192" class="indexterm"></a>
      </span></dt><dd><p>          Specifies a command to be run by master(primary) node at the
          first stage of online recovery. The command file must be placed in the
          database cluster directory for security reasons.
          For example, if <code class="varname">recovery_1st_stage_command</code> = <code class="literal">          'sync-command'</code>, then <span class="productname">Pgpool-II</span> will
          look for the command scrit in <code class="literal">$PGDATA</code> directory and will
          try to execute <code class="command">$PGDATA/sync-command</code>.
        </p><p>          <code class="varname">recovery_1st_stage_command</code> receives following 4 parameters:
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>              Path to the database cluster of the master(primary) node.
            </p></li><li class="listitem"><p>              Hostname of the backend node to be recovered.
            </p></li><li class="listitem"><p>              Path to the database cluster of the node to be recovered.
            </p></li><li class="listitem"><p>              Port number of the master(primary) node.
            </p></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>            <span class="productname">Pgpool-II</span> accept connections and queries
            while <code class="varname">recovery_1st_stage command</code> is executed,
            so you can retrieve and update data.
          </p></div><div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Caution</h3><p>            <code class="varname">recovery_1st_stage command</code> runs as a <acronym class="acronym">SQL</acronym>
            command from PostgreSQL's point of view. So <code class="varname">recovery_1st_stage command
            </code> can get prematuraly killed by PostgreSQL if the PostgreSQL's
            <code class="varname">statement_time_out</code> is configured with the value that is
            smaller than the time <code class="varname">recovery_1st_stage_command</code> takes for
            completion.
          </p><p>            Typical error in such case is
            </p><pre class="programlisting">rsync used in the command is killed by signal 2 for example.
            </pre><p>
          </p></div><p>          This parameter can be changed by reloading the <span class="productname">Pgpool-II</span> configurations.
        </p></dd><dt id="guc-recovery-2nd-stage-command"><span class="term"><code class="varname">recovery_2nd_stage_command</code> (<code class="type">string</code>)
        <a id="idp57494672" class="indexterm"></a>
      </span></dt><dd><p>          Specifies a command to be run by master(primary) node at the
          second stage of online recovery. The command file must be placed in the
          database cluster directory for security reasons.
          For example, if <code class="varname">recovery_2nd_stage_command</code> = <code class="literal">          'sync-command'</code>, then <span class="productname">Pgpool-II</span> will
          look for the command scrit in <code class="literal">$PGDATA</code> directory and will
          try to execute <code class="command">$PGDATA/sync-command</code>.
        </p><p>          <code class="varname">recovery_2nd_stage_command</code> receives following 4 parameters:
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>              Path to the database cluster of the master(primary) node.
            </p></li><li class="listitem"><p>              Hostname of the backend node to be recovered.
            </p></li><li class="listitem"><p>              Path to the database cluster of the node to be recovered.
            </p></li><li class="listitem"><p>              Port number of database to be recovered.
            </p></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>            <span class="productname">Pgpool-II</span> <span class="emphasis"><em>does not</em></span>
            accept client connections and queries during the execution
            of <code class="varname">recovery_2nd_stage_command</code> command, and waits
            for the existing clients to close their connections before executing the
            command.
            Therefore, the <code class="varname">recovery_2nd_stage_command</code> may not execute
            if the client stays connected for a long time.
          </p></div><div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Caution</h3><p>            <code class="varname">recovery_2nd_stage command</code> runs as a <acronym class="acronym">SQL</acronym>
            command from PostgreSQL's point of view. Therefore, <code class="varname">recovery_2nd_stage command
            </code> can get prematuraly killed by PostgreSQL if the PostgreSQL's
            <code class="varname">statement_time_out</code> is configured with the value that is
            smaller than the time <code class="varname">recovery_2nd_stage_command</code> takes for
            completion.
          </p></div><p>          This parameter can be changed by reloading the <span class="productname">Pgpool-II</span> configurations.
        </p></dd><dt id="guc-recovery-timeout"><span class="term"><code class="varname">recovery_timeout</code> (<code class="type">integer</code>)
        <a id="idp57511136" class="indexterm"></a>
      </span></dt><dd><p>          Specifies the timeout in seconds to cancel the online recovery if it
          does not completes within this time.
          Since <span class="productname">Pgpool-II</span> does not accepts the connections
          during the second stage of online recovery, this parameter can be used to cancel
          the online recovery to manage the service down time during the online recovery.
        </p><p>          This parameter can be changed by reloading the <span class="productname">Pgpool-II</span> configurations.
        </p></dd><dt id="guc-client-idle-limit-in-recovery"><span class="term"><code class="varname">client_idle_limit_in_recovery</code> (<code class="type">integer</code>)
        <a id="idp57516624" class="indexterm"></a>
      </span></dt><dd><p>          Specifies the time in seconds to disconnect a client if it remains idle
          since the last query during the online recovery.
          <code class="varname">client_idle_limit_in_recovery</code> is similar to the
          <a class="xref" href="runtime-config-connection-pooling.html#guc-client-idle-limit">client_idle_limit</a> but only takes effect during the
          second stage of online recovery.
        </p><p>          This is useful for preventing the <span class="productname">Pgpool-II</span>
          recovery from being disturbed by the lazy clients or if the TCP/IP
          connection between the client and <span class="productname">Pgpool-II</span>
          is accidentally down (a cut cable for instance).
        </p><p>          If set to -1, all clients get immediately disconnected when the second
          stage of online recovery starts.
          The default is 0, which turns off the feature.
        </p><p>          This parameter can be changed by reloading the <span class="productname">Pgpool-II</span> configurations.
					You can also use <a class="xref" href="sql-pgpool-set.html" title="PGPOOL SET"><span class="refentrytitle">PGPOOL SET</span></a> command to alter the value of
					this parameter for a current session.
        </p></dd></dl></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="runtime-config-failover.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="runtime-config.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="runtime-streaming-replication-check.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">5.9. Failover and Failback </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 5.11. Streaming Replication Check</td></tr></table></div></body></html>