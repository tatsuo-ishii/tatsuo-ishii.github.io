<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>7.2. Watchdog Configuration Example</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="pgpool-II 3.6.0 Documentation" /><link rel="up" href="example-configs.html" title="Chapter 7. Configuration Examples" /><link rel="prev" href="example-basic.html" title="7.1. Basic Configuration Example" /><link rel="next" href="example-aws.html" title="7.3. AWS Configuration Example" /><link rel="copyright" href="legalnotice.html" title="Legal Notice" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">7.2. Watchdog Configuration Example</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="example-basic.html">Prev</a> </td><th width="60%" align="center">Chapter 7. Configuration Examples</th><td width="20%" align="right"> <a accesskey="n" href="example-aws.html">Next</a></td></tr></table><hr /></div><div class="sect1" id="example-watchdog"><div class="titlepage"><div><div><h2 class="title" style="clear: both">7.2. Watchdog Configuration Example</h2></div></div></div><p>      This tutrial explains the simple way to try "Watchdog".
      What you need is 2 Linux boxes on which <span class="productname">      Pgpool-II</span> is installed and a <span class="productname">PostgreSQL</span>
      on the same machine or in the other one. It is enough
      that 1 node for backend exists.
      You can use watchdog with <span class="productname">      Pgpool-II</span> in any mode: replication mode,
      master/slave mode and raw mode.
    </p><p>      This example uses use "osspc16" as an Active node and
      "osspc20" as a Standby node. "Someserver" means one of them.
    </p><div class="sect2" id="example-watchdog-configuration"><div class="titlepage"><div><div><h3 class="title">7.2.1. Common configurations</h3></div></div></div><p>        Set the following parameters in both of active and standby nodes.
      </p><div class="sect3" id="example-watchdog-config-enable"><div class="titlepage"><div><div><h4 class="title">7.2.1.1. Enabling watchdog</h4></div></div></div><p>          First of all, set <a class="xref" href="runtime-watchdog-config.html#guc-use-watchdog">use_watchdog</a> to on.
          </p><pre class="programlisting">use_watchdog = on
                                    # Activates watchdog
          </pre><p>
        </p></div><div class="sect3" id="example-watchdog-config-upstream"><div class="titlepage"><div><div><h4 class="title">7.2.1.2. Configure Up stream servers</h4></div></div></div><p>          Specify the up stream servers (e.g. application servers).
          Leaving it blank is also fine.
          </p><pre class="programlisting">trusted_servers = ''
                                    # trusted server list which are used
                                    # to confirm network connection
                                    # (hostA,hostB,hostC,...)
          </pre><p>
        </p></div><div class="sect3" id="example-watchdog-config-wd-comm"><div class="titlepage"><div><div><h4 class="title">7.2.1.3. Watchdog Communication</h4></div></div></div><p>          Specify the TCP port number for watchdog communication.
          </p><pre class="programlisting">wd_port = 9000
                                    # port number for watchdog service
          </pre><p>
        </p></div><div class="sect3" id="example-watchdog-config-wd-vip"><div class="titlepage"><div><div><h4 class="title">7.2.1.4. Virtual IP</h4></div></div></div><p>          Specify the IP address to be used as a virtual IP address
          in the <a class="xref" href="runtime-watchdog-config.html#guc-delegate-ip">delegate_IP</a>.
          </p><pre class="programlisting">delegate_IP = '133.137.177.143'
                                    # delegate IP address
          </pre><p>
        </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>            Make sure the IP address configured as a Virtual IP should be
            free and is not used by any other machine.
          </p></div></div></div><div class="sect2" id="example-watchdog-configuration-each-server"><div class="titlepage"><div><div><h3 class="title">7.2.2. Individual Server Configurations</h3></div></div></div><p>        Next, set the following parameters for each <span class="productname">        Pgpool-II</span>.
        Specify <a class="xref" href="runtime-watchdog-config.html#guc-other-pgpool-hostname">other_pgpool_hostname</a>,
        <a class="xref" href="runtime-watchdog-config.html#guc-other-pgpool-port">other_pgpool_port</a> and
        <a class="xref" href="runtime-watchdog-config.html#guc-other-wd-port">other_wd_port</a> with the values of
        other <span class="productname">Pgpool-II</span> server values.
      </p><div class="sect3" id="example-watchdog-configuration-active-server"><div class="titlepage"><div><div><h4 class="title">7.2.2.1. Active (osspc16) Server configurations</h4></div></div></div><p>          </p><pre class="programlisting">other_pgpool_hostname0 = 'osspc20'
                                    # Host name or IP address to connect to for other pgpool 0
other_pgpool_port0 = 9999
                                    # Port number for othet pgpool 0
other_wd_port0 = 9000
                                    # Port number for othet watchdog 0
          </pre><p>
        </p></div><div class="sect3" id="example-watchdog-configuration-standby-server"><div class="titlepage"><div><div><h4 class="title">7.2.2.2. Standby (osspc20) Server configurations</h4></div></div></div><p>          </p><pre class="programlisting">other_pgpool_hostname0 = 'osspc16'
                                    # Host name or IP address to connect to for other pgpool 0
other_pgpool_port0 = 9999
                                    # Port number for othet pgpool 0
other_wd_port0 = 9000
                                    # Port number for othet watchdog 0
          </pre><p>
        </p></div></div><div class="sect2" id="example-watchdog-start-server"><div class="titlepage"><div><div><h3 class="title">7.2.3. Starting <span class="productname">Pgpool-II</span></h3></div></div></div><p>        Start <span class="productname">Pgpool-II</span> on each servers from
        <code class="literal">root</code> user with <code class="literal">"-n"</code> switch
        and redirect log messages into pgpool.log file.
      </p><div class="sect3" id="example-watchdog-start-active-server"><div class="titlepage"><div><div><h4 class="title">7.2.3.1. Starting pgpool in Active server (osspc16)</h4></div></div></div><p>          First start the <span class="productname">Pgpool-II</span> on Active server.
          </p><pre class="programlisting">[user@osspc16]$ su -
[root@osspc16]# {installed_dir}/bin/pgpool -n -f {installed_dir}/etc/pgpool.conf &gt; pgpool.log 2&gt;&amp;1
          </pre><p>
          Log messages will show that <span class="productname">Pgpool-II</span>
          has the virtual IP address and starts watchdog process.
          </p><pre class="programlisting">LOG:  I am announcing my self as master/coordinator watchdog node
LOG:  I am the cluster leader node
DETAIL:  our declare coordinator message is accepted by all nodes
LOG:  I am the cluster leader node. Starting escalation process
LOG:  escalation process started with PID:59449
<span class="emphasis"><strong>LOG:  watchdog process is initialized
LOG:  watchdog: escalation started
LOG:  I am the master watchdog node</strong></span>
DETAIL:  using the local backend node status
          </pre><p>
        </p></div><div class="sect3" id="example-watchdog-start-standby-server"><div class="titlepage"><div><div><h4 class="title">7.2.3.2. Starting pgpool in Standby server (osspc20)</h4></div></div></div><p>          Now start the <span class="productname">Pgpool-II</span> on Standby server.
          </p><pre class="programlisting">[user@osspc20]$ su -
[root@osspc20]# {installed_dir}/bin/pgpool -n -f {installed_dir}/etc/pgpool.conf &gt; pgpool.log 2&gt;&amp;1
          </pre><p>
          Log messages will show that <span class="productname">Pgpool-II</span>
          has joind the watchdog cluster as standby watchdog.
          </p><pre class="programlisting">LOG:  watchdog cluster configured with 1 remote nodes
LOG:  watchdog remote node:0 on Linux_osspc16_9000:9000
LOG:  interface monitoring is disabled in watchdog
LOG:  IPC socket path: "/tmp/.s.PGPOOLWD_CMD.9000"
LOG:  watchdog node state changed from [DEAD] to [LOADING]
LOG:  new outbond connection to Linux_osspc16_9000:9000
LOG:  watchdog node state changed from [LOADING] to [INITIALIZING]
LOG:  watchdog node state changed from [INITIALIZING] to [STANDBY]
<span class="emphasis"><strong>LOG:  successfully joined the watchdog cluster as standby node
DETAIL:  our join coordinator request is accepted by cluster leader node "Linux_osspc16_9000"
LOG:  watchdog process is initialized</strong></span>
          </pre><p>
        </p></div></div><div class="sect2" id="example-watchdog-try"><div class="titlepage"><div><div><h3 class="title">7.2.4. Try it out</h3></div></div></div><p>      Confirm to ping to the virtual IP address.
      </p><pre class="programlisting">[user@someserver]$ ping 133.137.177.142
PING 133.137.177.143 (133.137.177.143) 56(84) bytes of data.
64 bytes from 133.137.177.143: icmp_seq=1 ttl=64 time=0.328 ms
64 bytes from 133.137.177.143: icmp_seq=2 ttl=64 time=0.264 ms
64 bytes from 133.137.177.143: icmp_seq=3 ttl=64 time=0.412 ms
      </pre><p>
      Confirm if the Active server which started at first has the virtual IP address.
      </p><pre class="programlisting">[root@osspc16]# ifconfig
eth0      ...

eth0:0    inet addr:133.137.177.143 ...

lo        ...
      </pre><p>
      Confirm if the Standby server which started not at first doesn't have the virtual IP address.
      </p><pre class="programlisting">[root@osspc20]# ifconfig
eth0      ...

lo        ...
      </pre><p>

      Try to connect <span class="productname">PostgreSQL</span> by "psql -h delegate_IP -p port".
      </p><pre class="programlisting">[user@someserver]$ psql -h 133.137.177.142 -p 9999 -l
      </pre><p>
      </p></div><div class="sect2" id="example-watchdog-vip-switch"><div class="titlepage"><div><div><h3 class="title">7.2.5. Switching virtual IP</h3></div></div></div><p>        Confirm how the Standby server works when the Active server can't provide its service.
        Stop <span class="productname">Pgpool-II</span> on the Active server.
        </p><pre class="programlisting">[root@osspc16]# {installed_dir}/bin/pgpool stop
      </pre><p>

      Then, the Standby server starts to use the virtual IP address. Log shows:

        </p><pre class="programlisting"><span class="emphasis"><strong>LOG:  remote node "Linux_osspc16_9000" is shutting down
LOG:  watchdog cluster has lost the coordinator node</strong></span>
LOG:  watchdog node state changed from [STANDBY] to [JOINING]
LOG:  watchdog node state changed from [JOINING] to [INITIALIZING]
LOG:  I am the only alive node in the watchdog cluster
HINT:  skiping stand for coordinator state
LOG:  watchdog node state changed from [INITIALIZING] to [MASTER]
LOG:  I am announcing my self as master/coordinator watchdog node
LOG:  I am the cluster leader node
DETAIL:  our declare coordinator message is accepted by all nodes
<span class="emphasis"><strong>LOG:  I am the cluster leader node. Starting escalation process
LOG:  watchdog: escalation started</strong></span>
LOG:  watchdog escalation process with pid: 59551 exit with SUCCESS.
         </pre><p>

         Confirm to ping to the virtual IP address.
         </p><pre class="programlisting">[user@someserver]$ ping 133.137.177.142
PING 133.137.177.143 (133.137.177.143) 56(84) bytes of data.
64 bytes from 133.137.177.143: icmp_seq=1 ttl=64 time=0.328 ms
64 bytes from 133.137.177.143: icmp_seq=2 ttl=64 time=0.264 ms
64 bytes from 133.137.177.143: icmp_seq=3 ttl=64 time=0.412 ms
      </pre><p>

         Confirm that the Active server doesn't use the virtual IP address any more.
         </p><pre class="programlisting">[root@osspc16]# ifconfig
eth0      ...

lo        ...
        </pre><p>

         Confirm that the Standby server uses the virtual IP address.
         </p><pre class="programlisting">[root@osspc20]# ifconfig
eth0      ...

eth0:0    inet addr:133.137.177.143 ...

lo        ...
        </pre><p>

        Try to connect <span class="productname">PostgreSQL</span> by "psql -h delegate_IP -p port".
        </p><pre class="programlisting">[user@someserver]$ psql -h 133.137.177.142 -p 9999 -l
        </pre><p>

      </p></div><div class="sect2" id="example-watchdog-more"><div class="titlepage"><div><div><h3 class="title">7.2.6. More</h3></div></div></div><div class="sect3" id="example-watchdog-more-lifecheck"><div class="titlepage"><div><div><h4 class="title">7.2.6.1. Lifecheck</h4></div></div></div><p>          There are the parameters about watchdog's monitoring.
          Specify the interval to check <a class="xref" href="runtime-watchdog-config.html#guc-wd-interval">wd_interval</a>,
          the count to retry <a class="xref" href="runtime-watchdog-config.html#guc-wd-life-point">wd_life_point</a>,
          the qyery to check <a class="xref" href="runtime-watchdog-config.html#guc-wd-lifecheck-query">wd_lifecheck_query</a> and
          finaly the type of lifecheck <a class="xref" href="runtime-watchdog-config.html#guc-wd-lifecheck-method">wd_lifecheck_method</a>.
          </p><pre class="programlisting">wd_lifecheck_method = 'query'
                                    # Method of watchdog lifecheck ('heartbeat' or 'query' or 'external')
                                    # (change requires restart)
wd_interval = 10
                                    # lifecheck interval (sec) &gt; 0
wd_life_point = 3
                                    # lifecheck retry times
wd_lifecheck_query = 'SELECT 1'
                                    # lifecheck query to pgpool from watchdog
        </pre><p>

        </p></div><div class="sect3" id="example-watchdog-more-vip-switching"><div class="titlepage"><div><div><h4 class="title">7.2.6.2. Switching virtual IP address</h4></div></div></div><p>          There are the parameters for switching the virtual IP address.
          Specify switching commands <a class="xref" href="runtime-watchdog-config.html#guc-if-up-cmd">if_up_cmd</a>,
          <a class="xref" href="runtime-watchdog-config.html#guc-if-down-cmd">if_down_cmd</a>, the path to them
          <a class="xref" href="runtime-watchdog-config.html#guc-if-cmd-path">if_cmd_path</a>, the command executed after
          switching to send ARP request <a class="xref" href="runtime-watchdog-config.html#guc-arping-cmd">arping_cmd</a>
          and the path to it <a class="xref" href="runtime-watchdog-config.html#guc-arping-path">arping_path</a>.
          </p><pre class="programlisting">ifconfig_path = '/sbin'
                                    # ifconfig command path
if_up_cmd = 'ifconfig eth0:0 inet $_IP_$ netmask 255.255.255.0'
                                    # startup delegate IP command
if_down_cmd = 'ifconfig eth0:0 down'
                                    # shutdown delegate IP command

arping_path = '/usr/sbin'           # arping command path

arping_cmd = 'arping -U $_IP_$ -w 1'
        </pre><p>
        You can also use the custom scripts to bring up and bring down the
        virtual IP using <a class="xref" href="runtime-watchdog-config.html#guc-wd-escalation-command">wd_escalation_command</a> and
        <a class="xref" href="runtime-watchdog-config.html#guc-wd-de-escalation-command">wd_de_escalation_command</a> configurations.
        </p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="example-basic.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="example-configs.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="example-aws.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">7.1. Basic Configuration Example </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 7.3. AWS Configuration Example</td></tr></table></div></body></html>