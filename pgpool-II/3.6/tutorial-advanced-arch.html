<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>2.4. Architecure of the watchdog</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="pgpool-II 3.6beta2 Documentation" /><link rel="up" href="tutorial-watchdog.html" title="Chapter 2. Watchdog" /><link rel="prev" href="tutorial-watchdog-restrictions.html" title="2.3. Restrictions on watchdog" /><link rel="next" href="admin.html" title="Part II. Server Administration" /><link rel="copyright" href="legalnotice.html" title="Legal Notice" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">2.4. Architecure of the watchdog</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="tutorial-watchdog-restrictions.html">Prev</a> </td><th width="60%" align="center">Chapter 2. Watchdog</th><td width="20%" align="right"> <a accesskey="n" href="admin.html">Next</a></td></tr></table><hr /></div><div class="sect1" id="tutorial-advanced-arch"><div class="titlepage"><div><div><h2 class="title" style="clear: both">2.4. Architecure of the watchdog</h2></div></div></div><p>      Watchdog is a sub process of <span class="productname">Pgpool-II</span>,
      which adds the high availability and resolves the single point of
      failure by coordinating multiple <span class="productname">Pgpool-II</span>.
      The watchdog process automatically starts (if enabled) when the
      <span class="productname">Pgpool-II</span> starts up and consists of two
      main components, Watchdog core and the lifecheck system.
    </p><div class="sect2" id="tutorial-advanced-arch-wd-core"><div class="titlepage"><div><div><h3 class="title">2.4.1. Watchdog Core</h3></div></div></div><p>          Watchdog core referred as a "watchdog" is a
          <span class="productname">Pgpool-II</span> child process that
          manages all the watchdog related communications with the
          <span class="productname">Pgpool-II</span> nodes present in the
          cluster and also communicates with the <span class="productname">Pgpool-II</span>
          parent and lifecheck processes.
        </p><p>          The heart of a watchdog process is a state machine that starts
          from its initial state (<code class="literal">WD_LOADING</code>) and transit
          towards either standby (<code class="literal">WD_STANDBY</code>) or
          master/coordinator (<code class="literal">WD_COORDINATOR</code>) state.
          Both standby and master/coordinator states are stable states of the
          watchdog state machine and the node stays in standby or
          master/coordinator state until some problem in local
          <span class="productname">Pgpool-II</span> node is detected or a
          remote <span class="productname">Pgpool-II</span> disconnects from the cluster.
        </p><p>          The watchdog process performs the following tasks:
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>                Manages and coordinates the local node watchdog state.
              </p></li><li class="listitem"><p>                Interacts with built-in or external lifecheck system
                for the of local and remote <span class="productname">Pgpool-II</span>
                node health checking.
              </p></li><li class="listitem"><p>                Interacts with <span class="productname">Pgpool-II</span> main
                process and provides the mechanism to
                <span class="productname">Pgpool-II</span> parent process for
                executing the cluster commands over the watchdog channel.
              </p></li><li class="listitem"><p>                Communicates with all the participating <span class="productname">Pgpool-II
                </span> nodes to coordinate the selection of
                master/coordinator node and to ensure the quorum in the cluster.
              </p></li><li class="listitem"><p>                Manages the Virtual-IP on the active/coordinator node and
                allow the users to provide custom scripts for
                escalation and de-escalation.
              </p></li><li class="listitem"><p>                Verifies the consistency of <span class="productname">Pgpool-II</span>
                configurations across the participating <span class="productname">Pgpool-II
                </span> nodes in the watchdog cluster.
              </p></li><li class="listitem"><p>                Synchronize the status of all PostgreSQL backends at startup.
              </p></li><li class="listitem"><p>                Provides the distributed locking facility to
                <span class="productname">Pgpool-II</span> main process
                for synchronizing the different failover commands.
              </p></li></ul></div><div class="sect3" id="tutorial-advanced-arch-wd-core-comm"><div class="titlepage"><div><div><h4 class="title">2.4.1.1. Communication with other nodes in the Cluster</h4></div></div></div><p>          Watchdog uses TCP/IP sockets for all the communication with other nodes.
          Each watchdog node can have two sockets opened with each node. One is the
          outgoing (client) socket which this node creates and initiate the
          connection to the remote node and the second socket is the one which
          is listening socket for inbound connection initiated by remote
          watchdog node. As soon as the socket connection to remote node succeeds
          watchdog sends the ADD NODE (<code class="literal">WD_ADD_NODE_MESSAGE</code>)
          message on that socket. And upon receiving the ADD NODE message the
          watchdog node verifies the node information encapsulated in the message
          with the Pgpool-II configurations for that node, and if the node passes
          the verification test it is added to the cluster otherwise the connection
          is dropped.
        </p></div><div class="sect3" id="tutorial-advanced-arch-wd-ipc-data"><div class="titlepage"><div><div><h4 class="title">2.4.1.2. IPC and data format</h4></div></div></div><p>          Watchdog process exposes a <acronym class="acronym">UNIX</acronym> domain socket
          for IPC communications, which accepts and provides the data in
          <acronym class="acronym">JSON</acronym> format. All the internal <span class="productname">Pgpool-II
          </span> processes, including <span class="productname">Pgpool-II's</span>
          built-in lifecheck and <span class="productname">Pgpool-II</span> main process
          uses this IPC socket interface to interact with the watchdog.
          This IPC socket can also be used by any external/3rd party system
          to interact with watchdog.
        </p><p>          See <a class="xref" href="tutorial-watchdog-integrating-external-lifecheck.html" title="2.2. Integrating external lifecheck with watchdog">Section 2.2, “Integrating external lifecheck with watchdog”</a> for details
          on how to use watchdog IPC interface for integrating external/3rd party systems.
        </p></div></div><div class="sect2" id="tutorial-advanced-arch-wd-lifecheck"><div class="titlepage"><div><div><h3 class="title">2.4.2. Watchdog Lifecheck</h3></div></div></div><p>        Watchdog lifecheck is the sub-component of watchdog that monitors the health
        of <span class="productname">Pgpool-II</span> nodes participating in the watchdog
        cluster. <span class="productname">Pgpool-II</span> watchdog provides two built-in
        methods of remote node health checking, "heartbeat" and "query" mode.
      </p><p>        In "heartbeat" mode, The lifecheck process sends and receives the data over
        <acronym class="acronym">UDP</acronym> socket to check the availability of remote nodes and
        for each node the parent lifecheck process spawns two child process one for
        sending the heartbeat signal and another for receiving the heartbeat.
        While in "query" mode, The lifecheck process uses the PostgreSQL libpq
        interface for querying the remote <span class="productname">Pgpool-II</span>.
        And in this mode the lifecheck process creates a new thread for each health
        check query which gets destroyed as soon as the query finishes.
      </p><p>        Apart from remote node health checking watchdog lifecheck can also check the
        health of node it is installed on by monitoring the connection to upstream servers.
        For monitoring the connectivity to the upstream server <span class="productname">Pgpool-II
        </span> lifecheck uses <code class="literal">execv()</code> function to executes
        <code class="command">'ping -q -c3 hostname'</code> command.
        So a new child process gets spawned for executing each ping command.
        This means for each health check cycle a child process gets created and
        destroyed for each configured upstream server.
        For example, if two upstream servers are configured in the lifecheck and it is
        asked to health check at ten second intervals, then after each ten second
        lifecheck will spawn two child processes, one for each upstream server,
        and each process will live until the ping command is finished.
      </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="tutorial-watchdog-restrictions.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="tutorial-watchdog.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="admin.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">2.3. Restrictions on watchdog </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Part II. Server Administration</td></tr></table></div></body></html>