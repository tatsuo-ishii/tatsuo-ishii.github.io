<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>1.5. Testing Fail Over</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="pgpool-II 3.6beta2 Documentation" /><link rel="up" href="tutorial-start.html" title="Chapter 1. Getting Started" /><link rel="prev" href="tutorial-testing-replication.html" title="1.4. Testing Replication" /><link rel="next" href="tutorial-testing-online-recovery.html" title="1.6. Testing Online Recovery" /><link rel="copyright" href="legalnotice.html" title="Legal Notice" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">1.5. Testing Fail Over</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="tutorial-testing-replication.html">Prev</a> </td><th width="60%" align="center">Chapter 1. Getting Started</th><td width="20%" align="right"> <a accesskey="n" href="tutorial-testing-online-recovery.html">Next</a></td></tr></table><hr /></div><div class="sect1" id="tutorial-testing-failover"><div class="titlepage"><div><div><h2 class="title" style="clear: both">1.5. Testing Fail Over</h2></div></div></div><p>      <span class="productname">Pgpool-II</span> allows an automatic fail
      over when <span class="productname">PostgreSQL</span> server goes
      down. In this case <span class="productname">Pgpool-II</span> sets the
      status of the server to "down" and continue the database
      operation using remaining servers.
      </p><pre class="programlisting">$ pg_ctl -D data1 stop
waiting for server to shut down.... done
server stopped
$ psql -p 11000 -c "show pool_nodes" test
 node_id | hostname | port  | status | lb_weight |  role   | select_cnt | load_balance_node | replication_delay 
---------+----------+-------+--------+-----------+---------+------------+-------------------+-------------------
 0       | /tmp     | 11002 | up     | 0.500000  | primary | 2172       | true              | 0
 1       | /tmp     | 11003 | down   | 0.500000  | standby | 0          | false             | 0
(2 rows)

$ psql -p 11000 -c "SELECT sum(abalance) FROM pgbench_accounts" test
  sum   
--------
 192112
(1 row)
      </pre><p>
      The standby node was shut down by pg_ctl
      command. <span class="productname">Pgpool-II</span> detects it and
      detaches the standby node. "show pool_nodes" command shows that
      the standby node is in down status. You can continue to use the
      cluster without the standby node:
      </p><pre class="programlisting">$ psql -p 11000 -c "SELECT sum(abalance) FROM pgbench_accounts" test
  sum   
--------
 192112
(1 row)
      </pre><p>
      What happens if the primary server goes down? In this case, one
      of remaining standby server is promoted to new primary
      server. For this testing, we start from the state in which both
      nodes are up.
      </p><pre class="programlisting">$ psql -p 11000 -c "show pool_nodes" test
 node_id | hostname | port  | status | lb_weight |  role   | select_cnt | load_balance_node | replication_delay 
---------+----------+-------+--------+-----------+---------+------------+-------------------+-------------------
 0       | /tmp     | 11002 | up     | 0.500000  | primary | 2173       | true              | 0
 1       | /tmp     | 11003 | up     | 0.500000  | standby | 0          | false             | 0
(2 rows)

$ pg_ctl -D data0 stop
waiting for server to shut down.... done
server stopped
$ psql -p 11000 -c "show pool_nodes" test
 node_id | hostname | port  | status | lb_weight |  role   | select_cnt | load_balance_node | replication_delay 
---------+----------+-------+--------+-----------+---------+------------+-------------------+-------------------
 0       | /tmp     | 11002 | down   | 0.500000  | standby | 2173       | false             | 0
 1       | /tmp     | 11003 | up     | 0.500000  | primary | 0          | true              | 0
(2 rows)
      </pre><p>
      Now the primary node is changed from 0 to 1. What happens
      inside? When the node 0 goes
      down, <span class="productname">Pgpool-II</span> detects it and
      executes "fail_over_script" defined
      in <code class="filename">pgpool.conf</code>.  Here is the content of the
      file.
      </p><pre class="programlisting">#! /bin/sh
# Execute command by failover.
# special values:  %d = node id
#                  %h = host name
#                  %p = port number
#                  %D = database cluster path
#                  %m = new master node id
#                  %M = old master node id
#                  %H = new master node host name
#                  %P = old primary node id
#                  %R = new master database cluster path
#                  %r = new master port number
#                  %% = '%' character
failed_node_id=$1
failed_host_name=$2
failed_port=$3
failed_db_cluster=$4
new_master_id=$5
old_master_id=$6
new_master_host_name=$7
old_primary_node_id=$8
new_master_port_number=$9
new_master_db_cluster=${10}
mydir=/home/t-ishii/tmp/Tutorial
log=$mydir/log/failover.log
pg_ctl=/usr/local/pgsql/bin/pg_ctl
cluster0=$mydir/data0
cluster1=$mydir/data1

date &gt;&gt; $log
echo "failed_node_id $failed_node_id failed_host_name $failed_host_name failed_port $failed_port failed_db_cluster $failed_db_cluster new_master_id $new_master_id old_master_id $old_master_id new_master_host_name $new_master_host_name old_primary_node_id $old_primary_node_id new_master_port_number $new_master_port_number new_master_db_cluster $new_master_db_cluster" &gt;&gt; $log

if [ a"$failed_node_id" = a"$old_primary_node_id" ];then	# master failed
! 	new_primary_db_cluster=${mydir}/data"$new_master_id"
	echo $pg_ctl -D $new_primary_db_cluster promote &gt;&gt;$log	# let standby take over
	$pg_ctl -D $new_primary_db_cluster promote &gt;&gt;$log	# let standby take over
fi
      </pre><p>
      The script receives necessary information as parameters
      from <span class="productname">Pgpool-II</span>. If the primary server
      goes down, it executes "pg_ctl -D data1 promote", which should
      promote the standby server to a new primary server.
    </p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="tutorial-testing-replication.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="tutorial-start.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="tutorial-testing-online-recovery.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">1.4. Testing Replication </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 1.6. Testing Online Recovery</td></tr></table></div></body></html>