<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>5.9. Failover and Failback</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="pgpool-II 3.7devel Documentation" /><link rel="up" href="runtime-config.html" title="Chapter 5. Server Configuration" /><link rel="prev" href="runtime-config-health-check.html" title="5.8. Health Check" /><link rel="next" href="runtime-online-recovery.html" title="5.10. Online Recovery" /><link rel="copyright" href="legalnotice.html" title="Legal Notice" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">5.9. Failover and Failback</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="runtime-config-health-check.html">Prev</a> </td><th width="60%" align="center">Chapter 5. Server Configuration</th><td width="20%" align="right"> <a accesskey="n" href="runtime-online-recovery.html">Next</a></td></tr></table><hr /></div><div class="sect1" id="runtime-config-failover"><div class="titlepage"><div><div><h2 class="title" style="clear: both">5.9. Failover and Failback</h2></div></div></div><div class="sect2" id="runtime-config-failover-settings"><div class="titlepage"><div><div><h3 class="title">5.9.1. Failover and Failback Settings</h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt id="guc-failover-command"><span class="term"><code class="varname">failover_command</code> (<code class="type">string</code>)
        <a id="idm45333510348288" class="indexterm"></a>
      </span></dt><dd><p>          Specifies a user command to run when a <span class="productname">PostgreSQL</span> backend node gets detached.
          <span class="productname">Pgpool-II</span> replaces the following special characters
          with the backend specific information.
        </p><div class="table" id="failover-command-table"><p class="title"><strong>Table 5.6. failover command options</strong></p><div class="table-contents"><table class="table" summary="failover command options" border="1"><colgroup><col /><col /></colgroup><thead><tr><th>Special character</th><th>Description</th></tr></thead><tbody><tr><td>%d</td><td>DB node ID of the detached node</td></tr><tr><td>%h</td><td>Hostname of the detached node</td></tr><tr><td>%p</td><td>Port number of the detached node</td></tr><tr><td>%D</td><td>Database cluster directory of the detached node</td></tr><tr><td>%M</td><td>Old master node ID</td></tr><tr><td>%m</td><td>	New master node ID</td></tr><tr><td>%H</td><td>Hostname of the new master node</td></tr><tr><td>%P</td><td>	Old primary node ID</td></tr><tr><td>%r</td><td>Port number of the new master node</td></tr><tr><td>%R</td><td>Database cluster directory of the new master node</td></tr><tr><td>%%</td><td>	'%' character</td></tr></tbody></table></div></div><br class="table-break" /><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>	    The "master node" referes to a node which has the
	    "youngest (or the smallest) node id" among live the
	    database nodes. In <a class="link" href="configuring-pgpool.html#running-mode" title="4.3.2. Running mode of Pgpool-II">streaming
	    replication mode</a>, this may be different from
	    primary node. In <a class="xref" href="runtime-config-failover.html#failover-command-table" title="Table 5.6. failover command options">Table 5.6, “failover command options”</a>,
	    %m is the new master node chosen
	    by <span class="productname">Pgpool-II</span>. It is the node
	    being assigned the youngest (smallest) node id which is
	    alive. For example if you have 3 nodes, namely node 0, 1,
	    2. Suppose node 1 the primary and all of them are healthy
	    (no down node). If node 1 fails, failover_command is
	    called with %m = 0.
	  </p></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>            When a failover is performed,
            basically <span class="productname">Pgpool-II</span> kills all
            its child processes, which will in turn terminate all the
            active sessions to
            <span class="productname">Pgpool-II</span>. After that <span class="productname">Pgpool-II</span>
            invokes the <code class="command">failover_command</code> and after the command completion
            <span class="productname">Pgpool-II</span> starts new child processes
            which makes it ready again to accept client connections.
          </p><p>	    However from <span class="productname">Pgpool-II</span> 3.6, In
	    the steaming replication mode, client sessions will not be
	    disconnected when a fail-over occurs any more if the
	    session does not use the failed standby server. If the
	    primary server goes down, still all sessions will be
	    disconnected. Health check timeout case will also cause
	    the full session disconnection. Other health check error,
	    including retry over case does not trigger full session
	    disconnection.
	  </p></div><p>          This parameter can be changed by reloading the <span class="productname">Pgpool-II</span> configurations.
        </p></dd><dt id="guc-failback-command"><span class="term"><code class="varname">failback_command</code> (<code class="type">string</code>)
        <a id="idm45333510323376" class="indexterm"></a>
      </span></dt><dd><p>          Specifies a user command to run when a <span class="productname">PostgreSQL</span> backend node gets attached to
          <span class="productname">Pgpool-II</span>. <span class="productname">Pgpool-II</span>
          replaces the following special characters with the backend specific information.
          before excuting the command.
        </p><div class="table" id="ffailback-command-table"><p class="title"><strong>Table 5.7. failback command options</strong></p><div class="table-contents"><table class="table" summary="failback command options" border="1"><colgroup><col /><col /></colgroup><thead><tr><th>Special character</th><th>Description</th></tr></thead><tbody><tr><td>%d</td><td>DB node ID of the attached node</td></tr><tr><td>%h</td><td>Hostname of the attached node</td></tr><tr><td>%p</td><td>Port number of the attached node</td></tr><tr><td>%D</td><td>Database cluster directory of the attached node</td></tr><tr><td>%M</td><td>Old master node ID</td></tr><tr><td>%m</td><td>	New master node ID</td></tr><tr><td>%H</td><td>Hostname of the new master node</td></tr><tr><td>%P</td><td>	Old primary node ID</td></tr><tr><td>%r</td><td>Port number of the new master node</td></tr><tr><td>%R</td><td>Database cluster directory of the new master node</td></tr><tr><td>%%</td><td>	'%' character</td></tr></tbody></table></div></div><br class="table-break" /><p>          This parameter can be changed by reloading the <span class="productname">Pgpool-II</span> configurations.
        </p></dd><dt id="guc-follow-master-command"><span class="term"><code class="varname">follow_master_command</code> (<code class="type">string</code>)
        <a id="idm45333510306720" class="indexterm"></a>
      </span></dt><dd><p>          Specifies a user command to run after failover on the primary node failover.
		  This works only in Master Replication mode with streaming replication.
          <span class="productname">Pgpool-II</span> replaces the following special characters
          with the backend specific information before excuting the command.
        </p><div class="table" id="follow-master-command-table"><p class="title"><strong>Table 5.8. follow master command options</strong></p><div class="table-contents"><table class="table" summary="follow master command options" border="1"><colgroup><col /><col /></colgroup><thead><tr><th>Special character</th><th>Description</th></tr></thead><tbody><tr><td>%d</td><td>DB node ID of the detached node</td></tr><tr><td>%h</td><td>Hostname of the detached node</td></tr><tr><td>%p</td><td>Port number of the detached node</td></tr><tr><td>%D</td><td>Database cluster directory of the detached node</td></tr><tr><td>%M</td><td>Old master node ID</td></tr><tr><td>%m</td><td>	New master node ID</td></tr><tr><td>%H</td><td>Hostname of the new master node</td></tr><tr><td>%P</td><td>	Old primary node ID</td></tr><tr><td>%r</td><td>Port number of the new master node</td></tr><tr><td>%R</td><td>Database cluster directory of the new master node</td></tr><tr><td>%%</td><td>	'%' character</td></tr></tbody></table></div></div><br class="table-break" /><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>          If <code class="varname">follow_master_command</code>&gt; is not empty, then after failover
          on the primary node gets completed in Master Slave mode with streaming replication,
          <span class="productname">Pgpool-II</span> degenerates all nodes excepted the new primary
          and starts new child processes to be ready again to accept connections from the clients.
          After this, <span class="productname">Pgpool-II</span> executes the command configured
          in the <code class="varname">follow_master_command</code> for each degenerated backend nodes.
        </p></div><p>          Typically <code class="varname">follow_master_command</code> command is used to recover
          the slave from the new primary by calling the pcp_recovery_node command.
        </p><p>          This parameter can be changed by reloading the <span class="productname">Pgpool-II</span> configurations.
        </p></dd><dt id="guc-fail-over-on-backend-error"><span class="term"><code class="varname">fail_over_on_backend_error</code> (<code class="type">boolean</code>)
        <a id="idm45333510287504" class="indexterm"></a>
      </span></dt><dd><p>          When set to on, <span class="productname">Pgpool-II</span> considers the reading/writing
          errors on the PostgreSQL backend connection as the backend node failure and trigger the
          failover on that node after disconnecting the current session.
          When this is set to off, <span class="productname">Pgpool-II</span> only report an error
          and disconnect the session in case of such errors.
        </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>            It is recommended to turn on the backend health checking
            (see <a class="xref" href="runtime-config-health-check.html" title="5.8. Health Check">Section 5.8, “Health Check”</a>)
            when <code class="varname">fail_over_on_backend_error</code> is set to off.
            Note, however, that <span class="productname">Pgpool-II</span> still triggers the
            failover when it detects the administrative shutdown of
            <span class="productname">PostgreSQL</span> backend server.
          </p></div><p>          This parameter can be changed by reloading the <span class="productname">Pgpool-II</span> configurations.
        </p></dd><dt id="guc-search-primary-node-timeout"><span class="term"><code class="varname">search_primary_node_timeout</code> (<code class="type">integer</code>)
        <a id="idm45333510278016" class="indexterm"></a>
      </span></dt><dd><p>          Specifies the maximum amount of time in seconds to search for the
          primary node when a failover scenario occurs.
          <span class="productname">Pgpool-II</span> will give up looking for the primary
          node if it is not found with-in this configured time.
          Default is 300 and Setting this parameter to 0 means keep trying forever.
        </p><p>          This parameter is only applicable in the streaming replication mode.
        </p><p>          This parameter can be changed by reloading the <span class="productname">Pgpool-II</span> configurations.
        </p></dd></dl></div></div><div class="sect2" id="runtime-config-failover-in-the-raw-mode"><div class="titlepage"><div><div><h3 class="title">5.9.2. Failover in the raw Mode</h3></div></div></div><p>  Failover can be performed in raw mode if multiple backend servers are defined.
  <span class="productname">Pgpool-II</span> usually accesses the backend specified by
  <code class="literal">backend_hostname0</code> during normal operation. If the
  <code class="literal">backend_hostname0</code> fails for some reason,
  <span class="productname">Pgpool-II</span> tries to access the backend specified by
  <code class="literal">backend_hostname1</code>. If that fails, <span class="productname">Pgpool-II</span>
  tries the <code class="literal">backend_hostname2, 3</code> and so on.
  </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="runtime-config-health-check.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="runtime-config.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="runtime-online-recovery.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">5.8. Health Check </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 5.10. Online Recovery</td></tr></table></div></body></html>