<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>5.5. Connection Pooling</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="pgpool-II 3.7devel Documentation" /><link rel="up" href="runtime-config.html" title="Chapter 5. Server Configuration" /><link rel="prev" href="runtime-config-backend-settings.html" title="5.4. Backend Settings" /><link rel="next" href="runtime-config-logging.html" title="5.6. Error Reporting and Logging" /><link rel="copyright" href="legalnotice.html" title="Legal Notice" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">5.5. Connection Pooling</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="runtime-config-backend-settings.html">Prev</a> </td><th width="60%" align="center">Chapter 5. Server Configuration</th><td width="20%" align="right"> <a accesskey="n" href="runtime-config-logging.html">Next</a></td></tr></table><hr /></div><div class="sect1" id="runtime-config-connection-pooling"><div class="titlepage"><div><div><h2 class="title" style="clear: both">5.5. Connection Pooling</h2></div></div></div><p>   <span class="productname">Pgpool-II</span> maintains established
    connections to the PostgreSQL servers, and reuses them whenever a
    new connection with the same properties (i.e. user name, database,
    protocol version) comes in. It reduces the connection overhead,
    and improves system's overall throughput.
  </p><div class="sect2" id="runtime-config-connection-pooling-settings"><div class="titlepage"><div><div><h3 class="title">5.5.1. Connection Pooling Settings</h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt id="guc-connection-cache"><span class="term"><code class="varname">connection_cache</code> (<code class="type">boolean</code>)
	  <a id="idm45333510751632" class="indexterm"></a>
	</span></dt><dd><p>	    Caches connections to backends when set to on. Default is on.
	    <span class="emphasis"><em>However, connections to <code class="literal">template0</code>, <code class="literal">template1</code>,
		<code class="literal">postgres</code> and <code class="literal">regression</code> databases are not cached even if
		<code class="varname">connection_cache</code> is on.</em></span>
	  </p><p>	    You need to restart <span class="productname">Pgpool-II</span>
	    if you change this value.
	  </p></dd><dt id="guc-max-pool"><span class="term"><code class="varname">max_pool</code> (<code class="type">integer</code>)
	  <a id="idm45333510744496" class="indexterm"></a>
	</span></dt><dd><p>	    The maximum number of cached connections
	    in each <span class="productname">Pgpool-II</span> child
	    process.  <span class="productname">Pgpool-II</span> reuses the
	    cached connection if an incoming connection is connecting
	    to the same database with the same user name.  If not,
	    <span class="productname">Pgpool-II</span> creates a new
	    connection to the backend.  If the number of cached
	    connections exceeds max_pool, the oldest connection will
	    be discarded, and uses that slot for the new connection.
	  </p><p>	    Default value is 4. Please be aware that the number of
	    connections from <span class="productname">Pgpool-II</span> processes to the backends may reach
	    num_init_children * max_pool in total.
	  </p><p>	    This parameter can only be set at server start.
	  </p></dd><dt id="guc-listen-backlog-multiplier"><span class="term"><code class="varname">listen_backlog_multiplier</code> (<code class="type">integer</code>)
        <a id="idm45333510737872" class="indexterm"></a>
      </span></dt><dd><p>					Specifies the length of connection queue from frontend to
					<span class="productname">Pgpool-II</span>. The queue length (actually
					<code class="literal">"backlog"</code> parameter of <code class="literal">listen()</code>
					system call) is defined as
					<code class="varname">listen_backlog_multiplier</code> * <a class="xref" href="runtime-config-connection.html#guc-num-init-children">num_init_children</a>.
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>						Some systems have the upper limit of the backlog parameter of
						<code class="literal">listen()</code> system call.
						See <a class="xref" href="runtime-config-connection.html#guc-num-init-children">num_init_children</a> for more details.
					</p></div><p>					Default is 2.
				</p><p>          This parameter can only be set at server start.
        </p></dd><dt id="guc-serialize-accept"><span class="term"><code class="varname">serialize_accept</code> (<code class="type">boolean</code>)
        <a id="idm45333510729952" class="indexterm"></a>
      </span></dt><dd><p>					When set to on, <span class="productname">Pgpool-II</span> enables the serialization
					on incoming client connections.
					Without serialization the OS kernel wakes up all of the <span class="productname">					Pgpool-II</span> children processes to execute <code class="literal">accept()</code> and one of them
					actually gets the incoming connection. The problem here is, because so my child
					process wake up at a same time, heavy context switching occurs and the
					performance is affected.
				</p><p>					This phenomena is a well known classic problem called
					"the thundering herd problem". This can be solved by the
					serialization of the <code class="literal">accept()</code> calls, so that only one
					<span class="productname">Pgpool-II</span> process gets woken up
					for incoming connection to execute the <code class="literal">accept()
					</code>.
				</p><p>					But serialization has its own overheads, and it is recomended
					to be used only with the larger values of <a class="xref" href="runtime-config-connection.html#guc-num-init-children">num_init_children</a>.
					For the small number of <a class="xref" href="runtime-config-connection.html#guc-num-init-children">num_init_children</a>,
					the serialize accept can degrade the performance because of
					serializing overhead.
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>						It is recomended to do a benchmark before deciding wether to use
						<code class="varname">serialize_accept</code> or not, because the corelation
						of <a class="xref" href="runtime-config-connection.html#guc-num-init-children">num_init_children</a> and <code class="varname">serialize_accept</code>
						can be different on different environments.
					</p></div><div class="example" id="example-serialize-accept-pgbench"><p class="title"><strong>Example 5.1. Using pgbench to decide if serialize_accept should be used</strong></p><div class="example-contents"><p>						To run the <code class="command">pgbench</code> use the following
						command.
          </p><pre class="programlisting">pgbench -n -S -p 9999 -c 32 -C -S -T 300 test
          </pre><p>
						Here, <code class="literal">-C</code> tells <code class="command">pgbench</code> to connect
						to database each time a transaction gets executed. <code class="literal">-c 32</code>
						specifies the number of the concurrent sessions to <span class="productname">Pgpool-II</span>.
						You should change this according to your system's requirement.
						After <code class="command">pgbench</code> finishes, check the number from
						"including connections establishing".
          </p></div></div><br class="example-break" /><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>						When <a class="xref" href="runtime-config-connection-pooling.html#guc-child-life-time">child_life_time</a> is enabled, <code class="varname">serialize_accept</code>
						has no effect. Make sure that you set <a class="xref" href="runtime-config-connection-pooling.html#guc-child-life-time">child_life_time</a> to 0 if you intend
						to turn on the <code class="varname">serialize_accept</code>.
						And if you are worried about <span class="productname">Pgpool-II</span> process memory leaks
						or whatever potential issue, you could use <a class="xref" href="runtime-config-connection-pooling.html#guc-child-max-connections">child_max_connections</a> instead.
						This is purely an implementation limitation and may be removed in the future.
					</p></div><p>					Default is off.
				</p><p>          This parameter can only be set at server start.
        </p></dd><dt id="guc-child-life-time"><span class="term"><code class="varname">child_life_time</code> (<code class="type">integer</code>)
        <a id="idm45333510709328" class="indexterm"></a>
      </span></dt><dd><p>          Specifies the time in seconds to terminate a <span class="productname">Pgpool-II
					</span> child process if it remains idle. The new child process
					is immediately spawned by <span class="productname">Pgpool-II</span> when it
					is terminated because of <code class="varname">child_life_time</code>.
					<code class="varname">child_life_time</code> is a measure to prevent the
					memory leaks and other unexpected errors in <span class="productname">Pgpool-II
					</span> children.
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>						<code class="varname">child_life_time</code> does not apply to
						processes that have not accepted any connection yet.
					</p></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>						<a class="xref" href="runtime-config-connection-pooling.html#guc-serialize-accept">serialize_accept</a> becomes ineffective when
						<code class="varname">child_life_time</code> is enabled.
					</p></div><p>					Default is 300 (5 minutes) and setting it to 0 disables the feature.
				</p><p>          This parameter can only be set at server start.
        </p></dd><dt id="guc-client-idle-limit"><span class="term"><code class="varname">client_idle_limit</code> (<code class="type">integer</code>)
        <a id="idm45333510700768" class="indexterm"></a>
      </span></dt><dd><p>          Specifies the time in seconds to disconnect a client if it remains idle
          since the last query.
          This is useful for preventing the <span class="productname">Pgpool-II</span>
          children from being occupied by a lazy clients or broken TCP/IP
					connection between client and <span class="productname">Pgpool-II</span>.
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>						<code class="varname">client_idle_limit</code> is ignored in
						the second stage of online recovery.
					</p></div><p>          The default is 0, which turns off the feature.
				</p><p>          This parameter can be changed by reloading the <span class="productname">Pgpool-II</span> configurations.
					You can also use <a class="xref" href="sql-pgpool-set.html" title="PGPOOL SET"><span class="refentrytitle">PGPOOL SET</span></a> command to alter the value of
					this parameter for a current session.
        </p></dd><dt id="guc-child-max-connections"><span class="term"><code class="varname">child_max_connections</code> (<code class="type">integer</code>)
        <a id="idm45333510693584" class="indexterm"></a>
      </span></dt><dd><p>          Specifies the lifetime of a <span class="productname">Pgpool-II</span>
					child process in terms of the number of client connections it can receive.
					<span class="productname">Pgpool-II</span> will terminate the child process
					after it has served <code class="varname">child_max_connections</code> client
					connections and will immediately spawn a new child process to take its place.
				</p><p>					<code class="varname">child_max_connections</code> is useful on a very busy server,
					where <a class="xref" href="runtime-config-connection-pooling.html#guc-child-life-time">child_life_time</a> and <a class="xref" href="runtime-config-connection-pooling.html#guc-connection-life-time">connection_life_time</a>
					never gets triggered. It is also useful to prevent the <span class="productname">PostgreSQL</span> servers from getting
					too big.
				</p><p>          The default is 0, which turns off the feature.
				</p><p>          This parameter can only be set at server start.
        </p></dd><dt id="guc-connection-life-time"><span class="term"><code class="varname">connection_life_time</code> (<code class="type">integer</code>)
        <a id="idm45333510685760" class="indexterm"></a>
      </span></dt><dd><p>          Specifies the time in seconds to terminate the cached connections
					to the PostgreSQL backend. This serves as the cached connection expiration time.
				</p><p>          The default is 0, which means the cached connections will not be disconnected.
				</p><p>          This parameter can only be set at server start.
        </p></dd><dt id="guc-reset-query-list"><span class="term"><code class="varname">reset_query_list</code> (<code class="type">string</code>)
        <a id="idm45333510681984" class="indexterm"></a>
      </span></dt><dd><p>					Specifies the <acronym class="acronym">SQL</acronym> commands to be sent to reset the backend connection
					when exiting the user session. Multiple commands can be specified by delimiting each
					by <code class="literal">";"</code>.
				</p><p>					The available commands differ among <span class="productname">PostgreSQL</span> versions.
					Below are some recommended settings for <code class="varname">reset_query_list</code>
					on different <span class="productname">PostgreSQL</span> versions.
					Note, however, that <code class="literal">ABORT</code> command should be always included.
				</p><div class="table" id="reset-query-list-suggestions-table"><p class="title"><strong>Table 5.4. Recommended setting for <code class="varname">reset_query_list</code>
					on different PostgreSQL versions</strong></p><div class="table-contents"><table class="table" summary="Recommended setting for reset_query_list&#10;&#9;&#9;&#9;&#9;&#9;on different PostgreSQL versions" border="1"><colgroup><col /><col /></colgroup><thead><tr><th>PostgreSQL version</th><th>reset_query_list</th></tr></thead><tbody><tr><td>7.1 or earlier</td><td><code class="literal">'ABORT'</code></td></tr><tr><td>7.2 to 8.2</td><td><code class="literal">'ABORT; RESET ALL; SET SESSION AUTHORIZATION DEFAULT'</code></td></tr><tr><td>8.3 or later</td><td><code class="literal">'ABORT; DISCARD ALL'</code></td></tr></tbody></table></div></div><br class="table-break" /><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>						<code class="literal">"ABORT"</code> is not issued when not in a transaction block for 7.4 or later
						<span class="productname">PostgreSQL</span> versions.
					</p></div><p>					Default is <code class="literal">'ABORT; DISCARD ALL'</code>.
				</p><p>          This parameter can be changed by reloading the <span class="productname">Pgpool-II</span> configurations.
        </p></dd></dl></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="runtime-config-backend-settings.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="runtime-config.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="runtime-config-logging.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">5.4. Backend Settings </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 5.6. Error Reporting and Logging</td></tr></table></div></body></html>