<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>7.1. Basic Configuration Example</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="pgpool-II 3.7devel Documentation" /><link rel="up" href="example-configs.html" title="Chapter 7. Configuration Examples" /><link rel="prev" href="example-configs.html" title="Chapter 7. Configuration Examples" /><link rel="next" href="example-watchdog.html" title="7.2. Watchdog Configuration Example" /><link rel="copyright" href="legalnotice.html" title="Legal Notice" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">7.1. Basic Configuration Example</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="example-configs.html">Prev</a> </td><th width="60%" align="center">Chapter 7. Configuration Examples</th><td width="20%" align="right"> <a accesskey="n" href="example-watchdog.html">Next</a></td></tr></table><hr /></div><div class="sect1" id="example-basic"><div class="titlepage"><div><div><h2 class="title" style="clear: both">7.1. Basic Configuration Example</h2></div></div></div><div class="sect2" id="example-configs-begin"><div class="titlepage"><div><div><h3 class="title">7.1.1. Let's Begin!</h3></div></div></div><p>        First, we must learn how to install and configure <span class="productname">Pgpool-II</span> and database nodes before using replication.
      </p><div class="sect3" id="example-configs-begin-installing"><div class="titlepage"><div><div><h4 class="title">7.1.1.1. Installing <span class="productname">Pgpool-II</span></h4></div></div></div><p>          Installing <span class="productname">Pgpool-II</span> is very easy.
          In the directory which you have extracted the source tar ball,
          execute the following commands.
          </p><pre class="programlisting">$ ./configure
$ make
$ make install
          </pre><p>
          <code class="command">configure</code> script collects your system information
          and use it for the compilation procedure. You can pass command
          line arguments to <code class="command">configure</code> script to change the default behavior,
          such as the installation directory. <span class="productname">Pgpool-II</span>
          will be installed to <code class="literal">/usr/local</code> directory by default.
        </p><p>          <code class="command">make</code> command compiles the source code, and
          <code class="command">make install</code> will install the executables.
          You must have write permission on the installation directory.
          In this tutorial, we will install <span class="productname">Pgpool-II
          </span> in the default <code class="literal">/usr/local</code> directory.
        </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>            <span class="productname">Pgpool-II</span> requires <code class="literal">libpq</code>
            library in <span class="productname">PostgreSQL</span> 7.4 or later (version 3 protocol).
          </p></div><p>          If the <code class="command">configure</code> script displays the following error message, the
          <code class="literal">libpq</code> library may not be installed, or it is not of version 3
          </p><pre class="programlisting">configure: error: libpq is not installed or libpq is old
          </pre><p>
          If the library is version 3, but the above message is still displayed, your
          <code class="literal">libpq</code> library is probably not recognized by the <code class="command">          configure</code> script.
          The <code class="command">configure</code> script searches for <code class="literal">libpq</code>
          library under <code class="literal">/usr/local/pgsql</code>. If you have installed the
          <span class="productname">PostgreSQL</span> in a directory other than <code class="literal">/usr/local/pgsql</code>, use
          <code class="literal">--with-pgsql</code>, or <code class="literal">--with-pgsql-includedir</code>
          and <code class="literal">--with-pgsql-libdir</code> command line options when you
          execute <code class="command">configure</code>.
        </p></div><div class="sect3" id="example-configs-begin-config-files"><div class="titlepage"><div><div><h4 class="title">7.1.1.2. Configuration Files</h4></div></div></div><p>          <span class="productname">Pgpool-II</span> configuration parameters are saved in the
          <code class="literal">pgpool.conf</code> file. The file is in <code class="literal">"parameter = value"
          </code> per line format. When you install <span class="productname">Pgpool-II</span>,
          <code class="literal">pgpool.conf.sample</code> is automatically created.
          We recommend copying and renaming it to <code class="literal">pgpool.conf</code>, and edit
          it as you like.
          </p><pre class="programlisting">$ cp /usr/local/etc/pgpool.conf.sample /usr/local/etc/pgpool.conf
          </pre><p>
          <span class="productname">Pgpool-II</span> only accepts connections from the localhost
          using port 9999. If you wish to receive conenctions from other hosts,
          set <a class="xref" href="runtime-config-connection.html#guc-listen-addresses">listen_addresses</a> to <code class="literal">'*'</code>.
          </p><pre class="programlisting">listen_addresses = 'localhost'
port = 9999
          </pre><p>
          We will use the default parameters in thie tutorial.
        </p></div><div class="sect3" id="example-configs-begin-config-pcp"><div class="titlepage"><div><div><h4 class="title">7.1.1.3. Configuring <acronym class="acronym">PCP</acronym> Commands</h4></div></div></div><p>          <span class="productname">Pgpool-II</span> has an interface for administrative
          purpose to retrieve information on database nodes, shutdown
          <span class="productname">Pgpool-II</span>, etc. via network. To use
          <acronym class="acronym">PCP</acronym> commands, user authentication is required.
          This authentication is different from <span class="productname">PostgreSQL</span>'s user authentication.
          A user name and password need to be defined in the <code class="literal">pcp.conf</code>
          file. In the file, a user name and password are listed as a pair on each line,
          and they are separated by a colon (:). Passwords are encrypted in
          <code class="literal">md5</code> hash format.

          </p><pre class="programlisting">postgres:e8a48653851e28c69d0506508fb27fc5
          </pre><p>

          When you install <span class="productname">Pgpool-II</span>, <code class="literal">pcp.conf.sample
          </code> is automatically created. We recommend copying and renaming it
          to <code class="literal">pcp.conf</code>, and edit it.
          </p><pre class="programlisting">$ cp /usr/local/etc/pcp.conf.sample /usr/local/etc/pcp.conf
          </pre><p>
          To encrypt your password into md5 hash format, use the <code class="command">pg_md5</code>
          command, which is installed as one of <span class="productname">Pgpool-II</span>'s
          executables. <code class="command">pg_md5</code> takes text as a command line argument,
          and displays its md5-hashed text.
          For example, give <code class="literal">"postgres"</code> as the command line argument,
          and <code class="command">pg_md5</code> displays md5-hashed text on its standard output.
          </p><pre class="programlisting">$ /usr/bin/pg_md5 postgres
e8a48653851e28c69d0506508fb27fc5
          </pre><p>
          PCP commands are executed via network, so the port number must be configured
          with <a class="xref" href="runtime-config-connection.html#guc-pcp-port">pcp_port</a> parameter in <code class="literal">pgpool.conf</code> file.
          We will use the default 9898 for <a class="xref" href="runtime-config-connection.html#guc-pcp-port">pcp_port</a> in this tutorial.
          </p><pre class="programlisting">pcp_port = 9898
          </pre><p>
        </p></div><div class="sect3" id="example-configs-prep-db-nodes"><div class="titlepage"><div><div><h4 class="title">7.1.1.4. Preparing Database Nodes</h4></div></div></div><p>          Now, we need to set up backend <span class="productname">PostgreSQL</span> servers for <span class="productname">Pgpool-II
          </span>. These servers can be placed within the same host as
          <span class="productname">Pgpool-II</span>, or on separate machines. If you decide
          to place the servers on the same host, different port numbers must be assigned
          for each server. If the servers are placed on separate machines,
          they must be configured properly so that they can accept network
          connections from <span class="productname">Pgpool-II</span>.

          </p><pre class="programlisting">backend_hostname0 = 'localhost'
backend_port0 = 5432
backend_weight0 = 1
backend_hostname1 = 'localhost'
backend_port1 = 5433
backend_weight1 = 1
backend_hostname2 = 'localhost'
backend_port2 = 5434
backend_weight2 = 1
          </pre><p>

          For <a class="xref" href="runtime-config-backend-settings.html#guc-backend-hostname">backend_hostname</a>, <a class="xref" href="runtime-config-backend-settings.html#guc-backend-port">backend_port</a>,
          <a class="xref" href="runtime-config-backend-settings.html#guc-backend-weight">backend_weight</a>, set the node's hostname, port number,
          and ratio for load balancing. At the end of each parameter string,
          node ID must be specified by adding positive integers starting with 0 (i.e. 0, 1, 2..).
        </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>            <a class="xref" href="runtime-config-backend-settings.html#guc-backend-weight">backend_weight</a> parameters for all nodes are
            set to 1, meaning that SELECT queries are equally distributed among
            three servers.
          </p></div></div><div class="sect3" id="example-configs-start-stop-pgpool"><div class="titlepage"><div><div><h4 class="title">7.1.1.5. Starting/Stopping <span class="productname">Pgpool-II</span></h4></div></div></div><p>        To fire up <span class="productname">Pgpool-II</span>, execute the following
        command on a terminal.

        </p><pre class="programlisting">$ pgpool
        </pre><p>

        The above command, however, prints no log messages because <span class="productname">        Pgpool-II</span> detaches the terminal. If you want to show
        <span class="productname">Pgpool-II</span> log messages, you pass <code class="literal">-n</code>
        option to <code class="command">pgpool</code> command so <span class="productname">Pgpool-II</span>
        is executed as non-daemon process, and the terminal will not be detached.
        </p><pre class="programlisting">$ pgpool -n &amp;
        </pre><p>

        The log messages are printed on the terminal, so it is recommended to use the following options.
        </p><pre class="programlisting">$ pgpool -n -d &gt; /tmp/pgpool.log 2&gt;&amp;1 &amp;
        </pre><p>

        The <code class="literal">-d</code> option enables debug messages to be generated.
        The above command keeps appending log messages to <code class="literal">/tmp/pgpool.log
        </code>. If you need to rotate log files, pass the logs to a external
        command which has log rotation function.
        For example, you can use <a class="ulink" href="https://httpd.apache.org/docs/2.4/programs/rotatelogs.html" target="_top">        <code class="command">rotatelogs</code></a> from Apache2:
        </p><pre class="programlisting">$ pgpool -n 2&gt;&amp;1 | /usr/local/apache2/bin/rotatelogs \
  -l -f /var/log/pgpool/pgpool.log.%A 86400 &amp;
        </pre><p>

        This will generate a log file named <code class="literal">"pgpool.log.Thursday"</code>
        then rotate it 00:00 at midnight. Rotatelogs adds logs to a file if it already
        exists. To delete old log files before rotation, you could use cron:
        </p><pre class="programlisting">55 23 * * * /usr/bin/find /var/log/pgpool -type f -mtime +5 -exec /bin/rm -f '{}' \;
        </pre><p>

          Please note that rotatelogs may exist as <code class="literal">/usr/sbin/rotatelogs2</code>
          in some distributions. <code class="literal">-f</code> option generates a log file as soon as
          <code class="command">rotatelogs</code> starts and is available in apache2 2.2.9 or greater.
          Also <a class="ulink" href="http://www.cronolog.org/" target="_top">cronolog</a> can be used.
        </p><pre class="programlisting">$ pgpool -n 2&gt;&amp;1 | /usr/sbin/cronolog \
  --hardlink=/var/log/pgsql/pgpool.log \
  '/var/log/pgsql/%Y-%m-%d-pgpool.log' &amp;
        </pre><p>

        To stop <span class="productname">Pgpool-II</span>  execute the following command.
        </p><pre class="programlisting">$ pgpool stop
        </pre><p>

        If any client is still connected, <span class="productname">Pgpool-II</span>
        waits for it to disconnect, and then terminates itself. Run the following
        command instead if you want to shutdown <span class="productname">Pgpool-II</span>
        forcibly.
        </p><pre class="programlisting">$ pgpool -m fast stop
        </pre><p>

        </p></div></div><div class="sect2" id="example-configs-replication"><div class="titlepage"><div><div><h3 class="title">7.1.2. Your First Replication</h3></div></div></div><p>        Replication (see <a class="xref" href="runtime-config-runnung-mode.html#runtime-config-replication-mode" title="5.3.2. Replication mode">Section 5.3.2, “Replication mode”</a>) enables
        the same data to be copied to multiple database nodes.
        In this section, we'll use three database nodes, which we have already set
        up in <a class="xref" href="example-basic.html#example-configs-begin" title="7.1.1. Let's Begin!">Section 7.1.1, “Let's Begin!”</a>, and takes you step by step to
        create a database replication system.
        Sample data to be replicated will be generated by the
        <a class="ulink" href="https://www.postgresql.org/docs/current/static/pgbench.html" target="_top">        <code class="command">pgbench</code></a> benchmark program.
      </p><div class="sect3" id="example-configs-config-replication"><div class="titlepage"><div><div><h4 class="title">7.1.2.1. Configuring Replication</h4></div></div></div><p>          To enable the database replication function, set
          <a class="xref" href="runtime-config-runnung-mode.html#guc-replication-mode">replication_mode</a> to on in <code class="literal">pgpool.conf</code> file.
        </p><pre class="programlisting">replication_mode = true
        </pre><p>
          When <a class="xref" href="runtime-config-runnung-mode.html#guc-replication-mode">replication_mode</a> is on, <span class="productname">Pgpool-II</span>
          will send a copy of a received query to all the database nodes.
          In addition, when <a class="xref" href="runtime-config-load-balancing.html#guc-load-balance-mode">load_balance_mode</a> is set to true,
          <span class="productname">Pgpool-II</span> will distribute <acronym class="acronym">SELECT</acronym> queries
          among the database nodes.
        </p><pre class="programlisting">load_balance_mode = true
        </pre><p>
          In this section, we will enable both <a class="xref" href="runtime-config-runnung-mode.html#guc-replication-mode">replication_mode</a>
          and <a class="xref" href="runtime-config-load-balancing.html#guc-load-balance-mode">load_balance_mode</a>.
        </p></div><div class="sect3" id="example-configs-checking-replication"><div class="titlepage"><div><div><h4 class="title">7.1.2.2. Checking Replication</h4></div></div></div><p>          To reflect the changes in <code class="literal">pgpool.conf</code>,
          <span class="productname">Pgpool-II</span> must be restarted.
          Please refer to "Starting/Stopping <span class="productname">Pgpool-II</span>"
          <a class="xref" href="example-basic.html#example-configs-start-stop-pgpool" title="7.1.1.5. Starting/Stopping Pgpool-II">Section 7.1.1.5, “Starting/Stopping <span class="productname">Pgpool-II</span>”</a>.
          After configuring <code class="literal">pgpool.conf</code> and restarting the
          <span class="productname">Pgpool-II</span>, let's try the actual replication
          and see if everything is working.
          First, we need to create a database to be replicated. We will name it
          <code class="literal">"bench_replication"</code>. This database needs to be created
          on all the nodes. Use the
          <a class="ulink" href="https://www.postgresql.org/docs/current/static/app-createdb.html" target="_top">        <code class="command">createdb</code></a> commands through
          <span class="productname">Pgpool-II</span>, and the database will be created
          on all the nodes.
          </p><pre class="programlisting">$ createdb -p 9999 bench_replication
          </pre><p>
          Then, we'll execute <a class="ulink" href="https://www.postgresql.org/docs/current/static/pgbench.html" target="_top">        <code class="command">pgbench</code></a> with <code class="literal">-i</code> option.
          <code class="literal">-i</code> option initializes the database with pre-defined tables and data.
          </p><pre class="programlisting">$ pgbench -i -p 9999 bench_replication
          </pre><p>
          The following table is the summary of tables and data, which will be created by
          <a class="ulink" href="https://www.postgresql.org/docs/current/static/pgbench.html" target="_top">        <code class="command">pgbench -i</code></a>. If, on all the nodes, the listed tables and
          data are created, replication is working correctly.
        </p><div class="table" id="example-configs-checking-replication-table"><p class="title"><strong>Table 7.1. data summary</strong></p><div class="table-contents"><table class="table" summary="data summary" border="1"><colgroup><col /><col /></colgroup><thead><tr><th>Table Name</th><th>Number of Rows</th></tr></thead><tbody><tr><td>branches</td><td>1</td></tr><tr><td>tellers</td><td>10</td></tr><tr><td>accounts</td><td>100000</td></tr><tr><td>history</td><td>0</td></tr></tbody></table></div></div><br class="table-break" /><p>          Let's use a simple shell script to check the above on all the nodes.
          The following script will display the number of rows in branches,
          tellers, accounts, and history tables on all the nodes (5432, 5433, 5434).
            </p><pre class="programlisting">$ for port in 5432 5433 5434; do
&gt;     echo $port
&gt;     for table_name in branches tellers accounts history; do
&gt;         echo $table_name
&gt;         psql -c "SELECT count(*) FROM $table_name" -p $port bench_replication
&gt;     done
&gt; done
            </pre><p>

        </p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="example-configs.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="example-configs.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="example-watchdog.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter 7. Configuration Examples </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 7.2. Watchdog Configuration Example</td></tr></table></div></body></html>