<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>2.2. Integrating external lifecheck with watchdog</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="pgpool-II 3.6beta2 Documentation" /><link rel="up" href="tutorial-watchdog.html" title="Chapter 2. Watchdog" /><link rel="prev" href="tutorial-watchdog-intro.html" title="2.1. Introduction" /><link rel="next" href="tutorial-watchdog-restrictions.html" title="2.3. Restrictions on watchdog" /><link rel="copyright" href="legalnotice.html" title="Legal Notice" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">2.2. Integrating external lifecheck with watchdog</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="tutorial-watchdog-intro.html">Prev</a> </td><th width="60%" align="center">Chapter 2. Watchdog</th><td width="20%" align="right"> <a accesskey="n" href="tutorial-watchdog-restrictions.html">Next</a></td></tr></table><hr /></div><div class="sect1" id="tutorial-watchdog-integrating-external-lifecheck"><div class="titlepage"><div><div><h2 class="title" style="clear: both">2.2. Integrating external lifecheck with watchdog</h2></div></div></div><p>      <span class="productname">Pgpool-II</span> watchdog process uses the
      <acronym class="acronym">BSD</acronym> sockets for communicating with
      all the <span class="productname">Pgpool-II</span> processes and the
      same <acronym class="acronym">BSD</acronym> socket can also be used by any third
      party system to provide the lifecheck function for local and remote
      <span class="productname">Pgpool-II</span> watchdog nodes.
      The <acronym class="acronym">BSD</acronym> socket file name for IPC is constructed
      by appending <span class="productname">Pgpool-II</span> wd_port after
      <code class="literal">"s.PGPOOLWD_CMD."</code> string and the socket file is
      placed in the <a class="xref" href="runtime-watchdog-config.html#guc-wd-ipc-socket-dir">wd_ipc_socket_dir</a> directory.
    </p><div class="sect2" id="tutorial-watchdog-ipc-command-packet"><div class="titlepage"><div><div><h3 class="title">2.2.1. Watchdog IPC command packet format</h3></div></div></div><a id="idp56388368" class="indexterm"></a><p>      The watchdog IPC command packet consists of three fields.
      Below table details the message fields and description.
    </p><div class="table" id="wd-ipc-command-format-table"><p class="title"><strong>Table 2.1. Watchdog IPC command packet format</strong></p><div class="table-contents"><table summary="Watchdog IPC command packet format" border="1"><colgroup><col /><col /><col /></colgroup><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>TYPE</td><td>BYTE1</td><td>Command Type</td></tr><tr><td>LENGTH</td><td>INT32 in network byte order</td><td>The length of data to follow</td></tr><tr><td>DATA</td><td>DATA in <acronym class="acronym">JSON</acronym> format</td><td>Command data in <acronym class="acronym">JSON</acronym> format</td></tr></tbody></table></div></div><br class="table-break" /></div><div class="sect2" id="tutorial-watchdog-ipc-result-packet"><div class="titlepage"><div><div><h3 class="title">2.2.2. Watchdog IPC result packet format</h3></div></div></div><a id="idp56395856" class="indexterm"></a><p>      The watchdog IPC command result packet consists of three fields.
      Below table details the message fields and description.
    </p><div class="table" id="wd-ipc-resutl-format-table"><p class="title"><strong>Table 2.2. Watchdog IPC result packet format</strong></p><div class="table-contents"><table summary="Watchdog IPC result packet format" border="1"><colgroup><col /><col /><col /></colgroup><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>TYPE</td><td>BYTE1</td><td>Command Type</td></tr><tr><td>LENGTH</td><td>INT32 in network byte order</td><td>The length of data to follow</td></tr><tr><td>DATA</td><td>DATA in <acronym class="acronym">JSON</acronym> format</td><td>Command result data in <acronym class="acronym">JSON</acronym> format</td></tr></tbody></table></div></div><br class="table-break" /></div><div class="sect2" id="tutorial-watchdog-ipc-command-packet-types"><div class="titlepage"><div><div><h3 class="title">2.2.3. Watchdog IPC command packet types</h3></div></div></div><a id="idp56403360" class="indexterm"></a><p>      The first byte of the IPC command packet sent to watchdog process
      and the result returned by watchdog process is identified as the
      command or command result type.
      The below table lists all valid types and their meanings
    </p><div class="table" id="wd-ipc-command-packet--types-table"><p class="title"><strong>Table 2.3. Watchdog IPC command packet types</strong></p><div class="table-contents"><table summary="Watchdog IPC command packet types" border="1"><colgroup><col /><col /><col /><col /></colgroup><thead><tr><th>Name</th><th>Byte Value</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>REGISTER FOR NOTIFICATIONS</td><td>'0'</td><td>Command packet</td><td>Command to register the current connection to receive watchdog notifications</td></tr><tr><td>NODE STATUS CHANGE</td><td>'2'</td><td>Command packet</td><td>Command to inform watchdog about node status change of watchddog node</td></tr><tr><td>GET NODES LIST</td><td>'3'</td><td>Command packet</td><td>Command to get the list of all configured watchdog nodes</td></tr><tr><td>NODES LIST DATA</td><td>'4'</td><td>Result packet</td><td>The <acronym class="acronym">JSON</acronym> data in packet contains the list of all configured watchdog nodes</td></tr><tr><td>CLUSTER IN TRANSITION</td><td>'7'</td><td>Result packet</td><td>Watchdog returns this packet type when it is not possible to process the command because the cluster is transitioning.</td></tr><tr><td>RESULT BAD</td><td>'8'</td><td>Result packet</td><td>Watchdog returns this packet type when the IPC command fails</td></tr><tr><td>RESULT OK</td><td>'9'</td><td>Result packet</td><td>Watchdog returns this packet type when IPC command succeeds</td></tr></tbody></table></div></div><br class="table-break" /></div><div class="sect2" id="tutorial-watchdog-external-lifecheck-ipc"><div class="titlepage"><div><div><h3 class="title">2.2.4. External lifecheck IPC packets and data</h3></div></div></div><a id="idp56416848" class="indexterm"></a><p>      "GET NODES LIST" ,"NODES LIST DATA" and "NODE STATUS CHANGE"
      IPC messages of watchdog can be used to integration an external
      lifecheck systems. Note that the built-in lifecheck of pgpool
      also uses the same channel and technique.
    </p><div class="sect3" id="tutorial-watchdog-external-lifecheck-get-nodes"><div class="titlepage"><div><div><h4 class="title">2.2.4.1. Getting list of configured watchdog nodes</h4></div></div></div><a id="idp56418864" class="indexterm"></a><p>        Any third party lifecheck system can send the "GET NODES LIST"
        packet on watchdog IPC socket with a <acronym class="acronym">JSON</acronym>
        data containing the authorization key and value if
        <a class="xref" href="runtime-watchdog-config.html#guc-wd-authkey">wd_authkey</a> is set or empty packet data
        when <a class="xref" href="runtime-watchdog-config.html#guc-wd-authkey">wd_authkey</a> is not configured to get
        the "NODES LIST DATA" result packet.
      </p><p>        The result packet returnd by watchdog for the "GET NODES LIST"
        will contains the list of all configured watchdog nodes to do
        health check on in the <acronym class="acronym">JSON</acronym> format.
        The <acronym class="acronym">JSON</acronym> of the watchdog nodes contains the
        <code class="literal">"WatchdogNodes"</code> Array of all watchdog nodes.
        Each watchdog <acronym class="acronym">JSON</acronym> node contains the
        <code class="literal">"ID"</code>, <code class="literal">"NodeName"</code>,
        <code class="literal">"HostName"</code>, <code class="literal">"DelegateIP"</code>,
        <code class="literal">"WdPort"</code> and <code class="literal">"PgpoolPort"</code>
        for each node.
      </p><p>        </p><pre class="programlisting">    -- The example JSON data contained in "NODES LIST DATA"

      {
      "NodeCount":3,
      "WatchdogNodes":
        [
          {
            "ID":0,
            "State":1,
            "NodeName":"Linux_ubuntu_9999",
            "HostName":"watchdog-host1",
            "DelegateIP":"172.16.5.133",
            "WdPort":9000,
            "PgpoolPort":9999
          },
          {
            "ID":1,
            "State":1,
            "NodeName":"Linux_ubuntu_9991",
            "HostName":"watchdog-host2",
            "DelegateIP":"172.16.5.133",
            "WdPort":9000,
            "PgpoolPort":9991
          },
          {
            "ID":2,
            "State":1,
            "NodeName":"Linux_ubuntu_9992",
            "HostName":"watchdog-host3",
            "DelegateIP":"172.16.5.133",
            "WdPort":9000,
            "PgpoolPort":9992
          }
        ]
      }

    -- Note that ID 0 is always reserved for local watchdog node

        </pre><p>
      </p><p>        After getting the configured watchdog nodes information from the
        watchdog the external lifecheck system can proceed with the
        health checking of watchdog nodes, and when it detects some status
        change of any node it can inform that to watchdog using the
        "NODE STATUS CHANGE" IPC messages of watchdog.
        The data in the message should contain the <acronym class="acronym">JSON</acronym>
        with the node ID of the node whose status is changed
        (The node ID must be same as returned by watchdog for that node
        in WatchdogNodes list) and the new status of node.
      </p><p>        </p><pre class="programlisting">  -- The example JSON to inform pgpool-II watchdog about health check
  failed on node with ID 1 will look like

    {
    "NodeID":1,
    "NodeStatus":1,
    "Message":"optional message string to log by watchdog for this event"
    "IPCAuthKey":"wd_authkey configuration parameter value"
    }

  -- NodeStatus values meanings are as follows
  NODE STATUS DEAD  =  1
  NODE STATUS ALIVE =  2

        </pre><p>
      </p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="tutorial-watchdog-intro.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="tutorial-watchdog.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="tutorial-watchdog-restrictions.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">2.1. Introduction </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 2.3. Restrictions on watchdog</td></tr></table></div></body></html>