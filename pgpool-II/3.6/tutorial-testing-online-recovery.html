<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>1.6. Testing Online Recovery</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="pgpool-II 3.6.0 Documentation" /><link rel="up" href="tutorial-start.html" title="Chapter 1. Getting Started" /><link rel="prev" href="tutorial-testing-failover.html" title="1.5. Testing Fail Over" /><link rel="next" href="tutorial-arch.html" title="1.7. Architectural Fundamentals" /><link rel="copyright" href="legalnotice.html" title="Legal Notice" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">1.6. Testing Online Recovery</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="tutorial-testing-failover.html">Prev</a> </td><th width="60%" align="center">Chapter 1. Getting Started</th><td width="20%" align="right"> <a accesskey="n" href="tutorial-arch.html">Next</a></td></tr></table><hr /></div><div class="sect1" id="tutorial-testing-online-recovery"><div class="titlepage"><div><div><h2 class="title" style="clear: both">1.6. Testing Online Recovery</h2></div></div></div><p>      <span class="productname">Pgpool-II</span> allows to recover a downed
      node by technique called "Online Recovery". This copies data
      from the primary node to a standby node so that it sync with the
      primary. This may take long time and database may be updated
      during the process. That's no problem because in the streaming
      configuration, the standby will receive WAL log and applies it
      to catch up the primary. To test online recovery, let's start
      with previous cluster, where node 0 is in down state.
      </p><pre class="programlisting">$ pcp_recovery_node -p 11001 0
Password: 
pcp_recovery_node -- Command Successful

$ psql -p 11000 -c "show pool_nodes" test
 node_id | hostname | port  | status | lb_weight |  role   | select_cnt | load_balance_node | replication_delay 
---------+----------+-------+--------+-----------+---------+------------+-------------------+-------------------
 0       | /tmp     | 11002 | up     | 0.500000  | standby | 2173       | true              | 0
 1       | /tmp     | 11003 | up     | 0.500000  | primary | 0          | false             | 0
(2 rows)
      </pre><p>
      <a class="xref" href="pcp-recovery-node.html" title="pcp_recovery_node"><span class="refentrytitle">pcp_recovery_node</span></a> is one of control commands
      coming with <span class="productname">Pgpool-II</span>
      installation. The argument -p is to specify the port number
      assigned to the command, which is 11001 set
      by <code class="command">pgpool_setup</code>. The second argument is the
      target node id. After executing the command, node 0 returned to
      "up" status.
    </p><p>      The script executed by <code class="command">pcp_recovery_node</code> is
      specified as "recovery_1st_stage_command"
      in <code class="filename">pgpool.conf</code>. Here is the file installed
      by <code class="command">pgpool_setup</code>.
      </p><pre class="programlisting">#! /bin/sh
psql=/usr/local/pgsql/bin/psql
DATADIR_BASE=/home/t-ishii/tmp/Tutorial
PGSUPERUSER=t-ishii

master_db_cluster=$1
recovery_node_host_name=$2
DEST_CLUSTER=$3
PORT=$4

log=$DATADIR_BASE/log/recovery.log

$psql -p $PORT -c "SELECT pg_start_backup('Streaming Replication', true)" postgres

echo "source: $master_db_cluster dest: $DEST_CLUSTER" &gt; $log

rsync -C -a -c --delete --exclude postgresql.conf --exclude postmaster.pid \
--exclude postmaster.opts --exclude pg_log \
--exclude recovery.conf --exclude recovery.done \
--exclude pg_xlog \
$master_db_cluster/ $DEST_CLUSTER/

rm -fr $DEST_CLUSTER/pg_xlog 
mkdir $DEST_CLUSTER/pg_xlog
chmod 700 $DEST_CLUSTER/pg_xlog
rm $DEST_CLUSTER/recovery.done
cat &gt; $DEST_CLUSTER/recovery.conf $lt;$lt;REOF
standby_mode          = 'on'
primary_conninfo      = 'port=$PORT user=$PGSUPERUSER'
recovery_target_timeline='latest'
REOF

$psql -p $PORT -c "SELECT pg_stop_backup()" postgres
      </pre><p>
    </p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="tutorial-testing-failover.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="tutorial-start.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="tutorial-arch.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">1.5. Testing Fail Over </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 1.7. Architectural Fundamentals</td></tr></table></div></body></html>