<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>7.2. Watchdogの設定例</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Pgpool-II 3.7devel 文書" /><link rel="up" href="example-configs.html" title="第7章 設定の例" /><link rel="prev" href="example-basic.html" title="7.1. 基本設定の例" /><link rel="next" href="example-aws.html" title="7.3. AWS設定の例" /><link rel="copyright" href="legalnotice.html" title="Legal Notice" /><meta name="viewport" content="width=device-width,initial-scale=1.0" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><td width="20%" align="left" colspan="2"></td><th width="60%" align="center"><a accesskey="h" href="index.html">Pgpool-II 3.7devel 文書</a></th><td width="20%" align="right"></td></tr><tr><td width="10%" align="left" valign="top"><a accesskey="p" href="example-basic.html">前へ</a> </td><td width="10%" align="left" valign="top"><a accesskey="u" href="example-configs.html">上へ</a></td><td width="60%" align="center">7.2. Watchdogの設定例</td><td width="20%" align="right" valign="top"> <a accesskey="n" href="example-aws.html">次へ</a></td></tr></table><hr /></div><div class="sect1" id="example-watchdog"><div class="titlepage"><div><div><h2 class="title" style="clear: both">7.2. Watchdogの設定例</h2></div></div></div><p>ここではwatchdogの機能を簡単に試す方法を説明します。
Linux マシン2台にそれぞれ <span class="productname">Pgpool-II</span> がインストールされているものとします。
また、いずれかのマシンか第 3 のマシンに、<span class="productname">PostgreSQL</span> がインストールされて稼働しているものとします。
バックエンドノードは1台でかまいません。
<span class="productname">Pgpool-II</span> がどのモードで稼働していても（レプリケーションモードでもマスタースレーブモードでも）、watchdogを利用することができます。
    </p><p>この例では、「osspc16」をActiveノードとして、「osspc20」をStandbyノードとして使います。
「someserver」は、これらのどちらかということを意味しています。
    </p><div class="sect2" id="example-watchdog-configuration"><div class="titlepage"><div><div><h3 class="title">7.2.1. 共通設定</h3></div></div></div><p>アクティブとスタンバイの両サーバで以下を設定します。
      </p><div class="sect3" id="example-watchdog-config-enable"><div class="titlepage"><div><div><h4 class="title">7.2.1.1. Watchdogの有効化</h4></div></div></div><p>まず、<a class="xref" href="runtime-watchdog-config.html#guc-use-watchdog">use_watchdog</a>をonにします。
          </p><pre class="programlisting">use_watchdog = on
                                    # Activates watchdog
          </pre><p>
        </p></div><div class="sect3" id="example-watchdog-config-upstream"><div class="titlepage"><div><div><h4 class="title">7.2.1.2. 上位サーバの設定</h4></div></div></div><p>上流のサーバ（アプリケーションサーバなど）を指定します。
空欄にしておいても構いません。
          </p><pre class="programlisting">trusted_servers = ''
                                    # trusted server list which are used
                                    # to confirm network connection
                                    # (hostA,hostB,hostC,...)
          </pre><p>
        </p></div><div class="sect3" id="example-watchdog-config-wd-comm"><div class="titlepage"><div><div><h4 class="title">7.2.1.3. Watchdog通信</h4></div></div></div><p>watchdog通信を行うTCPポート番号を指定します。
          </p><pre class="programlisting">wd_port = 9000
                                    # port number for watchdog service
          </pre><p>
        </p></div><div class="sect3" id="example-watchdog-config-wd-vip"><div class="titlepage"><div><div><h4 class="title">7.2.1.4. 仮想IP</h4></div></div></div><p>仮想IPを<a class="xref" href="runtime-watchdog-config.html#guc-delegate-ip">delegate_IP</a>に設定します。
          </p><pre class="programlisting">delegate_IP = '133.137.177.143'
                                    # delegate IP address
          </pre><p>
        </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>仮想IPに設定されるIPアドレスは空いており他のマシンで使用されていないことを確認してください。
          </p></div></div></div><div class="sect2" id="example-watchdog-configuration-each-server"><div class="titlepage"><div><div><h3 class="title">7.2.2. 個々のサーバ設定</h3></div></div></div><p>次に、それぞれの<span class="productname">Pgpool-II</span>で以下のパラメータを設定します。
<a class="xref" href="runtime-watchdog-config.html#guc-other-pgpool-hostname">other_pgpool_hostname</a>、<a class="xref" href="runtime-watchdog-config.html#guc-other-pgpool-port">other_pgpool_port</a>、<a class="xref" href="runtime-watchdog-config.html#guc-other-wd-port">other_wd_port</a>を他の<span class="productname">Pgpool-II</span>の値で設定します。
      </p><div class="sect3" id="example-watchdog-configuration-active-server"><div class="titlepage"><div><div><h4 class="title">7.2.2.1. Activeサーバの設定(osspc16)</h4></div></div></div><p>          </p><pre class="programlisting">other_pgpool_hostname0 = 'osspc20'
                                    # Host name or IP address to connect to for other pgpool 0
other_pgpool_port0 = 9999
                                    # Port number for othet pgpool 0
other_wd_port0 = 9000
                                    # Port number for othet watchdog 0
          </pre><p>
        </p></div><div class="sect3" id="example-watchdog-configuration-standby-server"><div class="titlepage"><div><div><h4 class="title">7.2.2.2. Standbyサーバの設定(osspc20)</h4></div></div></div><p>          </p><pre class="programlisting">other_pgpool_hostname0 = 'osspc16'
                                    # Host name or IP address to connect to for other pgpool 0
other_pgpool_port0 = 9999
                                    # Port number for othet pgpool 0
other_wd_port0 = 9000
                                    # Port number for othet watchdog 0
          </pre><p>
        </p></div></div><div class="sect2" id="example-watchdog-start-server"><div class="titlepage"><div><div><h3 class="title">7.2.3. <span class="productname">Pgpool-II</span>の起動</h3></div></div></div><p>両方のサーバで<span class="productname">Pgpool-II</span>を<code class="literal">root</code>ユーザで、<code class="literal">"-n"</code>オプションを付けて起動し、ログメッセージはpgpool.logファイルにリダイレクトします。
      </p><div class="sect3" id="example-watchdog-start-active-server"><div class="titlepage"><div><div><h4 class="title">7.2.3.1. ActiveサーバでのPgpool-II起動(osspc16)</h4></div></div></div><p>最初に、Active サーバで<span class="productname">Pgpool-II</span>を起動します。
          </p><pre class="programlisting">[user@osspc16]$ su -
[root@osspc16]# {installed_dir}/bin/pgpool -n -f {installed_dir}/etc/pgpool.conf &gt; pgpool.log 2&gt;&amp;1
          </pre><p>
ログから、仮想IP アドレスを使用し、またwatchdogプロセス起動したことが確認できます。
          </p><pre class="programlisting">LOG:  I am announcing my self as master/coordinator watchdog node
LOG:  I am the cluster leader node
DETAIL:  our declare coordinator message is accepted by all nodes
LOG:  I am the cluster leader node. Starting escalation process
LOG:  escalation process started with PID:59449
<span class="emphasis"><strong>LOG:  watchdog process is initialized
LOG:  watchdog: escalation started
LOG:  I am the master watchdog node</strong></span>
DETAIL:  using the local backend node status
          </pre><p>
        </p></div><div class="sect3" id="example-watchdog-start-standby-server"><div class="titlepage"><div><div><h4 class="title">7.2.3.2. StandbyサーバでのPgpool-II起動(osspc20)</h4></div></div></div><p>次に、Standbyサーバで<span class="productname">Pgpool-II</span>を起動します。
          </p><pre class="programlisting">[user@osspc20]$ su -
[root@osspc20]# {installed_dir}/bin/pgpool -n -f {installed_dir}/etc/pgpool.conf &gt; pgpool.log 2&gt;&amp;1
          </pre><p>
ログメッセージから<span class="productname">Pgpool-II</span>がwatchdogクラスタにスタンバイとして参加したことがわかります。
          </p><pre class="programlisting">LOG:  watchdog cluster configured with 1 remote nodes
LOG:  watchdog remote node:0 on Linux_osspc16_9000:9000
LOG:  interface monitoring is disabled in watchdog
LOG:  IPC socket path: "/tmp/.s.PGPOOLWD_CMD.9000"
LOG:  watchdog node state changed from [DEAD] to [LOADING]
LOG:  new outbond connection to Linux_osspc16_9000:9000
LOG:  watchdog node state changed from [LOADING] to [INITIALIZING]
LOG:  watchdog node state changed from [INITIALIZING] to [STANDBY]
<span class="emphasis"><strong>LOG:  successfully joined the watchdog cluster as standby node
DETAIL:  our join coordinator request is accepted by cluster leader node "Linux_osspc16_9000"
LOG:  watchdog process is initialized</strong></span>
          </pre><p>
        </p></div></div><div class="sect2" id="example-watchdog-try"><div class="titlepage"><div><div><h3 class="title">7.2.4. 動作確認</h3></div></div></div><p>仮想 IP アドレスに、pingが通ることを確認します。
      </p><pre class="programlisting">[user@someserver]$ ping 133.137.177.142
PING 133.137.177.143 (133.137.177.143) 56(84) bytes of data.
64 bytes from 133.137.177.143: icmp_seq=1 ttl=64 time=0.328 ms
64 bytes from 133.137.177.143: icmp_seq=2 ttl=64 time=0.264 ms
64 bytes from 133.137.177.143: icmp_seq=3 ttl=64 time=0.412 ms
      </pre><p>
先に<span class="productname">Pgpool-II</span>を起動したActiveサーバが、仮想IPアドレスを使っていることを確認します。
      </p><pre class="programlisting">[root@osspc16]# ifconfig
eth0      ...

eth0:0    inet addr:133.137.177.143 ...

lo        ...
      </pre><p>
後から<span class="productname">Pgpool-II</span>を立ち上げたStandbサーバは、仮想IPアドレスを使っていないことを確認します。
      </p><pre class="programlisting">[root@osspc20]# ifconfig
eth0      ...

lo        ...
      </pre><p>

仮想IPアドレスを使って、<span class="productname">PostgreSQL</span> に接続をできることを確認します。
      </p><pre class="programlisting">[user@someserver]$ psql -h 133.137.177.142 -p 9999 -l
      </pre><p>
      </p></div><div class="sect2" id="example-watchdog-vip-switch"><div class="titlepage"><div><div><h3 class="title">7.2.5. 仮想IPの切り替え</h3></div></div></div><p>Activeサーバがサービス供給不可な状態になったときに、Standbyがそれを引き継ぐのを確認します。
Activeサーバの<span class="productname">Pgpool-II</span>を停止します。
        </p><pre class="programlisting">[root@osspc16]# {installed_dir}/bin/pgpool stop
      </pre><p>

するとStandbyサーバで、仮想IPアドレスを使用しはじめたというログメッセージが出力されます。

        </p><pre class="programlisting"><span class="emphasis"><strong>LOG:  remote node "Linux_osspc16_9000" is shutting down
LOG:  watchdog cluster has lost the coordinator node</strong></span>
LOG:  watchdog node state changed from [STANDBY] to [JOINING]
LOG:  watchdog node state changed from [JOINING] to [INITIALIZING]
LOG:  I am the only alive node in the watchdog cluster
HINT:  skiping stand for coordinator state
LOG:  watchdog node state changed from [INITIALIZING] to [MASTER]
LOG:  I am announcing my self as master/coordinator watchdog node
LOG:  I am the cluster leader node
DETAIL:  our declare coordinator message is accepted by all nodes
<span class="emphasis"><strong>LOG:  I am the cluster leader node. Starting escalation process
LOG:  watchdog: escalation started</strong></span>
LOG:  watchdog escalation process with pid: 59551 exit with SUCCESS.
         </pre><p>

仮想 IP アドレスに、pingが通ることを確認します。
         </p><pre class="programlisting">[user@someserver]$ ping 133.137.177.142
PING 133.137.177.143 (133.137.177.143) 56(84) bytes of data.
64 bytes from 133.137.177.143: icmp_seq=1 ttl=64 time=0.328 ms
64 bytes from 133.137.177.143: icmp_seq=2 ttl=64 time=0.264 ms
64 bytes from 133.137.177.143: icmp_seq=3 ttl=64 time=0.412 ms
      </pre><p>

Activeではもう仮想IPアドレスが使われなくなったのを確認します。
         </p><pre class="programlisting">[root@osspc16]# ifconfig
eth0      ...

lo        ...
        </pre><p>

Standbyで仮想IP アドレスが使われていることを確認します。
         </p><pre class="programlisting">[root@osspc20]# ifconfig
eth0      ...

eth0:0    inet addr:133.137.177.143 ...

lo        ...
        </pre><p>

仮想IPアドレスを使って、<span class="productname">PostgreSQL</span>に接続できることを確認します。
        </p><pre class="programlisting">[user@someserver]$ psql -h 133.137.177.142 -p 9999 -l
        </pre><p>

      </p></div><div class="sect2" id="example-watchdog-more"><div class="titlepage"><div><div><h3 class="title">7.2.6. 応用</h3></div></div></div><div class="sect3" id="example-watchdog-more-lifecheck"><div class="titlepage"><div><div><h4 class="title">7.2.6.1. 死活監視</h4></div></div></div><p>watchdog の監視方法について設定するパラメータがあります。
監視間隔秒を指定する<a class="xref" href="runtime-watchdog-config.html#guc-wd-interval">wd_interval</a>、リトライ回数を指定する<a class="xref" href="runtime-watchdog-config.html#guc-wd-life-point">wd_life_point</a>、 監視に使うクエリを指定する<a class="xref" href="runtime-watchdog-config.html#guc-wd-lifecheck-query">wd_lifecheck_query</a>、死活監視のタイプを指定する<a class="xref" href="runtime-watchdog-config.html#guc-wd-lifecheck-method">wd_lifecheck_method</a>を記述します。
          </p><pre class="programlisting">wd_lifecheck_method = 'query'
                                    # Method of watchdog lifecheck ('heartbeat' or 'query' or 'external')
                                    # (change requires restart)
wd_interval = 10
                                    # lifecheck interval (sec) &gt; 0
wd_life_point = 3
                                    # lifecheck retry times
wd_lifecheck_query = 'SELECT 1'
                                    # lifecheck query to pgpool from watchdog
        </pre><p>

        </p></div><div class="sect3" id="example-watchdog-more-vip-switching"><div class="titlepage"><div><div><h4 class="title">7.2.6.2. 仮想IPの切り替え</h4></div></div></div><p>IP アドレスの切り替えコマンドについて設定するパラメータがあります。
仮想 IP を切り替える際に使うコマンドとして<a class="xref" href="runtime-watchdog-config.html#guc-if-up-cmd">if_up_cmd</a>、<a class="xref" href="runtime-watchdog-config.html#guc-if-down-cmd">if_down_cmd</a>、そのパスを指定する<a class="xref" href="runtime-watchdog-config.html#guc-if-cmd-path">if_cmd_path</a>を記述します。
また、仮想IP切り替え後のARPリクエスト送信コマンドを指定する<a class="xref" href="runtime-watchdog-config.html#guc-arping-cmd">arping_cmd</a>、そのパスを指定する<a class="xref" href="runtime-watchdog-config.html#guc-arping-path">arping_path</a>を記述します。
          </p><pre class="programlisting">ifconfig_path = '/sbin'
                                    # ifconfig command path
if_up_cmd = 'ifconfig eth0:0 inet $_IP_$ netmask 255.255.255.0'
                                    # startup delegate IP command
if_down_cmd = 'ifconfig eth0:0 down'
                                    # shutdown delegate IP command

arping_path = '/usr/sbin'           # arping command path

arping_cmd = 'arping -U $_IP_$ -w 1'
        </pre><p>
<a class="xref" href="runtime-watchdog-config.html#guc-wd-escalation-command">wd_escalation_command</a>および<a class="xref" href="runtime-watchdog-config.html#guc-wd-de-escalation-command">wd_de_escalation_command</a>の設定を用いて仮想IPの起動・停止を行う同時にスクリプトを使うこともできます。

        </p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="example-basic.html">前へ</a> </td><td width="20%" align="center"><a accesskey="u" href="example-configs.html">上へ</a></td><td width="40%" align="right"> <a accesskey="n" href="example-aws.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">7.1. 基本設定の例 </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> 7.3. AWS設定の例</td></tr></table></div></body></html>