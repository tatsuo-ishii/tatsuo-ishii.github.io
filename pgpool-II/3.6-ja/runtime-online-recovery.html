<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>5.10. オンラインリカバリ</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Pgpool-II 3.7devel 文書" /><link rel="up" href="runtime-config.html" title="第5章 サーバの設定" /><link rel="prev" href="runtime-config-failover.html" title="5.9. フェイルオーバとフェイルバック" /><link rel="next" href="runtime-streaming-replication-check.html" title="5.11. ストリーミングレプリケーションのチェック" /><link rel="copyright" href="legalnotice.html" title="Legal Notice" /><meta name="viewport" content="width=device-width,initial-scale=1.0" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><td width="20%" align="left" colspan="2"></td><th width="60%" align="center"><a accesskey="h" href="index.html">Pgpool-II 3.7devel 文書</a></th><td width="20%" align="right"></td></tr><tr><td width="10%" align="left" valign="top"><a accesskey="p" href="runtime-config-failover.html">前へ</a> </td><td width="10%" align="left" valign="top"><a accesskey="u" href="runtime-config.html">上へ</a></td><td width="60%" align="center">5.10. オンラインリカバリ</td><td width="20%" align="right" valign="top"> <a accesskey="n" href="runtime-streaming-replication-check.html">次へ</a></td></tr></table><hr /></div><div class="sect1" id="runtime-online-recovery"><div class="titlepage"><div><div><h2 class="title" style="clear: both">5.10. オンラインリカバリ</h2></div></div></div><p><span class="productname">Pgpool-II</span> はサービスを止めることなくデータベースノード同期させ、ノードを復帰させることができます。
この機能は「<acronym class="acronym">オンラインリカバリ</acronym>」と呼ばれます。
  </p><p>オンラインリカバリを実施するためには、リカバリ対象のノードは<span class="productname">Pgpool-II</span>から切り離されている必要があります。
新しい<span class="productname">PostgreSQL</span>サーバを動的に追加したい場合には、<a class="xref" href="runtime-config-backend-settings.html#guc-backend-hostname">backend_hostname</a>および関連パラメータを追加した後に<code class="filename">pgpool.conf</code>を再読み込みします。
これにより新しいサーバが切り離された状態のバックエンドノードとして<span class="productname">Pgpool-II</span>に登録されます。
  </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>オンラインリカバリ実行のためには、対象となる<span class="productname">PostgreSQL</span>サーバは稼働していてはいけません。
対象の<span class="productname">PostgreSQL</span>がすでに動作中であれば、オンラインリカバリを開始する前にシャットダウンしておいてください。 
    </p></div><p>オンラインリカバリは2段階に分けて実施されます。
ファーストステージではデータの更新や読み取りができますが、セカンドステージではクライアントからの接続は許されていません。
オンラインリカバリでは<span class="productname">Pgpool-II</span>は以下の手順を実施します。
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>        CHECKPOINT.
      </p></li><li class="listitem"><p>オンラインリカバリのファーストステージ。
      </p></li><li class="listitem"><p>全てのクライアント接続が切断されるまで待機
      </p></li><li class="listitem"><p>        CHECKPOINT.
      </p></li><li class="listitem"><p>オンラインリカバリのセカンドステージ。
      </p></li><li class="listitem"><p>postmasterの起動（<code class="literal">pgpool_remote_start</code>の実施）
      </p></li><li class="listitem"><p>ノードの復帰
      </p></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>オンラインリカバリには制限事項があります。
<span class="productname">Pgpool-II</span>が複数のホストにインストールされている場合、<span class="productname">Pgpool-II</span>はオンラインリカバリの2ndステージの間全てのクライアントを止める必要があるため、オンラインリカバリは正しく動作しません。
複数の<span class="productname">Pgpool-II</span>ホストがある場合、そのうちの１台のみがオンラインリカバコマンドを受け取り、クライアントからの接続をブロックします。
    </p></div><div class="variablelist"><dl class="variablelist"><dt id="guc-recovery-user"><span class="term"><code class="varname">recovery_user</code> (<code class="type">string</code>)
        <a id="idm45645430267376" class="indexterm"></a>
      </span></dt><dd><p>オンラインリカバリを行うための<span class="productname">PostgreSQL</span>ユーザ名です。
      </p><p>このパラメータは<span class="productname">Pgpool-II</span>の設定を再読み込みすることで変更可能です。
        </p></dd><dt id="guc-recovery-password"><span class="term"><code class="varname">recovery_password</code> (<code class="type">string</code>)
        <a id="idm45645430262160" class="indexterm"></a>
      </span></dt><dd><p>オンラインリカバリを行うための PostgreSQL ユーザパスワードです。
          <a class="xref" href="runtime-online-recovery.html#guc-recovery-user">recovery_user</a> to perform online recovery.
        </p><p>このパラメータは<span class="productname">Pgpool-II</span>の設定を再読み込みすることで変更可能です。
        </p></dd><dt id="guc-recovery-1st-stage-command"><span class="term"><code class="varname">recovery_1st_stage_command</code> (<code class="type">string</code>)
        <a id="idm45645430256752" class="indexterm"></a>
      </span></dt><dd><p>オンラインリカバリのファーストステージでマスタ（プライマリ）ノードで実行されるコマンドを指定します。
コマンドファイルはセキュリティ上の観点からデータベースクラスタ内に配置される必要があります。
例えば、<code class="varname">recovery_1st_stage_command</code> = <code class="literal">'sync-command'</code>となっている場合、<span class="productname">Pgpool-II</span>はコマンドスクリプトを<code class="literal">$PGDATA</code>ディレクトリの中で探し、<code class="command">$PGDATA/sync-command</code>を起動しようとします。
        </p><p><code class="varname">recovery_1st_stage_command</code>は次の4つの引数を受けとります。 
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>マスター（プライマリ）ノードのデータベースクラスタへのパス
            </p></li><li class="listitem"><p>リカバリされるバックエンドノードのホスト名
            </p></li><li class="listitem"><p>リカバリされるノードのデータベースクラスタへのパス
            </p></li><li class="listitem"><p>リカバリーされるノードのポート番号
            </p></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p><code class="varname">recovery_1st_stage_command</code>の実行中は<span class="productname">Pgpool-II</span>は接続やクエリを受け付けており、データの参照や更新を行うことができます。
          </p></div><div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注意</h3><p><code class="varname">recovery_1st_stage_command</code>は、<span class="productname">PostgreSQL</span>から見ると、一つの<acronym class="acronym">SQL</acronym>として実行されます。
そのため、<span class="productname">PostgreSQL</span>の<code class="varname">statement_timeout</code>が<code class="varname">recovery_1st_stage_command</code>の完了にかかる時間よりも短く設定されていると、<code class="varname">recovery_1st_stagecommand</code>コマンドの実行が途中でキャンセルされます。
          </p><p>典型的なエラーは以下のようなものです。
            </p><pre class="programlisting">rsync used in the command is killed by signal 2 for example.
            </pre><p>
          </p></div><p>このパラメータは<span class="productname">Pgpool-II</span>の設定を再読み込みすることで変更可能です。
        </p></dd><dt id="guc-recovery-2nd-stage-command"><span class="term"><code class="varname">recovery_2nd_stage_command</code> (<code class="type">string</code>)
        <a id="idm45645430239104" class="indexterm"></a>
      </span></dt><dd><p>オンラインリカバリのセカンドステージでマスタ（プライマリ）ノードで実行されるコマンドを指定します。
コマンドファイルはセキュリティ上の観点からデータベースクラスタ内に配置される必要があります。
例えば、<code class="varname">recovery_2nd_stage_command</code> = <code class="literal">'sync-command'</code>となっている場合、<span class="productname">Pgpool-II</span>はコマンドスクリプトを<code class="literal">$PGDATA</code>ディレクトリの中で探し、<code class="command">$PGDATA/sync-command</code>を起動しようとします。
        </p><p><code class="varname">recovery_2nd_stage_command</code>は次の4つの引数を受けとります。 
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>マスター（プライマリ）ノードのデータベースクラスタへのパス
            </p></li><li class="listitem"><p>リカバリされるバックエンドノードのホスト名
            </p></li><li class="listitem"><p>リカバリされるノードのデータベースクラスタへのパス
            </p></li><li class="listitem"><p>マスター（プライマリ）ノードのポート番号
            </p></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p><code class="varname">recovery_2nd_stage_command</code>の実行中は、<span class="productname">Pgpool-II</span>はクライアントからの接続およびクエリを<span class="emphasis"><em>受け付けません</em></span>。
また、コマンドを実行する前に既存のクライアントが接続を閉じるのを待ちます。
そのため、長時間接続したままのクライアントがいる場合、<code class="varname">recovery_2nd_stage_command</code>は実行されない可能性があります。
          </p></div><div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注意</h3><p><code class="varname">recovery_2nd_stage_command</code>は、<span class="productname">PostgreSQL</span>から見ると、一つの<acronym class="acronym">SQL</acronym>として実行されます。
そのため、<span class="productname">PostgreSQL</span>の<code class="varname">statement_timeout</code>が<code class="varname">recovery_2nd_stage_command</code>の完了にかかる時間よりも短く設定されていると、<code class="varname">recovery_1st_stagecommand</code>コマンドの実行が途中でキャンセルされます。
          </p></div><p>このパラメータは<span class="productname">Pgpool-II</span>の設定を再読み込みすることで変更可能です。
        </p></dd><dt id="guc-recovery-timeout"><span class="term"><code class="varname">recovery_timeout</code> (<code class="type">integer</code>)
        <a id="idm45645430221504" class="indexterm"></a>
      </span></dt><dd><p>時間内にオンラインリカバリが完了しなかった場合に、これをキャンセルするためのタイムアウトを秒単位で指定します。
<span class="productname">Pgpool-II</span>は、オンラインリカバリのセカンドステージの間は接続を受け付けけないので、このパラメータはオンラインリカバリの最中のサーバがダウンした時にオンラインリカバリをキャンセルするのに使えます。
        </p><p>このパラメータは<span class="productname">Pgpool-II</span>の設定を再読み込みすることで変更可能です。
        </p></dd><dt id="guc-client-idle-limit-in-recovery"><span class="term"><code class="varname">client_idle_limit_in_recovery</code> (<code class="type">integer</code>)
        <a id="idm45645430215840" class="indexterm"></a>
      </span></dt><dd><p>オンラインリカバリの最中で、クライアントが前回のクエリからアイドル状態のままでいるときに、それを切断するまでの時間を秒単位で指定します。
<code class="varname">client_idle_limit_in_recovery</code>は<a class="xref" href="runtime-config-connection-pooling.html#guc-client-idle-limit">client_idle_limit</a>と似ていますが、オンラインリカバリのセカンドステージでのみ効果を持ちます。
        </p><p>これは、だらしないクライアントや<span class="productname">Pgpool-II</span>の間のTCP/IPコネクションの不調（例えばケーブルの切断など）によって、<span class="productname">Pgpool-II</span>のリカバリが邪魔されるのを防止するのに役立ちます。
        </p><p>-1に設定すると、オンラインリカバリのセカンドステージが始まると全てのクライアントは直ちに切断されます。
デフォルト値は0で、この機能は無効です。
        </p><p>このパラメータは<span class="productname">Pgpool-II</span>の設定を再読み込みすることで変更可能です。
現在のセッションでのパラメータ値は、<a class="xref" href="sql-pgpool-set.html" title="PGPOOL SET"><span class="refentrytitle">PGPOOL SET</span></a>コマンドで変更することもできます。
        </p></dd></dl></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="runtime-config-failover.html">前へ</a> </td><td width="20%" align="center"><a accesskey="u" href="runtime-config.html">上へ</a></td><td width="40%" align="right"> <a accesskey="n" href="runtime-streaming-replication-check.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">5.9. フェイルオーバとフェイルバック </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> 5.11. ストリーミングレプリケーションのチェック</td></tr></table></div></body></html>