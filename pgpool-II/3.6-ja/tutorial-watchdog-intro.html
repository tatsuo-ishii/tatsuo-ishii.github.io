<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>2.1. はじめに</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Pgpool-II 3.7devel 文書" /><link rel="up" href="tutorial-watchdog.html" title="第2章 Watchdog" /><link rel="prev" href="tutorial-watchdog.html" title="第2章 Watchdog" /><link rel="next" href="tutorial-watchdog-integrating-external-lifecheck.html" title="2.2. watchdogに外部死活監視を組み込む" /><link rel="copyright" href="legalnotice.html" title="Legal Notice" /><meta name="viewport" content="width=device-width,initial-scale=1.0" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><td width="20%" align="left" colspan="2"></td><th width="60%" align="center"><a accesskey="h" href="index.html">Pgpool-II 3.7devel 文書</a></th><td width="20%" align="right"></td></tr><tr><td width="10%" align="left" valign="top"><a accesskey="p" href="tutorial-watchdog.html">前へ</a> </td><td width="10%" align="left" valign="top"><a accesskey="u" href="tutorial-watchdog.html">上へ</a></td><td width="60%" align="center">2.1. はじめに</td><td width="20%" align="right" valign="top"> <a accesskey="n" href="tutorial-watchdog-integrating-external-lifecheck.html">次へ</a></td></tr></table><hr /></div><div class="sect1" id="tutorial-watchdog-intro"><div class="titlepage"><div><div><h2 class="title" style="clear: both">2.1. はじめに</h2></div></div></div><p>Watchdogは、高可用性のための<span class="productname">Pgpool-II</span>のサブプロセスです。
Watchdogは、単一障害点を除くために複数の<span class="productname">Pgpool-II</span>を使用する際に使用されます。
Watchdogは、最初に<span class="productname">Pgpool-II</span> <span class="emphasis"><em>V3.2</em></span>で導入され、<span class="productname">Pgpool-II</span> <span class="emphasis"><em>V3.5</em></span>で常にクォーラムを保つように大きく改善されました。
この機能追加により、watchdogはより対障害性が増し、スプリットブレイン障害とネットワーク分割に対する対処および防止が強固になりました。
ただし、クォーラム機構を正しく動かすためには、pgpool-IIノードの数は奇数であり、かつ3以上でなければなりません。
  </p><div class="sect2" id="tutorial-watchdog-coordinating-nodes"><div class="titlepage"><div><div><h3 class="title">2.1.1. 複数<span class="productname">Pgpool-II</span>ノードを協調させる</h3></div></div></div><a id="idm45863247533792" class="indexterm"></a><p>watchdogは、お互いに情報をやり取りすることにより、複数の<span class="productname">Pgpool-II</span>ノードを協調させます。
    </p><p>もしwatchdogが有効なら、<span class="productname">Pgpool-II</span>ノードは起動時にマスターwatchdogノードの情報を使ってバックエンドの状態の同期を取ります。
そのノードが自分自身をマスターに昇格中であれば、バックエンド状態をローカルに初期化します。
フェイルオーバなどでバックエンドの状態が変更したら、watchdogは他の<span class="productname">Pgpool-II</span>ノードに通知し、同期を取ります。
オンラインリカバリを実行すると、バックエンドの不整合を防ぐために、watchdogはクライアントが他の<span class="productname">Pgpool-II</span>ノードに接続するのを防ぎます。
    </p><p>また、watchdogは、接続したすべての<span class="productname">Pgpool-II</span>ノードを調停し、フェイルバック、フェイルオーバ、フォローマスターコマンドがただひとつの<span class="productname">Pgpool-II</span>で実行されるようにします。
    </p></div><div class="sect2" id="tutorial-watchdog-lifechecking"><div class="titlepage"><div><div><h3 class="title">2.1.2. 他の<span class="productname">Pgpool-II</span>ノードの死活監視</h3></div></div></div><a id="idm45863247525904" class="indexterm"></a><p>watchdog死活監視は、高可用性のために、watchdogクラスタに所属する<span class="productname">Pgpool-II</span>ノードの健全性を監視するための下位コンポーネントです。
伝統的に、<span class="productname">Pgpool-II</span> watchdogは2種類のリモートの死活監視方法を提供しています。
<code class="literal">"heartbeat"</code>と<code class="literal">"query"</code>モードです。
<span class="productname">Pgpool-II</span> <span class="emphasis"><em>V3.5</em></span>で、<a class="xref" href="runtime-watchdog-config.html#guc-wd-lifecheck-method">wd_lifecheck_method</a>に新しく<code class="literal">"external"</code>が追加され、<span class="productname">Pgpool-II</span> watchdogが外部サードパーティのシステムを呼び出すことが可能になりました。
    </p><p>リモートノードの死活監視の他に、watchdog死活監視は、上位サーバへの接続を監視することにより、稼働しているノードの健全性をチェックすることができます。
監視がエラーを返したら、watchdogはローカル<span class="productname">Pgpool-II</span>ノードの障害として扱います。
    </p><p><code class="literal">heartbeat</code>モードでは、watchdogは他の<span class="productname">Pgpool-II</span>プロセスを<code class="literal">heartbeat</code>信号で監視します。
watchdogは、定期的に他の<span class="productname">Pgpool-II</span>から送られたハートビート信号を受信します。
一定期間信号が受信されなければ、watchdogはその<span class="productname">Pgpool-II</span>に障害が起こったとみなします。
冗長性のために<span class="productname">Pgpool-II</span>ノード間で取り交わされるハートビート通信のためのネットワーク接続を複数使うことができます。
これがデフォルトかつ推奨される死活監視のモードです。
    </p><p><code class="literal">query</code>モードでは、watchdogは<span class="productname">Pgpool-II</span>のプロセスではなく、サービスを監視します。
このモードでは、watchdogは他の<span class="productname">Pgpool-II</span>にクエリを送り、結果をチェックします。
       </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>この方法では、他の<span class="productname">Pgpool-II</span>からの接続が必要で、<a class="xref" href="runtime-config-connection.html#guc-num-init-children">num_init_children</a>が十分に大きくないと失敗します。
このモードは非推奨で、後方互換性のために残されています。
       </p></div><p>
      </p><p><code class="literal">external</code>モードは、<span class="productname">Pgpool-II</span> <span class="emphasis"><em>V3.5</em></span>で導入されました。
このモードでは、基本的に<span class="productname">Pgpool-II</span> watchdogの組み込み死活監視は無効になり、watchdogは外部システムがローカルと、watchdogクラスタに所属しているすべてのリモートノードの健全性について報告することを期待します。
      </p></div><div class="sect2" id="tutorial-watchdog-consistency-of-config"><div class="titlepage"><div><div><h3 class="title">2.1.3. すべての<span class="productname">Pgpool-II</span>ノードの設定パラメータの一貫性</h3></div></div></div><a id="idm45863247505008" class="indexterm"></a><p>起動時に、watchdogはローカルノードの<span class="productname">Pgpool-II</span>の設定パラメータを、マスターノードのwatchdog上の設定パラメータとの一貫性を確認し、違いがあれば警告を出します。
これにより、異なる<span class="productname">Pgpool-II</span>ノードにおける設定パラメータの違いによる好ましくない振る舞いが起きる可能性を減らします。
    </p></div><div class="sect2" id="tutorial-watchdog-changing-active"><div class="titlepage"><div><div><h3 class="title">2.1.4. 障害が検出された際のアクティブ/スタンバイ状態の切換</h3></div></div></div><a id="idm45863247501552" class="indexterm"></a><p><span class="productname">Pgpool-II</span>の障害が検出されると、watchdogは他のwatchdogにそのことを通知します。
障害が起きたのがアクティブな<span class="productname">Pgpool-II</span>であれば、watchdogは投票によって新しいアクティブ<span class="productname">Pgpool-II</span>を決定し、active/standby状態を変更します
    </p></div><div class="sect2" id="tutorial-watchdog-automatic-vip"><div class="titlepage"><div><div><h3 class="title">2.1.5. 自動仮想IP切換</h3></div></div></div><a id="idm45863247497744" class="indexterm"></a><p>スタンバイ<span class="productname">Pgpool-II</span>サーバが昇格すると、新しいアクティブサーバは仮想IPインターフェスを立ち上げます。
一方、以前のアクティブサーバは、仮想IPインターフェイスを停止します。
これにより、サーバが切り替わっても<span class="productname">Pgpool-II</span>は同じIPアドレスを使うことができます。
    </p></div><div class="sect2" id="tutorial-watchdog-changing-automatic-register-in-recovery"><div class="titlepage"><div><div><h3 class="title">2.1.6. リカバリ時にサーバをスタンバイとして自動的に登録</h3></div></div></div><a id="idm45863247494048" class="indexterm"></a><p>故障したサーバが復帰あるいは新しいサーバが追加されると、watchdogプロセスは新しいサーバの情報と共に、クラスタ内の他のwatchdogに通知します。
アクティブサーバとそれ以外のサーバ上のwatchdogはその情報を受けとります。
そして、復帰したサーバはスタンバイとして登録されます。
    </p></div><div class="sect2" id="tutorial-watchdog-start-stop"><div class="titlepage"><div><div><h3 class="title">2.1.7. watchdogの起動と停止</h3></div></div></div><a id="idm45863247491344" class="indexterm"></a><p>watchdogは、<span class="productname">Pgpool-II</span>の下位プロセスとして自動的に起動、停止されます。
したがって、専用の起動、停止コマンドはありません。</p><p>watchdogは仮想IPインターフェイスを制御します。
VIPを起動、停止するために実行されるコマンドにはroot権限が必要です。
watchdogが委任IPを伴って起動される際には、<span class="productname">Pgpool-II</span>は、<span class="productname">Pgpool-II</span>を実行しているユーザがroot権限を持つことを要求します。
しかし、<span class="productname">Pgpool-II</span>をrootユーザで実行するのは良いセキュリティの実践とは言えません。
別の推奨する方法は、<span class="productname">Pgpool-II</span>を通常のユーザとして起動し、<code class="command">sudo</code>を使って<a class="xref" href="runtime-watchdog-config.html#guc-if-up-cmd">if_up_cmd</a>、<a class="xref" href="runtime-watchdog-config.html#guc-if-down-cmd">if_down_cmd</a>、<a class="xref" href="runtime-watchdog-config.html#guc-arping-cmd">arping_cmd</a>にカスタムコマンドを設定するか、<code class="literal">if_*</code>コマンドに<code class="command">setuid</code>("set user ID upon execution")することです。</p><p>死活監視プロセスはwatchdogの下位コンポーネントです。
その仕事は、watchdogクラスタに参加している<span class="productname">Pgpool-II</span>ノードの健全さを監視することです。
死活監視プロセスは、組み込みの死活監視を使用するようにwatchdogが設定されている場合、自動的に起動されます。
死活監視プロセスは、watchdogのメインプロセスの初期化が完了した後に起動します。
watchdogの組み込み死活監視は、すべての<span class="productname">Pgpool-II</span>ノードが起動してから始まります。
ただし、死活監視プロセスは、設定されているすべてのwatchdogノードがクラスタに参加し、アクティブになった時にだけ起動されます。
死活監視がアクティブになる前にリモートノードに障害が起こると、その障害が死活監視によって捕捉されません。
    </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="tutorial-watchdog.html">前へ</a> </td><td width="20%" align="center"><a accesskey="u" href="tutorial-watchdog.html">上へ</a></td><td width="40%" align="right"> <a accesskey="n" href="tutorial-watchdog-integrating-external-lifecheck.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">第2章 Watchdog </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> 2.2. watchdogに外部死活監視を組み込む</td></tr></table></div></body></html>