<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>2.4. watchdogの構造</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Pgpool-II 3.7devel 文書" /><link rel="up" href="tutorial-watchdog.html" title="第2章 Watchdog" /><link rel="prev" href="tutorial-watchdog-restrictions.html" title="2.3. watchdogの制限事項" /><link rel="next" href="admin.html" title="パート II. サーバ管理" /><link rel="copyright" href="legalnotice.html" title="Legal Notice" /><meta name="viewport" content="width=device-width,initial-scale=1.0" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><td width="20%" align="left" colspan="2"></td><th width="60%" align="center"><a accesskey="h" href="index.html">Pgpool-II 3.7devel 文書</a></th><td width="20%" align="right"></td></tr><tr><td width="10%" align="left" valign="top"><a accesskey="p" href="tutorial-watchdog-restrictions.html">前へ</a> </td><td width="10%" align="left" valign="top"><a accesskey="u" href="tutorial-watchdog.html">上へ</a></td><td width="60%" align="center">2.4. watchdogの構造</td><td width="20%" align="right" valign="top"> <a accesskey="n" href="admin.html">次へ</a></td></tr></table><hr /></div><div class="sect1" id="tutorial-advanced-arch"><div class="titlepage"><div><div><h2 class="title" style="clear: both">2.4. watchdogの構造</h2></div></div></div><p>watchdogは<span class="productname">Pgpool-II</span>の下位プロセスで、単一障害点を除くために複数の<span class="productname">Pgpool-II</span>を統合します。
（もし有効なら）watchdogプロセスは<span class="productname">Pgpool-II</span>が起動した際に自動的に起動されます。
watchdogは、コアシステムと死活監視システムの2つの主なコンポーネントから構成されます。
    </p><div class="sect2" id="tutorial-advanced-arch-wd-core"><div class="titlepage"><div><div><h3 class="title">2.4.1. watchdogコア</h3></div></div></div><p>"watchdog"として参照されるwatchdogコアは、クラスタに存在する<span class="productname">Pgpool-II</span>ノードとのwatchdog関連の通信を管理します。
また、<span class="productname">Pgpool-II</span>親プロセスと死活監視プロセスとも通信します。
        </p><p>watchdogプロセスの中心はステートマシンで、初期状態(<code class="literal">WD_LOADING</code>)から出発し、スタンバイ状態(<code class="literal">WD_STANDBY</code>)かマスター/コーディネーター状態(<code class="literal">WD_COORDINATOR</code>)へと遷移します。
スタンバイ状態もマスター/コーディネーター状態も、watchdogステートマシンとしては安定状態です。
ローカルの<span class="productname">Pgpool-II</span>ノードに問題が起きるか、リモートの<span class="productname">Pgpool-II</span>ノードがクラスタから切り離されるまでその状態を保ちます。
        </p><p>watchdogプロセスは以下のタスクを実行します。

        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>ローカルノードのwatchdog状態の管理と調停
              </p></li><li class="listitem"><p>ローカルあるいはリモートの<span class="productname">Pgpool-II</span>を対象とする組み込みあるいは外部死活監視との通信
              </p></li><li class="listitem"><p>watchdogチャンネルを通じて<span class="productname">Pgpool-II</span>親プロセスがクラスタコマンドを実行するための機構を提供するために、<span class="productname">Pgpool-II</span>メインプロセスと通信する
              </p></li><li class="listitem"><p>参加しているすべての<span class="productname">Pgpool-II</span>ノードと通信し、マスター/コーディネーターノードの選択を調停し、クラスタのクォーラムを確実にする
              </p></li><li class="listitem"><p>マスター/コーディネーターノード上の仮想IPを管理し、ユーザが昇格と降格用のカスタムスクリプトを書けるようにする
              </p></li><li class="listitem"><p>watchdogクラスタ中の<span class="productname">Pgpool-II</span>ノードの設定の一貫性を検証する
              </p></li><li class="listitem"><p>起動時にすべてのPostgreSQLバックエンドの状態を同期する
              </p></li><li class="listitem"><p>複数のフェイルオーバコマンドを直列化するために<span class="productname">Pgpool-II</span>メインプロセスに対して分散ロック機能を提供する
              </p></li></ul></div><div class="sect3" id="tutorial-advanced-arch-wd-core-comm"><div class="titlepage"><div><div><h4 class="title">2.4.1.1. クラスタの他のノードとの通信</h4></div></div></div><p>watchdogはほかのすべてのノードとの通信にTCP/IPソケットを使っています。
各々のwatchdogノードはそれぞれのノードに2つのソケットを開くことができます。
ひとつは出て行く（クライアント）ソケットで、他のノードとの通信のためにこのノードが作り初期化します。
2つ目は、リモートwatchdogノードが開いた通信から入ってくるのを待ち受けるソケットです。
リモートノードとのソケット接続が成功すると、直ちにwatchdogはADD NODE (<code class="literal">WD_ADD_NODE_MESSAGE</code>)メッセージをそのソケットに送ります。
ADD NODEメッセージを受信したwatchdogノードは、メッセージにカプセル化されたノード情報をそのノードのPgpool-II設定と照合し、照合テストが成功すればノードをクラスタに追加します。
照合テストが失敗すると、接続は切断されます。
        </p></div><div class="sect3" id="tutorial-advanced-arch-wd-ipc-data"><div class="titlepage"><div><div><h4 class="title">2.4.1.2. IPCとデータフォーマット</h4></div></div></div><p>watchdogプロセスはIPC通信のために<acronym class="acronym">UNIX</acronym>ドメインソケットを公開し、<acronym class="acronym">JSON</acronym>形式のデータを受付、また提供します。
<span class="productname">Pgpool-II</span>の組み込み死活監視とメインプロセスも含めて、すべての<span class="productname">Pgpool-II's</span>内部プロセスは、このIPCソケットを使ってwatchdogと通信します。
IPCソケットは、watchdogと通信する外部/サードパーティシステムも利用することができます。
        </p><p>外部/サードパーティシステムと統合するための、watchdog IPCインターフェイスの使い方の詳細は<a class="xref" href="tutorial-watchdog-integrating-external-lifecheck.html" title="2.2. watchdogに外部死活監視を組み込む">2.2. watchdogに外部死活監視を組み込む</a>をご覧ください。
        </p></div></div><div class="sect2" id="tutorial-advanced-arch-wd-lifecheck"><div class="titlepage"><div><div><h3 class="title">2.4.2. Watchdogにおける死活監視</h3></div></div></div><p>Watchdogにおける死活監視は、watchdogクラスタに参加している<span class="productname">Pgpool-II</span>ノードの健全性を監視するwatchdogの下位コンポーネントです。
<span class="productname">Pgpool-II</span> watchdogは、リモートノードの健全性をチェックする2つの方法、"heartbeat"と"query"モードを提供します。
      </p><p>"heartbeat"モードでは、死活監視プロセスは<acronym class="acronym">UDP</acronym>を使ってリモートノードにアクセスできるかどうか確認します。
各ノード毎に死活監視の親プロセスは2つの子プロセスを起動します。
ひとつはハートビート信号の送信のため、もうひとつはハートビートの受信のためです。
"query"モードでは、死活監視プロセスはPostgreSQLのlibpqインターフェイスを使ってリモートの<span class="productname">Pgpool-II</span>に問い合わせを送ります。
このモードでは、各死活監視プロセスは、死活監視のために新しくスレッドを作成します。
クエリが終了すると、直ちにそのスレッドは破棄されます。
      </p><p>リモートノードの死活監視以外にも、watchdogの死活監視は、上位サーバへの接続を監視することにより、インストールされたノードの健全性をチェックできます。
上位サーバへの接続を監視するために、<span class="productname">Pgpool-II</span>の死活監視は<code class="literal">execv()</code>を使って<code class="command">'ping -q -c3 hostname'</code>コマンドを実行します。
つまり、各々の死活監視のサイクルごとに、それぞれの上位サーバのために子プロセスが作られ、破棄されます。
たとえば、死活監視の設定で2つの上位サーバがあり、10秒ごとに死活監視を行うとすると、死活監視は10秒ごとに2つの子プロセスを起動し、各上位サーバ用に1個ずつプロセスが割り当てられます。
それぞれのプロセスは、pingコマンドが完了するまで生存します。
      </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="tutorial-watchdog-restrictions.html">前へ</a> </td><td width="20%" align="center"><a accesskey="u" href="tutorial-watchdog.html">上へ</a></td><td width="40%" align="right"> <a accesskey="n" href="admin.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">2.3. watchdogの制限事項 </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> パート II. サーバ管理</td></tr></table></div></body></html>