<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>7.3. AWS設定の例</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Pgpool-II 3.7devel 文書" /><link rel="up" href="example-configs.html" title="第7章 設定の例" /><link rel="prev" href="example-watchdog.html" title="7.2. Watchdogの設定例" /><link rel="next" href="reference.html" title="パート IV. リファレンス" /><link rel="copyright" href="legalnotice.html" title="Legal Notice" /><meta name="viewport" content="width=device-width,initial-scale=1.0" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><td width="20%" align="left" colspan="2"></td><th width="60%" align="center"><a accesskey="h" href="index.html">Pgpool-II 3.7devel 文書</a></th><td width="20%" align="right"></td></tr><tr><td width="10%" align="left" valign="top"><a accesskey="p" href="example-watchdog.html">前へ</a> </td><td width="10%" align="left" valign="top"><a accesskey="u" href="example-configs.html">上へ</a></td><td width="60%" align="center">7.3. AWS設定の例</td><td width="20%" align="right" valign="top"> <a accesskey="n" href="reference.html">次へ</a></td></tr></table><hr /></div><div class="sect1" id="example-aws"><div class="titlepage"><div><div><h2 class="title" style="clear: both">7.3. AWS設定の例</h2></div></div></div><p>このチュートリアルでは、<a class="ulink" href="https://aws.amazon.com/" target="_top">AWS</a>上で"Watchdog"を使う簡単な例を示します。
この例では、高可用性のために<a class="ulink" href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html" target="_top">Elastic IP Address</a>を仮想IPとして使います。
      </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>        watchdogは、<span class="productname">Pgpool-II</span>のすべてのモード、すなわちレプリケーションモード、マスタ／スレーブモード、ローモードのいずれでも使えます。
        </p></div><p>
    </p><div class="sect2" id="example-aws-setup"><div class="titlepage"><div><div><h3 class="title">7.3.1. AWSのセットアップ</h3></div></div></div><p>この例では、2ノードの<span class="productname">Pgpool-II</span> watchdogクラスタを使います。
そこで、2つのAmazon Linux EC2インスタンスを設定し、ひとつのElastic IPアドレスを使用します。
以下のステップを実施してください。
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Amazon Linux EC2インスタンスを2つ起動します。
この例では、それぞれ"instance-1"と"instance-2"という名前を付けます。
          </p></li><li class="listitem"><p>これらのインスタンスのセキュリティグループを設定し、Pgpool-IIとwatchdogが使用するポートへのインバウンドトラフィックを許可します。
          </p></li><li class="listitem"><p><span class="productname">Pgpool-II</span>を両方のインスタンスにインストールします。
          </p></li><li class="listitem"><p>Elastic IPアドレスを確保します。
この例では、Elastic IPアドレスに"35.163.178.3"を設定します。
          </p></li></ul></div></div><div class="sect2" id="example-aws-pgpool-config"><div class="titlepage"><div><div><h3 class="title">7.3.2. <span class="productname">Pgpool-II</span>の設定</h3></div></div></div><p>この例の設定は<a class="xref" href="example-watchdog.html" title="7.2. Watchdogの設定例">7.2. Watchdogの設定例</a>とほとんど同じになりますが、<a class="xref" href="runtime-watchdog-config.html#guc-delegate-ip">delegate_IP</a>を設定せず、代わりに<a class="xref" href="runtime-watchdog-config.html#guc-wd-escalation-command">wd_escalation_command</a>と<a class="xref" href="runtime-watchdog-config.html#guc-wd-de-escalation-command">wd_de_escalation_command</a>を使ってmaste/Active <span class="productname">Pgpool-II</span>ノードのElastic IPアドレスを切り替えるのが異なります。
      </p><div class="sect3" id="example-aws-pgpool-config-instance-1"><div class="titlepage"><div><div><h4 class="title">7.3.2.1. Instance-1における<span class="productname">Pgpool-II</span>の設定</h4></div></div></div><p>
          </p><pre class="programlisting">use_watchdog = on
delegate_IP = ''
wd_hostname = 'instance-1-private-ip'
other_pgpool_hostname0 = 'instance-2-private-ip'
other_pgpool_port0 = 9999
other_wd_port0 = 9000
wd_escalation_command = '$path_to_script/aws-escalation.sh'
wd_de_escalation_command = '$path_to_script/aws-de-escalation.sh'
          </pre><p>

        </p></div><div class="sect3" id="example-aws-pgpool-config-instance-2"><div class="titlepage"><div><div><h4 class="title">7.3.2.2. Instance-2における<span class="productname">Pgpool-II</span>の設定</h4></div></div></div><p>
          </p><pre class="programlisting">use_watchdog = on
delegate_IP = ''
wd_hostname = 'instance-2-private-ip'
other_pgpool_hostname0 = 'instance-1-private-ip'
other_pgpool_port0 = 9999
other_wd_port0 = 9000
wd_escalation_command = '$path_to_script/aws-escalation.sh'
wd_de_escalation_command = '$path_to_script/aws-de-escalation.sh'
          </pre><p>

        </p></div></div><div class="sect2" id="example-aws-pgpool-aws-escalation-instance"><div class="titlepage"><div><div><h3 class="title">7.3.3. エスカレーションおよびディエスカレーション用のスクリプト</h3></div></div></div><p>aws-escalation.shとaws-de-escalation.shスクリプトを2つのインスタンス上に作成し、<a class="xref" href="runtime-watchdog-config.html#guc-wd-escalation-command">wd_escalation_command</a>と<a class="xref" href="runtime-watchdog-config.html#guc-wd-de-escalation-command">wd_de_escalation_command</a>がそれぞれそれらを指すようにしてください。
      </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>AWSインスタンス上でwd-escalation.shとwd-de-escalation.shで使用するコマンドが実行できるようにするために、AWS CLIの設定が必要になるかもしれません。
<a class="ulink" href="http://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html" target="_top">configure AWS CLI</a>を参照してください。
        </p></div><div class="sect3" id="example-aws-pgpool-aws-escalation-script"><div class="titlepage"><div><div><h4 class="title">7.3.3.1. エスカレーションスクリプト</h4></div></div></div><p>このスクリプトは、watchdogがactive/masterノードになったときに、Elastic IPをアサインするためにwatchdogが実行します。
      </p><p>        <span class="emphasis"><em>aws-escalation.sh:</em></span>
        </p><pre class="programlisting">#! /bin/sh

ELASTIC_IP=35.163.178.3
                        # replace it with the Elastic IP address you
                        # allocated from the aws console
INSTANCE_ID=i-0a9b64e449b17ed4b
                        # replace it with the instance id of the Instance
                        # this script is installed on

echo "Assigning Elastic IP $ELASTIC_IP to the instance $INSTANCE_ID"
# bring up the Elastic IP
aws ec2 associate-address --instance-id $INSTANCE_ID --public-ip $ELASTIC_IP

exit 0
        </pre><p>

      </p></div><div class="sect3" id="example-aws-pgpool-aws-de-escalation-script"><div class="titlepage"><div><div><h4 class="title">7.3.3.2. ディエスカレーションスクリプト</h4></div></div></div><p>このスクリプトは、watchdogがactive/masterノードを退任するときに、Elastic IPのアサインを解除するためにwatchdogが実行します。
      </p><p>      <span class="emphasis"><em>aws-de-escalation.sh:</em></span>
        </p><pre class="programlisting">#! /bin/sh

ELASTIC_IP=35.163.178.3
                        # replace it with the Elastic IP address you
                        # allocated from the aws console

echo "disassociating the Elastic IP $ELASTIC_IP from the instance"
# bring down the Elastic IP
aws ec2 disassociate-address --public-ip $ELASTIC_IP
exit 0
          </pre><p>
        </p></div><div class="bibliography" id="idm45863245525520"><div class="titlepage"><div><div><h4 class="title">AWSコマンドリファレンス</h4></div></div></div><div class="biblioentry" id="idm45863245525056"><p><span class="biblioset">「<a class="ulink" href="http://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html" target="_top">Configure AWS CLI</a>」. </span><span class="biblioset"><em>AWS Documentation: Configuring the AWS Command Line Interface</em>. </span></p></div><div class="biblioentry" id="idm45863245523040"><p><span class="biblioset">「<a class="ulink" href="http://docs.aws.amazon.com/cli/latest/reference/ec2/associate-address.html" target="_top">associate-address</a>」. </span><span class="biblioset"><em>AWS Documentation: associate-address reference</em>. </span></p></div><div class="biblioentry" id="idm45863245521040"><p><span class="biblioset">「<a class="ulink" href="http://docs.aws.amazon.com/cli/latest/reference/ec2/disassociate-address.html" target="_top">disassociate-address</a>」. </span><span class="biblioset"><em>AWS Documentation: disassociate-address reference</em>. </span></p></div></div></div><div class="sect2" id="example-aws-try"><div class="titlepage"><div><div><h3 class="title">7.3.4. 実行してみる</h3></div></div></div><p>それぞれのサーバ上で<span class="productname">Pgpool-II</span>を"-n"スイッチ付きで起動し、pgpool.logにログメッセージをリダイレクトします。
master/active <span class="productname">Pgpool-II</span>ノードは、Elastic IPのアサインメッセージを表示します。
        </p><pre class="programlisting">LOG:  I am the cluster leader node. Starting escalation process
LOG:  escalation process started with PID:23543
LOG:  watchdog: escalation started
<span class="emphasis"><strong>Assigning Elastic IP 35.163.178.3 to the instance i-0a9b64e449b17ed4b
{
    "AssociationId": "eipassoc-39853c42"
}</strong></span>
LOG:  watchdog escalation successful
LOG:  watchdog escalation process with pid: 23543 exit with SUCCESS.
        </pre><p>
      </p><p>Elastic IPアドレスにpingが通ることを確かめます。
        </p><pre class="programlisting">[user@someserver]$ ping 35.163.178.3
PING 35.163.178.3 (35.163.178.3) 56(84) bytes of data.
64 bytes from 35.163.178.3: icmp_seq=1 ttl=64 time=0.328 ms
64 bytes from 35.163.178.3: icmp_seq=2 ttl=64 time=0.264 ms
64 bytes from 35.163.178.3: icmp_seq=3 ttl=64 time=0.412 ms
        </pre><p>
     </p><p>"psql -h ELASTIC_IP -p port"で<span class="productname">PostgreSQL</span>に接続してみます。
        </p><pre class="programlisting">[user@someserver]$ psql -h 35.163.178.3 -p 9999 -l
        </pre><p>
      </p></div><div class="sect2" id="example-aws-vip-switch"><div class="titlepage"><div><div><h3 class="title">7.3.5. Elastic IPの切換</h3></div></div></div><p>アクティブなサーバが使用できなくなった時にスタンバイサーバがElastic IPを獲得できることを確認するために、アクティブサーバ上の<span class="productname">Pgpool-II</span>を停止します。
すると、スタンバイサーバはElastic IPアドレスを使い始めるはずです。
<span class="productname">Pgpool-II</span>のログには以下のようなメッセージが表示されます。
        </p><pre class="programlisting"><span class="emphasis"><strong>LOG:  remote node "172.31.2.94:9999 [Linux ip-172-31-2-94]" is shutting down
LOG:  watchdog cluster has lost the coordinator node</strong></span>
LOG:  watchdog node state changed from [STANDBY] to [JOINING]
LOG:  watchdog node state changed from [JOINING] to [INITIALIZING]
LOG:  I am the only alive node in the watchdog cluster
HINT:  skiping stand for coordinator state
LOG:  watchdog node state changed from [INITIALIZING] to [MASTER]
LOG:  I am announcing my self as master/coordinator watchdog node
LOG:  I am the cluster leader node
DETAIL:  our declare coordinator message is accepted by all nodes
LOG:  I am the cluster leader node. Starting escalation process
LOG:  escalation process started with PID:23543
LOG:  watchdog: escalation started
<span class="emphasis"><strong>Assigning Elastic IP 35.163.178.3 to the instance i-0dd3e60734a6ebe14
{
    "AssociationId": "eipassoc-39853c42"
}</strong></span>
LOG:  watchdog escalation successful
LOG:  watchdog escalation process with pid: 61581 exit with SUCCESS.
        </pre><p>
Elastic IPアドレスにpingが通ることを再度確かめます。
        </p><pre class="programlisting">[user@someserver]$ ping 35.163.178.3
PING 35.163.178.3 (35.163.178.3) 56(84) bytes of data.
64 bytes from 35.163.178.3: icmp_seq=1 ttl=64 time=0.328 ms
64 bytes from 35.163.178.3: icmp_seq=2 ttl=64 time=0.264 ms
64 bytes from 35.163.178.3: icmp_seq=3 ttl=64 time=0.412 ms
        </pre><p>
      </p><p>"psql -h ELASTIC_IP -p port"で<span class="productname">PostgreSQL</span>に接続してみます。
        </p><pre class="programlisting">[user@someserver]$ psql -h 35.163.178.3 -p 9999 -l
        </pre><p>
      </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="example-watchdog.html">前へ</a> </td><td width="20%" align="center"><a accesskey="u" href="example-configs.html">上へ</a></td><td width="40%" align="right"> <a accesskey="n" href="reference.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">7.2. Watchdogの設定例 </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> パート IV. リファレンス</td></tr></table></div></body></html>