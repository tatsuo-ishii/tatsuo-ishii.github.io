<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>2.2. watchdogに外部死活監視を組み込む</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Pgpool-II 3.6.0 文書" /><link rel="up" href="tutorial-watchdog.html" title="第2章 Watchdog" /><link rel="prev" href="tutorial-watchdog-intro.html" title="2.1. はじめに" /><link rel="next" href="tutorial-watchdog-restrictions.html" title="2.3. watchdogの制限事項" /><link rel="copyright" href="legalnotice.html" title="Legal Notice" /><meta name="viewport" content="width=device-width,initial-scale=1.0" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><td width="20%" align="left" colspan="2"></td><th width="60%" align="center"><a accesskey="h" href="index.html">Pgpool-II 3.6.0 文書</a></th><td width="20%" align="right"></td></tr><tr><td width="10%" align="left" valign="top"><a accesskey="p" href="tutorial-watchdog-intro.html">前へ</a> </td><td width="10%" align="left" valign="top"><a accesskey="u" href="tutorial-watchdog.html">上へ</a></td><td width="60%" align="center">2.2. watchdogに外部死活監視を組み込む</td><td width="20%" align="right" valign="top"> <a accesskey="n" href="tutorial-watchdog-restrictions.html">次へ</a></td></tr></table><hr /></div><div class="sect1" id="tutorial-watchdog-integrating-external-lifecheck"><div class="titlepage"><div><div><h2 class="title" style="clear: both">2.2. watchdogに外部死活監視を組み込む</h2></div></div></div><p><span class="productname">Pgpool-II</span> watchdogプロセスは、すべての<span class="productname">Pgpool-II</span>プロセスと<acronym class="acronym">BSD</acronym>ソケットを使って通信します。
その<acronym class="acronym">BSD</acronym>ソケットは、ローカルとリモートの<span class="productname">Pgpool-II</span> watchdogノードをサードパーティのシステムが死活監視するために使用することができます。
IPCのための<acronym class="acronym">BSD</acronym>ソケットの名前は、<code class="literal">"s.PGPOOLWD_CMD."</code>文字列の後に<span class="productname">Pgpool-II</span>のwd_portを付けたもので、そのソケットファイルは<a class="xref" href="runtime-watchdog-config.html#guc-wd-ipc-socket-dir">wd_ipc_socket_dir</a>ディレクトリに置かれます。
    </p><div class="sect2" id="tutorial-watchdog-ipc-command-packet"><div class="titlepage"><div><div><h3 class="title">2.2.1. watchdogのIPCコマンドパケットフォーマット</h3></div></div></div><a id="idp56887600" class="indexterm"></a><p>watchdogのIPCコマンドパケットは3つのフィールドから構成されます。
以下のテーブルはメッセージフィールドの詳細な説明です。
    </p><div class="table" id="wd-ipc-command-format-table"><p class="title"><strong>表2.1 watchdogのIPCコマンドパケットフォーマット</strong></p><div class="table-contents"><table summary="watchdogのIPCコマンドパケットフォーマット" border="1"><colgroup><col /><col /><col /></colgroup><thead><tr><th>フィールド</th><th>型</th><th>説明</th></tr></thead><tbody><tr><td>TYPE</td><td>BYTE1</td><td>コマンド型</td></tr><tr><td>LENGTH</td><td>ネットワークバイトオーダーのINT32</td><td>データ部の長さ</td></tr><tr><td>DATA</td><td><acronym class="acronym">JSON</acronym>フォーマットのデータ</td><td><acronym class="acronym">JSON</acronym>フォーマットのコマンドデータ</td></tr></tbody></table></div></div><br class="table-break" /></div><div class="sect2" id="tutorial-watchdog-ipc-result-packet"><div class="titlepage"><div><div><h3 class="title">2.2.2. watchdogのIPC結果パケットフォーマット</h3></div></div></div><a id="idp56895296" class="indexterm"></a><p>watchdogのIPCコマンド結果パケットは3つのフィールドから構成されます。
以下のテーブルはメッセージフィールドの詳細な説明です。
    </p><div class="table" id="wd-ipc-resutl-format-table"><p class="title"><strong>表2.2 watchdogのIPC結果パケットフォーマット</strong></p><div class="table-contents"><table summary="watchdogのIPC結果パケットフォーマット" border="1"><colgroup><col /><col /><col /></colgroup><thead><tr><th>フィールド</th><th>型</th><th>説明</th></tr></thead><tbody><tr><td>TYPE</td><td>BYTE1</td><td>コマンド型</td></tr><tr><td>LENGTH</td><td>ネットワークバイトオーダーのINT32</td><td>データ部の長さ</td></tr><tr><td>DATA</td><td><acronym class="acronym">JSON</acronym>フォーマットのデータ</td><td><acronym class="acronym">JSON</acronym>フォーマットのコマンドデータ</td></tr></tbody></table></div></div><br class="table-break" /></div><div class="sect2" id="tutorial-watchdog-ipc-command-packet-types"><div class="titlepage"><div><div><h3 class="title">2.2.3. watchdogのIPCコマンドパケット型</h3></div></div></div><a id="idp56902976" class="indexterm"></a><p>watchdogプロセスに送られ、またwatchdogプロセスから返却されるIPCコマンドのパケットの最初のバイトは、コマンドまたはコマンド結果型と認識されます。
    </p><div class="table" id="wd-ipc-command-packet--types-table"><p class="title"><strong>表2.3 Watchdog IPC command packet types</strong></p><div class="table-contents"><table summary="Watchdog IPC command packet types" border="1"><colgroup><col /><col /><col /><col /></colgroup><thead><tr><th>名前</th><th>バイト値</th><th>型</th><th>説明</th></tr></thead><tbody><tr><td>REGISTER FOR NOTIFICATIONS</td><td>'0'</td><td>コマンドパケット</td><td>現在の接続をwatchdog通知を受け取るために登録するコマンド</td></tr><tr><td>NODE STATUS CHANGE</td><td>'2'</td><td>コマンドパケット</td><td>watchdogノードの状態変化をwatchdogに通知するためのコマンド</td></tr><tr><td>GET NODES LIST</td><td>'3'</td><td>コマンドパケット</td><td>Command to get the list of all configured watchdog nodes</td></tr><tr><td>NODES LIST DATA</td><td>'4'</td><td>結果パケット</td><td>パケット中の<acronym class="acronym">JSON</acronym>データにすべてのwatchdogノードのリストが含まれます</td></tr><tr><td>CLUSTER IN TRANSITION</td><td>'7'</td><td>結果パケット</td><td>クラスタが遷移中なのでコマンドを処理できないときにwatchdogはこのパケットを返します</td></tr><tr><td>RESULT BAD</td><td>'8'</td><td>結果パケット</td><td>IPCコマンドが失敗すると、watchdogはこのパケット型を返します</td></tr><tr><td>RESULT OK</td><td>'9'</td><td>結果パケット</td><td>IPCコマンドが成功すると、watchdogはこのパケット型を返します</td></tr></tbody></table></div></div><br class="table-break" /></div><div class="sect2" id="tutorial-watchdog-external-lifecheck-ipc"><div class="titlepage"><div><div><h3 class="title">2.2.4. 外部死活監視のIPCパケットとデータ</h3></div></div></div><a id="idp56916912" class="indexterm"></a><p>watchdogの"GET NODES LIST"、"NODES LIST DATA"、"NODE STATUS CHANGE"IPCメッセージは、外部死活監視システムを統合するために使用できます。
pgpoolの組み込み死活監視も同じチャンネルと技術を使っていることに注意してください。
    </p><div class="sect3" id="tutorial-watchdog-external-lifecheck-get-nodes"><div class="titlepage"><div><div><h4 class="title">2.2.4.1. 構成されているwatchdogノードのリストの取得</h4></div></div></div><a id="idp56919344" class="indexterm"></a><p>サードパーティの死活監視システムは、<a class="xref" href="runtime-watchdog-config.html#guc-wd-authkey">wd_authkey</a>が設定されている時は認証キーとデータを含む<acronym class="acronym">JSON</acronym>データを、<a class="xref" href="runtime-watchdog-config.html#guc-wd-authkey">wd_authkey</a>が設定されていない時は空のパケットデータを含む"GET NODES LIST"パケットをwatchdogのIPCソケットに送ることにより、"NODES LIST DATA"結果パケットを入手できます。
      </p><p>"GET NODES LIST"に対するwatchdogに返却される結果パケットは、死活監視を実施する対象となる、構成されているすべてのwatchdogノードのリストを含む<acronym class="acronym">JSON</acronym>フォーマットです。
      </p><p>        </p><pre class="programlisting">    -- The example JSON data contained in "NODES LIST DATA"

      {
      "NodeCount":3,
      "WatchdogNodes":
        [
          {
            "ID":0,
            "State":1,
            "NodeName":"Linux_ubuntu_9999",
            "HostName":"watchdog-host1",
            "DelegateIP":"172.16.5.133",
            "WdPort":9000,
            "PgpoolPort":9999
          },
          {
            "ID":1,
            "State":1,
            "NodeName":"Linux_ubuntu_9991",
            "HostName":"watchdog-host2",
            "DelegateIP":"172.16.5.133",
            "WdPort":9000,
            "PgpoolPort":9991
          },
          {
            "ID":2,
            "State":1,
            "NodeName":"Linux_ubuntu_9992",
            "HostName":"watchdog-host3",
            "DelegateIP":"172.16.5.133",
            "WdPort":9000,
            "PgpoolPort":9992
          }
        ]
      }

    -- Note that ID 0 is always reserved for local watchdog node

        </pre><p>
      </p><p>構成されているwatchdogノード情報をwatchdogから入手したら、外部死活監視システムはwatchdogノードの死活監視を実施できます。
ノードの状態変化を検知したら、watchdogの"NODE STATUS CHANGE"IPCメッセージを使って、watchdogに通知できます。
メッセージには、状態変化したノードIDとノードの新しい状態を伴う<acronym class="acronym">JSON</acronym>でデータを格納してください（ノードIDは、watchdogから返却されたWatchdogNodesリスト中のノードと同じノードIDを使わなければなりません）。
      </p><p>        </p><pre class="programlisting">  -- The example JSON to inform pgpool-II watchdog about health check
  failed on node with ID 1 will look like

    {
    "NodeID":1,
    "NodeStatus":1,
    "Message":"optional message string to log by watchdog for this event"
    "IPCAuthKey":"wd_authkey configuration parameter value"
    }

  -- NodeStatus values meanings are as follows
  NODE STATUS DEAD  =  1
  NODE STATUS ALIVE =  2

        </pre><p>
      </p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="tutorial-watchdog-intro.html">前へ</a> </td><td width="20%" align="center"><a accesskey="u" href="tutorial-watchdog.html">上へ</a></td><td width="40%" align="right"> <a accesskey="n" href="tutorial-watchdog-restrictions.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">2.1. はじめに </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> 2.3. watchdogの制限事項</td></tr></table></div></body></html>