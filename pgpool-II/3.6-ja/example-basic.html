<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>7.1. 基本設定の例</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Pgpool-II 3.7devel 文書" /><link rel="up" href="example-configs.html" title="第7章 設定の例" /><link rel="prev" href="example-configs.html" title="第7章 設定の例" /><link rel="next" href="example-watchdog.html" title="7.2. Watchdogの設定例" /><link rel="copyright" href="legalnotice.html" title="Legal Notice" /><meta name="viewport" content="width=device-width,initial-scale=1.0" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><td width="20%" align="left" colspan="2"></td><th width="60%" align="center"><a accesskey="h" href="index.html">Pgpool-II 3.7devel 文書</a></th><td width="20%" align="right"></td></tr><tr><td width="10%" align="left" valign="top"><a accesskey="p" href="example-configs.html">前へ</a> </td><td width="10%" align="left" valign="top"><a accesskey="u" href="example-configs.html">上へ</a></td><td width="60%" align="center">7.1. 基本設定の例</td><td width="20%" align="right" valign="top"> <a accesskey="n" href="example-watchdog.html">次へ</a></td></tr></table><hr /></div><div class="sect1" id="example-basic"><div class="titlepage"><div><div><h2 class="title" style="clear: both">7.1. 基本設定の例</h2></div></div></div><div class="sect2" id="example-configs-begin"><div class="titlepage"><div><div><h3 class="title">7.1.1. さあ始めましょう</h3></div></div></div><p>ここでは、レプリケーションを行うための準備として、<span class="productname">Pgpool-II</span> のインストールや設定、データベースノードの準備について説明します。
      </p><div class="sect3" id="example-configs-begin-installing"><div class="titlepage"><div><div><h4 class="title">7.1.1.1. <span class="productname">Pgpool-II</span>のインストール</h4></div></div></div><p><span class="productname">Pgpool-II</span>のインストールはとても簡単です。
ソースのtar ballを展開したディレクトリで以下のようにコマンドを実行します。
          </p><pre class="programlisting">$ ./configure
$ make
$ make install
          </pre><p>
<code class="command">configure</code>スクリプトはシステム情報を収集しコンパイル処理に利用します。
<code class="command">configure</code>スクリプトにコマンドライン引数を指定することにより、インストール先ディレクトリなど、デフォルトの動作を変更することができます。
デフォルトでは<span class="productname">Pgpool-II</span> は<code class="literal">/usr/local</code>ディレクトリ以下にインストールされます。
        </p><p><code class="command">make</code>コマンドはソースコードはコンパイルし、<code class="command">make install</code>コマンドで実行可能ファイルがインストールされます。
インストール先ディレクトリに書き込み権限を持っている必要があります。
ここでは、<span class="productname">Pgpool-II</span>は<code class="literal">/usr/local</code>にインストールすることにします。
        </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p><span class="productname">Pgpool-II</span>は<span class="productname">PostgreSQL</span> 7.4 以降の<code class="literal">libpq</code>ライブラリ(3.0 プロトコル)を必要とします。
          </p></div><p><code class="command">configure</code>スクリプトが以下のエラーメッセージを表示した場合、<code class="literal">libpq</code>ライブラリがインストールされていないか、バージョンが3.0でない可能性があります。
          </p><pre class="programlisting">configure: error: libpq is not installed or libpq is old
          </pre><p>
プロトコルのバージョンが3.0の<code class="literal">libpq</code>ライブラリがインストールされているにも係わらず上記のエラーメッセージが表示される場合、<code class="command">configure</code>スクリプトに<code class="literal">libpq</code>ライブラリが認識されていない可能性があります。
<code class="command">configure</code>スクリプトは標準では<code class="literal">/usr/local/pgsql</code>ディレクトリ以下から<code class="literal">libpq</code>ライブラリを検索します。
<span class="productname">PostgreSQL</span>のインストール先が<code class="literal">/usr/local/pgsql</code>ディレクトリ以下でなければ、<code class="command">configure</code>スクリプトを実行する際にコマンドライン引数として<code class="literal">--with-pgsql</code>や<code class="literal">--with-pgsql-includedir</code>、<code class="literal">--with-pgsql-libdir</code>オプションを指定してください。
        </p></div><div class="sect3" id="example-configs-begin-config-files"><div class="titlepage"><div><div><h4 class="title">7.1.1.2. 設定ファイルの作成</h4></div></div></div><p><span class="productname">Pgpool-II</span>の設定パラメータは<code class="literal">pgpool.conf</code>ファイルに保存されてします。
ファイルは、1 行ごとに<code class="literal">パラメータ名 = 値</code>という書式です。
<span class="productname">Pgpool-II</span> をインストールすると、<code class="literal">pgpool.conf.sample</code>ファイルが作成されます。
それを<code class="literal">pgpool.conf</code>というファイル名にコピーしてから編集するといいでしょう。
          </p><pre class="programlisting">$ cp /usr/local/etc/pgpool.conf.sample /usr/local/etc/pgpool.conf
          </pre><p>
<span class="productname">Pgpool-II</span> はローカルホストからのポート番号9999への接続のみを受け付けます。
<span class="productname">Pgpool-II</span> と異なるホストからの接続を受け付けたい場合は、<a class="xref" href="runtime-config-connection.html#guc-listen-addresses">listen_addresses</a>を<code class="literal">'*'</code>に設定します。
          </p><pre class="programlisting">listen_addresses = 'localhost'
port = 9999
          </pre><p>
ここではデフォルトのパラメータを使うことにします。
        </p></div><div class="sect3" id="example-configs-begin-config-pcp"><div class="titlepage"><div><div><h4 class="title">7.1.1.3. <acronym class="acronym">PCP</acronym>コマンドの設定</h4></div></div></div><p><span class="productname">Pgpool-II</span>には、データベースノードの情報取得や<span class="productname">Pgpool-II</span>停止などをネットワーク越しに行える管理目的のインターフェイスがあります。
<acronym class="acronym">PCP</acronym>コマンドを使用するにはユーザ認証が必要になります。
この認証は<span class="productname">PostgreSQL</span>ユーザの認証とは異なります。
ユーザ名とパスワードが<code class="literal">pcp.conf</code>ファイルに定義されている必要があります。
このファイルでは、1行ごとにユーザ名とパスワードがペアとしてリストされており、これららコロン(:)で区切られています。
パスワードは<code class="literal">MD5</code>ハッシュ形式で暗号化されています。

          </p><pre class="programlisting">postgres:e8a48653851e28c69d0506508fb27fc5
          </pre><p>

<span class="productname">Pgpool-II</span> をインストールするとサンプルとして<code class="literal">pcp.conf.sample</code>が自動的に生成されます。
それを<code class="literal">pcp.conf</code>というファイル名にコピーしてから編集するといいでしょう。
          </p><pre class="programlisting">$ cp /usr/local/etc/pcp.conf.sample /usr/local/etc/pcp.conf
          </pre><p>
パスワードをMD5ハッシュ形式に変換する際には、<span class="productname">Pgpool-II</span>とともにインストールされる<code class="command">pg_md5</code>コマンドを使用します。
<code class="command">pg_md5</code>コマンドは、コマンドライン引数として文字列を指定すると、それをMD5ハッシュ化したものを表示します。
例えば、以下のようにコマンドライン引数として<code class="literal">"postgres"</code>を指定して実行すると、それをMD5ハッシュ化しテキストが標準出力に表示されます。
          </p><pre class="programlisting">$ /usr/bin/pg_md5 postgres
e8a48653851e28c69d0506508fb27fc5
          </pre><p>
PCPコマンドはネットワークを通して実行されるので、ポート番号を<code class="literal">pgpool.conf</code>ファイルの<a class="xref" href="runtime-config-connection.html#guc-pcp-port">pcp_port</a>パラメータに設定します。
ここでは、<a class="xref" href="runtime-config-connection.html#guc-pcp-port">pcp_port</a>のデフォルトである9898を使用することにします。
          </p><pre class="programlisting">pcp_port = 9898
          </pre><p>
        </p></div><div class="sect3" id="example-configs-prep-db-nodes"><div class="titlepage"><div><div><h4 class="title">7.1.1.4. データベースノードの準備</h4></div></div></div><p>次に、<span class="productname">Pgpool-II</span>のための<span class="productname">PostgreSQL</span>サーバを設定する必要があります。
これらのサーバは、<span class="productname">Pgpool-II</span> と同じホストで起動しても、異なるホストであっても構いません。
同じホストにサーバを配置するのならば、各サーバにそれぞれ異なるポート番号を割り合てなければなりません。
異なるマシンで起動する場合は <span class="productname">Pgpool-II</span>からのネットワーク接続を受け入れられるよう適切に設定されている必要があります。

が起動するホストからデータベースサーバに接続できるように設定する必要があります。 <span class="productname">Pgpool-II</span> ではデータベースサーバごとにレプリケーションを行うので、チュートリアルのためのデータベースクラスタを作成したほうがいいでしょう。
          </p><pre class="programlisting">backend_hostname0 = 'localhost'
backend_port0 = 5432
backend_weight0 = 1
backend_hostname1 = 'localhost'
backend_port1 = 5433
backend_weight1 = 1
backend_hostname2 = 'localhost'
backend_port2 = 5434
backend_weight2 = 1
          </pre><p>

<a class="xref" href="runtime-config-backend-settings.html#guc-backend-hostname">backend_hostname</a>、<a class="xref" href="runtime-config-backend-settings.html#guc-backend-port">backend_port</a>、<a class="xref" href="runtime-config-backend-settings.html#guc-backend-weight">backend_weight</a>には、ノードのホスト名、ポート番号、負荷分散の割合を設定します。
各パラメータ名の後ろには、ノードIDが0から始まる整数(すなわち、0, 1, 2, ...)で指定されていなければなりません。
        </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>すべてのノードで<a class="xref" href="runtime-config-backend-settings.html#guc-backend-weight">backend_weight</a>パラメータが1に設定してるのは、SELECTクエリが３台のサーバで等しく分散されることを意味しています。
          </p></div></div><div class="sect3" id="example-configs-start-stop-pgpool"><div class="titlepage"><div><div><h4 class="title">7.1.1.5. <span class="productname">Pgpool-II</span>の起動と停止</h4></div></div></div><p><span class="productname">Pgpool-II</span> を起動するにはターミナルで以下のコマンドを実行します。

        </p><pre class="programlisting">$ pgpool
        </pre><p>

しかしこれでは、<span class="productname">Pgpool-II</span>が制御端末を切り離すため、ログが出力されません。
<span class="productname">Pgpool-II</span>にログメッセージを表示させたい場合、<code class="command">pgpool</code>コマンドに<code class="literal">-n</code>オプションを指定すると、<span class="productname">Pgpool-II</span>は非デーモンプロセスとして起動し、制御端末は切り離されません。
        </p><pre class="programlisting">$ pgpool -n &amp;
        </pre><p>

コマンドを実行した端末にログメッセージが表示されるので、以下のようなオプションを使うことをお勧めします。
        </p><pre class="programlisting">$ pgpool -n -d &gt; /tmp/pgpool.log 2&gt;&amp;1 &amp;
        </pre><p>

-d オプションはデバッグメッセージの出力を有効にします。
上記の例はファイルにリダイレクトさせているため、ログメッセージが<code class="literal">/tmp/pgpol.log</code>追加され続けます。
ログをローテートさせたい場合は、ローテート機能を持った外部コマンドにログを渡してください。
たとえば、Apache2の<a class="ulink" href="https://httpd.apache.org/docs/2.4/programs/rotatelogs.html" target="_top">rotatelogs</a>が使用できます。

        </p><pre class="programlisting">$ pgpool -n 2&gt;&amp;1 | /usr/local/apache2/bin/rotatelogs \
  -l -f /var/log/pgpool/pgpool.log.%A 86400 &amp;
        </pre><p>

これにより毎日夜中の0時にログがローテートされ、<code class="literal">pgpool.log.Thursday</code>のような名前のログファイルが毎日作成されます。
ただし、すでに同じ名前のファイルがある場合にはrotatelogsはログをそのファイルに追加してしまいます。
cronを使うことで、古いログファイルをローテーションの前に削除することができます。

        </p><pre class="programlisting">55 23 * * * /usr/bin/find /var/log/pgpool -type f -mtime +5 -exec /bin/rm -f '{}' \;
        </pre><p>

注意：Linuxディストリビューションによっては、rotatelogsは<code class="literal">usr/sbin/rotatelogs2</code>として存在しているかもしれません。
<code class="literal">-f</code>オプションは<code class="command">rotatelogs</code>が起動された直後に直ちにログファイルを作るオプションで、apache2 2.2.9以降でのみ有効です。
<a class="ulink" href="http://www.cronlog.org/" target="_top">cronolog</a>を使うこともできます。
        </p><pre class="programlisting">$ pgpool -n 2&gt;&amp;1 | /usr/sbin/cronolog \
  --hardlink=/var/log/pgsql/pgpool.log \
  '/var/log/pgsql/%Y-%m-%d-pgpool.log' &amp;
        </pre><p>

<span class="productname">Pgpool-II</span> を停止するには以下のコマンドを実行します。
        </p><pre class="programlisting">$ pgpool stop
        </pre><p>

<span class="productname">Pgpool-II</span> を停止する際にクライアントが接続している場合、<span class="productname">Pgpool-II</span>はその接続が切断されるまで待ってから停止します。
<span class="productname">Pgpool-II</span>を強制的にシャットダウンしたい場合は、以下のコマンドを実行します。
        </p><pre class="programlisting">$ pgpool -m fast stop
        </pre><p>

        </p></div></div><div class="sect2" id="example-configs-replication"><div class="titlepage"><div><div><h3 class="title">7.1.2. 初めてのレプリケーション</h3></div></div></div><p>レプリケーション（<a class="xref" href="runtime-config-runnung-mode.html#runtime-config-replication-mode" title="5.3.2. レプリケーションモード">5.3.2. レプリケーションモード</a>を参照）では複数のデータベースノードに同じデータを複製して格納します。
ここでは、<a class="xref" href="example-basic.html#example-configs-begin" title="7.1.1. さあ始めましょう">7.1.1. さあ始めましょう</a>で準備した 3 台のデータベースノードを使用し、一歩一歩データベースクラスタシステムを作っていきまししょう。
複製させるサンプルのデータ<a class="ulink" href="https://www.postgresql.org/docs/current/static/pgbench.html" target="_top"><code class="command">pgbench</code></a>ベンチマークプログラムで生成することにします。
      </p><div class="sect3" id="example-configs-config-replication"><div class="titlepage"><div><div><h4 class="title">7.1.2.1. レプリケーションの設定</h4></div></div></div><p>データベースノードのレプリケーションを有効にするには、<code class="literal">pgpool.conf</code>ファイルの<a class="xref" href="runtime-config-runnung-mode.html#guc-replication-mode">replication_mode</a>をonに設定します。
        </p><pre class="programlisting">replication_mode = true
        </pre><p>
<a class="xref" href="runtime-config-runnung-mode.html#guc-replication-mode">replication_mode</a>をonに設定することにより、<span class="productname">Pgpool-II</span>は受信したクエリを全てのデータベースノードに送信します。
対して実行され、同じデータが複製されて格納されるようになります。
さらに、<a class="xref" href="runtime-config-load-balancing.html#guc-load-balance-mode">load_balance_mode</a>をonに設定することにより、<span class="productname">Pgpool-II</span>はSELECTクエリをデータベースノード間に振り分けます。
        </p><pre class="programlisting">load_balance_mode = true
        </pre><p>
ここでは、<a class="xref" href="runtime-config-runnung-mode.html#guc-replication-mode">replication_mode</a>、<a class="xref" href="runtime-config-load-balancing.html#guc-load-balance-mode">load_balance_mode</a>の両方を有効にします。
        </p></div><div class="sect3" id="example-configs-checking-replication"><div class="titlepage"><div><div><h4 class="title">7.1.2.2. レプリケーションの確認</h4></div></div></div><p><code class="literal">pgpool.conf</code>の変更を<span class="productname">Pgpool-II</span>に反映させるには<span class="productname">Pgpool-II</span>を再起動する必要があります。
「<span class="productname">Pgpool-II</span> の起動と停止」<a class="xref" href="example-basic.html#example-configs-start-stop-pgpool" title="7.1.1.5. Pgpool-IIの起動と停止">7.1.1.5. <span class="productname">Pgpool-II</span>の起動と停止</a>を参照してください。
<code class="literal">pgpool.conf</code>の設定と再起動がすんだら、実際にレプリケーションを試してうまく行くことを確認しましょう。
まず、複製するデータベースを作成する必要があります。
これを<code class="literal">"bench_replication"</code>と名づけましょう。
このデータベースが全てのノードで作成される必要があります。
<a class="ulink" href="https://www.postgresql.org/docs/current/static/app-createdb.html" target="_top"><code class="command">createdb</code></a>コマンドを<span class="productname">Pgpool-II</span>経由で実行すると、すべてのノードでデータベースが作成されます。
          </p><pre class="programlisting">$ createdb -p 9999 bench_replication
          </pre><p>
そして<a class="ulink" href="https://www.postgresql.org/docs/current/static/pgbench.html" target="_top"><code class="command">pgbench</code></a>に<code class="literal">-i</code>オプションを指定して実行します。
<code class="literal">-i</code>オプションにより、データベースは事前に定義されたテーブルとデータで初期化されます。
          </p><pre class="programlisting">$ pgbench -i -p 9999 bench_replication
          </pre><p>
<a class="ulink" href="https://www.postgresql.org/docs/current/static/pgbench.html" target="_top"><code class="command">pgbench -i</code></a>によいって作成されるテーブルとデータを以下の表にまとめます。
すべてのノードにおいてこれらのテーブルおよびデータが作成されていれば、正常にレプリケーションが動作していることになります。
        </p><div class="table" id="example-configs-checking-replication-table"><p class="title"><strong>表7.1 data summary</strong></p><div class="table-contents"><table class="table" summary="data summary" border="1"><colgroup><col /><col /></colgroup><thead><tr><th>テーブル名</th><th>行数</th></tr></thead><tbody><tr><td>branches</td><td>1</td></tr><tr><td>tellers</td><td>10</td></tr><tr><td>accounts</td><td>100000</td></tr><tr><td>history</td><td>0</td></tr></tbody></table></div></div><br class="table-break" /><p>これをチェックするため、簡単なシェルスクリプトを実行してみましょう。
以下のスクリプトはすべてのノード (ポート番号 5432、5433、5434) のデータベースにおけるbranches、tellers、accounts、historyの行数が表示されます。
            </p><pre class="programlisting">$ for port in 5432 5433 5434; do
&gt;     echo $port
&gt;     for table_name in branches tellers accounts history; do
&gt;         echo $table_name
&gt;         psql -c "SELECT count(*) FROM $table_name" -p $port bench_replication
&gt;     done
&gt; done
            </pre><p>

        </p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="example-configs.html">前へ</a> </td><td width="20%" align="center"><a accesskey="u" href="example-configs.html">上へ</a></td><td width="40%" align="right"> <a accesskey="n" href="example-watchdog.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">第7章 設定の例 </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> 7.2. Watchdogの設定例</td></tr></table></div></body></html>