<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>A.1. リリース 3.6</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Pgpool-II 3.6.0 文書" /><link rel="up" href="release.html" title="付録A リリースノート" /><link rel="prev" href="release.html" title="付録A リリースノート" /><link rel="next" href="bookindex.html" title="索引" /><link rel="copyright" href="legalnotice.html" title="Legal Notice" /><meta name="viewport" content="width=device-width,initial-scale=1.0" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><td width="20%" align="left" colspan="2"></td><th width="60%" align="center"><a accesskey="h" href="index.html">Pgpool-II 3.6.0 文書</a></th><td width="20%" align="right"></td></tr><tr><td width="10%" align="left" valign="top"><a accesskey="p" href="release.html">前へ</a> </td><td width="10%" align="left" valign="top"><a accesskey="u" href="release.html">上へ</a></td><td width="60%" align="center">A.1. リリース 3.6</td><td width="20%" align="right" valign="top"> <a accesskey="n" href="bookindex.html">次へ</a></td></tr></table><hr /></div><div class="sect1" id="release-3-6"><div class="titlepage"><div><div><h2 class="title" style="clear: both">A.1. リリース 3.6</h2></div></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Release Date</h3><p>2016-11-21</p></div><div class="sect2" id="idp59524128"><div class="titlepage"><div><div><h3 class="title">A.1.1. 概要</h3></div></div></div><p>    
      <span class="productname">Pgpool-II</span> 3.6 の主な改善点は以下のとおりです。
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>      fail-over の挙動が改善されました。
      </p><p>      Streaming Replicationモードで、フェイルオーバーが発生した時に、ダウンしたスタンバイサーバを利用しなければ、クライアントセッションが切断されなくなります。
      プライマリサーバがダウンした場合、すべてのセッションが切断されます。
      また、ヘルスチェックのリトライの最中でも <span class="productname">Pgpool-II</span>に接続することが可能です。
<span class="productname">Pgpool-II</span>への接続リトライする最大回数までヘルスチェックのリトライが続きます。
	    </p></li><li class="listitem"><p>    
      新しいコマンド <a class="link" href="sql-pgpool-set.html" title="PGPOOL SET">PGPOOL SET</a> が追加されました。
      このコマンドを使用することで、現行セッション内で設定パラメータを変更することができるようになりました。
	</p></li><li class="listitem"><p>    
Watchdogが大幅に改善されました。
以前のバージョンよりも信頼性が向上しています。
	</p></li><li class="listitem"><p>    
問合せから大量の行が返される場合、ストリーミングレプリケーション時の拡張問い合わせプロトコル（例えば、Java アプリケーションで使用される場合）の処理速度が改善されました。
	</p></li><li class="listitem"><p>    
      PostgreSQL 9.6 のパーサを取り込みました。
	</p></li><li class="listitem"><p>    
特定の場合に<code class="function">pg_terminate_backend()</code>がフェイルオーバを起こさないようになりました。
	</p></li><li class="listitem"><p>    
      ドキュメントの形式が HTML から SGML に変更されました。
	</p></li></ul></div><p>    
      上記の項目は以下のセクションで詳しく説明します。
    </p></div><div class="sect2" id="idp59534736"><div class="titlepage"><div><div><h3 class="title">A.1.2. 主な改善点</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>    
      fail-over の挙動が改善されました。(Tatsuo Ishii)
	</p><p>    
      Streaming Replication モードで、フェイルオーバーが発生した時に、ダウンしたスタンバイサーバがそのセッションで使用されていなければ、クライアントセッションが切断されなくなりました。
プライマリサーバがダウンした場合は、すべてのセッションが切断されます。
ヘルスチェックタイムアウトした場合でも、すべてのセッションが切断されます。
リトライ最大回数を超えた場合を含めて、他のヘルスチェックエラーではすべてのセッションは切断されません。
	</p><p>    
fail-over が発生する場合にローカル負荷分散ノードの情報が重要なので、<code class="command">show pool_nodes</code> コマンドで、ローカル負荷分散ノードの情報が利用者の便宜のために表示されるようになりました。
負荷分散ノードがダウンしたノードではない場合、フェイルオーバーによる影響はありません。
	</p><p>    
      また、ヘルスチェックのリトライの最中でも <span class="productname">Pgpool-II</span> に接続できるようになりました。
以前は、<a class="xref" href="runtime-config-failover.html#guc-fail-over-on-backend-error">fail_over_on_backend_error</a>がオフの場合でも<span class="productname">Pgpool-II</span>への接続は、ヘルスチェックのリトライをしている間はすべて失敗していました。
これは、<span class="productname">Pgpool-II</span>の子プロセスがまず失敗したバックエンドを含めてすべてのバックエンドへの接続を試み、失敗した場合終了するためです（これはもちろん失敗します）。
これは一時的な状況であり、<span class="productname">Pgpool-II</span>がフェールオーバーを行えば解決します。
しかし、ヘルスチェックの再試行が行っている場合は、この一時的な状況は
      <a class="xref" href="runtime-config-health-check.html#guc-health-check-max-retries">health_check_max_retries</a>と<a class="xref" href="runtime-config-health-check.html#guc-health-check-retry-delay">health_check_retry_delay</a>の設定次第で長時間続きます。
この状況は良くないので、以下のように修正しました。

	</p><p>    
ストリーミングレプリケーションモードにおいて、バックエンドへの接続に失敗したら、そのダウンしたノードがプライマリではなければ、このバックエンドへの接続をあきらめて、他のノードへの接続を試みます。
	</p><p>    
ローカルノードのステータスを"down"と記録します。
これによりプライマリーノードがロードバランスノードとして選択され、すべてのクエリがプライマリーノードへ転送されます。
他にスタンバイのノードが存在する場合、その中からロードバランスノードが選択されます。
	</p><p>    
セッションが終了した後、ローカルの状態を保持しないように子プロセスは自殺します。
	</p></li><li class="listitem"><p>    
	  <a class="link" href="sql-pgpool-show.html" title="PGPOOL SHOW">PGPOOL
	  SHOW</a>, <a class="link" href="sql-pgpool-set.html" title="PGPOOL SET">PGPOOL
	  SET</a> と
	  <a class="link" href="sql-pgpool-reset.html" title="PGPOOL RESET">PGPOOL RESET</a>
	  コマンドが追加されました。 (Muhammad Usama)
	</p><p>    
これは<span class="productname">Pgpool-II</span>に現在のセッションの設定パラメータを設定またはリセットする機能を追加するという点で<span class="productname">PostgreSQL</span>のSET、SHOW、RESETコマンドと似ていますが、PostgreSQLのSET、RESETコマンドコマンドと区別するために、<code class="literal">PGPOOL</code>というキーワードが前に挿入してあります。
	</p><p>    
      現在 PGPOOL SHOW/SET/RESET に対応している設定パラメータは以下です。
	  <a class="xref" href="runtime-config-logging.html#guc-log-per-node-statement">log_per_node_statement</a>, <a class="xref" href="runtime-misc.html#guc-check-temp-table">check_temp_table</a>,
	  <a class="xref" href="runtime-misc.html#guc-check-unlogged-table">check_unlogged_table</a>, <a class="xref" href="runtime-config-load-balancing.html#guc-allow-sql-comments">allow_sql_comments</a>,
	  <a class="xref" href="runtime-config-connection-pooling.html#guc-client-idle-limit">client_idle_limit</a>, <a class="xref" href="runtime-config-logging.html#guc-log-error-verbosity">log_error_verbosity</a>,
	  <a class="xref" href="runtime-config-logging.html#guc-client-min-messages">client_min_messages</a>, <a class="xref" href="runtime-config-logging.html#guc-log-min-messages">log_min_messages</a>,
	  <a class="xref" href="runtime-online-recovery.html#guc-client-idle-limit-in-recovery">client_idle_limit_in_recovery</a>.
	</p></li><li class="listitem"><p>    
<span class="productname">Pgpool-II</span>再起動後、<span class="productname">PostgreSQL</span>ノードの状態の不整合がある場合、これを同期するようにしました。(bug 218) (Muhammad Usama)
	</p><p>    
    watchdog がバックエンドノードを同期させなかったのが原因でした。
	</p></li><li class="listitem"><p>    
多くの行が出力されるSELECTの性能を改善しました。(Tatsuo Ishii)
	</p><p>    
<span class="productname">Pgpool-II</span> がフロントエンドに行データ（"Data Row"メッセージ）を送るたびにネットワークにデータを（<code class="function">write(2)</code>を呼び出して）フラッシュしていました。
例えば、10,000行を転送する必要がある場合、write()が10,000 回呼び出されます。
これは非常にコストが高いです。
繰り返し行データを送信した後、"Command Complete"メッセージが送られるので、Command Completeメッセージの時に併せてwrite()を発行すれば十分です。
また、command completeメッセージの取り扱いにおいて、不必要なフラッシュがありました。
	</p><p>    
<a class="ulink" href="http://www.pgpool.net/pipermail/pgpool-hackers/2016-September/001784.html" target="_top">Quick testing</a>のテスト結果から、この修正により、特定の場合で、47%から62%の性能向上が得られたことが分かりました。
	</p><p>    
しかし、問い合わせが返す行が少ない場合は、まだ改善されていません。
そうした行はいずれにせよネットワークへのフラッシュが必要だからです。
	</p></li><li class="listitem"><p>    
	  <span class="productname">PostgreSQL</span> 9.6's のパーサを取り込みました。 (Bo Peng)
	</p><p>    
      これにより、<span class="productname">Pgpool-II</span> は <span class="productname">PostgreSQL</span>
      9.6 で導入された新しい構文 (<code class="literal">COPY INSERT/UPDATE/DELETE ... RETURNING</code> など) を理解可能です。
	</p></li><li class="listitem"><p>    
ある場合では、pg_terminate_backend() 関数が failover を引き起さないようになりました。(Muhammad Usama)
	</p><p><code class="function">pg_terminate_backend()</code>でバックエンドを終了させた場合、
<span class="productname">PostgreSQL</span>がpostmasterをシャットダウンしたときと同じメッセージを返しますので、
ユーザが望まないかもしれないフェールオーバーを発生させます。</p><p>これを修正するために、<span class="productname">Pgpool-II</span>は、
<code class="function">pg_terminate_backend()</code>の対象バックエンドのPIDを検出し、フェールオーバーを発生させません。</p><p>この修正は単純なプロトコルの場合、または<code class="function">pg_terminate_backend()</code>
に渡されたPIDが定数の場合にのみ適用します。
拡張プロトコル（Javaなど）の場合、<code class="function">pg_terminate_backend()</code>はフェールオーバーを起こします。</p></li><li class="listitem"><p>HTMLドキュメントが、SGMLドキュメントから生成されるようになりました。(Muhammad Usama, Tatsuo Ishii, Bo Peng)
	</p><p>これはより良い構成、内容、保守の容易性をもたらすためです。
また、manページがSGMLから生成されるようになりました。
しかし、SGMLドキュメントにはまだたくさんの改良の余地があります。
どうか私達を助けてください！
	</p></li></ul></div></div><div class="sect2" id="idp59579104"><div class="titlepage"><div><div><h3 class="title">A.1.3. 他の改善点</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>    
	  認証エラーメッセージをわかりやすくしました。 (Tatsuo Ishii)
	</p><p>    
バックエンドに接続する時に(ヘルスチェックを含む)、"invalid authentication message response type, Expecting 'R' and received '%c'" メッセージではなく"sorry, too many clients already"のようなメッセージを返すようにしました。
	</p></li><li class="listitem"><p>    
      pool_check_fd()のヘルスチェックタイマーの期限切れ条件を強化しました。(Muhammad Usama)
	</p></li><li class="listitem"><p>    
	  新しいスクリプト "watchdog_setup" が追加されました。 (Tatstuo Ishii)
	</p><p>    
<a class="xref" href="watchdog-setup.html" title="watchdog_setup"><span class="refentrytitle">watchdog_setup</span></a> は watchdog 機能を有効にした<span class="productname">Pgpool-II</span>クラスタのテスト環境を構築するコマンドです。
	</p></li><li class="listitem"><p>    
	  pgpool_setup に "pg" オプションが追加されました。(Tatsuo Ishii)
	</p><p>    
これは<a class="xref" href="pgpool-setup.html" title="pgpool_setup"><span class="refentrytitle">pgpool_setup</span></a>を使用する時に、<span class="productname">PostgreSQL</span>に特定のポート番号を割り当てたい場合に便利です。
また、<code class="command">pgpool</code> と同じように、<code class="command">pgpool_setup</code>は標準binディレクトリにインストールされるようになりました。
	</p></li><li class="listitem"><p>    
	  <a class="link" href="sql-show-pool-nodes.html" title="SHOW POOL NODES">show pool_nodes</a> の出力結果に replication delay カラムが追加されました。(Tatsuo Ishii)
	</p><p>    
      streaming replication モードの場合、
      このカラムは <a class="link" href="runtime-streaming-replication-check.html" title="5.11. ストリーミングレプリケーションのチェック">replication delay</a> の値を bytes 単位で表示します。
	</p></li><li class="listitem"><p>    
     すべてのノードがダウンした場合、 status ファイルを更新しないように変更されました。(Chris Pacejo, Tatsuo Ishii)
	</p><p>    
レプリケーションモードにおいて、すべてのノードがダウン状態の場合にstatusファイルに記録しないようにすることで、<a class="ulink" href="http://www.pgpool.net/pipermail/pgpool-general/2015-August/003974.html" target="_top">[pgpool-general:3918]</a> で報告されたデータの不整合を修正しました。
この驚ほど単純ですが、スマートな解決方法はChris Pacejoにより提供されました。
	</p></li><li class="listitem"><p>    
     <span class="productname">Pgpool-II</span> が 複数 SSL cipher protocols に対応できるように修正しました。(Muhammad Usama)
	</p><p>    
SSLセッションを初期化する際の処理でTLSv1_method()を<code class="function">SSLv23_method()</code>で置き換えることにより、TLSv1プロトコルよりも多くのプロトコルを使うことができるようになりました。
	</p></li><li class="listitem"><p>    
	  black_function_list/white_function_list
      に任意のアイテムの数が使用できるようになりました。(Muhammad Usama)
	</p><p>    
      これまで、このアイテムの数には固定の上限がありました。
	</p></li><li class="listitem"><p>    
     コメントのみを含む空クエリを適切に処理できるよう修正しました。(Tatsuo Ishii)
	</p><p>    
この修正で、<span class="productname">Pgpool-II</span>"/* DBD::Pg ping test v3.5.3 */" (';' を含まないことに注意)のような空クエリを正しく識別できるようになりました。
	  </p><p>    
      これまではエラークエリとして処理していました。
	</p></li><li class="listitem"><p>    
      wd_authkey ハッシュ計算失敗時に警告メッセージを出力するようにしました。(Yugo Nagata)
	</p><p>    
      たまに、認証キー不一致以外の何らかの理由で wd_authkey 計算に失敗することがあります。
      メッセージ出力を追加することでこれらを互いに区別できるようにしました。
	</p></li></ul></div></div><div class="sect2" id="idp59600720"><div class="titlepage"><div><div><h3 class="title">A.1.4. 変更点</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>        
log_destination = syslog 設定の不具合を修正しました。(Muhammad Usama)
        </p><p>        
PGPOOL SET/SHOW コマンド追加の修正によって、ログの出力先がsyslogの場合、不具合がありましたので、修正しました。また、log_destinationパラメータがカンマ区切りで複数出力先を指定することができるようになりました。この修正によって、log_destination は "syslog" と "stderr" の任意の組み合わせに設定できるようになりました。
        </p></li><li class="listitem"><p>            
<a class="xref" href="runtime-config-failover.html#guc-search-primary-node-timeout">search_primary_node_timeout</a>のデフォルト値を10から300に変更しました。(Tatstuo Ishii)
			</p><p>            
これまでのデフォルト値10秒は、スタンバイを昇格する際には小さすぎでした。
			</p></li><li class="listitem"><p>            
            src/sql/ 配下の Makefile が修正されました。(Bo Peng)
            </p><p>            詳しくは  <a class="ulink" href="http://www.pgpool.net/pipermail/pgpool-hackers/2016-June/001611.html" target="_top">            [pgpool-hackers: 1611]</a> を参照してください。
			</p></li><li class="listitem"><p>            
                pcp_proc_count コマンドの出力結果のプロセス ID を 6 桁まで表示 できるよう修正しました。(Bo Peng)
			</p><p>            
                 特定の環境において、pcp_proc_count コマンドの出力結果のプロセス ID が6 桁の場合、
                 6 番目の文字が表示されませんでした。 この修正で、プロセス ID が最大 6 桁まで表示するよう変更しました。
            </p></li><li class="listitem"><p>            
                すべてのクエリがプライマリサーバに送信されるように変更しました。(Tatsuo Ishii)
            </p><p>            
<a class="xref" href="runtime-config-load-balancing.html#guc-load-balance-mode">load_balance_mode</a> = off の場合でも、一部のクエリがプライマリサーバ以外にも転送されていました。
               この修正で、 streaming replication モードで load_balance_mode = off
               の場合はすべてのクエリをプライマリサーバにのみ送るようにしました。
            </p></li></ul></div></div><div class="sect2" id="idp59610320"><div class="titlepage"><div><div><h3 class="title">A.1.5. 不具合修正</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>      
pool_stream関数の潜在的なクラッシュを修正しました。(Muhammad Usama)
      </p><p>      
POOL_CONNECTION-&gt; con_infoは、バックエンドソケットで読み取りまたは書き込みが失敗したときに、逆参照する前にヌル値をチェックする必要があります。
      </p></li><li class="listitem"><p>      
watchdogクラスタでのフェイルオーバーコマンドの転送処理が改善されました。(Muhammad Usama)
      </p><p>      
これまでは、<span class="productname">Pgpool-II</span> ノードの watchdogがすべての接続されたノードにフェイルオーバーコマンド(failover、 failback 及び promote node)を転送していました。多数のノードが含まれているwatchdogクラスタでは、フェールオーバーコマンドが複数の<span class="productname">Pgpool-II</span>によって実行されることによって、データの同期問題を引き起こす可能性がありました。このコミットでは、すべてのフェイルオーバーコマンド(failover、 failback 及び promote node)が master/coordinator watchdog に転送され、master/coordinator watchdogはすべてのスタンバイノードに転送するようになりました。
      </p><p>      
また、今回の修正では、インターロック機能も変更されました。master/coordinatorノーのみがロックホルダになり、フェイルオーバコマンドはmaster/coordinatorノードでのみ実行されます。
      </p></li><li class="listitem"><p>        
        すべてのバックエンドがダウンした後に、1つのノードを復帰させる時の不具合が修正されました。(Tatsuo Ishii)
        </p><p>        
すべてのノードがダウンすると、すべてのコネクションを受け付けなくなります。
その状態で1つの<span class="productname">PostgreSQL</span>が起動し、<code class="command">pcp_attach_node</code>コマンドでそのノードを復帰させます。
そしてこのコマンドは成功しました。
しかし、新しい接続が拒否されました。
これは<span class="productname">Pgpool-II</span> の子プロセスがキャッシュされた古い情報を参照したのが原因でした。
ストリーミングレプリケーションモードでは、このキャッシュされた情報において、復帰させたノードの状態がdownのままでした。
（ネィティブレプリケーションモード、およびそれ以外のモードでは問題ありません）
解決法として、全ノードがダウンした場合、強制的に全 <span class="productname">Pgpool-II</span>子プロセスを再起動するようにしました。
        </p></li><li class="listitem"><p>        
再起動が必要なパラメータの設定を変更した際の<span class="productname">Pgpool-II</span>停止が起こらないようにしました。(Muhammad Usama)
        </p><p>        
この修正のために、設定パラメータの検証機構の順序を逆にしました。
以前はスタンバイノードが<span class="productname">Pgpool-II</span>マスターノードに対して設定パラメータの値を検証し、不整合が見つかった場合にはFATALエラーが出力されていました。
この修正で、<span class="productname">Pgpool-II</span>マスターノードに検証の役割が移譲されました。
マスターノードは参加している個々のスタンバイノードの設定値をローカルの設定値と比較し、違っている場合にはエラーではなくてWARNINGメッセージを出力します。
この方法では、watchdogクラスタとユーザは、手動でマスター<span class="productname">Pgpool-II</span>ログの中から不整合ワーニングを見つけて、<span class="productname">Pgpool-II</span>マスターのスイッチオーバが見つかった時に驚くようなことが起こらないようにしなければなりません。
        </p></li><li class="listitem"><p>        
        watchdog が有効な場合、<a class="xref" href="runtime-config-failover.html#guc-failover-command">failover_command</a> コマンドのロック取得時の処理が改善されました。(Muhammad Usama)
        </p></li><li class="listitem"><p>        
        コンパイルエラーを修正するために、<code class="filename">configure.ac</code>
        ファイルにコンパイルフラグ "-fno-strict-aliasing" が追加されました。(Tatsuo Ishii)
        </p></li><li class="listitem"><p>        
        MD5 salt を生成するときに、<code class="function">random()</code> を使用しないように修正しました。(Tatsuo Ishii)
        </p><p>        
<code class="function">random()</code>関数はセキュリティ関連のアプリケーションに使用しないべきです。
<code class="function">random()</code>の代わりに<span class="productname">PostgreSQL</span>の<code class="function">PostmasterRandom()</code> 使用するように変更しました。
        </p></li><li class="listitem"><p>        
        クエリキャッシュが有効な場合、sync メッセージが廃棄されないよう修正しました。(Tatsuo Ishii)
        </p></li><li class="listitem"><p>        
<a class="xref" href="runtime-config-connection.html#guc-listen-addresses">listen_addresses</a>が空文字の場合、Pgpool-II が起動できない不具合を修正しました。(bug 237) (Muhammad Usama)
        </p><p>        
        TCP listen addresses が空の場合、socket descriptor 配列（fds[]）の終了マークがないのが原因でした。
        </p></li><li class="listitem"><p>        
リグレッションログディレクトリが存在しない場合、作成されるようになりました。(Tatsuo Ishii)
        </p></li><li class="listitem"><p>        
        ソケットの操作に失敗したときのエラーメッセージを修正しました。(Muhammad Usama)
        </p></li><li class="listitem"><p>        
        <a class="link" href="sql-show-pool-nodes.html" title="SHOW POOL NODES">show pool_nodes</a> コマンドの修正を反映し、レグレッションテスト 003.failover を変更しました。
        </p></li><li class="listitem"><p>        
        Portal suspend を受け取ったときのハングが修正されました。(bug 230) (Tatsuo Ishii)
        </p></li><li class="listitem"><p>ネットワークが復旧した時にIPを降格しない問題を修正しました。(bug 228) (Muhammad Usama)
        </p><p>ローカルノードの状態が調停者状態から他の状態に変わった時に降格させるために、set_state関数が実装されました。
        </p></li><li class="listitem"><p>        
        SIGUSR1 シグナルハンドラーを watchdog の初期化前にインストールするように修正しました。(Muhammad Usama)
        </p><p>        
        watchdog 初期化直後に 他のwatchdog ノードから failover リクエストがあった場合、
        SIGUSR1 シグナルハンドラーのインストールを待っていれば、クラッシュが発生する可能性がありました。
        </p></li><li class="listitem"><p>        
        他のノードが利用できない場合、<span class="productname">Pgpool-II</span> が
        IPアドレスをエスカレートしない不具合を修正しました。(bug 215) (Muhammad Usama)
        </p><p>        
        Heartbeat destination が IPアドレスで指定され、wd_hostname が hostname で設定される場合、
        heartbeat receiver が heartbeat sender watchdog ノードを識別できなかったのが原因でした。
        逆の場合でも同様なエラーが起こります。
        </p></li><li class="listitem"><p>        
        watchdog に関するコーデイングミスを修正しました。(Muhammad Usama)
        </p><p>        
<code class="function">wd_issue_failover_lock_command()</code>関数は、渡ってきたコマンドタイプを<code class="function">wd_send_failover_sync_command()</code>関数の引数に渡すように想定されていますが、その代わりにNODE_FAILBACK_CMDコマンドタイプを渡していました。
        </p><p>        
        この修正で、いくつかのログメッセージも改善しました。
        </p></li><li class="listitem"><p>        
        <a class="link" href="pcp-proc-info.html" title="pcp_proc_info">pcp_node_info</a> コマンドの標準出力の「Status」がわかりやすくように変更されました。(Muhammad Usama)

        </p><p>        
        <a class="link" href="pcp-proc-info.html" title="pcp_proc_info">pcp_node_info</a> コマンドの標準出力の「Status」が内部状態コードから人間がわかりやすい状態の文字列に変更されました。
        </p></li><li class="listitem"><p>        
          「MAJOR」マクロによる発生しうるセグメンテーションフォルトを修正しました。(Tatsuo Ishii)
        </p><p>        
          MAJOR が <code class="function">pool_virtual_master_db_node_id()</code> を呼出し、
          戻り値 idを使ってbackend-&gt;slots[id]-&gt;con にアクセスします。
可能性は低いですが、conが0を指し（DB にアクセスできない場合）、con-&gt;major にアクセスし、セグメンテーションフォルトを引き起す可能性がありました。
        </p></li><li class="listitem"><p>        
        "kind mismatch" エラーメッセージの処理について修正しました。(Muhammad Usama)
        </p><p>        
        多くの"kind mismatch..."エラーは、NOTICE や WARNING メッセージが
        DBノードのいくつかで起こることによるものです。
        この修正では、そうしたケースにおいて、"kind mismatch..."エラーを引き起こすのではなく、
        NOTICE や WARNINGメッセージをフロントエンドに送るようになりました。
        これにより、"kind mismatch..."エラーの発生が減少します。
        </p></li><li class="listitem"><p>        
        <a class="xref" href="runtime-config-connection.html#guc-pcp-listen-addresses">pcp_listen_addresses</a> パラメータの処理の不具合を修正しました。(Muhammad Usama)
        </p></li><li class="listitem"><p>        
        シグナルハンドラ中でエラー番号が保存されるようになりました。 (Tatsuo Ishii)
        </p></li><li class="listitem"><p>        
        pgpool メインプロセスの <code class="function">wait(2)</code> の扱いを修正しました。(Tatsuo Ishii)
        </p><p>        
<span class="productname">Pgpool-II</span> メインプロセスから呼び出される<code class="function">wait(2)</code>はそのシステムコール内で永久に待つ可能性があります。
        この修正で、 <code class="function">wait(2)</code> の代わりに、<code class="function">waitpid(2)</code> を使うように変更しました。
        </p></li><li class="listitem"><p>        
        <a class="xref" href="runtime-config-failover.html#guc-fail-over-on-backend-error">fail_over_on_backend_error</a> が off の場合、
        <code class="function">read(2)</code> が -1 を返しても
        <code class="function">pool_read()</code> がエラーメッセージを発行しない不具合が修正されました。(Tatsuo Ishii)
        </p></li><li class="listitem"><p>        
        <code class="command">show pool_nodes</code> でのバッファオーバーランを修正しました。(Tatsuo Ishii)
        </p><p>        
        <code class="command">show pool_nodes</code> を実行時、hostname に割り当てられたバッファが十分ではないのが原因でした。
        <code class="filename">pgpool.conf</code> のバッファサイズと同じようにしました。
        </p></li><li class="listitem"><p>        
        <a class="ulink" href="http://www.pgpool.net/pipermail/pgpool-hackers/2016-June/001638.html" target="_top">        [pgpool-hackers: 1638]</a> で報告された、<span class="productname">Pgpool-II</span>
        がデフォルトの設定を使用しない不具合が修正されました。(Muhammad Usama)
        </p><p>        
         設定ファイルが見つからない場合は、 ERROR または FATAL ではなく、WARNING を返すように修正しました。
        </p></li><li class="listitem"><p>        
        共有メモリ上のロードバランスノードの書き込みに関するバグを修正しました。(Tatsuo Ishii)
        </p><p>        
2, 3の箇所で、ロードバランスノードが間違ったことろに置かれてしまいました。
        </p><p>        [正しい場所]
        </p><pre class="programlisting">ConnectionInfo *con_info[child id, connection pool_id, backend id].load_balancing_node].
        </pre><p>        [実際に置かれた場所]
        </p><pre class="programlisting">*con_info[child id, connection pool_id, 0].load_balancing_node].
        </pre><p>        
バックエンド id が 0 の場合、上記バグが発生しませんが、<span class="productname">Pgpool-II</span> 3.6 のフェイルオーバーテストで、プライマリノードが 1 (ロードバランスノード)、スタンバイノードが 0 の場合、ノード1 の接続が切断され、フェイルオーバーが起きています。
これは想定外のことだったのでこのバグが見つかりました。
        </p><p>        
このバグはかなり前からありましたが、上記の理由で、今まで見つかっておリませんでした。
        </p></li><li class="listitem"><p>        
#197 で報告されたpgpoolのハングを修正しました。(bug 197) (Muhammad Usama)
        </p><p>        
watchdog が有効で、バックエンドノードとリモート <span class="productname">Pgpool-II</span>ノードが同時接続できなくなった場合、クライアント接続がスタックします。
        原因は watchdog に IPC コマンドを送信する関数を呼び出すコマンドタイムアウトがなかったからです。
        </p></li><li class="listitem"><p>        
        ヘルスチェックで発生し得るハングアップを修正しました。(bug 204) (Yugo Nagata)
        </p><p>        
        <code class="function">connect(2)</code> が成功し、
        その後バックエンドからデータが送信されない場合、ヘルスチェックがハングしていました。
ヘルスチェック中に、<code class="function">select(2)</code>がSIGALRMのためにEINTRで終了した場合、<code class="function">pool_check_fd()</code>が1を返すように修正しました。
        </p></li><li class="listitem"><p>        
         streaming replication モードで、プライマリノードが 0 ではない場合に発生する不具合が修正されました。 (Tatsuo Ishii)
        </p><p>        
<a class="ulink" href="http://www.pgpool.net/mantisbt/view.php?id=194#c837" target="_top">http://www.pgpool.net/mantisbt/view.php?id=194#c837</a>の報告により、bug194-3.3.diff を適用しても、プライマリノードが 0 ではない場合、ステートメントタイムアウトが発生する可能性がありました。
         調査した結果、MASTER マクロがプライマリノードまたはロードバランスノード
         以外のノードを返したからです。
そのため、<code class="function">do_query()</code>がクエリを間違ったノードに送信していました（これは報告では明確ではありませんでしが、 調査で確認できました）。
        </p><p>        
MASTER マクロから呼ばれる<code class="function">pool_virtual_master_db_node_id()</code> は、クエリコンテキストが存在する場合、query_context-&gt;virtual_master_node_id を返します。
その変数がまだ初期化されていない場合、この関数が間違ったノード を返す可能性があります。
そのため、<code class="function">pool_virtual_master_db_node_id()</code> 関数を以下のように修正しました。
変数にプライマリノードもロード バランスノードも設定されていない場合、プライマリノードを返します。
        </p></li><li class="listitem"><p>        
バックエンドのステートメントタイムアウトが有効で、<code class="function">do_query()</code>がクエリをプライマリノードに送信し、それ以降のユーザクエリがスタンバイノードに送信された場合、次のコマンド、例えば、ENDコマンドが、プライマリノードのステートメントタイムアウトを引き起こし、kind mismatch error が発生する可能性がありました。(bug 194) (Tatsuo Ishii)
        </p><p>        
        この問題を軽減するために、<code class="function">do_query()</code>
        がフラッシュメッセージを送信する代わりに、sync メッセージ送信するように修正しました。
明示的トランザクションのときは、sync メッセージを送信することで、ステートメントタイムアウトタイマーがリセットされます。
暗黙的なトランザクションでは、このやり方は使えません。
なぜなら、unnamed portal が存在する場合、sync メッセージが unnamed portalを削除するからです。
        </p><p>更にこれにより、pg_stat_statement が <code class="function">do_query()</code> が発行したクエリを "running" で表示しなくなります。
        </p></li><li class="listitem"><p>        
        拡張プロトコルのraw モードでのバグを修正しました。(bug 152) (Tatsuo Ishii)
        </p><p>        
        Bug 152の報告により、拡張プロトコルの raw モード（実は stream モード以外）で
        <code class="function">Describe()</code> と <code class="function">Close()</code>
        の処理に誤りがありました。stream モードとは異なり、バックエンドからの応答を待つべきでした。
        </p></li><li class="listitem"><p>        
        <code class="filename">pgpool.conf</code> の不正確なコメントを修正しました。(Tatsuo Ishii)
        </p></li><li class="listitem"><p>        
日本語と中国語ドキュメントのraw モードに関する内容の誤りを修正しました。(Yugo Nagata, Bo Peng)
        </p><p>        
        raw モードでも、コネクションプーリングが有効です。
        </p></li><li class="listitem"><p>        
<code class="function">is_set_transaction_serializable()</code>関数の<code class="command">SET default_transaction_isolation TO 'serializable'</code>の扱いに関するバグを修正しました。(bug 191) (Bo Peng)
        </p><p>        
        <span class="productname">Pgpool-II</span> は <code class="command">SET default_transaction_isolation TO 'serializable'</code>
        をプライマリだけではなく、スタンバイにも送信してしまい、エラーが起きていました。
        この修正で、streaming replication モードの場合、<code class="command">SET default_transaction_isolation TO 'serializable'</code>
        がプライマリサーバのみに送信されます。
        </p></li><li class="listitem"><p>        
        拡張プロトコルにおける空クエリの場合、発生し得るハングアップを修正しました。(Tatsuo Ishii)
        </p><p>        
この修正は3.5.1で空のクエリの場合の拡張プロトコルの扱いに関係しています。
この場合バックエンドはcommand complete messageと同じ意味を持つ"empty query response"を返します。
問題は、"empty query response"を受信した際に、<span class="productname">Pgpool-II</span>がクエリ進行中フラグをリセットせず、 バックエンドの応答を待ち続けることことです。
しかし、バックエンドはsyncメッセージをを受け取るまではready for queryメッセージを返しません。
解決方法は、"empty query response"を受信した際に、クエリ進行中フラグをリセットし、フロントエンドがsync メッセージを送信することを期待してフロントエンドからの応答を待つことです。
        </p></li><li class="listitem"><p>        
	    <a class="ulink" href="http://www.pgpool.net/pipermail/pgpool-general/2016-March/004627.html" target="_top">        [pgpool-general: 4569]</a> により報告された
        trusted_servers チェック時のセグメンテーションフォルトを修正しました。 (Muhammad Usama)
        </p><p>        
        <span class="productname">Pgpool-II</span> 3.4 からは <span class="productname">PostgreSQL</span>
        のメモリマネージャおよび 例外マネージャ API を流用していますが、
        それはスレッドセーフ ではありません。上位接続を確認するため ping の応答で信頼できるサーバ確認時、
        watchdog lifecheck プロセスでセグメンテ ーションフォルトを引き起こしていました。
        スレッドを削除し、 子プロセスを使うように修正しました。
        </p></li><li class="listitem"><p>        
PCP パケットの長さを検証するよう修正しました。(Muhammad Usama)
        </p><p>        
        この検証がない場合、非常に巨大なデータサイズのパケットを送信することで、
        不正な PCP パケットが PCP 子プロセスをクラッシュさせたり、サーバで out of memory を発生させることが可能でした。
        </p></li><li class="listitem"><p>        
         <a class="link" href="pgpool-setup.html" title="pgpool_setup">pgpool_setup</a>がログ出力を混乱させないように修正しました。(Tatsuo Ishii)
        </p><p>        
         以前は <span class="productname">Pgpool-II</span> プロセスの stdout および stderr
         は単にログファイルにリダイレクトされていました。
         これは複数プロセスが同時に書き込みを行うため競合が発生し、
         ログの文字化けや消失の原因となっていました。
         </p><p>         
         このため、<a class="link" href="pgpool-setup.html" title="pgpool_setup">pgpool_setup </a>
         が生成する startall スクリプトでは、<span class="productname">Pgpool-II</span>
         は stdout/stderr を cat コマンドにパイプで送信し、
         cat がログファイルの書き込みを行うように修正されました。
（パイプに書き込む際にはこの競合状態は発生しないようです）
        </p></li><li class="listitem"><p>        
<a class="ulink" href="http://www.pgpool.net/pipermail/pgpool-general/2016-March/004577.html" target="_top">[pgpool-general: 4519]</a> により報告されたワーカープロセスが終了し再生成されなくなる不具合を修正しました。(Muhammad Usama)
        </p><p>        
        この問題は watchdog が有効のときに終了した子プロセスのタイプをチェックするコードにロジック間違いがあったのが原因でした。
        また、接続が max connection に達して子プロセスが終了する際に出力されるメッセージの重要度を FATAL からLOG に変更されました。
        </p></li><li class="listitem"><p>        
バックエンドからエラー状態を受信した後のハングを修正しました。 (bug #169) (Tatsuo Ishii)
        </p><p>        
        これは拡張プロトコル問い合わせを実行しそれが失敗したときに発生し得ました。
        </p></li><li class="listitem"><p>        
        ストリーミングレプリケーションモードで拡張プロトコル問い合わせを使用したときに
        スタックが発生する問題を修正しました。(bug 167, 168) (Tatsuo Ishii)
        </p><p>        </p></li><li class="listitem"><p>        
	    <a class="ulink" href="http://www.pgpool.net/pipermail/pgpool-hackers/2016-March/001440.html" target="_top">        [pgpool-hackers: 1440]</a> により報告されたリセットクエリがスタックする問題を修正しました。(Tatsuo Ishii)
        </p><p>        
        フロントエンドから 'X' メッセージを受信した後、リセットクエリ送信前に <span class="productname">Pgpool-II</span> が
        EOF をその接続で検出すると、<span class="productname">Pgpool-II</span>
        がリセットクエリを受信していないバックエンドからの応答を待ち続けることがありました。
        EOF を受信した場合には、これを ERROR ではなく FRONTEND_ERROR として扱うことで修正しました。
        </p></li><li class="listitem"><p>        
	    <a class="ulink" href="http://www.pgpool.net/pipermail/pgpool-general/2015-December/004323.html" target="_top">[pgpool-general: 4265]</a>
        より報告されたリセットクエリがスタックする問題を修正しました。(Muhammad Usama)
        </p><p>        
        フロントエンドソケットにおける pool_flush が失敗したときには、ERRORではなく FRONTEND_ERROR を発生させることで解決しました。
        </p></li><li class="listitem"><p>        
<span class="productname">PostgreSQL</span> 9.6における pgpool-recovery モジュールのコンパイルエラーを修正しました。(Muhammad Usama)
        </p><p>        
        <span class="productname">PostgreSQL</span> 9.6 の <code class="function">GetConfigOption()</code>
        関数の関数定義の変化に対応しました。
        </p></li><li class="listitem"><p>        
            FreeBSD でのコンパイルエラーを修正しました。(Muhammad Usama)
        </p><p>        
        不足していた include ファイルを追加しました。
        パッチはバグ報告者によって作成され、Usama により改善されました。
        </p></li><li class="listitem"><p>        
        個々のテストのタイムアウトをチェックできるようレグレッションテストを修正しました。(Yugo Nagata)
        </p></li></ul></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="release.html">前へ</a> </td><td width="20%" align="center"><a accesskey="u" href="release.html">上へ</a></td><td width="40%" align="right"> <a accesskey="n" href="bookindex.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">付録A リリースノート </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> 索引</td></tr></table></div></body></html>