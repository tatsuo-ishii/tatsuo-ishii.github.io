<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>5.12. インメモリキャッシュ</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Pgpool-II 3.7devel 文書" /><link rel="up" href="runtime-config.html" title="第5章 サーバの設定" /><link rel="prev" href="runtime-streaming-replication-check.html" title="5.11. ストリーミングレプリケーションのチェック" /><link rel="next" href="runtime-ssl.html" title="5.13. Secure Sockect Layer (SSL)" /><link rel="copyright" href="legalnotice.html" title="Legal Notice" /><meta name="viewport" content="width=device-width,initial-scale=1.0" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><td width="20%" align="left" colspan="2"></td><th width="60%" align="center"><a accesskey="h" href="index.html">Pgpool-II 3.7devel 文書</a></th><td width="20%" align="right"></td></tr><tr><td width="10%" align="left" valign="top"><a accesskey="p" href="runtime-streaming-replication-check.html">前へ</a> </td><td width="10%" align="left" valign="top"><a accesskey="u" href="runtime-config.html">上へ</a></td><td width="60%" align="center">5.12. インメモリキャッシュ</td><td width="20%" align="right" valign="top"> <a accesskey="n" href="runtime-ssl.html">次へ</a></td></tr></table><hr /></div><div class="sect1" id="runtime-in-memory-query-cache"><div class="titlepage"><div><div><h2 class="title" style="clear: both">5.12. インメモリキャッシュ</h2></div></div></div><p>    
    <span class="productname">Pgpool-II</span>の全てのモードでインメモリクエリキャッシュを利用することができます。
    テーブルが更新によりキャッシュが古くなっても、<span class="productname">Pgpool-II</span>の再起動の必要はありません。</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>      
      基本的に以下のSELECTはキャッシュされません。
      </p><pre class="programlisting">       immutableな関数を含むSELECT
       一時テーブル、unloggedテーブルを使ったSELECT
       検索結果が memqcache_maxcache を越えるようなSELECT
       SELECT FOR SHARE/UPDATE
       /*NO QUERY CACHE*/コメントで始まるSELECT
       システムカタログを使用しているSELECT
       TABLESAMPLEを使っているSELECT
      </pre><p>

    </p></div><p>  
  インメモリクエリキャッシュは、SELECT文(拡張問い合わせの場合は更にバインドパラメータ)と 検索結果をペアで記録します。
  同じSELECT文が発行された場合に、<span class="productname">Pgpool-II</span>はキャッシュから結果を返します。
  <acronym class="acronym">SQL</acronym>の解析も<span class="productname">PostgreSQL</span>へのアクセスも行われないため、インメモリキャッシュからの結果の提供は非常に高速です。
</p><p>  
  反面、キャッシュをストアするオーバヘッドが生じるので、通常の方法より遅くなる場合も有ります。
  また、あるテーブルが更新された場合、<span class="productname">Pgpool-II</span>は自動的にそのテーブルに関係する全てのキャッシュを削除します。
  そのため、更新が多いシステムではパフォーマンスが悪くなります。
  キャッシュのヒット率(<a class="xref" href="sql-show-pool-cache.html" title="SHOW POOL_CACHE"><span class="refentrytitle">SHOW POOL_CACHE</span></a>を使って確認できます)が70%以下の場合は、インメモリクエリキャッシュ無効にしたほうがいいかもしれません。</p><div class="sect2" id="runtime-in-memory-query-cache-enabling"><div class="titlepage"><div><div><h3 class="title">5.12.1. インメモリクエリキャッシュを有効にする</h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt id="guc-memory-cache-enabled"><span class="term"><code class="varname">memory_cache_enabled</code> (<code class="type">boolean</code>)
	<a id="idm45863246280512" class="indexterm"></a>
      </span></dt><dd><p>	  
	  onにするとメモリキャッシュが有効になります。
	  デフォルトはoffです。
	</p><p>	  
	  このパラメータは<span class="productname">Pgpool-II</span>の設定を再読み込みすることで変更可能です。</p></dd></dl></div></div><div class="sect2" id="runtime-in-memory-query-cache-choose-storage"><div class="titlepage"><div><div><h3 class="title">5.12.2. キャッシュストレージの選択</h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt id="guc-memqcache-method"><span class="term"><code class="varname">memqcache_method</code> (<code class="type">string</code>)
	<a id="idm45863246274816" class="indexterm"></a>
      </span></dt><dd><p>	  
	  キャッシュに用いるストレージのタイプを指定します。
	  このパラメータで有効な全ての値のリストを以下の表に示します。
	</p><div class="table" id="memqcache-method-table"><p class="title"><strong>表5.10 Memcache method options</strong></p><div class="table-contents"><table class="table" summary="Memcache method options" border="1"><colgroup><col /><col /></colgroup><thead><tr><th>値</th><th>説明</th></tr></thead><tbody><tr><td><code class="literal">'shmem'</code></td><td>共有メモリを使用</td></tr><tr><td><code class="literal">'memcached'</code></td><td><a class="ulink" href="http://memcached.org/" target="_top">memcached</a>を使用</td></tr></tbody></table></div></div><br class="table-break" /><p>	  
	  デフォルトは<code class="literal">'shmem'</code>です。
	</p><p>	  
	  このパラメータはサーバ起動時にのみ設定可能です。
	</p></dd></dl></div></div><div class="sect2" id="runtime-in-memory-query-cache-config"><div class="titlepage"><div><div><h3 class="title">5.12.3. 共通設定</h3></div></div></div><p>    
    以下は<code class="literal">shmem</code>と<code class="literal">memcached</code>の両タイプのクエリキャッシュで有効なパラメータです。
  </p><div class="variablelist"><dl class="variablelist"><dt id="guc-memqcacheexpire"><span class="term"><code class="varname">memqcache_expire</code> (<code class="type">integer</code>)
	<a id="idm45863246261792" class="indexterm"></a>
      </span></dt><dd><p>	  
	  クエリキャッシュの寿命を秒単位で設定します。
	  デフォルト0で、キャッシュの期限はなくなり、関連テーブルが更新されるまではキャッシュが有効になります。
        </p><p>	  
	  このパラメータは<span class="productname">Pgpool-II</span>の設定を再読み込みすることで変更可能です。</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>    
    <code class="varname">memqcache_expire</code>と<a class="xref" href="runtime-in-memory-query-cache.html#guc-memqcache-auto-cache-invalidation">memqcache_auto_cache_invalidation</a>は互いに独立です。
  </p></div></dd><dt id="guc-memqcache-auto-cache-invalidation"><span class="term"><code class="varname">memqcache_auto_cache_invalidation</code> (<code class="type">boolean</code>)
    <a id="idm45863246255056" class="indexterm"></a>
  </span></dt><dd><p>      
      onに設定した場合、更新されたテーブルに関連するキャッシュを自動で削除します。
      offならばキャッシュは削除されません。
    </p><p>      
      デフォルト値はonです。
    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>	
	<code class="varname">memqcache_auto_cache_invalidation</code>と<a class="xref" href="runtime-in-memory-query-cache.html#guc-memqcacheexpire">memqcache_expire</a>は互いに独立です。
      </p></div><p>      
      このパラメータは<span class="productname">Pgpool-II</span>の設定を再読み込みすることで変更可能です。</p></dd><dt id="guc-memqcache-maxcache"><span class="term"><code class="varname">memqcache_maxcache</code> (<code class="type">integer</code>)
    <a id="idm45863246248096" class="indexterm"></a>
  </span></dt><dd><p>      
      キャッシュされるSELECTクエリ結果の最大サイズをバイト数で指定します。
      この値より大きいサイズのデータの結果は<span class="productname">Pgpool-II</span>にキャッシュされません。
      サイズの制約によりデータのキャッシュができなかった場合、以下のメッセージが表示されます。
      </p><pre class="programlisting">	LOG:   pid 13756: pool_add_temp_query_cache: data size exceeds memqcache_maxcache. current:4095 requested:111 memq_maxcache:4096
      </pre><p>
    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>	
	共有メモリによるクエリキャッシュ（<code class="literal">'shmem'</code>）の場合は、<code class="varname">memqcache_maxcache</code>は<a class="xref" href="runtime-in-memory-query-cache.html#guc-memqcache-cache-block-size">memqcache_cache_block_size</a>を超えないように、<code class="literal">'memcached'</code>を使用する場合は、slabのサイズ(デフォルトで1MB)を超えないようにしてください。
      </p></div><p>      
      このパラメータは<span class="productname">Pgpool-II</span>の設定を再読み込みすることで変更可能です。</p></dd><dt id="guc-white-memqcache-table-list"><span class="term"><code class="varname">white_memqcache_table_list</code> (<code class="type">string</code>)
    <a id="idm45863246238128" class="indexterm"></a>
  </span></dt><dd><p>      
      SELECT結果が<span class="productname">Pgpool-II</span>にキャッシュされるべきテーブル名のリストをカンマ区切りで指定します。
      このパラメータは、VIEWとunloggedテーブルにのみ適用されます。
      通常のテーブルは、<a class="xref" href="runtime-in-memory-query-cache.html#guc-black-memqcache-table-list">black_memqcache_table_list</a>に記載されていない限りキャッシュされます。
    </p><p>      
      テーブル名のマッチングには正規表現も利用できます （指定した各表現に ^ と $ をつけた形で使われます）。
    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>	
	スキーマ名を付けないテーブル名とスキーマ名を付けた形の両方をクエリの中で使う場合は、両方共リストに登録してください。
        </p><pre class="programlisting">	  #For example:
	  #If the queries sometime use "table1" and other times "public.table1"
	  #to refer the table1 then the white_memqcache_table_list
	  #would be configured as follows.

	  white_memqcache_table_list = "table1,public.table1"

        </pre><p>

      </p></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>	
	<code class="varname">black_memqcache_table_list</code>は<a class="xref" href="runtime-in-memory-query-cache.html#guc-white-memqcache-table-list">white_memqcache_table_list</a>より優先されます。
      </p></div><p>      
      このパラメータは<span class="productname">Pgpool-II</span>の設定を再読み込みすることで変更可能です。</p></dd><dt id="guc-black-memqcache-table-list"><span class="term"><code class="varname">black_memqcache_table_list</code> (<code class="type">string</code>)
    <a id="idm45863246227840" class="indexterm"></a>
  </span></dt><dd><p>      
      SELECT結果が<span class="productname">Pgpool-II</span>にキャッシュされる<span class="emphasis"><em>べきでない</em></span>テーブル名のリストをカンマ区切りで指定します。
    </p><p>      
      テーブル名のマッチングには正規表現も利用できます （指定した各表現に ^ と $ をつけた形で使われます）。
    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>	
	スキーマ名を付けないテーブル名とスキーマ名を付けた形の両方をクエリの中で使う場合は、両方共リストに登録してください。
        </p><pre class="programlisting">	  #For example:
	  #If the queries sometime use "table1" and other times "public.table1"
	  #to refer the table1 then the black_memqcache_table_list
	  #would be configured as follows.

	  black_function_list = "table1,public.table1"

        </pre><p>

      </p></div><p>      
      このパラメータは<span class="productname">Pgpool-II</span>の設定を再読み込みすることで変更可能です。</p></dd><dt id="guc-memqcache-oiddir"><span class="term"><code class="varname">memqcache_oiddir</code> (<code class="type">string</code>)
    <a id="idm45863246219696" class="indexterm"></a>
  </span></dt><dd><p>      
      SELECTクエリが使用するテーブルに<code class="literal">OID</code>を格納するディレクトリへのフルパスで指定します。

    </p><p>      
      <code class="varname">memqcache_oiddir</code>には、各データベースのためのディレクトリが格納されます。
      そのディレクトリ名はデータベースのOIDです。
      更に、各データベースディレクトリその下には各テーブルの「ためのファイルが格納されます。
      そのファイル名は同じくテーブルのOIDです。
      これらのファイルの中にはクエリキャッシュへのポインタが格納されており、 キャッシュを削除する際のキーとして使われます。
    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>	
	<span class="productname">Pgpool-II</span>の通常の再起動では<code class="varname">memqcache_oiddir</code>の中身はクリアされません。
      </p></div><p>      
      このパラメータは<span class="productname">Pgpool-II</span>の設定を再読み込みすることで変更可能です。</p></dd></dl></div></div><div class="sect2" id="runtime-in-memory-query-cache-shmem-config"><div class="titlepage"><div><div><h3 class="title">5.12.4. 共有メモリ使用時の設定</h3></div></div></div><p>    
    これらはキャッシュストレージとして共有メモリを使用した場合に使われるパラメーターです。
  </p><div class="variablelist"><dl class="variablelist"><dt id="guc-memqcache-total-size"><span class="term"><code class="varname">memqcache_total_size</code> (<code class="type">integer</code>)
	<a id="idm45863246209232" class="indexterm"></a>
      </span></dt><dd><p>	  
	  共有メモリのキャッシュサイズをバイト単位で指定します。
	</p><p>	  
	  このパラメータはサーバ起動時にのみ設定可能です。
	</p></dd><dt id="guc-memqcache-max-num-cache"><span class="term"><code class="varname">memqcache_max_num_cache</code> (<code class="type">integer</code>)
	<a id="idm45863246205280" class="indexterm"></a>
      </span></dt><dd><p>	  
	  キャッシュエントリの数を指定します。
	  この設定項目は、キャッシュの管理領域の大きさを決めるために使用します。
	</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>	    
	    管理領域の大きさは、<code class="varname">memqcache_max_num_cache</code> * 48バイトで計算できます。
	    少なすぎるとキャッシュを登録することができずにエラーになります。
	    逆に多すぎると単に空間の無駄になります。
          </p></div><p>	  
	  このパラメータはサーバ起動時にのみ設定可能です。
	</p></dd><dt id="guc-memqcache-cache-block-size"><span class="term"><code class="varname">memqcache_cache_block_size</code> (<code class="type">integer</code>)
	<a id="idm45863246199872" class="indexterm"></a>
      </span></dt><dd><p>	  
	  キャッシュのブロックサイズを指定します。
	  <span class="productname">Pgpool-II</span>は<code class="varname">memqcache_cache_block_size</code>のブロックで管理されたキャッシュメモリを利用します。
	  SELECT結果はこのブロックに詰め込まれ、１つのブロックに収まらなければなりません。
	  従って、<code class="varname">memqcache_cache_block_size</code>を検索結果が超えると、キャッシュされません。。
	</p><p>	  
	  <code class="varname">memqcache_cache_block_size</code>は、512以上の値でなければなりません。
        </p><p>	  
	  このパラメータはサーバ起動時にのみ設定可能です。
	</p></dd></dl></div></div><div class="sect2" id="runtime-in-memory-query-cache-memcached-config"><div class="titlepage"><div><div><h3 class="title">5.12.5. memcached使用時の設定</h3></div></div></div><p>    
    これらはキャッシュストレージとしてmemcachedを使用した場合に使われるパラメーターです。
  </p><div class="variablelist"><dl class="variablelist"><dt id="guc-memqcache-memcached-host"><span class="term"><code class="varname">memqcache_memcached_host</code> (<code class="type">string</code>)
	<a id="idm45863246191632" class="indexterm"></a>
      </span></dt><dd><p>	  
	  <code class="literal">memcached</code>が動いているホスト名またはIPアドレスを指定します。
	  <span class="productname">Pgpool-II</span>と同じマシンで<code class="literal">memcached</code>を動かす場合は、<code class="literal">'localhost'</code>が使えます。
	</p><p>	  
	  このパラメータはサーバ起動時にのみ設定可能です。
	</p></dd><dt id="guc-memqcache-memcached-port"><span class="term"><code class="varname">memqcache_memcached_port</code> (<code class="type">integer</code>)
	<a id="idm45863246184864" class="indexterm"></a>
      </span></dt><dd><p>	  
	  <acronym class="acronym">memcached</acronym>のポート番号を指定します。
	  デフォルトは 11211 です。

	</p><p>	  
	  このパラメータはサーバ起動時にのみ設定可能です。
	</p></dd></dl></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="runtime-streaming-replication-check.html">前へ</a> </td><td width="20%" align="center"><a accesskey="u" href="runtime-config.html">上へ</a></td><td width="40%" align="right"> <a accesskey="n" href="runtime-ssl.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">5.11. ストリーミングレプリケーションのチェック </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> 5.13. Secure Sockect Layer (SSL)</td></tr></table></div></body></html>