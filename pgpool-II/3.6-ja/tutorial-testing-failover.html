<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>1.5. フェイルオーバを試してみる</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Pgpool-II 3.7devel 文書" /><link rel="up" href="tutorial-start.html" title="第1章 さあ始めましょう" /><link rel="prev" href="tutorial-testing-replication.html" title="1.4. レプリケーションを試してみる" /><link rel="next" href="tutorial-testing-online-recovery.html" title="1.6. オンラインリカバリを試してみる" /><link rel="copyright" href="legalnotice.html" title="Legal Notice" /><meta name="viewport" content="width=device-width,initial-scale=1.0" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><td width="20%" align="left" colspan="2"></td><th width="60%" align="center"><a accesskey="h" href="index.html">Pgpool-II 3.7devel 文書</a></th><td width="20%" align="right"></td></tr><tr><td width="10%" align="left" valign="top"><a accesskey="p" href="tutorial-testing-replication.html">前へ</a> </td><td width="10%" align="left" valign="top"><a accesskey="u" href="tutorial-start.html">上へ</a></td><td width="60%" align="center">1.5. フェイルオーバを試してみる</td><td width="20%" align="right" valign="top"> <a accesskey="n" href="tutorial-testing-online-recovery.html">次へ</a></td></tr></table><hr /></div><div class="sect1" id="tutorial-testing-failover"><div class="titlepage"><div><div><h2 class="title" style="clear: both">1.5. フェイルオーバを試してみる</h2></div></div></div><p><span class="productname">PostgreSQL</span>サーバが停止した際に、<span class="productname">Pgpool-II</span>は自動フェイルオーバさせることができます。
この場合、<span class="productname">Pgpool-II</span>はステータスを"down"にして、残ったサーバでデータベースの運用を継続します。
      </p><pre class="programlisting">$ pg_ctl -D data1 stop
waiting for server to shut down.... done
server stopped
$ psql -p 11000 -c "show pool_nodes" test
 node_id | hostname | port  | status | lb_weight |  role   | select_cnt | load_balance_node | replication_delay 
---------+----------+-------+--------+-----------+---------+------------+-------------------+-------------------
 0       | /tmp     | 11002 | up     | 0.500000  | primary | 2172       | true              | 0
 1       | /tmp     | 11003 | down   | 0.500000  | standby | 0          | false             | 0
(2 rows)

$ psql -p 11000 -c "SELECT sum(abalance) FROM pgbench_accounts" test
  sum   
--------
 192112
(1 row)
      </pre><p>
スタンバイノードをpg_ctlコマンドで停止しました。
<span class="productname">Pgpool-II</span>はそのことを検出し、そのスタンバイノードを切り離します。
"show pool_nodes"コマンドは、スタンバイノードがダウンしていることを表示します。
このスタンバイノードなしで、クラスタの運用を継続できます。
      </p><pre class="programlisting">$ psql -p 11000 -c "SELECT sum(abalance) FROM pgbench_accounts" test
  sum   
--------
 192112
(1 row)
      </pre><p>
プライマリサーバが落ちたらどうなるでしょう？
この場合、残ったスタンバイサーバの一つが新しいプライマリサーバへと昇格します。
テストのため、両方のノードが稼働中である状態から始めます。
      </p><pre class="programlisting">$ psql -p 11000 -c "show pool_nodes" test
 node_id | hostname | port  | status | lb_weight |  role   | select_cnt | load_balance_node | replication_delay 
---------+----------+-------+--------+-----------+---------+------------+-------------------+-------------------
 0       | /tmp     | 11002 | up     | 0.500000  | primary | 2173       | true              | 0
 1       | /tmp     | 11003 | up     | 0.500000  | standby | 0          | false             | 0
(2 rows)

$ pg_ctl -D data0 stop
waiting for server to shut down.... done
server stopped
$ psql -p 11000 -c "show pool_nodes" test
 node_id | hostname | port  | status | lb_weight |  role   | select_cnt | load_balance_node | replication_delay 
---------+----------+-------+--------+-----------+---------+------------+-------------------+-------------------
 0       | /tmp     | 11002 | down   | 0.500000  | standby | 2173       | false             | 0
 1       | /tmp     | 11003 | up     | 0.500000  | primary | 0          | true              | 0
(2 rows)
      </pre><p>
プライマリノードが0から1へと変わりました。
内部では何が起きたのでしょう？
ノード0がダウンした時、<span class="productname">Pgpool-II</span>はそのことを検出し、<code class="filename">pgpool.conf</code>に定義された"fail_over_script"を実行します。
その内容を以下に示します。
      </p><pre class="programlisting">#! /bin/sh
# Execute command by failover.
# special values:  %d = node id
#                  %h = host name
#                  %p = port number
#                  %D = database cluster path
#                  %m = new master node id
#                  %M = old master node id
#                  %H = new master node host name
#                  %P = old primary node id
#                  %R = new master database cluster path
#                  %r = new master port number
#                  %% = '%' character
failed_node_id=$1
failed_host_name=$2
failed_port=$3
failed_db_cluster=$4
new_master_id=$5
old_master_id=$6
new_master_host_name=$7
old_primary_node_id=$8
new_master_port_number=$9
new_master_db_cluster=${10}
mydir=/home/t-ishii/tmp/Tutorial
log=$mydir/log/failover.log
pg_ctl=/usr/local/pgsql/bin/pg_ctl
cluster0=$mydir/data0
cluster1=$mydir/data1

date &gt;&gt; $log
echo "failed_node_id $failed_node_id failed_host_name $failed_host_name failed_port $failed_port failed_db_cluster $failed_db_cluster new_master_id $new_master_id old_master_id $old_master_id new_master_host_name $new_master_host_name old_primary_node_id $old_primary_node_id new_master_port_number $new_master_port_number new_master_db_cluster $new_master_db_cluster" &gt;&gt; $log

if [ a"$failed_node_id" = a"$old_primary_node_id" ];then	# master failed
! 	new_primary_db_cluster=${mydir}/data"$new_master_id"
	echo $pg_ctl -D $new_primary_db_cluster promote &gt;&gt;$log	# let standby take over
	$pg_ctl -D $new_primary_db_cluster promote &gt;&gt;$log	# let standby take over
fi
      </pre><p>
そのスクリプトは、パラメータとして必要な情報を<span class="productname">Pgpool-II</span>から受け取ります。
プライマリサーバが落ちた時に、"pg_ctl -D data1 promote"を実行し、スタンバイサーバは新しいプライマリサーバへと昇格します。
    </p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="tutorial-testing-replication.html">前へ</a> </td><td width="20%" align="center"><a accesskey="u" href="tutorial-start.html">上へ</a></td><td width="40%" align="right"> <a accesskey="n" href="tutorial-testing-online-recovery.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">1.4. レプリケーションを試してみる </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> 1.6. オンラインリカバリを試してみる</td></tr></table></div></body></html>