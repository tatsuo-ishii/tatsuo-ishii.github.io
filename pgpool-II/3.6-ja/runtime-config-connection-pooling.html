<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>5.5. コネクションプーリング</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Pgpool-II 3.6.0 文書" /><link rel="up" href="runtime-config.html" title="第5章 サーバの設定" /><link rel="prev" href="runtime-config-backend-settings.html" title="5.4. バックエンドの設定" /><link rel="next" href="runtime-config-logging.html" title="5.6. エラー報告とログ取得" /><link rel="copyright" href="legalnotice.html" title="Legal Notice" /><meta name="viewport" content="width=device-width,initial-scale=1.0" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><td width="20%" align="left" colspan="2"></td><th width="60%" align="center"><a accesskey="h" href="index.html">Pgpool-II 3.6.0 文書</a></th><td width="20%" align="right"></td></tr><tr><td width="10%" align="left" valign="top"><a accesskey="p" href="runtime-config-backend-settings.html">前へ</a> </td><td width="10%" align="left" valign="top"><a accesskey="u" href="runtime-config.html">上へ</a></td><td width="60%" align="center">5.5. コネクションプーリング</td><td width="20%" align="right" valign="top"> <a accesskey="n" href="runtime-config-logging.html">次へ</a></td></tr></table><hr /></div><div class="sect1" id="runtime-config-connection-pooling"><div class="titlepage"><div><div><h2 class="title" style="clear: both">5.5. コネクションプーリング</h2></div></div></div><p><span class="productname">Pgpool-II</span>は確立された<span class="productname">PostgreSQL</span>サーバへの接続を保存しておき、同じ属性(ユーザ名、データベース、プロトコルバージョン)を持つ新しい接続が来た時にこれらを再利用します。
これにより接続のオーバヘッドを低減し、システム全体のスループットを向上することができます。
  </p><div class="sect2" id="runtime-config-connection-pooling-settings"><div class="titlepage"><div><div><h3 class="title">5.5.1. コネクションプールの設定</h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt id="guc-connection-cache"><span class="term"><code class="varname">connection_cache</code> (<code class="type">boolean</code>)
	  <a id="idp57432256" class="indexterm"></a>
	</span></dt><dd><p>onに設定されるとバックエンドへの接続をキャッシュします。
デフォルトはonです。
<span class="emphasis"><em>ただし、<code class="varname">connection_cache</code>がonでも、<code class="literal">template0</code>、<code class="literal">template1</code>、<code class="literal">postgres</code>、<code class="literal">regression</code>データベースへの接続はキャッシュされません。</em></span>
	  </p><p>このパラメータを変更した時には<span class="productname">Pgpool-II</span>を再起動してください。
	  </p></dd><dt id="guc-max-pool"><span class="term"><code class="varname">max_pool</code> (<code class="type">integer</code>)
	  <a id="idp57439616" class="indexterm"></a>
	</span></dt><dd><p><span class="productname">Pgpool-II</span>の各子プロセスがキャッシュするコネクションの最大数です。
<span class="productname">Pgpool-II</span>は、受け付けた接続が同じユーザ名で同じデータベースに接続しようとする場合に、キャッシュされたコネクションを再利用します。
そうでなければ<span class="productname">Pgpool-II</span>はバックエンドへの新しい接続を生成します。
もしキャッシュされている接続の数がmax_poolを超えた場合には、一番古いコネクションが廃棄され、そのスロットが新しい接続のために使用されます。
	  </p><p>デフォルト値は4です。
<span class="productname">Pgpool-II</span>のプロセスからバックエンドへの接続の数は全部で<a class="xref" href="runtime-config-connection.html#guc-num-init-children">num_init_children</a> * <code class="varname">max_pool</code>に達する可能性があることに注意してください。
	  </p><p>このパラメータはサーバ起動時にのみ設定可能です。
	  </p></dd><dt id="guc-listen-backlog-multiplier"><span class="term"><code class="varname">listen_backlog_multiplier</code> (<code class="type">integer</code>)
        <a id="idp57447136" class="indexterm"></a>
      </span></dt><dd><p>フロントエンドから<span class="productname">Pgpool-II</span>への接続待ち行列の長さを制御します。
接続待ち行列の長さ(具体的には<code class="literal">listen()</code>システムコールの<code class="literal">backlog</code>パラメータ)は、<code class="varname">listen_backlog_multiplier</code> * <a class="xref" href="runtime-config-connection.html#guc-num-init-children">num_init_children</a>で決まります。
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>システムのよっては<code class="literal">listen()</code>システムコールの<code class="literal">backlog</code>パラメータに上限が設定されています。
詳細は<a class="xref" href="runtime-config-connection.html#guc-num-init-children">num_init_children</a>の項を参照してください。
					</p></div><p>デフォルト値は2です。
				</p><p>このパラメータはサーバ起動時にのみ設定可能です。
        </p></dd><dt id="guc-serialize-accept"><span class="term"><code class="varname">serialize_accept</code> (<code class="type">boolean</code>)
        <a id="idp57455712" class="indexterm"></a>
      </span></dt><dd><p>onに設定することで、<span class="productname">Pgpool-II</span>は受け付けるクライアント接続のシリアライズを有効にします。
シリアライズを行わない場合、OSカーネルは<code class="literal">accept()</code>を実行するために全ての<span class="productname">Pgpool-II</span>子プロセスを起こし、実際にはそのうちの１つのみが入ってきた接続を処理します。
ここでの問題は、子プロセスが一度に起こされるために重いコンテキストスイッチングが起こり、性能に影響がでることです。
				</p><p>この現象は「thundering herd problem（猛獣の暴走）」と呼ばれる古典的な問題です。
これは<code class="literal">accept()</code>呼び出しのシリアライズを行うことで解決できます。
入ってきた接続に対して<span class="productname">Pgpool-II</span>プロセスのうちひとつだけが起こされて<code class="literal">accept()</code>を実行ようになるためです。
				</p><p>しかしシリアライズにはオーバヘッドがあり、<a class="xref" href="runtime-config-connection.html#guc-num-init-children">num_init_children</a>が大きい時のみ使用することを推奨します。
小さい<a class="xref" href="runtime-config-connection.html#guc-num-init-children">num_init_children</a>に対しては、シリアライズのオーバヘッドのために性能が低下するかもしれません。
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p><a class="xref" href="runtime-config-connection.html#guc-num-init-children">num_init_children</a>と<code class="varname">serialize_accept</code>の相関は環境によって異なるので、<code class="varname">serialize_accept</code>を使うかどうか決める前にベンチマークテストを行ってみることをおすすめします。
					</p></div><div class="example" id="example-serialize-accept-pgbench"><p class="title"><strong>例5.1 serialize_acceptの使用判断のためにpgbenchを利用する</strong></p><div class="example-contents"><p>以下のコマンドを使って<code class="command">pgbench</code>を実行します。
          </p><pre class="programlisting">pgbench -n -S -p 9999 -c 32 -C -S -T 300 test
          </pre><p>
ここで、<code class="literal">-C</code>は<code class="command">pgbench</code>にトランザクション実行の度に毎回データベースに接続することを指示します。
<code class="literal">-c 32</code>は、<span class="productname">Pgpool-II</span>への同時セッション数です。
これはシステム要件にあわせて変更するのがよいでしょう。
<code class="command">pgbench</code>が終了後、"including connections establishing" の数値をチェックします。
          </p></div></div><br class="example-break" /><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>なお、<a class="xref" href="runtime-config-connection-pooling.html#guc-child-life-time">child_life_time</a> が有効だと、<code class="varname">serialize_accept</code>は効果がありません。
<code class="varname">serialize_accept</code>をonにしたい場合は、<a class="xref" href="runtime-config-connection-pooling.html#guc-child-life-time">child_life_time</a>が0であることを確認してください。
<span class="productname">Pgpool-II</span>プロセスのメモリーリークなどの潜在的な問題を気にする場合は、代わりに<a class="xref" href="runtime-config-connection-pooling.html#guc-child-max-connections">child_max_connections</a>を使ってください。
この制限は純粋に実装上の問題であり、将来はなくなるかもしれません。
          </p></div><p>デフォルトはoffです。
				</p><p>このパラメータはサーバ起動時にのみ設定可能です。
        </p></dd><dt id="guc-child-life-time"><span class="term"><code class="varname">child_life_time</code> (<code class="type">integer</code>)
        <a id="idp57476608" class="indexterm"></a>
      </span></dt><dd><p><span class="productname">Pgpool-II</span>の子プロセスがアイドル状態のままでいるときに、それを強制終了するまでの時間を秒単位で指定します。
<code class="varname">child_life_time</code>により終了された時には、すぐに新しい子プロセスが<span class="productname">Pgpool-II</span>により起動されます。
<code class="varname">child_life_time</code>は<span class="productname">Pgpool-II</span>子プロセスのメモリリークやその他の不測のエラーに備えた予防措置です。
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p><code class="varname">child_life_time</code>はまだ一度もコネクションを受け付けていないプロセスには適用されません。
					</p></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>						<a class="xref" href="runtime-config-connection-pooling.html#guc-serialize-accept">serialize_accept</a> becomes ineffective when
						<code class="varname">child_life_time</code> is enabled.
					</p></div><p>デフォルト値は300秒（すなわち5分）です。
0を指定するとこの機能は無効になります。
				</p><p>このパラメータはサーバ起動時にのみ設定可能です。
        </p></dd><dt id="guc-client-idle-limit"><span class="term"><code class="varname">client_idle_limit</code> (<code class="type">integer</code>)
        <a id="idp57485184" class="indexterm"></a>
      </span></dt><dd><p>クライアントが前回のクエリからアイドル状態のままでいるときに、それを切断するまでの時間を秒単位で指定します。
これは、だらしないクライアントや<span class="productname">Pgpool-II</span>の間のTCP/IPコネクションの不調によって、<span class="productname">Pgpool-II</span>の子プロセスが占有されてしまうのを回避するのに役立ちます。
				</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p><code class="varname">client_idle_limit</code>はオンラインリカバリのセカンドステージでは無視されます。
					</p></div><p>デフォルト値は0で、この機能はoffとなります。
				</p><p>このパラメータは<span class="productname">Pgpool-II</span>の設定を再読み込みすることで変更可能です。
現在のセッションでのパラメータ値は、<a class="xref" href="sql-pgpool-set.html" title="PGPOOL SET"><span class="refentrytitle">PGPOOL SET</span></a>コマンドで変更することもできます。
        </p></dd><dt id="guc-child-max-connections"><span class="term"><code class="varname">child_max_connections</code> (<code class="type">integer</code>)
        <a id="idp57492416" class="indexterm"></a>
      </span></dt><dd><p>各<span class="productname">Pgpool-II</span>子プロセスの寿命を、受付可能なクライアント接続の数で指定します。
<code class="varname">child_max_connections</code>個のクライアント接続を処理した後に<span class="productname">Pgpool-II</span>はその子プロセスを終了させ、すぐに代わりの新しい子プロセスを生成します。
				</p><p><code class="varname">child_max_connections</code>は<a class="xref" href="runtime-config-connection-pooling.html#guc-child-life-time">child_life_time</a>や<a class="xref" href="runtime-config-connection-pooling.html#guc-connection-life-time">connection_life_time</a>が効かないくらい忙しいサーバで有用です。
また<span class="productname">PostgreSQL</span>バックエンドが肥大化するのを防ぐのにも有用です。
				</p><p>デフォルト値は0で、この機能はoffとなります。
				</p><p>このパラメータはサーバ起動時にのみ設定可能です。
        </p></dd><dt id="guc-connection-life-time"><span class="term"><code class="varname">connection_life_time</code> (<code class="type">integer</code>)
        <a id="idp57500176" class="indexterm"></a>
      </span></dt><dd><p>キャッシュされた<span class="productname">PostgreSQL</span>への接続を切断するまでの時間を秒単位で指定します。
これはキャッシュされた接続の有効期間として働きます。
				</p><p>デフォルトは0です。
これはキャッシュされた接続が切断されないことを意味しています。
				</p><p>このパラメータはサーバ起動時にのみ設定可能です。
        </p></dd><dt id="guc-reset-query-list"><span class="term"><code class="varname">reset_query_list</code> (<code class="type">string</code>)
        <a id="idp57504624" class="indexterm"></a>
      </span></dt><dd><p>ユーザセッションを終了するときにバックエンドコネクションを初期化するために送られる<acronym class="acronym">SQL</acronym>コマンドを指定します。
複数のコマンドを<code class="literal">";"</code>で区切って指定することができます。
				</p><p>利用できるコマンドは<span class="productname">PostgreSQL</span>のバージョンによって異なります。
各<span class="productname">PostgreSQL</span>バージョンごとの設定は以下です。
ただし、"ABORT"は必ずコマンドに含めてください。
				</p><div class="table" id="reset-query-list-suggestions-table"><p class="title"><strong>表5.4 PostgreSQLバージョンごとの<code class="varname">reset_query_list</code>の推奨設定</strong></p><div class="table-contents"><table summary="PostgreSQLバージョンごとのreset_query_listの推奨設定" border="1"><colgroup><col /><col /></colgroup><thead><tr><th>PostgreSQLバージョン</th><th>reset_query_list</th></tr></thead><tbody><tr><td>7.1以前</td><td><code class="literal">'ABORT'</code></td></tr><tr><td>7.2から8.2</td><td><code class="literal">'ABORT; RESET ALL; SET SESSION AUTHORIZATION DEFAULT'</code></td></tr><tr><td>8.3以降</td><td><code class="literal">'ABORT; DISCARD ALL'</code></td></tr></tbody></table></div></div><br class="table-break" /><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>
<code class="literal">ABORT</code>は、<span class="productname">PostgreSQL</span> 7.4以降ではトランザクションブロックの中にいない場合には発行されません。

					</p></div><p>デフォルト<code class="literal">'ABORT; DISCARD SLL'</code>です。
				</p><p>このパラメータは<span class="productname">Pgpool-II</span>の設定を再読み込みすることで変更可能です。
        </p></dd></dl></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="runtime-config-backend-settings.html">前へ</a> </td><td width="20%" align="center"><a accesskey="u" href="runtime-config.html">上へ</a></td><td width="40%" align="right"> <a accesskey="n" href="runtime-config-logging.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">5.4. バックエンドの設定 </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> 5.6. エラー報告とログ取得</td></tr></table></div></body></html>