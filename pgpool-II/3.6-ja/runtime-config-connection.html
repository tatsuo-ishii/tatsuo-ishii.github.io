<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>5.2. 接続と認証</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Pgpool-II 3.7devel 文書" /><link rel="up" href="runtime-config.html" title="第5章 サーバの設定" /><link rel="prev" href="config-setting.html" title="5.1. パラメータの設定" /><link rel="next" href="runtime-config-runnung-mode.html" title="5.3. 動作モード" /><link rel="copyright" href="legalnotice.html" title="Legal Notice" /><meta name="viewport" content="width=device-width,initial-scale=1.0" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><td width="20%" align="left" colspan="2"></td><th width="60%" align="center"><a accesskey="h" href="index.html">Pgpool-II 3.7devel 文書</a></th><td width="20%" align="right"></td></tr><tr><td width="10%" align="left" valign="top"><a accesskey="p" href="config-setting.html">前へ</a> </td><td width="10%" align="left" valign="top"><a accesskey="u" href="runtime-config.html">上へ</a></td><td width="60%" align="center">5.2. 接続と認証</td><td width="20%" align="right" valign="top"> <a accesskey="n" href="runtime-config-runnung-mode.html">次へ</a></td></tr></table><hr /></div><div class="sect1" id="runtime-config-connection"><div class="titlepage"><div><div><h2 class="title" style="clear: both">5.2. 接続と認証</h2></div></div></div><div class="sect2" id="runtime-config-connection-settings"><div class="titlepage"><div><div><h3 class="title">5.2.1. 接続設定</h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt id="guc-listen-addresses"><span class="term"><code class="varname">listen_addresses</code> (<code class="type">string</code>)
		<a id="idm45863247148592" class="indexterm"></a>
	</span></dt><dd><p><span class="productname">Pgpool-II</span>がTCP/IP接続を受け付けるホスト名またはIPアドレスを指定します。
<code class="literal">*</code>を指定すると入ってくる全ての接続を受け付けます。
<code class="literal">''</code>を指定するとTCP/IP接続を受け付けません。
デフォルト値は<code class="literal">'localhost'</code>です。
UNIXドメインソケット経由の接続は常に受け付けます。
		</p><p>このパラメータはサーバ起動時にのみ設定可能です。
		</p></dd><dt id="guc-port"><span class="term"><code class="varname">port</code> (<code class="type">integer</code>)
		<a id="idm45863247142576" class="indexterm"></a>
	</span></dt><dd><p><span class="productname">Pgpool-II</span>が接続を受け付けるために監視するポート番号です。
デフォルト値は9999です。
		</p><p>このパラメータはサーバ起動時にのみ設定可能です。
		</p></dd><dt id="guc-socket-dir"><span class="term"><code class="varname">socket_dir</code> (<code class="type">string</code>)
		<a id="idm45863247138704" class="indexterm"></a>
	</span></dt><dd><p><span class="productname">Pgpool-II</span>が接続を受け付けるUNIXドメインソケットを置くディレクトリです。
デフォルト値は<code class="literal">/tmp</code>です。
このソケットは、cron によって削除されることがあるので注意してください。
<code class="literal">/var/run</code>などのディレクトリに変更することをお勧めします。
		</p><p>このパラメータはサーバ起動時にのみ設定可能です。
		</p></dd><dt id="guc-pcp-listen-addresses"><span class="term"><code class="varname">pcp_listen_addresses</code> (<code class="type">string</code>)
		<a id="idm45863247133360" class="indexterm"></a>
	</span></dt><dd><p>PCPプロセスがTCP/IP接続を受け付けるホスト名またはIPアドレスを指定します。
<code class="literal">*</code>を指定すると入ってくる全てのの接続を受け付けます。
<code class="literal">''</code>を指定するとTCP/IP接続を受け付けません。
デフォルト値は<code class="literal">*</code>です。
UNIXドメインソケット経由のコネクションは常に受け付けます。
		</p><p>このパラメータはサーバ起動時にのみ設定可能です。
		</p></dd><dt id="guc-pcp-port"><span class="term"><code class="varname">pcp_port</code> (<code class="type">integer</code>)
		<a id="idm45863247127712" class="indexterm"></a>
	</span></dt><dd><p>PCPプロセスが接続を受け付けるために監視するポート番号です。
デフォルト値は9898です。
		</p><p>このパラメータはサーバ起動時にのみ設定可能です。
		</p></dd><dt id="guc-pcp-socket-dir"><span class="term"><code class="varname">pcp_socket_dir</code> (<code class="type">string</code>)
		<a id="idm45863247124192" class="indexterm"></a>
	</span></dt><dd><p>PCPプロセスが接続を受け付けるUNIXドメインソケットを置くディレクトリです。
デフォルト値は<code class="literal">/tmp</code>です。
このソケットは、cron によって削除されることがあるので注意してください。
<code class="literal">/var/run</code>などのディレクトリに変更することをお勧めします。
		</p><p>このパラメータはサーバ起動時にのみ設定可能です。
		</p></dd><dt id="guc-num-init-children"><span class="term"><code class="varname">num_init_children</code> (<code class="type">integer</code>)
		<a id="idm45863247119200" class="indexterm"></a>
	</span></dt><dd><p>preforkする<span class="productname">Pgpool-II</span>のサーバプロセスの数です。
デフォルト値は32です。
num_init_childrenは<span class="productname">Pgpool-II</span>に対してクライアントが同時に接続できる上限の数でもあります。
num_init_childrenより多いクライアントが<span class="productname">Pgpool-II</span>に接続しようとした場合、<span class="emphasis"><em>それらのクライアントは、<span class="productname">Pgpool-II</span>のどれかのプロセスへの接続が閉じられるまで待たされます(<span class="productname">PostgreSQL</span>のように接続拒否エラーにはなりません。)</em></span>。

待たされる数の上限は、<a class="xref" href="runtime-config-connection-pooling.html#guc-listen-backlog-multiplier">listen_backlog_multiplier</a> * num_init_children です。
		</p><p>待ち行列は、OS内部に作られ、「listenキュー」と呼ばれます。
listenキューの長さは「バックログ」と呼ばれます。
システムによってはバックログの上限が設定されており、<a class="xref" href="runtime-config-connection-pooling.html#guc-listen-backlog-multiplier">listen_backlog_multiplier</a>*num_init_childrenがこれを越える場合はバックログを大きく設定する必要があります。
さもないと高負荷時に以下のような問題が発生する可能性があります:
1) <span class="productname">Pgpool-II</span>への接続が失敗する。
2) カーネル内で行われるリトライにより<span class="productname">Pgpool-II</span>への接続が遅くなる。
実際にlistenキューが溢れているかどうかは、"netstat -s"コマンドを使って確認できます。
もし、以下のような出力があった場合、
			</p><pre class="programlisting">535 times the listen queue of a socket overflowed
			</pre><p>
listenキューが溢れています。
この場合にはバックログを増やす必要があります（スーパユーザ権限が権限が必要になります)。

			</p><pre class="programlisting"># sysctl net.core.somaxconn
net.core.somaxconn = 128
# sysctl -w net.core.somaxconn = 256
			</pre><p>
/etc/sysctl.confに以下のように書いても構いません。
			</p><pre class="programlisting">net.core.somaxconn = 256
			</pre><p>
		</p><p><span class="productname">PostgreSQL</span>へ貼られる接続数は大まかにはmax_pool*num_init_childrenとなります。
		</p><p>ただし、問い合わせのキャンセルを行うとバックエンドに対して別の接続が張られます。
したがって、すべての接続が使用中の場合には問い合わせのキャンセルができなくなります。
問い合わせのキャンセルを必ず保証したい場合は、想定されるコネクション数の倍の値を設定してください。
		</p><p>また、<span class="productname">PostgreSQL</span>は一般ユーザによる同時接続をmax_connections - superuser_reserved_connections個まで許しています。
		</p><p>まとめると、max_pool、num_init_children、max_connections、superuser_reserved_connectionsは、以下の式を満たいていなければなりません。
			</p><pre class="programlisting">max_pool*num_init_children &lt;= (max_connections - superuser_reserved_connections) (クエリのキャンセルを考慮しない場合)
max_pool*num_init_children*2 &lt;= (max_connections - superuser_reserved_connections) (クエリのキャンセルを考慮する場合)
			</pre><p>
		</p><p>このパラメータはサーバ起動時にのみ設定可能です。
		</p></dd></dl></div></div><div class="sect2" id="runtime-config-authentication-settings"><div class="titlepage"><div><div><h3 class="title">5.2.2. 認証設定</h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt id="guc-enable-pool-hba"><span class="term"><code class="varname">enable_pool_hba</code> (<code class="type">boolean</code>)
					<a id="idm45863247100560" class="indexterm"></a>
				</span></dt><dd><p><code class="literal">true</code>の場合、<span class="productname">Pgpool-II</span>はクライアント認証に<code class="filename">pool_hba.conf</code>を使用します。
クライアント認証のため<code class="filename">pool_hba.conf</code>を設定する方法について、詳細は<a class="xref" href="auth-pool-hba-conf.html" title="6.1. pool_hba.confファイル">6.1. <code class="filename">pool_hba.conf</code>ファイル</a>を参照してください。
デフォルトは<code class="literal">false</code>です。

					</p><p>このパラメータは<span class="productname">Pgpool-II</span>の設定を再読み込みすることで変更可能です。
					</p></dd><dt id="guc-pool-passwd"><span class="term"><code class="varname">pool_passwd</code> (<code class="type">string</code>)
					<a id="idm45863247093216" class="indexterm"></a>
				</span></dt><dd><p>md5 認証で用いるパスワードのファイルのファイル名を指定します。
デフォルト値は<code class="literal">"pool_passwd"</code>です。
<code class="literal">''</code>（空文字列）を指定すると パスワードファイルの使用は無効になります。
詳細は<a class="xref" href="auth-methods.html#auth-md5" title="6.2.2. MD5パスワード認証">6.2.2. MD5パスワード認証</a>を参照してください
					</p><p>このパラメータはサーバ起動時にのみ設定可能です。
					</p></dd><dt id="guc-authentication-timeout"><span class="term"><code class="varname">authentication_timeout</code> (<code class="type">integer</code>)
					<a id="idm45863247087856" class="indexterm"></a>
				</span></dt><dd><p><span class="productname">Pgpool-II</span>の認証処理のタイムアウト時間を秒単位で指定します。
0 を指定するとタイムアウトを無効にします。
デフォルト値は60です。
					</p><p>このパラメータは<span class="productname">Pgpool-II</span>の設定を再読み込みすることで変更可能です。
					</p></dd></dl></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="config-setting.html">前へ</a> </td><td width="20%" align="center"><a accesskey="u" href="runtime-config.html">上へ</a></td><td width="40%" align="right"> <a accesskey="n" href="runtime-config-runnung-mode.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">5.1. パラメータの設定 </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> 5.3. 動作モード</td></tr></table></div></body></html>